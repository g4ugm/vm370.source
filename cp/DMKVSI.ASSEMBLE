VSI      TITLE 'DMKVSI     (CP)        VM/370 - RELEASE 6'              00001000
         ISEQ  73,80          VALIDATE SERIALIZATION OF INPUT           00002000
*.                                                                      00003000
* MODULE NAME -                                                         00004000
*                                                                       00005000
*        DMKVSI                                                         00006000
*                                                                       00007000
* FUNCTION -                                                            00008000
*                                                                       00009000
*        TO SIMULATE THE OPERATION OF PRIVILEGED I/O INSTRUCTIONS       00010000
*        ISSUED BY VIRTUAL MACHINES                                     00011000
*                                                                       00012000
* ATTRIBUTES -                                                          00013000
*                                                                       00014000
*        REENTRANT, RESIDENT, ENTERED VIA GOTO FROM DMKPRVLG FOR THE    00015000
*        SIMULATION OF AN INSTRUCTION                                   00016000
*                                                                       00017000
* ENTRY POINTS -                                                        00018000
*                                                                       00019000
*        DMKVSIEX - SIMULATE A SIO, TIO, HIO, TCH, OR CLCH              00020000
*                                                                       00021000
* ENTRY CONDITIONS -                                                    00022000
*                                                                       00023000
*        FOR DMKVSIEX -                                                 00024000
*        GPR11 = ADDRESS OF USER'S VMBLOK                               00025000
*        GPR12 = DMKVSIEX BASE                                          00026000
*        THE FIELD VMINST IN THE USER'S VMBLOK CONTAINS THE I/O         00027000
*        INSTRUCTION TO BE SIMULATED                                    00028000
*                                                                       00029000
*        NOTE THAT GPR13 DOES NOT POINT TO A SAVEAREA                   00030000
*                                                                       00031000
* EXIT CONDITIONS -                                                     00032000
*                                                                       00033000
*        FOR DMKVSIEX - NORMAL                                          00034000
*        THE CORRECT STATUS AND CONDITION CODES ARE REFLECTED TO THE    00035000
*        VIRTUAL MACHINE, AND, IF APPROPRIATE, THE I/O IS STARTED       00036000
*                                                                       00037000
         EJECT                                                          00038000
*                                                                       00039000
* CALLS TO OTHER ROUTINES -                                             00040000
*                                                                       00041000
*        DMKPTRAN - LOCATE THE USER'S PAGE 0                            00042000
*        DMKCCWTR - TO TRANSLATE THE USER'S CHANNEL PROGRAM             00043000
*        DMKFREE  - TO OBTAIN FREE STORAGE FOR IOBLOKS                  00044000
*        DMKFRET  - TO RETURN USED IOBLOKS TO FREE STORAGE              00045000
*        DMKIOSQV - TO SCHEDULE THE VIRTUAL OPERATION                   00046000
*        DMKVCAST - TO SIMULATE A START I/O TO A VIRTUAL CTCA           00047000
*        DMKVCATS - TO SIMULATE A TEST I/O TO A VIRTUAL CTCA            00048000
*        DMKVCASH - TO SIMULATE A HALT I/O TO A VIRTUAL CTCA            00049000
*        DMKSTKIO - TO STACK AN INTERRUPT DUE TO THE COMPLETION OF A    00050000
*                   VIRTUAL ENABLE  CAUSED BY A HIO                     00051000
*        DMKDSPCH - EXIT VIA GOTO AFTER I/O IS SCHEDULED BY DMKIOSQV    00052000
*        DMKSCNVU - LOCATE VIRTUAL CHANNEL, CU, AND DEVICE BLOKS        00053000
*        DMKTRDSI - TO TRACE AN I/O OPER. (SIO, TIO, HIO, TCH, CLCH)    00054000
*        DMKVSPEX - EXIT VIA GOTO TO SIMULATE SPOOLED U/R OPERATION     00055000
*        DMKVCNEX - EXIT VIA GOTO TO SIMULATE VIRTUAL 1052 CONSOLE      00056000
*        DMKVSPTO - TO SIMULATE A TIO TO A UNIT RECORD INPUT DEVICE     00057000
*        DMKSCHDL - TO DROP A USER FROM Q                               00058000
*        DMKVIOC1 - TO REFLECT CONDITION CODE 1 CSW STATUS              00059000
*        DMKVIOIN - IOB INTERRUPT RETURN ADDRESS (IOBIRA)               00060000
*        DMKCCHRF - CALLED TO REFLECT CHANNEL CHECK TO VIRTUAL MACHINE  00061000
*                                                                       00062000
* EXTERNAL REFERENCES -                                                 00063000
*                                                                       00064000
*        NONE                                                           00065000
*                                                                       00066000
* TABLES / WORKAREAS -                                                  00067000
*                                                                       00068000
*        VCHBLOK,VCUBLOK, AND VDEVBLOK ARE REFERENCED AND UPDATED       00069000
*                                                                       00070000
* REGISTER USAGE -                                                      00071000
*                                                                       00072000
*        GPR0  = CONDITION CODE RETURNED FROM DMKSCNVU                  00073000
*        GPR1  = SCRATCH - OR USED FOR DEDICATED CHANNEL SUPPORT        00074000
*        GPR2  = SCRATCH - OR USED FOR DEDICATED CHANNEL SUPPORT        00075000
*        GPR3  = ADDRESS OF VBLOK THAT CONTAINS SUBCHANNEL STATUS       00076000
*        GPR4  = CSW STATUS TO BE STORED                                00077000
*        GPR5  = INTERNAL SUBROUTINE LINKAGE                            00078000
*        GPR6  = VCHBLOK BASE                                           00079000
*        GPR7  = VCUBLOK BASE                                           00080000
*        GPR8  = VDEVBLOK BASE                                          00081000
*        GPR9  = VIRTUAL DEVICE ADDRESS                                 00082000
*        GPR10 = IOBLOK BASE                                            00083000
*        GPR11 = VMBLOK BASE                                            00084000
*        GPR12 = DMKVSI BASE                                            00085000
*        GPR13   NOT USED                                               00086000
*        GPR14 = EXTERNAL LINKAGE                                       00087000
*        GPR15 = EXTERNAL LINKAGE                                       00088000
         EJECT                                                          00089000
*                                                                       00090000
* NOTES -                                                               00091000
*                                                                       00092000
* OPERATION -                                                           00093000
*        1. SET CONDITION CODE IN VIRTUAL PSW TO ZERO                   00094000
*        2. CALCULATE VIRTUAL UNIT ADDRESS USING REGISTER AND DISPLACE- 00095000
*           MENT VALUES PASSED BY PRIVILEGED IN VMINST                  00096000
*        3. CALL DMKSCNVU TO LOCATE VCHBLOK, VCUBLOK, AND VDEVBLOK,     00097000
*           AND SAVE THE RESULTING CONDITION IN GPR0                    00098000
*     4. BRANCH TO HANDLE SIO, TIO, TCH, CLCH, AND HIO, DESCRIBED       00099000
*        IN SECTIONS A-E RESPECTIVELY.                                  00100000
*.                                                                      00101000
         EJECT                                                          00102000
         COPY  OPTIONS                                                  00103000
         COPY  LOCAL               OPTIONS                              00104000
         SPACE 2                                                        00105000
DMKVSI   CSECT                                                          00106000
         ENTRY DMKVSIEX,DMKVSICT,DMKVSICW                               00107000
         ENTRY DMKVSISI       COUNT OF SIO (9C00) INSTRUCTIONS @V2B2638 00108000
         ENTRY DMKVSISF       COUNT OF SIOF (9CX1) INSTRUCTIONS@V2B2638 00109000
         ENTRY DMKVSITI       COUNT OF TIO (9DX0) INSTRUCTIONS @V2B2638 00110000
         ENTRY DMKVSICI       COUNT OF CLRIO (9DX1)            @V2B2638 00111000
*                             INSTRUCTIONS                              00112000
         ENTRY DMKVSIHI       COUNT OF HIO (9EX0) INSTRUCTIONS @V2B2638 00113000
         ENTRY DMKVSIHD       COUNT OF HDV (9EX1) INSTRUCTIONS @V2B2638 00114000
         ENTRY DMKVSITC       COUNT OF TCH (9FXX) INSTRUCTIONS @V2B2638 00115000
         ENTRY DMKVSIVS       INTERNAL SYM. 'VSIO'(FOR EVMA)   @V386198 00116000
         EXTRN DMKVIOMK,DMKVIOXK                                        00117000
         EXTRN DMKVIOIN                                                 00118000
         EXTRN DMKVIOC1                                                 00119000
         EXTRN DMKSCHDL                                                 00120000
         EXTRN DMKCCWTR                                                 00121000
         EXTRN DMKIOSQV                                                 00122000
         EXTRN DMKSTKIO                                                 00123000
         EXTRN DMKSCNVU                                                 00124000
         EXTRN DMKVCAST,DMKVCATS,DMKVCASH                               00125000
         EXTRN DMKVSPEX,DMKVSPTO                               @VA03503 00126000
         EXTRN DMKVCNEX                                                 00127000
         EXTRN DMKCCHRF                                        @V508690 00128000
         EXTRN DMKSSSMQ,DMKDSPCH                               @V60B6B8 00129000
         AIF   (NOT &TRACE(6)).TRA1                             **AIF** 00130000
         EXTRN DMKTRDSI                                        @V4M0240 00131000
.TRA1    ANOP                                                           00132000
         AIF (NOT &AP).LOKSY4                                           00133000
         EXTRN DMKLOKSY,DMKDSPRU                               @VA08305 00134000
.LOKSY4  ANOP                                                           00135000
         EXTRN DMKSTKDE,DMKSTKOP,DMKSTKMP                      @VA08305 00136000
         SPACE 2                                                        00137000
         USING PSA,R0                                                   00138000
         USING VCHBLOK,R6                                               00139000
         EXTRN DMKDSPA                                         @V408246 00140000
         EXTRN DMKDSPRQ                                        @V408246 00141000
         USING VCUBLOK,R7                                               00142000
         USING VDEVBLOK,R8                                              00143000
         USING IOBLOK,R10                                               00144000
         USING VMBLOK,R11                                               00145000
         USING DMKVSIEX,R12                                             00146000
         EJECT                                                          00147000
*.                                                                      00148000
*********************************************************************** 00149000
*                                                                       00150000
*                                                                       00151000
*        EXPANDED VMA PARTIAL EMULATION FUNCTION FOR SIO AND SIOF:      00152000
*                                                                       00153000
*        INVOKED BY THESE INSTRUCTIONS WHEN EXECUTED IN PROBLEM STATE   00154000
*        WITH CONTROL REGISTER 6 BYTE 0 SET TO B'10XXXX1X' (X = 0 OR 1) 00155000
*    AND BIT 3 OF THE ASSIST CONTROLS FULLWORD (OFFSET X'14'            00156000
*    INTO THE MICBLOK) SET TO 1.                                        00157000
*                                                                       00158000
*        REGISTER INPUT:                                                00159000
*           CR 6 = BITS 0-7 ARE THE ASSIST FLAGS; BITS 8-28 ADDRESS     00160000
*                  THE MICBLOK (THE VIRTUAL MACHINE POINTER LIST)       00161000
*                                                                       00162000
*        SYSTEM DATA AREAS REFERENCED (BY MODULE WHERE APPLICABLE):     00163000
*           DMKPRV - 'DMKPRVMA' (EQUALS 'VMALIST')                      00164000
*           DMKPSA - 'AVMALIST', 'PRNPSW', CPCREGS, TIMER FIELDS,       00165000
*                    TRACING INFORMATION, 'CPSTATUS', 'PROPSW'          00166000
*           MICBLOK, VCHBLOK, VCUBLOK, VDEVBLOK, VMBLOK                 00167000
*                                                                       00168000
*                                                                       00169000
*                                                                       00170000
*        EXIT TO 'DMKVSIVS' (PATH AVAILABLE AND NO INTERRUPTS PENDING)  00171000
*        NOTE: THE CONTENT OF ANY UNSPECIFIED GPR IS UNPREDICTABLE      00172000
*           REGISTER OUTPUT:                                            00173000
*               CR  0 = VALUE FROM 'CPCREG0'                            00174000
*               CR  8 = VALUE FROM 'CPCREG8'                            00175000
*              GPR  3 = ADDRESS OF EITHER VCHBLOK, VCUBLOK, OR VDEVBLOK 00176000
*              GPR  4 = ZERO                                            00177000
*              GPR  6 = ADDRESS OF THE VCHBLOK                          00178000
*              GPR  7 = ADDRESS OF THE VCUBLOK                          00179000
*              GPR  8 = ADDRESS OF THE VDEVBLOK                         00180000
*              GPR 11 = X'A8' LESS THAN 'MICVPSW' (ADDRESS OF VMBLOK)   00181000
*              GPR 12 = ADDRESS OF 'DMKVSIEX'                           00182000
*              GPR 13 = VIRTUAL DEVICE ADDRESS (RIGHT JUSTIFIED)        00183000
*                                                                       00184000
*        EXIT TO 'DMKVSIEX' (COULDN'T FIND AN AVAILABLE PATH TO DEVICE) 00185000
*           REGISTER OUTPUT:                                            00186000
*              CR 0,8 AND GPR 11,12 SAME AS FOR EXIT TO 'DMKVSIVS'      00187000
*                                                                       00188000
*********************************************************************** 00189000
*.                                                                      00190000
         SPACE                                                          00191000
DMKVSIEX DS    0D                                              %V386198 00192000
         NI    VMPSW+2,X'FF'-X'30'   SET CC = 0                %V386198 00193000
         NI    VMPSW+4,X'FF'-X'30'   SET CC = 0                %V386198 00194000
         NI    VMDSTAT,X'FF'-VMTIO   REMOVE TIO-BUSY FLAG      %V386198 00195000
         SR    R4,R4          SET CSW-STORE SW TO STATUS ONLY  %V386198 00196000
         CLI   VMINST,X'83'   DIAG CONSOLE WRITE ??            %V200730 00197000
         BE    DIAGDEV        YES, GO FIND CNTROL BLOCKS       %V2B2638 00198000
         L     R1,VMINST      I/O INSTRUCTION BEING EXECUTED   %VA01382 00199000
         N     R1,F4095       KEEP ONLY DISPLACEMENT           %V386198 00200000
         IC    R8,VMINST+2    PICK UP REGISTER NUMBER          %V386198 00201000
         N     R8,F240        KEEP ONLY REGISTER NUMBER        %V386198 00202000
         BZ    DIAGDEV        NO REGISTER SPECIFIED            %VA01382 00203000
         SRL   R8,2           GET REGISTER NUMBER X 4          %V386198 00204000
         AH    R1,VMGPRS+2(R8)   COMPUTE DEVICE ADDRESS        %V386198 00205000
DIAGDEV  LR    R13,R1         SAVE DEV ADDRESS                 %V200730 00206000
         CALL  DMKSCNVU       GO GET VCH, VCU, AND VDEV BLOKS  %V386198 00207000
         BALR  R0,0           PRESERVE CONDITION CODE          %V386198 00208000
         SPACE 2                                                        00209000
         LA    R2,X'30'       COND CODE IF DEVICE NOT FOUND    %VA01527 00210000
         LA    R1,1           INCREMENT VALUE                  %V2B2638 00211000
         AL    R1,DMKVSICT    ADD CALLS TO DMKVSIEX            %V2B2638 00212000
         ST    R1,DMKVSICT    AND SAVE                         %V2B2638 00213000
         LA    R1,1           INCREMENT VALUE FOR LATER        %V2B2638 00214000
         SPACE                                                          00215000
         CLI   VMINST,X'9D'   SIO OR TIO ?                     %V386198 00216000
         BL    VIOSIO              START I/O                   %V386198 00217000
         BE    VIOTIO              TEST I/O                             00218000
         CLC   VMINST(2),TCHOPER HIO OR TCH?                   @VMD0117 00219000
         BL    VIOHIO              HALT I/O                             00220000
         BE    VIOTCH         TEST CHANNEL                     @VMD0117 00221000
         BH    VIOCLCH        CLEAR CHANNEL                    @VMD0117 00222000
         EJECT                                                          00223000
*.                                                                      00224000
*     A. VIRTUAL SIO SIMULATION -                                       00225000
*        1. IF ALL BLOCKS WERE NOT FOUND, SET VIRTUAL CONDITION         00226000
*           CODE 3 AND EXIT.                                            00227000
*        3. IF THE ADDRESSED SUBCHANNEL IS BUSY OR HAS CE PENDING,      00228000
*           SET VIRTUAL CONDITION CODE 2 AND EXIT.                      00229000
*        4. IF THE ADDRESSED CU OR DEVICE IS BUSY OR HAS STATUS         00230000
*           PENDING, OR, FOR MINIDISKS, IF THE DEVICE IS RESERVED       00231000
*           BY ANOTHER USER, STORE STATUS, SET VIRTUAL CC 1, AND EXIT.  00232000
*        5. IF THE PATH TO THE DEVICE IS FREE, TRANS FOR USER'S         00233000
*           PAGE 0, AND LOAD HIS VIRTUAL CAW; THEN BASED ON THE         00234000
*           VIRTUAL DEVICE TYPE, PROCESS AS FOLLOWS-                    00235000
*        6. -IF THE DEVICE IS A TERMINAL, GOTO DMKVCNEX TO SIMULATE     00236000
*            THE OPERATION.                                             00237000
*           -IF THE DEVICE IS NON-DEDICATED U/R, GOTO DMKVSPEX          00238000
*            TO SIMULATE THE OPERATION.                                 00239000
*           -OTHERWISE, CONSTRUCT AN IOBLOK, STORE THE DEVICE           00240000
*            ADDRESS AND CAW, AND CALL DMKCCWTR.                        00241000
*        7. IF THE OPERATION IS AN ENABLE TO A VIRTUAL 270X LINE,       00242000
*           LET THE IOBLOK STAY ON THE VDEVBLOK FOR THE 'DIAL' CMD.     00243000
*        8. IF THE OPERATION IS DIRECTED AT A VIRTUAL CTCA, CALL        00244000
*           DMKVCAST TO SIMULATE THE DEVICE OPERATIONS.                 00245000
*        9. OTHERWISE, PLACE THE USER IN IOWAIT AND CALL DMKIOSQV       00246000
*           TO SCHEDULE THE REAL I/O OPERATION.                         00247000
*        10.  EXIT VIA GOTO DMKDSPCH.                                   00248000
*.                                                                      00249000
         SPACE                                                          00250000
VIOSIO   EQU   *                                               %V386198 00251000
         CLI   VMINST,X'9C'   IS IT AN SIO?                    %V2B2638 00252000
         BNE   VIOSIO1        NOPE, MUST BE DIAG.              %V2B2638 00253000
         TM    VMINST+1,X'01' IS IT AN SIOF?                   %V2B2638 00254000
         BO    SIOF           YUP, BR.                         %V2B2638 00255000
         AL    R1,DMKVSISI    ADD SIO COUNT                    %V2B2638 00256000
         ST    R1,DMKVSISI    AND RE-STORE                     %V2B2638 00257000
         B     VIOSIO1        CONTINUE                         %V2B2638 00258000
         SPACE                                                          00259000
SIOF     AL    R1,DMKVSISF    ADD SIOF COUNT TO INCREMENT      %V2B2638 00260000
         ST    R1,DMKVSISF    AND RE-STORE                     %V2B2638 00261000
         SPACE                                                          00262000
VIOSIO1  EQU   *              HERE WHEN COUNTS ARE BUMPED      %V2B2638 00263000
         SPM   R0             RESTORE COND. CODE FROM DMKSCNVU %V386198 00264000
         BNZ   VIOEXIT        EXIT WITH CC = 3 - DEV NOT FOUND %VA01527 00265000
         C     R11,AVMREAL    V=R USER?                        @VA08305 00266000
         BE    VIOSIO2        YES,TRY TO HANDLE WITHOUT LOCKS  @VA08305 00267000
         BAL   R9,GETLOCK     NO,GO GET THE SYSTEM LOCK        @VA08305 00268000
VIOSIO2  EQU   *                                               @VA08305 00269000
         SPACE                                                          00270000
         LR    R10,R5         SAVE CCW ADDRESS FROM HVC        @VA08305 00271000
         BAL   R9,CHSCAN      IS CHANNEL BUSY OR CE PENDING ?  %V386198 00272000
         LA    R2,X'20'       CC IF NOT BUSY, CE PENDING       %V386198 00273000
         BNZ   VIOEXIT        CE PENDING - SET CC=2 AND EXIT   %V386198 00274000
         SPACE                                                          00275000
         BAL   R9,CUSCAN      CHECK IF CU BUSY OR CUE PENDING  %V386198 00276000
         BO    SIOCUE              NOT BUSY, CUE PENDING       %V386198 00277000
         SPACE                                                          00278000
         BAL   R9,DEVSCAN     IS DEVICE BUSY OR INT PENDING ?  %V386198 00279000
         CLC   VMINST(2),=X'9C01' IS THIS A SIOF?              @VA08305 00280000
         BE    VSIO           YES,BYPASS THE LOCK              @VA08305 00281000
         BAL   R9,GETLOCK     NO,MUST HAVE THE SYSTEM LOCK     @VA08305 00282000
         EJECT                                                          00283000
*                                                                       00284000
*        RETURN IS HERE IF PATH TO DEVICE IS NOT BUSY AND               00285000
*        NO INTERRUPTS ARE PENDING                                      00286000
*                                                                       00287000
         CLI   VMINST,X'83'   DIAG SIO TO CONSOLE ??           %V200730 00288000
         BNE   VSIO           NO, REGULAR SIO                  %V200730 00289000
         LR    R2,R10         GET CCW ADDRESS                  @VA08305 00290000
         B     TSTDED1        TEST FOR DED CHAN                @V200730 00291000
         SPACE                                                          00292000
VSIO     DS    0H                                              @V200730 00293000
DMKVSIVS EQU   VSIO           FOR USE AS ENTRY IN EVMA LIST    @V386198 00294000
         LA    R1,CAW              LOGICAL ADDRESS OF USER'S CAW        00295000
         SL    R6,VMCHSTRT    CHAN. DISP.                      @VA01770 00296000
         SL    R7,VMCUSTRT    C.U. DISP.                       @VA01770 00297000
         SL    R8,VMDVSTRT    DEV. DISP                        @VA01770 00298000
         TRANS 2,1,OPT=(BRING,DEFER) GET USER'S PAGE 0                  00299000
         AL    R6,VMCHSTRT    RESTORE VCHANBLOKADDR            @VA01770 00300000
         AL    R7,VMCUSTRT    RESTORE CU ADDR                  @VA01770 00301000
         AL    R8,VMDVSTRT    RESTORE DEV. ADDR                @VA01770 00302000
         L     R2,0(,R2)           GET LOGICAL ADDRESS OF USER'S 1ST    00303000
*                                  CCW                                  00304000
TSTDED1  DS    0H                                              @V200730 00305000
         TM    VDEVSTAT,VDEVDED        DO WE HAVE A DEDICATED DEVICE    00306000
         BO    GETIOB             YES, GO PERFORM REAL I/O              00307000
         BAL   R9,GETLOCK     NEED THE SYSTEM LOCK             @VA08305 00308000
         SPACE 1                                                        00309000
         TM    VDEVTYPC,CLASTERM   IS IT A TERMINAL DEVICE ?            00310000
         BZ    TESTUR         NO -- CHECK FOR UNIT RECORD               00311000
         CLI   VDEVTYPE,TYP3210    IS IT A CONSOLE ??                   00312000
         BNE   GETIOB         NO - MUST BE ENABLE TO NON-DEDICATED LINE 00313000
         GOTO  DMKVCNEX            DMKVCNEX HANDLES USER CONSOLE IO     00314000
         SPACE 2                                                        00315000
TESTUR   TM    VDEVTYPC,CLASURI+CLASURO IS IT A UNIT RECORD DEVICE ??   00316000
         BZ    GETIOB              NO -- IO DONE VIA DMKCCWTR           00317000
         GOTO  DMKVSPEX            DMKVSPEX HANDLES SPOOLED UNIT        00318000
*                                  RECORD IO                            00319000
         EJECT                                                          00320000
GETIOB   EQU   *                                                        00321000
         OI    VDEVSTAT,VDEVBUSY+VDEVCHBS    FLAG DEVICE AND CHANNEL    00322000
         OI    VCHSTAT-VCHBLOK(R3),VCHBUSY MARK THE SUBCHANNEL BUSY     00323000
         OI    VCUSTAT,VCUBUSY CONTROL UNIT IS BUSY            @VA01700 00324000
         TM    VCHTYPE,VCHBMX BMX CHANNEL ?                    @VA03150 00325000
         BNO   IOBFREE        NO - DON'T FLAG C U              @VA03150 00326000
         OI    VCUSTAT,VCUACTV FLAG CONTROL UNIT ACTIVE        @VA03150 00327000
         TM    VDEVTYPC,CLASTERM IS THIS A TERMINAL DEVICE?    @VA03150 00328000
         BNO   IOBFREE        NO...CONTROL UNIT WILL BE ACTIVE @VA03150 00329000
         NI    VCUSTAT,255-VCUACTV RESET ACTIVE FLAG           @VA03150 00330000
         SPACE                                                          00331000
IOBFREE  LA    R0,IOBSIZE          GET CORE                             00332000
         CALL  DMKFREE             FOR AN IOBLOK                        00333000
         LR    R10,R1              USE GPR 10 FOR ADDRESSABILITY        00334000
         XC    IOBLOK(IOBSIZE*8),IOBLOK CLEAR THE IOBLOK                00335000
         ST    R10,IOBLINK    IOBLOK POINTS TO ITSELF (= ORIGINAL COPY) 00336000
*                                                                       00337000
*                                                                       00338000
         OI    IOBFLAG,IOBRELCU RELEASE CU                     @VA01700 00339000
         SPACE                                                          00340000
         STH   R13,IOBVADD          SAVE VIRTUAL DEVICE ADDRESS         00341000
         L     R1,=A(DMKVIOIN)                                          00342000
         ST    R1,IOBIRA           AND STORE IN IOBLOK                  00343000
         ST    R2,IOBCAW      SAVE VIRTUAL ADDRESS OF FIRST CCW         00344000
         ST    R10,VDEVIOB    SAVE ADDRESS OF IOBLOK                    00345000
         AIF   (NOT &VIRREAL).NOVR3                             **AIF** 00346000
         C     R11,AVMREAL    IS REQUEST FOR VIRT=REAL USER             00347000
         BNE   CCWTR2         NO, ALLOW CCW'S TO BE TRANSLATED          00348000
         TM    VMPSTAT,VMNOTRAN    DOES USER WANT CCW TRANSLATION       00349000
         BZ    CCWTR2         YES, CALL DMKCCW                          00350000
*                                                                       00351000
*        TEST TO SEE IF THE MSS IS PRESENT IN THIS SYSTEM.              00352000
*              IF IT IS, AND THE REAL DEVICE IS A 3330V AND             00353000
*              THE VIRTUAL DEVICE IS NOT A 3330V, THEN DMKCCW           00354000
*              MUST BE CALLED IN ORDER TO INSERT THE PREFIX             00355000
*              CCW'S IN ORDER TO TRAP MSS CYLINDER FAULTS.              00356000
*                                                                       00357000
         TM    VDEVFLG2,VIRTUAL IS VDEV A 3330V                @V60B6B8 00358000
         BO    TSTRAC         NO NEED TO CALL DMKCCW FOR THAT  @V60B6B8 00359000
*                             REASON                                    00360000
         L     R15,VDEVREAL   GET REAL DEV BLOK                @V60B6B8 00361000
         CLI   RDEVTYPC-RDEVBLOK(R15),CLASDASD IS RDEV A DASD  @V60B6B8 00362000
         BNE   TSTRAC         CAN'T BE A VUA                   @V60B6B8 00363000
         TM    RDEVFTR-RDEVBLOK(R15),VIRTUAL+SYSVIRT IS IT A   @V60B6B8 00364000
*                             VUA                                       00365000
         BNZ   CCWTR2         YES, MUST TRANS THE CHAN PROG    @V60B6B8 00366000
TSTRAC   EQU   *                                               @V60B6B8 00367000
         TM    VMTRCTL,VMTRSIO SIO TRACING ACTIVE ?            @VA01818 00368000
         BO    CCWTR2         YES, TRANSLATE CCW.              @VA01818 00369000
         LA    R9,0(0,R2)     STRIP PROTECTION KEY FROM CAW    @VA02481 00370000
         CLI   VDEVTYPC,CLASTERM TERMINAL TYPE ??              @V200730 00371000
         BNE   TSTDED         NO, SEE IF DEDICATED             @V200730 00372000
         TM    VDEVFLAG,VDEVDIAL IS IT DIALED ??               @V200730 00373000
         BO    CCWTR2              YES - MUST TRANSLATE CCWS   @VA02481 00374000
TSTDED   L     R15,VDEVREAL   SETUP PTR TO RDEVBLOK            @VA07835 00375000
         USING RDEVBLOK,R15   ADDRESSABILITY                   @VA07835 00376000
         TM    RDEVSTA2,RDEVALT ALT PATH DEVICE                @VA07835 00377000
         BO    CCWTR2         MUST GO THRU CCWTRANS            @VA07835 00378000
         TM    VDEVSTAT,VDEVDED DEDICATE DEVICE                @VA07835 00379000
         BNO   TSTNDED        NOT DEDICATED CONTINUE           @VA05399 00380000
         TM    VDEVFLAG,VDEVRDO READ/ONLY DEVICE?              @VA05399 00381000
         BO    CCWTR2         YES, DO CCW TRANS                @VA05399 00382000
         B     TSTSENSE       NO, CK FOR VIRT SENSE BYTES      @VA05399 00383000
TSTNDED  CLI   VDEVTYPC,CLASDASD DASD DEVICE                   @VA07835 00384000
         BNE   CCWTR2         NO, DO CCW TRANS                 @VA03813 00385000
         TM    VDEVFLAG,VDEVRDO  READ ONLY DEVICE?             @VA03813 00386000
         BO    CCWTR2         YES, DO CCW TRANS                @VA03813 00387000
         TM    VDEVFLG2,VDEVRRF MDISK WITH RES/REL FEATURE?    @V407438 00388000
         BO    CCWTR2         YUP, MUST TRANSLATE CCWS, BR.    @V407438 00389000
         CLI   VDEVTYPE,TYP3330 3330?                          @VA03813 00390000
         BNE   DASD3340       NO, TRY 3340                     @VA03813 00391000
         CLI   RDEVMDL,X'0B'  MOD 11?                          @VA03813 00392000
         BNE   MOD1OR2        NO, TRY MOD 1 OR 2               @VA03813 00393000
         CLC   VDEVBND(2),=H'808' ALL CYLS USED?               @VA03813 00394000
         BNL   TSTSENSE       YES, HOPEFULLY BYPASS CCWTRANS   @VA06150 00395000
         B     CCWTR2         NO, DO CCW TRANS                 @VA03813 00396000
MOD1OR2  CLC   VDEVBND(2),=H'404' ALL CYLS USED?               @VA03813 00397000
         BNL   TSTSENSE       YES, HOPEFULLY BYPASS CCWTRANS   @VA06150 00398000
         B     CCWTR2         NO, DO CCW TRANS                 @VA03813 00399000
DASD3340 CLI   VDEVTYPE,TYP3340 3340?                          @VA03813 00400000
         BNE   DASD3350       NO, TRY 3350                     @VA05091 00401000
         CLI   RDEVFTR,FTR70MB 70 MB FEATURE?                  @VA03813 00402000
         BNE   FEATUR35       NO, TRY FEATURE 35 MB            @VA03813 00403000
         CLC   VDEVBND(2),=H'698' ALL CYLS USED                @VA03813 00404000
         BNL   TSTSENSE       YES, HOPEFULLY BYPASS CCWTRANS   @VA06150 00405000
         B     CCWTR2         NO, DO CCW TRANS                 @VA03813 00406000
FEATUR35 CLI   RDEVFTR,FTR35MB 35 MB FEATURE?                  @VA03813 00407000
         BNE   CCWTR2         NO, DO CCW TRANS                 @VA03813 00408000
         CLC   VDEVBND(2),=H'349' ALL CYLS USED?               @VA03813 00409000
         BNL   TSTSENSE       YES, HOPEFULLY BYPASS CCWTRANS   @VA06150 00410000
         B     CCWTR2         NO, DO CCW TRANS                 @VA03813 00411000
DASD3350 CLI   VDEVTYPE,TYP3350 3350?                          @VA05091 00412000
         BNE   DASD2314       NO, TRY 2314                     @VA05091 00413000
         CLC   VDEVBND(2),=H'555' ALL CYLS USED?               @VA05091 00414000
         BNL   TSTSENSE       YES, HOPEFULLY BYPASS CCWTRANS   @VA06150 00415000
         B     CCWTR2         NO, DO CCW TRANS                 @VA05091 00416000
DASD2314 CLI   VDEVTYPE,TYP2314 2314 OR 2319?                  @VA03813 00417000
         BNE   CCWTR2         NO, DO CCW TRANS                 @VA03813 00418000
         CLC   VDEVBND(2),=H'203' ALL CYLS USED?               @VA03813 00419000
         BL    CCWTR2         NO, MUST DO CCWTRANS             @VA06150 00420000
         DROP  R15                                             @VA04320 00421000
* OSTENSIBLY OK TO OMIT CCW-TRANSLATION:                                00422000
* NOTE:  R9 STILL POINTS TO THE CHANNEL PROGRAM                         00423000
TSTSENSE LA    R15,DMKVSISC   CALL SUBROUTINE TO "SCAN"        @VA04320 00424000
         BALR  R14,R15        CHANNEL PROGRAM                  @VA04320 00425000
         CL    R15,F10        CHECK FOR HIGH SEVERITY R.C.     @VA04320 00426000
         BH    CCWTR2         MUST CALL DMKCCW IF R.C. = 12    @VA04320 00427000
*                             RETURN-CODE = 0, 4, OR 8:                 00428000
         TM    VDEVFLAG,VDEVUC ANY VIRTUAL SENSE BYTES ?       @VA04320 00429000
         BZ    NOCCWTR2       IF NONE, NO TRANSLATION NEEDED.  @VA04320 00430000
         CL    R15,F4         YES - SEE IF R.C. = 0, 4, OR 8   @VA04320 00431000
         BE    CCWTR2         IF = 4, MUST CALL CCW TRANS      @VA04320 00432000
         BH    NOCCWTR2       IF = 8, NO CCW TRANS NEEDED      @VA04320 00433000
*                             FOR R.C. = 0, GET RID OF SENSE BYTES:     00434000
         LR    R3,R1          PRESERVE R1,                     @VA04320 00435000
         L     R1,VDEVIOER    POINT TO IOERBLOK,               @VA04320 00436000
         BAL   R2,IOERFRET    GIVE BACK SENSE BYTES,           @VA04320 00437000
         LR    R1,R3          RESTORE R1,                      @VA04320 00438000
         B     NOCCWTR2       AND BYPASS CCW-TRANSLATION       @VA04320 00439000
         SPACE 1                                                        00440000
.NOVR3   ANOP                                                           00441000
         EJECT                                                          00442000
CCWTR2   BAL   R9,GETLOCK     MUST HAVE THE SYSTEM LOCK        @VA08305 00443000
         ST    R11,IOBMISC    FLAG IOB AS PROCESSED BY CCWTRANS@VA08305 00444000
         LA    R9,0(,R2)      IOBCAW (LESS HIGH-ORDER BYTE) INTO R9,    00445000
         SL    R6,VMCHSTRT    MAKE R6 RELATIVE, CHAN. DISP     @VA03811 00446000
         SL    R7,VMCUSTRT    MAKE R7 RELATIVE, C.U. DISP      @VA03811 00447000
         SL    R8,VMDVSTRT    AND MAKE R8 "RELATIVE" FOR DMKCCW         00448000
         L     R1,DMKVSICW    GET TOTAL CCWTRANS CALL COUNT             00449000
         AL    R1,F1          BUMP                                      00450000
         ST    R1,DMKVSICW    AND SAVE                                  00451000
         CALL  DMKCCWTR            GO TRANSLATE THE CHANNEL PROGRAM     00452000
         AL    R6,VMCHSTRT    RESTORE VCHANNEL BLOCK ADDRESS   @VA03811 00453000
         AL    R7,VMCUSTRT    RESTORE VCONTROL UNIT ADDRESS    @VA03811 00454000
         AL    R8,VMDVSTRT    NOW LET R8 = A(VDEVBLOK) AGAIN            00455000
         TM    IOBSPEC2,IOBCLN CLEANUP JOB FOR CCWTR ??        @VA07728 00456000
         BZ    NOCCWTR2       NOPE, GOOD, BR.                  @V407438 00457000
* NOTE: R3 STILL POINTS TO AFFECTED SUBCHANNEL, R4 = 0 FOR STORECSW     00458000
         LA    R0,IOBSIZE     SIZE OF THE IOB                  @V407438 00459000
         LR    R1,R10         IOB ADDRESS TO R1                @V407438 00460000
         CALL  DMKFRET        THROW IT AWAY                    @V407438 00461000
         SLR   R10,R10        NO MORE IOB                      @V407438 00462000
         NI    VDEVSTAT,X'FF'-(VDEVBUSY+VDEVCHBS) UNFLAG DEVICE@V407438 00463000
         NI    VCHSTAT-VCHBLOK(R3),X'FF'-VCHBUSY UNFLAG SUBCHAN@V407438 00464000
         NI    VCUSTAT,X'FF'-VCUBUSY UNFLAG CTL UNIT           @V407438 00465000
         TM    VCHTYPE,VCHBMX BMX CHANNEL?                     @V407438 00466000
         BZ    REFBUSY        NOPE, BR.                        @V407438 00467000
         NI    VCUSTAT,X'FF'-VCUACTV UNFLAG CU                 @V407438 00468000
         B     REFBUSY        NOW GO REFLECT BUSY              @V407438 00469000
         SPACE                                                          00470000
NOCCWTR2 DS    0H             CONNECTOR                                 00471000
         TM    IOBFLAG,IOBRELCU C.U. RELEASED AT INIT. ??      @VA06371 00472000
         BZ    NORSTCUR       NO, FLAGS ALL SET                @VA06371 00473000
         NI    IOBFLAG,X'FF'-IOBRELCU RESET C.U. REL. FLAG     @VA06371 00474000
         NI    VCUSTAT,255-VCUBUSY TURN OFF CU BUSY            @VA08687 00475000
NORSTCUR EQU   *                                               @VA06371 00476000
         LTR   R1,R1               SHOULD DMKIOSQV BE CALLED??          00477000
         BNZ   VIOWAIT        YES, GO START REAL I/O                    00478000
         ST    R11,IOBUSER    OTHERWISE, SET UP OWNER OF I/O            00479000
         TM    IOBSTAT,IOBCC3 CC = 0 ?                         @VA04501 00480000
         BNZ   VIOGODSP       NO..DO NOT RUN OR (TRACE)        @VA04501 00481000
         B     VIOEXITX       AND LEAVE                        @VA08687 00482000
         EJECT                                                          00483000
VIOWAIT  EQU   *                                                        00484000
         OI    VMRSTAT,VMIOWAIT    PLACE USER IN IOWAIT                 00485000
         LA    R15,1          *    ADD 1 TO THE VIRTUAL START I/O COUNT 00486000
         AL    R15,VMIOCNT    *    FOR ACCOUNTING.                      00487000
         ST    R15,VMIOCNT    *                                         00488000
         CLI   VDEVTYPC,CLASSPEC SPECIAL DEVICE?               @VA04467 00489000
         BNE   VIOQREAL       NO...                            @VA04467 00490000
         BAL   R9,GETLOCK     MUST HAVE THE LOCK               @VA08305 00491000
         CLI   VDEVTYPE,TYPCTCA IS IT A VIRTUAL CTCA?          @VA04467 00492000
         BNE   VIOKNCP        NO...TEST FOR 3704/5             @VA04467 00493000
         TM    VDEVSTAT,VDEVDED    DEDICATED CHANNEL-TO-CHANNEL ?       00494000
         BO    VIOQREAL       YES - START REAL I/O OPERATION            00495000
         CALL  DMKVCAST       START I/O TO VIRTUAL CTCA        @VA01092 00496000
         B     VIOEXITY       DO NOT SET CHANNEL ACTIVE        @VA01092 00497000
         SPACE 4                                                        00498000
         USING IOERBLOK,R1                                     @VA03443 00499000
IOERFRET LA    R0,IOERSIZE    GET SIZE OF IOERBLOK             @VA03443 00500000
         AH    R0,IOEREXT     AND THE EXTRA (IF ANY)           @VA03443 00501000
         CALL  DMKFRET        AND RELEASE IT                   @VA03443 00502000
         SR    R1,R1          AND CLEAR                        @VA04320 00503000
         ST    R1,VDEVIOER    POINTER TO IOERBLOK              @VA04320 00504000
         NI    VDEVFLAG,255-VDEVUC RESET UNIT CHECK FLAG       @VA03443 00505000
         BR    R2             AND RETURN                       @VA03443 00506000
         DROP  R1             NO MORE IOERBLOK                          00507000
         EJECT                                                          00508000
VIOKNCP  EQU   *                                               @VA04467 00509000
         CLI   VDEVTYPE,TYP3705 IS THIS A 3704/5 CTLR?         @VA04467 00510000
         BNE   VIOQREAL       NO...NOTHING SPECIAL             @VA04467 00511000
         TM    VDEVINTS,ATTN  DID WE HIT THE TIMING WINDOW?    @VA04467 00512000
         BZ    VIOQREAL       NO...CONTINUE AS PLANNED         @VA04467 00513000
         MVI   IOBCSW+4,BUSY+ATTN BUSY FROM THE START I/O      @VA04467 00514000
         NI    VDEVINTS,X'FF'-ATTN RESET PENDING INTERRUPT     @VA04467 00515000
         GOTO  DMKVIOC1       GO SET CC = 1 AND STORE CSW      @VA05037 00516000
         SPACE                                                          00517000
VIOQREAL EQU   *                                                        00518000
         TM    VMINST+1,X'01'      MAYBE START I/O FAST RELEASE@VA01382 00519000
         BZ    IOSCALL             NO -- JUST CALL DMKIOSQV    @VA01382 00520000
         TM    VMTRCTL,VMTRSIO     TRACING START I/O ?         @VA01382 00521000
         BO    IOSCALL             YES - USE NORMAL PATH       @VA01382 00522000
         LA    R1,VMVCR0      CHECK FOR BLKMPX ENABLED         @VA01382 00523000
         TM    VMPSTAT,VMV370R     IS THERE AN ECBLOK ?        @VA01382 00524000
         BZ    *+8                 NO -- ALREADY HAVE CR0      @VA01382 00525000
         L     R1,VMECEXT     POINT TO EXTENDED CR0            @VA01382 00526000
         TM    0(R1),BLKMPX   BLOCK MULTIPLEXING ENABLED ?     @VA01382 00527000
         BNZ   NOWAIT         YES,SIOF                         @VA08305 00528000
         BAL   R9,GETLOCK     NO,MUST HAVE THE SYSTEM LOCK     @VA08305 00529000
         B     IOSCALL        NOW GO CALL IOS                  @VA08305 00530000
NOWAIT   EQU   *                                               @VA08305 00531000
         OI    IOBSPEC,IOBSIOF     START I/O FAST RELEASE      @VA01382 00532000
         NI    VMRSTAT,255-VMIOWAIT     LET THE USER RUN       @VA01382 00533000
         AIF (NOT &AP).APCHK4                                           00534000
         TM    APSTAT1,APUOPER RUNNING IN AP MODE?             @VA08305 00535000
         BNO   IOSCALL        NO,FOLLOW THE NORMAL PATH        @VA08305 00536000
         TM    APSTAT1,PROCIO IS THIS THE MAIN                 @VA08305 00537000
         BNO   SWITCH         NO,MUST EVENTUALLY SWITCH        @VA08305 00538000
         L     R15,=A(DMKLOKSY) POINT TO THE SYSTEM LOCK       @VA08305 00539000
         L     R15,0(R15)     PICK UP THE LOCK WORD            @VA08305 00540000
         LH    R1,LPUADDR     AND MY PROCESSOR ID              @VA08305 00541000
         CR    R1,R15         DO I HOLD IT?                    @VA08305 00542000
         BE    IOSCALL        YES,GO STRAIGHT TO IOS           @VA08305 00543000
         LTR   R15,R15        IS THE LOCK AVAILABLE?           @VA08305 00544000
         BNZ   SWITCH         DON'T WASTE TIME TRYING          @VA08305 00545000
         LOCK  OBTAIN,TYPE=SYS,SPIN=NO TRY FOR THE LOCK        @VA08305 00546000
         BZ    IOSCALL        GOT IT, GO TO IOS                @VA08305 00547000
SWITCH   STH   R13,VMACTDEV   SAVE VADDR FOR DMKTHI            @VA08305 00548000
         LH    R1,VCHADD      GET CHANNEL ADDRESS              @VA08305 00549000
*                             NOTE,IF HERE MUST BE DASD OR TAPE         00550000
         SRL   R1,7           TIMES 2                          @VA08305 00551000
         L     R15,=A(DMKVIOMK) GET ADDRESS OF MASK TABLE      @VA08305 00552000
         LH    R1,0(R1,R15)   GET APPROPRIATE MASK             @VA08305 00553000
         O     R1,VMIOACTV-2  ADD TO PRESENT ACTIVE MASK       @VA08305 00554000
         STH   R1,VMIOACTV    ...                              @VA08305 00555000
         LA    R0,CPEXSIZE    SIZE OF CPEXBLOK                 @VA08305 00556000
         CALL  DMKFREE        GO GET ONE                       @VA08305 00557000
         USING CPEXBLOK,R1                                     @VA08305 00558000
         LR    R2,R11         SAVE VMBLOK POINTER              @VA08305 00559000
         L     R11,ASYSVM     POINT TO SYSTEM VMBLOK           @VA08305 00560000
         STM   R0,R14,CPEXREGS SAVE ALL THE REGISTERS          @VA08305 00561000
         LA    R15,CALLIOS    RETURN ADDRESS AFTER UNSTACK     @VA08305 00562000
         ST    R15,CPEXADD    .....                            @VA08305 00563000
         DROP  R1                                              @VA08305 00564000
         LR    R11,R2         RESTORE R11                      @VA08305 00565000
         TM    APSTAT1,PROCIO IS THIS THE MAIN PROCESSOR?      @VA08305 00566000
         BNO   STACKOP        NO, STACK FOR THE MAIN           @VA08305 00567000
         CALL  DMKSTKMP       YES, STACK FOR THIS PROCESSOR    @VA08305 00568000
         B     VIOEXITY       NOW EXIT, CC=0 IS ALREADY SET    @VA08305 00569000
STACKOP  CALL  DMKSTKOP       STACK FOR OTHER PROCESSOR        @VA08305 00570000
         B     VIOEXITY       AND EXIT                         @VA08305 00571000
CALLIOS  CHARGE SWITCH,(R2)   START CHARGING ORIGINAL USER     @VA08305 00572000
         CALL  DMKIOSQV       NOW CALL IOS                     @VA08305 00573000
         CHARGE SWITCH,ASYSVM EXIT POINTING TO THE SYSTEM      @VA08305 00574000
         GOTO  DMKDSPCH       ALL DONE                         @VA08305 00575000
         SPACE                                                          00576000
.APCHK4  ANOP                                                           00577000
IOSCALL  EQU   *              SCHEDULE VIRTUAL MACHINE I/O     @VA01382 00578000
         CALL  DMKIOSQV       CALL TO EXECUTE I/O              @VA01092 00579000
         STH   R13,VMACTDEV   SAVE VADDR FOR DMKTHI            @VA05720 00580000
         TM    VDEVTYPC,CLASDASD+CLASTAPE+CLASTERM+CLASGRAF    @VA08600 00581000
         BZ    VIOEXITY       IF NEITHER, BRANCH               @VA05377 00582000
         LH    R1,VCHADD      GET CHANNEL ADDRESS                       00583000
         SRL   R1,7           TIMES 2                                   00584000
         L     R15,=A(DMKVIOMK) GET ADDRESS OF MASK TABLE      @VA05037 00585000
         LH    R1,0(R1,R15)   GET APPROPRIATE MASK             @VA05037 00586000
         O     R1,VMIOACTV-2  ADD TO PRESENT ACTIVE MASK                00587000
         STH   R1,VMIOACTV    ...                                       00588000
         B     VIOEXITY       AND LEAVE (NO V.M. TRACING DONE HERE).    00589000
         SPACE                                                          00590000
SIOCUE   EQU   *  HERE IF A CONTROL UNIT END INTERRUPT IS PENDING       00591000
         L     R5,=A(256*(SM+BUSY)) SET INTERRUPT STATUS FOR CSW        00592000
         NI    VCUINTS,X'FF'-CUE   CUE FOR ADDRESSED DEVICE - CLEAR CUE 00593000
         NI    VDEVSTAT,X'FF'-VDEVCUE FROM CU AND DEVICE BLOKS          00594000
         L     R5,=A(256*(CUE+BUSY))    SET CUE + BUSY INSTEAD          00595000
         B     STTOTCSW       AND GO STORE TOTAL CSW           @VA05104 00596000
         EJECT                                                          00597000
*.                                                                      00598000
*     B. VIRTUAL TIO SIMULATION -                                       00599000
*        1. IF ALL VBLOKS WERE NOT FOUND, SET VIRTUAL CONDITION         00600000
*           CODE 3 AND EXIT.                                            00601000
*        3. IF THE VIRTUAL SUBCHANNEL IS BUSY OR HAS AN INTERRUPT       00602000
*           PENDING FOR A DEVICE OTHER THAN THE ONE ADDRESSED, SET      00603000
*           VIRTUAL CONDITION CODE 2 AND EXIT.                          00604000
*        4. IF A CHANNEL END OR CUE IS PENDING FOR THE ADDRESSED        00605000
*           DEVICE, SET THE VIRTUAL CC = 1, CLEAR THE INTERRUPT,        00606000
*           AND STORE THE CSW.                                          00607000
*        5. IF THE CUE IS PENDING FOR A DEVICE OTHER THAN THE ONE       00608000
*           ADDRESSED, RETURN STATUS OF SM+BUSY, AND DO NOT CLEAR       00609000
*           THE INTERRUPT; SET CC= 1, AND EXIT.                         00610000
*        6. IF THERE ARE DEVICE CLASS INTERRUPTS PENDING, OR IF         00611000
*           THE DEVICE IS "RESERVED" BY ANOTHER USER, STORE THE         00612000
*           STATUS AND CLEAR THE INTERRUPTS; SET VIRTUAL CC = 1,        00613000
*           AND EXIT.                                                   00614000
*        7. IF NO STATUS IS PENDING ON THE ADDRESSED PATH,              00615000
*           AND THE DEVICE IS NOT VIRL SPOOL RDR, EXIT WITH CC=0        00616000
*        8. IF THE DEVICE IS A VIRTUAL CTCA, CALL DMKVCATS FOR          00617000
*           SIMULATION OF THE TEST I/O TO AN IDLE DEVICE.               00618000
*        9. IF THE DEVICE IS A DEDICATED CTCA, BUILD AN IOBLOK          00619000
*           TO SCHEDULE A REAL TEST I/O AND CALL DMKIOSQV TO PERFORM    00620000
*           THE NECESSARY INSTRUCTION.                                  00621000
*       10. FOR A VIRT READER DEVICE, SET CC=0 IF THE READER HAS        00622000
*           ACTIVE FILE. SET CC=1 IF THE RDR IS EMPTY ( DMKVSPTO IS     00623000
*           CALLED TO DECIDE IF THE READER IS EMPTY)                    00624000
*        (A CHANNEL-TO-CHANNEL ADAPTER MAY PRESENT CSW STATUS TO A      00625000
*         TEST I/O EVEN THOUGH THE DEVICE HAS NO ACTIVE COMMAND.)       00626000
*.                                                                      00627000
         SPACE                                                          00628000
VIOTIO   EQU   *                                                        00629000
         BAL   R9,GETLOCK     GO GET THE SYSTEM LOCK           @VA08305 00630000
         TM    VMINST+1,X'01' IS IT CLRIO?                     @V2B2638 00631000
         BO    CLRIO          YUP, BR                          @V2B2638 00632000
         AL    R1,DMKVSITI    ADD TIO COUNT TO INCREMENT       @V2B2638 00633000
         ST    R1,DMKVSITI    AND RE-STORE                     @V2B2638 00634000
         B     VIOTIO1        CONTINUE                         @V2B2638 00635000
         SPACE                                                          00636000
CLRIO    AL    R1,DMKVSICI    ADD CLRIO COUNT TO INCREMENT     @V2B2638 00637000
         ST    R1,DMKVSICI    AND RE-STORE                     @V2B2638 00638000
         SPACE                                                          00639000
VIOTIO1  EQU   *              HERE WHEN COUNTS ARE BUMPED      @V2B2638 00640000
         SPM   R0             RESTORE COND. CODE FROM DMKSCNVU          00641000
         BNZ   VIOEXIT        EXIT CC = 3 -- DEVICE NOT FOUND  @VA01527 00642000
         SPACE 2                                                        00643000
         BAL   R9,CHSCAN      TEST FOR CHANNEL BUSY OR CE PENDING       00644000
         BO    TIOCE          CHANNEL END PENDING -- REFLECT IT         00645000
         SPACE                                                          00646000
         BAL   R9,CUSCAN      TEST FOR C.U. BUSY OR CUE PENDING         00647000
         BO    TIOCUE         CONTROL UNIT END PENDING                  00648000
         SPACE                                                          00649000
         BAL   R9,DEVSCAN     TEST FOR DEVICE BUSY OR INTRPT PENDING    00650000
         EJECT                                                          00651000
*                                                                       00652000
*        HERE IF PATH TO DEVICE IS NOT BUSY AND NO                      00653000
*        INTERRUPTS ARE PENDING                                         00654000
*                                                                       00655000
         SPACE                                                          00656000
         TM    VDEVSTAT,VDEVNRDY   IS DEVICE READY ?                    00657000
         BZ    TIOCTCA        NO -- CHECK FOR VIRTUAL CHAN-TO-CHAN      00658000
         LA    R5,UC*256      SET UNIT CHECK STATUS,                    00659000
         B     STORECSW       AND GO STORE THE CSW BYTES 4 AND 5        00660000
         SPACE 2                                                        00661000
TIOCTCA  EQU   *              TEST FOR DEDICATED DEVICES       @VA00398 00662000
         LA    R3,IOBTIO      INDICATE A TIO                   @VA00398 00663000
         TM    VDEVSTAT,VDEVDED    DEDICATED CHANNEL-TO-CHANNEL ?       00664000
         BO    CTCAIOB        YES - BUILD IOBLOK TO SCHEDULE THE 'TIO'  00665000
         TM    VCUTYPE,VCUCTCA MIGHT THIS BE VIRTUAL CTCA ?    @VA00398 00666000
         BZ    TIORDR         NO- GO CHECK SEE IF IT IS READER @VA03503 00667000
         CALL  DMKVCATS       TIO TO VIRTUAL CTCA                       00668000
         BNZ   STORECSW       CC NON-ZERO => CSW STORED                 00669000
         B     VIOEXITX       EXIT, CC = 0                              00670000
TIORDR   EQU   *                                               @VA03503 00671000
         CLI   VDEVTYPC,CLASURI IS IT RDR DEVICE?              @VA03503 00672000
         BNE   VIOEXITX       NO- EXIT WITH CC=0               @VA03503 00673000
         TM    VDEVTYPE,TYPRDR CARD READER TYPE UR INPUT?      @VA04204 00674000
         BZ    VIOEXITX       NOPE, EXIT FORTHWITH             @VA04204 00675000
         L     R9,VDEVSPL     GET SPOOL CONTROL BLOK           @VA03503 00676000
         LTR   R9,R9          ANY ACTIVE FILE?                 @VA03503 00677000
         BNZ   VIOEXITX       YES--EXIT WITH CC =0             @VA03503 00678000
         CALL  DMKVSPTO       VSP WILL DO THE FILE SEARCH      @VA03503 00679000
         BNZ   VIOEXITX       FILE FOUND--EXIT WITH CC=0       @VA03503 00680000
         LA    R5,UC*256      EMPTY RDR--SET UC STATUS         @VA03503 00681000
         B     STORECSW       GO STORE CSW                     @VA03503 00682000
TIOCE    EQU   *  HERE IF CE IS PENDING                                 00683000
         TM    VDEVSTAT,VDEVCHAN   CE PENDING FOR ADDRESSED DEVICE?     00684000
         BO    TIOCEPND       YES...                                    00685000
         LA    R2,X'20'            NO -- EXIT WITH CC OF 2              00686000
         B     VIOEXIT                                                  00687000
         SPACE 2                                                        00688000
TIOCEPND EQU   *                                                        00689000
         NI    VCHSTAT-VCHBLOK(R3),X'FF'-VCHCEPND CLEAR PENDING         00690000
         NI    VDEVSTAT,X'FF'-VDEVCHAN AND FROM DEVICE                  00691000
         LM    R4,R5,VDEVCSW  PICK UP THE CSW FROM THE DEVICE           00692000
         NI    VDEVCSW+5,X'FF'-PCI REMOVE PCI                           00693000
         B     STORECSW            AND GO STORE CSW                     00694000
         SPACE 3                                                        00695000
TIOCUE   EQU   *  HERE IF A CUE IS PENDING                              00696000
         TM    VDEVSTAT,VDEVCUE    IS CUE PENDING FOR ADDRESSED DEVICE? 00697000
         BZ    SETSM               NO --                                00698000
         NI    VCUINTS,X'FF'-CUE   CLEAR INTERRUPT FROM CU              00699000
         NI    VDEVSTAT,X'FF'-VDEVCUE AND DEVICE                        00700000
         L     R5,=A(CUE*256) SET CSW STATUS                            00701000
         B     STTOTCSW       AND GO STORE TOTAL CSW           @VA05104 00702000
         SPACE 2                                                        00703000
SETSM    L     R5,=A(256*(SM+BUSY)) SET CSW STATUS                      00704000
         B     STTOTCSW       AND GO STORE TOTAL CSW           @VA05104 00705000
         EJECT                                                          00706000
*.                                                                      00707000
*     C. VIRTUAL TCH SIMULATION -                                       00708000
*        1. IF A VIRTUAL CHANNEL BLOK WAS NOT FOUND, RETURN VIRTUAL     00709000
*           CONDITION CODE 3.                                           00710000
*        3. IF THE ADDRESSED CHANNEL IS NOT A SELECTOR, RETURN          00711000
*           VIRTUAL CONDITION CODE 0; MPX AND BMPX ARE NEVER BUSY.      00712000
*        4. IF THE ADDRESSED CHANNEL IS BUSY, SET VIRTUAL CONDITION     00713000
*           CODE 2 AND EXIT.                                            00714000
*        5. IF THE ADDRESSED CHANNEL HAS A CHANNEL CLASS INTERRUPT      00715000
*           PENDING, SET CC = 1 AND EXIT.                               00716000
*        6. IF THE CHANNEL IS FREE, EXIT.                               00717000
*.                                                                      00718000
         SPACE                                                          00719000
VIOTCH   EQU   *                                                        00720000
         AL    R1,DMKVSITC    ADD TCH COUNT TO INCREMENT       @V2B2638 00721000
         ST    R1,DMKVSITC    AND RE-STORE                     @V2B2638 00722000
         SPM   R0             RESTORE COND. CODE FROM DMKSCNVU          00723000
         BC    4,VIOEXIT      EXIT CC = 3 IF VCHBLOK NOT FOUND @VA01527 00724000
         SPACE                                                          00725000
VIOTCH2  CLI   VCHTYPE,VCHSEL IS IT A SELECTOR CHANNEL?        @VMD0117 00726000
         BNE   VIOEXITX       NO - TREAT BMX/MPX AS NEVER BUSY @VA01771 00727000
         SPACE                                                          00728000
         BAL   R9,CHSCAN      TEST FOR CHANNEL BUSY OR CE PENDING       00729000
         BZ    VIOEXITX       NOPE - EXIT WITH CC = 0                   00730000
         LA    R2,X'10'       CE IS PENDING - SET CC = 1                00731000
         B     VIOEXIT             AND EXIT                             00732000
         EJECT                                                          00733000
*                                                                       00734000
*     D. VIRTUAL CLCH SIMULATION -                                      00735000
*                                                                       00736000
*        1. IF A NECESSARY CONTROL BLOCK WAS NOT FOUND, RETURN VIRTUAL  00737000
*           CONDITION CODE 3.                                           00738000
*                                                                       00739000
*        2. IF CHANNEL IS DEDICATED:                                    00740000
*              - ISSUE CLCH INSTRUCTION,                                00741000
*              - RECORD THE CLCH INFORMATION IN THE NEXT TRACE TABLE    00742000
*                ENTRY,                                                 00743000
*              - SET C.C. IN VIRTUAL PSW.                               00744000
*                                                                       00745000
*        3. IF CHANNEL IS NOT DEDICATED, SIMULATE CLCH AS A TCH.        00746000
*           (SEE TCH SIMULATION DESCRIPTION ABOVE.)                     00747000
*                                                                       00748000
VIOCLCH  DS    0H                                              @VMD0117 00749000
         AL    R1,DMKVSICC    ADD CLCH COUNT TO INCREMENT      @VMD0117 00750000
         ST    R1,DMKVSICC    STORE CLEAR CHANNEL COUNT        @VMD0117 00751000
         SPM   R0             RESTORE COND. CODE FROM DMKSCNVU @VMD0117 00752000
         BC    4,VIOEXIT      SET CC = 3. (DMKSCNVU RETURNS    @VA07864 00753000
*                             A CC OF 1 WHEN THE VCHBLOK WAS            00754000
*                             NOT FOUND)                                00755000
         TM    VCHSTAT,VCHDED IS CHANNEL DEDICATED?            @VA07864 00756000
         BNO   VIOTCH2        NO, TREAT CLCH AS A TCH          @VMD0117 00757000
EXCLCH   EX    R0,VMINST      EXECUTE THE CLCH INSTRUCTION     @VMD0117 00758000
         AIF   (NOT &TRACE(9)).NTCLCH1                          **AIF** 00759000
         BALR  R0,0           PERSERVE C.C. FROM CLCH INSTR.   @VMD0117 00760000
CCTRACE  DS    0H                                              @VMD0117 00761000
         TRACE CODE=TRCCLCH,R14,R1,R2 GET A TRACE ENTRY        @VMD0117 00762000
         STCM  R0,8,1(R14) MOVE IN CONDITION CODE              @VMD0117 00763000
         NI    1(R14),X'30' LEAVE ONLY THE CONDITION CODE      @VMD0117 00764000
         STH   R13,2(0,R14)   STORE DEVICE ADDR IN TRACE ENTRY @VMD0117 00765000
         ST    R11,4(,R14)    STORE VMBLOK POINTER             @VMD0117 00766000
         MVC   8(8,R14),VDEVCSW STORE VIRTUAL CSW              @VMD0117 00767000
         SPM   R0             RESTORE COND. CODE FROM CLCH     @VMD0117 00768000
.NTCLCH1 ANOP                                                           00769000
         BZ    VIOEXITX       CLCH WAS PERFORMED               @VMD0117 00770000
         LA    R2,X'10'       INDICATE CC SHOULD BE SET TO 1   @VMD0117 00771000
         BC    4,VIOEXIT      CC 1 IS MEANINGLESS FOR A CLCH   @VMD0117 00772000
         LA    R2,X'20'       INDICATE CC SHOULD BE SET TO 2   @VMD0117 00773000
         BC    2,VIOEXIT      CHANNEL IS BUSY                  @VMD0117 00774000
         LA    R2,X'30'       INDICATE CC SHOULD BE SET TO 3   @VMD0117 00775000
         B     VIOEXIT        CHANNEL IS NOT OPERATIONAL       @VMD0117 00776000
         EJECT                                                          00777000
*.                                                                      00778000
*     E. VIRTUAL HIO SIMULATION -                                       00779000
*        1. IF ALL VBLOKS WERE NOT FOUND, SET VIRTUAL CONDITION         00780000
*           CODE = 3 AND EXIT.                                          00781000
*        3. IF A VIRTUAL CHANNEL END IS PENDING, EXIT WITH CC = 0       00782000
*        4. IF THE CONTROL UNIT OR DEVICE IS BUSY, STORE CSW            00783000
*           STATUS OF ZERO, SET CC = 1, AND EXIT.                       00784000
*        5. IF THE VIRTUAL CU IS BUSY, STORE SM+BUSY, SET CC = 1,       00785000
*           AND EXIT.                                                   00786000
*        6. IF THE VIRTUAL SUBCHANNEL IS MARKED BUSY FOR A NON-TP       00787000
*           DEVICE, DO A REAL "HIO" AND RETURN THE CSW STATUS AND       00788000
*           COND. CODE TO THE USER; IF THE BUSY DEVICE IS A VIRTUAL     00789000
*           ENABLED 270X LINE THAT HAS NOT YET BEEN DIALED, UNCHAIN     00790000
*           THE IOBLOK,AND CALL DMKSTKIO TO REFLECT A CE-DE-UE TO       00791000
*           THE CALLER.                                                 00792000
*        7. IF THE DEVICE IS A VIRTUAL CTCA, CALL DMKVCASH TO           00793000
*           PERFORM THE NECESSARY SIMULATION OF THE HALT I/O.           00794000
*        8. IF THE DEVICE IS A DEDICATED CTCA, BUILD AN IOBLOK          00795000
*           AND SCHEDULE A REAL HALT I/O VIA A CALL TO DMKIOSQV.        00796000
*        (A REAL HALT I/O MUST BE PERFORMED EVEN IF THE DEVICE IS IDLE  00797000
*         SINCE IT IS USED TO TERMINATE THE Y-SIDE CHANNEL PROGRAM.)    00798000
*.                                                                      00799000
         SPACE                                                          00800000
VIOHIO   EQU   *                                                        00801000
         BAL   R9,GETLOCK     GO GET THE SYSTEM LOCK           @VA08305 00802000
         TM    VMINST+1,X'01' IS IT HDV?                       @V2B2638 00803000
         BO    VIOHDV         YUP, BR                          @V2B2638 00804000
         AL    R1,DMKVSIHI    ADD HIO COUNT TO INCREMENT       @V2B2638 00805000
         ST    R1,DMKVSIHI    AND RE-STORE                     @V2B2638 00806000
         B     VIOHIO1        CONTINUE                         @V2B2638 00807000
         SPACE                                                          00808000
VIOHDV   AL    R1,DMKVSIHD    ADD HDV COUNT TO INCREMENT       @V2B2638 00809000
         ST    R1,DMKVSIHD    AND RE-STORE                     @V2B2638 00810000
         SPACE                                                          00811000
VIOHIO1  EQU   *              HERE WHEN COUNTS ARE BUMPED      @V2B2638 00812000
         SPM   R0             RESTORE COND. CODE FROM DMKSCNVU          00813000
         BNZ   VIOEXIT        EXIT CC = 3 -- DEVICE NOT FOUND  @VA01527 00814000
         SPACE                                                          00815000
         LR    R3,R6               POINT TO VCHBLOK                     00816000
         TM    VCHTYPE,VCHSEL SELECTOR CHANNEL?                @VA03072 00817000
         BNZ   HIOCHAN                  YES ---                @VA01771 00818000
         LR    R3,R7               NO -- POINT TO VCUBLOK               00819000
         TM    VCUTYPE,VCUSHRD+VCUCTCA  SHARED SUB-CHANNEL ?            00820000
         BNZ   HIOCHAN                  YES ---                @VA01771 00821000
         LR    R3,R8               NO -- POINT TO VDEVBLOK              00822000
HIOCHAN  EQU   *              TEST FOR SUB-CHANNEL BUSY        @VA01771 00823000
         TM    VCHSTAT-VCHBLOK(R3),VCHBUSY TEST STATUS OF SUBCHANNEL    00824000
         BO    REALHIO             CHANNEL IS BUSY - GO DO REAL HIO     00825000
         TM    VCHSTAT-VCHBLOK(R3),VCHCEPND IS CHANNEL END PENDING?     00826000
         BO    VIOEXITX            CE PENDING -- EXIT WITH CC = 0       00827000
         TM    VCUSTAT,VCUBUSY     IS THE CU BUSY ??                    00828000
         BO    VIRHIO              YES -- GO DO VIRTUAL HIO             00829000
         TM    VCUINTS,CUE         IS A CUE PENDING ??                  00830000
         BO    HIOCUE              YES --                               00831000
         EJECT                                                          00832000
*                                                                       00833000
*        VIRTUAL HIO TO DEVICE                                          00834000
*                                                                       00835000
VIRHIO   SR    R5,R5               ZERO STATUS                          00836000
         CLI   VDEVTYPC,CLASSPEC   SPECIAL CLASS DEVICE?       @VA04040 00837000
         BNE   STORECSW       NOPE - STORE THE CSW             @VA04040 00838000
         LA    R3,IOBHIO      IF DEDICATED ADAPTER, THIS IS A HALT I/O  00839000
         TM    VDEVSTAT,VDEVDED    DEDICATED CHANNEL-TO-CHANNEL ?       00840000
         BO    CTCAIOB        YES - BUILD IOBLOK TO SCHEDULE THE 'HIO'  00841000
VCTCHIO  EQU   *              SIMULATE HIO TO VIRTUAL CTCA              00842000
         LR    R1,R13         CTCA ADDRESS TO R1                        00843000
         CALL  DMKVCASH       ...                                       00844000
         BNZ   STORECSW       CC NON-ZERO => CSW STORED                 00845000
         B     VIOEXITX       EXIT WITH CC = 0                          00846000
         SPACE                                                          00847000
HIOCUE   EQU   *  HERE IF CUE IS PENDING                                00848000
         TM    VDEVSTAT,VDEVCUE    IS IT FOR THE ADDRESSED DEVICE       00849000
         BO    VIRHIO              YES -- DO VIRTUAL HIO                00850000
         L     R5,=A(256*(SM+BUSY)) CAN'T DO HIO IF CU OCCUPIED         00851000
         B     STORECSW       STORE AND EXIT                            00852000
         SPACE                                                          00853000
REALHIO  EQU   *  HERE TO DO A REAL HIO                                 00854000
         TM    VDEVTYPC,CLASTERM+CLASSPEC    IS IT A LINE OR A CTCA ?   00855000
         BZ    HIO                           NO -- DO REAL HIO          00856000
         TM    VDEVSTAT,VDEVDED    IS IT A DEDICATED LINE ??            00857000
         BO    HIO                 YES - DO HIO                         00858000
         CLI   VDEVTYPC,CLASTERM   IS THIS A DIALED LINE ?              00859000
         BE    DIALHIO        YES - SIMULATE HIO                        00860000
         CLI   VDEVTYPE,TYPCTCA    IS THIS VIRTUAL CTCA ?               00861000
         BE    VCTCHIO             YES -- SIMULATE HIO                  00862000
         B     HIO            OTHERWISE, DO REAL HIO                    00863000
         SPACE                                                          00864000
DIALHIO  EQU   *              SIMULATE HIO FOR DIALED LINES             00865000
         SLR   R5,R5          SET CSW STATUS ZERO              @VA01527 00866000
         TM    VDEVFLAG,VDEVENAB ENABLED NOW?                  @VA01527 00867000
         BZ    STORECSW       N0...GIVE CC=1                   @VA01527 00868000
         TM    VDEVFLAG,VDEVDIAL IN DIAL PROCESS NOW?          @VA01527 00869000
         BO    VIOEXITX       YES....EXIT CC=0                 @VA01527 00870000
         NI    VDEVFLAG,255-VDEVENAB HAS BEEN HALTED           @VA01527 00871000
         L     R10,VDEVIOB    R10 = ENABLE IOBLOK              @VA01527 00872000
         L     R1,IOBRCAW     ADDRESS OF ENABLE CCW            @VA01527 00873000
         MVC   IOBCSW+6(2),6(R1) RESIDUAL COUNT                @VA01527 00874000
         LA    R1,8(0,R1)     THE ONE THAT WAS ACTIVE          @VA01527 00875000
         ICM   R1,8,IOBRCAW   RESTORE CAW KEY                  @VA01527 00876000
         ST    R1,IOBCSW      SET AS CSW ADDRESS               @VA01527 00877000
         LA    R1,(CE+DE+UE)*256 CSW STATUS                    @VA01527 00878000
         STH   R1,IOBCSW+4    . . .                            @VA01527 00879000
         CALL  DMKSTKIO                                        @VA01527 00880000
         B     STORECSW       GIVE CC=1 TO HIO                 @VA01527 00881000
         EJECT                                                          00882000
HIO      EQU   *  HERE TO DO REAL LIVE HIO                              00883000
         SWITCH         MAKE SURE WE ARE ON THE IO PROCESSOR   @V4075A0 00884000
         L     R3,VDEVREAL         GET POINTER TO REAL DEVICE BLOK      00885000
         L     R10,RDEVAIOB-RDEVBLOK(R3) GET POINTER TO ACTIVE IOBLOK   00886000
         LTR   R10,R10             IS THERE ONE ??                      00887000
         BZ    VIOEXITX            NO --                                00888000
         CL    R10,VDEVIOB    IS IT THE CURRENT OPERATION?     @VA03436 00889000
         BNE   VIOEXITX       NO--EXIT                         @VA03436 00890000
         LH    R1,VCHADD      GET CHANNEL ADDRESS                       00891000
         SRL   R1,7           TIMES 2                                   00892000
         L     R15,=A(DMKVIOXK)    ADDRESS THE MASK TABLE      @VA05037 00893000
         LH    R1,0(R1,R15)   PICK UP "TURN-OFF" MASK          @VA05037 00894000
         N     R1,VMIOACTV-2  TURN OFF PREVIOUSLY ACTIVE CHANNEL        00895000
         STH   R1,VMIOACTV    ...                                       00896000
         TM    VCHTYPE,VCHBMX BMX CHANNEL?                     @VA03150 00897000
         BNO   *+8            NO, SKIP CALL TO SCAN            @VA03150 00898000
         BAL   R14,SCANALL    ANYTHING ELSE GOING ON ?         @VA03150 00899000
         LH    R5,IOBRADD          GET REAL DEVICE ADDRESS              00900000
         HDV   0(R5)          HALT THE I/O                     @VA03436 00901000
         AIF   (NOT &TRACE(9)).NTR1                            @VA03431 00902000
         BAL   R15,HIOTRACE   TRACE HALT I/O                   @VA03431 00903000
         DC    X'0F00'        TRACE ENTRY FLAG                 @VA03431 00904000
.NTR1    ANOP                                                           00905000
         BZ    VIOEXITX       CC = 0, INTERRUPT PENDING                 00906000
         BC    4,HIOSTCSW     CC = 1, CSW STORED                        00907000
         LA    R2,X'20'            SET CC = 2                           00908000
         BC    2,VIOEXIT      IT WAS CC 2 -- EXIT                       00909000
         LA    R2,X'30'       SET CC 3                                  00910000
         B     VIOEXIT             AND LEAVE                            00911000
         SPACE                                                          00912000
HIOSTCSW EQU   *  HERE WHEN CSW IS STORED BY REAL HIO                   00913000
         LH    R5,CSW+4       GET STATUS FROM REAL CSW                  00914000
         B     STORECSW       AND GO STORE IN VIRTUAL CSW               00915000
         SPACE                                                          00916000
CTCAIOB  EQU   *                                               @VA08496 00917000
         OI    VMRSTAT,VMIOWAIT PUT VIRTUAL MACHINE IN IOWAIT  @VA08496 00918000
         LA    R0,IOBSIZE     GET FREE STORAGE FOR AN IOBLOK            00919000
         CALL  DMKFREE        ...                                       00920000
         LR    R10,R1         ADDRESS VIA GR10                          00921000
         USING IOBLOK,R10                                               00922000
         XC    IOBLOK(IOBSIZE*8),IOBLOK CLEAR ENTIRE BLOCK              00923000
*                             (NOTE:  "IOBLINK" FILLED IN BY DMKIOSQV)  00924000
         STH   R13,IOBVADD         SET VIRTUAL DEVICE ADDRESS           00925000
         L     R1,=A(DMKVIOIN)     SET INTERRUPT RETURN                 00926000
         ST    R1,IOBIRA           ...                                  00927000
         ST    R10,VDEVIOB         SAVE ACTIVE IOBLOK ADDRESS           00928000
         STC   R3,IOBSPEC     SET 'IOBTIO' OR 'IOBHIO' FLAG             00929000
         OI    VDEVSTAT,VDEVBUSY   MARK THE DEVICE TEMPORARILY BUSY     00930000
         CALL  DMKIOSQV       SCHEDULE THE TEST I/O OR HALT I/O         00931000
         B     VIOEXITY            EXIT - NO TRACING YET                00932000
         SPACE 1                                                        00933000
* CHECK FOR HALT I/O TRACE TABLE ENTRY                                  00934000
         AIF   (NOT &TRACE(9)).NTR2                            @VA03431 00935000
HIOTRACE EQU   *              CP TRACE TABLE ENTRY FOR HIO     @VA03431 00936000
         TM    TRACFLG2,TRACBEF I/O TRACING ACTIVE?            @VA03431 00937000
         BZ    HIONOTRC       NO -- RESTORE CC AND RETURN      @VA03431 00938000
         TRACE CODE=TRCHALT,R14,R1,R2                          @V4075A0 00939000
         STCM  R15,8,1(R14)   MOVE IN COND CODE                @VA03431 00940000
         NI    1(R14),X'30'   . . . AND ONLY THE COND CODE     @VA03431 00941000
         STH   R5,2(0,R14)    SAVE THE REAL DEVICE ADDRESS     @VA03431 00942000
         ST    R10,4(0,R14)   IOBLOK ADDRESS, IF ANY           @VA03431 00943000
         MVC   8(4,R14),CAW   CHANNEL ADDRESS WORD             @VA03431 00944000
         XC    12(4,R14),12(R14) CLEAR LAST WORD               @VA03431 00945000
         CLI   1(R14),X'10'   CONDITION CODE ONE?              @VA03431 00946000
         BNE   *+10           NO -- DO NOT MOVE IN CSW         @VA03431 00947000
         MVC   12(4,R14),CSW+4 MOVE IN CSW STATUS              @VA03431 00948000
HIONOTRC EQU   *              RESTORE COND CODE, RETURN        @VA03431 00949000
         SPM   R15            RESET COND CODE                  @VA03431 00950000
         B     2(0,R15)       SKIP OVER TRACE FLAG ON RETURN   @VA03431 00951000
.NTR2    ANOP                                                           00952000
         EJECT                                                          00953000
SCANALL  STM   R7,R8,TEMPSAVE SAVE THESE REGS                  @VA03150 00954000
         NI    VCUSTAT,255-VCUACTV RESET CU ACTIVE FLAG        @VA03150 00955000
         LA    R4,2           LOAD INDEX INCREMENT             @VA03150 00956000
         LA    R5,30          LOAD INDEX COMPARAND VALUE       @VA03150 00957000
         SR    R3,R3          ZERO VCUDVTBL INDEX              @VA03150 00958000
RESNDV   LH    R8,VCUDVTBL(R3) LOAD NEXT VDEVBLOK INDEX        @VA03150 00959000
         LTR   R8,R8          DOES DEVICE EXIST ?              @VA03150 00960000
         BM    RESXDV         NO, INDEX TO NEXT ONE            @VA03150 00961000
         A     R8,VMDVSTRT    POINT TO VDEVBLOK                @VA03150 00962000
         TM    VDEVSTAT,VDEVBUSY IS DEVICE BUSY ?              @VA03150 00963000
         BNO   RESXDV         NO, INDEX TO NEXT ONE            @VA03150 00964000
         TM    VDEVTYPC,CLASTERM IS THIS A TERMINAL?           @VA03150 00965000
         BO    RESXDV         YES, SKIP IT AND CHECK NEXT DEV  @VA03150 00966000
         OI    VCUSTAT,VCUACTV C U STILL ACTIVE THEN           @VA03150 00967000
REACTIVE LH    R1,VCHADD      GET CHANNEL ADDRESS              @VA03150 00968000
         SRL   R1,7           TIMES 2                          @VA03150 00969000
         L     R15,=A(DMKVIOMK)    ADDRESS THE MASK TABLE      @VA05037 00970000
         LH    R1,0(R1,R15)   PICK UP "TURN-ON" MASK           @VA05037 00971000
         O     R1,VMIOACTV-2  ADD IT BACK                      @VA03150 00972000
         STH   R1,VMIOACTV    CHANNEL STILL ACTIVE             @VA03150 00973000
         LM    R7,R8,TEMPSAVE RESTORE REGS                     @VA03150 00974000
         SR    R4,R4          CLEAR REG BEFORE RETURN          @VA07336 00975000
         BR    R14            RETURN                           @VA03150 00976000
RESNCU   LH    R7,VCHCUTBL(R2) LOAD NEXT VCUBLOK INDEX         @VA03150 00977000
         LTR   R7,R7          DOES C U EXIST ?                 @VA03150 00978000
         BM    RESXCU         NO - GET NEXT ONE                @VA03150 00979000
         A     R7,VMCUSTRT    POINT TO VCUBLOK                 @VA03150 00980000
         TM    VCUSTAT,VCUACTV IS C U ACTIVE ?                 @VA03150 00981000
         BO    REACTIVE       RESET CHANNEL ACTIVE             @VA03150 00982000
         B     RESXCU         CONTINUE WITH NEXT CU            @VA03150 00983000
RESXDV   BXLE  R3,R4,RESNDV   BRANCH IF MORE DEVICES ON C U    @VA03150 00984000
         SR    R2,R2          ZERO VCHCUTBL INDEX              @VA03150 00985000
RESXCU   BXLE  R2,R4,RESNCU   BRANCH IF MORE CONTROL UNITS     @VA03150 00986000
         LM    R7,R8,TEMPSAVE RESTORE REGS                     @VA03150 00987000
         SR    R4,R4          CLEAR REG BEFORE RETURN          @VA07336 00988000
         BR    R14            RETURN                           @VA03150 00989000
         EJECT                                                          00990000
*        COMMON SUBROUTINES USED BY VIOSIO, VIOTIO, VIOTCH, AND VIOHIO  00991000
         SPACE 2                                                        00992000
CHSCAN   EQU   *  HERE TO TEST FOR CHANNEL BUSY OR CE PENDING  %V386198 00993000
         LR    R3,R6          SAVE POINTER TO CHANNEL BLOK     %V386198 00994000
         TM    VCHTYPE,VCHSEL SELECTOR CHANNEL ?               %VA01771 00995000
         BO    CHTEST         YES                              %VA01771 00996000
         LR    R3,R7          SAVE ADDRESS OF VCUBLOK          %V386198 00997000
         TM    VCUTYPE,VCUSHRD+VCUCTCA  SHARED SUB-CHANNEL ?   %V386198 00998000
         BNZ   CHTEST         YES..                            %V386198 00999000
         LR    R3,R8          CHANNEL STATUS IN DEVICE BLOK    %V386198 01000000
         SPACE                                                          01001000
CHTEST   TM    VCHSTAT-VCHBLOK(R3),VCHBUSY IS SUBCHANNEL BUSY? %V386198 01002000
         BZ    TESTCE              NO --                       %V386198 01003000
         LA    R2,X'20'            SET CONDITION CODE 2                 01004000
         CLI   VMINST,X'9D'   PREVENT TIO BUSY LOOPS                    01005000
         BNE   VIOEXIT        NOT A TIO - EXIT                          01006000
         TM    VDEVSTAT,VDEVBUSY   DEVICE BUSY ??                       01007000
         BZ    VIOEXIT        NO -- RETURN                              01008000
         LA    R3,CLASSPEC*256+TYPCTCA VIRTUAL CTCA            @VM01091 01009000
         CH    R3,VDEVTYPC    IS THIS A CHAN-CHAN ADAPT.       @VM01091 01010000
         BE    CALLSCH        YES - CALL SCHEDULAR             @VM01091 01011000
         CLI   VDEVTYPC,CLASTERM TERMINAL CLASS ?              @VM01091 01012000
         BNE   IDLETIO        NO - IN IDLE TIO LOOP            @VM01091 01013000
         TM    VDEVSTAT,VDEVDED DEDICATED DEVICE ?             @VM01091 01014000
         BO    CALLSCH        YES - CALL SCHEDULAR             @VM01091 01015000
         TM    VDEVFLAG,VDEVENAB VIRTUAL 2702 LINE ?           @VM01091 01016000
         BZ    IDLETIO        NO - IN IDLE TIO LOOP            @VM01091 01017000
         BAL   R3,DROPUSER    PUT USER IN IDLE STATUS          @VM01091 01018000
         B     SETSM          SET UP CSW                       @VM01091 01019000
CALLSCH  BAL   R3,DROPUSER    PUT USER IN IDLE STATUS          @VM01091 01020000
         B     VIOEXIT        AND EXIT                         @VM01091 01021000
IDLETIO  OI    VMDSTAT,VMTIO  FLAG USER IN TIO BUSY LOOP       @VM01091 01022000
         B     VIOEXIT        AND EXIT                         @VM01091 01023000
DROPUSER OI    VMRSTAT,VMIDLE INDICATE IDLE STATUS             @VM01091 01024000
         CALL  DMKSCHDL       ALTER USER DISPATCHING STATUS    @VM01091 01025000
         BR    R3             RETURN TO CALLER                 @VM01091 01026000
         SPACE                                                          01027000
TESTCE   TM    VCHSTAT-VCHBLOK(R3),VCHCEPND CE PENDING ??      %V386198 01028000
         BR    R9             RETURN TO CALLER WITH CC INTACT  %V386198 01029000
         SPACE 3                                                        01030000
CUSCAN   EQU   *  HERE TO TEST FOR CU BUSY OR CUE PENDING      %V386198 01031000
         TM    VCUSTAT,VCUBUSY   IS THE CONTROL UNIT BUSY?     %V386198 01032000
         BZ    CUFREE         NO --                            %V386198 01033000
         OI    VCUSTAT,VCUCUEPN    FLAG CUE REQUESTED                   01034000
         L     R5,=A(256*(SM+BUSY)) SET CSW STATUS                      01035000
         B     STTOTCSW       STORE AND EXIT                   @VA05104 01036000
         SPACE 2                                                        01037000
CUFREE   TM    VCUINTS,CUE    TEST FOR CUE PENDING             %V386198 01038000
         BR    R9             RETURN WITH CONDITION CODE SET   %V386198 01039000
         EJECT                                                          01040000
DEVSCAN  EQU   *  HERE TO TEST FOR DEVICE BUSY OR INTS PENDING %V386198 01041000
         TM    VDEVSTAT,VDEVBUSY   IS THE DEVICE BUSY ??       %V386198 01042000
         BZ    CKINTS         NO --                            %V386198 01043000
         L     R5,=A(256*BUSY)     SET BUSY STATUS                      01044000
         B     STTOTCSW       AND EXIT                         @VA05104 01045000
         SPACE                                                          01046000
CKINTS   LH    R5,VDEVINTS    GET DEVICE INTERRUPTS            %V386198 01047000
         LTR   R5,R5          ANYTHING PENDING ??              %V386198 01048000
         BNZ   PNDINT         PENDING INTERRUPT, BR.           %V407438 01049000
         TM    VDEVFLG2,VDEVRRF MDISK WITH RES/REL FEATURE?    %V407438 01050000
         BZR   R9             NOPE, NO VIRT RES/REL TODAY      %V407438 01051000
         L     R2,VDEVRRB     GET THE VRRBLOK ADDRESS          @V407438 01052000
         USING VRRBLOK,R2     ADDRESS THE VRRBLOK              @V407438 01053000
         TM    VRRSTAT,VRRRES IS THE MDISK RESERVED NOW?       @V407438 01054000
         BZR   R9             NOPE, FREE PATH, BR.             @V407438 01055000
         TM    VDEVFLG2,VDEVRES RESERVED BY THIS GUY?          @V407438 01056000
         BOR   R9             YUP, FREE PATH, BR.              @V407438 01057000
REFBUSY  OI    VDEVFLG2,VDEVODE WE OWE THIS GUY DE WHEN FREE   @V407438 01058000
         L     R5,=A(256*BUSY) DEVICE IS BUSY RIGHT NOW        @V407438 01059000
         B     STORECSW       SORRY.                           @V407438 01060000
         SPACE                                                          01061000
PNDINT   EQU   *                                               @V407438 01062000
         SPACE                                                          01063000
         CLI   VMINST,X'9C'   IS IT A SIO                               01064000
         BNE   VIOATTN        NO --                                     01065000
         O     R5,=A(256*BUSY) ADD BUSY TO STATUS              @VA01803 01066000
VIOATTN  EQU   *                                                        01067000
         SLR   R0,R0          ZERO CONSTANT                             01068000
         TM    VDEVINTS,ATTN  ATTENTION PENDING ??                      01069000
         BZ    CLEARDEV       NO -- REFLECT A SINGLE INTERRUPT          01070000
         TM    VDEVFLAG,VDEVPOST PRESENT ALL TO-GETHER ?       @VA01653 01071000
         BO    POSTOFF        YES                              @VA04343 01072000
         TM    VDEVINTS,X'FF'-(ATTN+UC) ANYTHING ELSE ??                01073000
         BNZ   ATTNPLUS       YES -- SEPARATE INTERRUPTS, PLEASE        01074000
         CLI   VDEVTYPC,CLASSPEC   MIGHT THIS BE CHAN-TO-CHAN ADAPTER   01075000
         BNE   CLEARDEV            NO -- PRESENT STATUS                 01076000
         CLI   VDEVTYPE,TYPCTCA    BETTER BE SURE ABOUT IT              01077000
         BNE   CLEARDEV            NO -- PRESENT STATUS                 01078000
         TM    VDEVINTS,UC    IS THERE A UNIT CHECK INCLUDED ?          01079000
         BO    CLEARDEV       YES - GIVE IT TO HIM                      01080000
         STH   R0,VDEVINTS         CLEAR DEVICE INTERRUPT STATUS        01081000
         NI    VDEVSTAT,X'FF'-VDEVPEND  ...                             01082000
         TM    VDEVSTAT,VDEVDED    DEDICATED CHANNEL-TO-CHANNEL ?       01083000
         BCR   1,R9                YES - LET THE 'SIO' GO THROUGH       01084000
         L     R1,VDEVREAL    ACCESS THE CHXBLOK FOR VIRTUAL            01085000
         USING CHXBLOK,R1     ...                                       01086000
         TM    CHXFLAG,CHBM370     RUNNING IN COMPATIBILITY MODE ?      01087000
         BCR   8,R9                YES - LET THE 'SIO' GO THROUGH       01088000
         DROP  R1             PRESENT INTERRUPT STATUS TO START I/O     01089000
         B     CLEARDEV       PRESENT STATUS                   @VA04343 01090000
         SPACE                                                          01091000
* HERE IF ATTN ALONE, OR NO ATTN                                        01092000
POSTOFF  NI    VDEVFLAG,X'FF'-VDEVPOST TURN OFF VDEVPOST       @VA04343 01093000
CLEARDEV EQU   *              CLEAR DEVICE INTERRUPT STATUS             01094000
         STH   R0,VDEVINTS    CLEAR OUT STATUS BYTES                    01095000
         NI    VDEVSTAT,X'FF'-VDEVPEND  CLEAR OUT PENDING FLAG          01096000
         B     STTOTCSW       AND GO FINISH REFLECTING         @VA05104 01097000
         SPACE                                                          01098000
ATTNPLUS EQU   *  HERE FOR SEPARATE INTERRUPTS                          01099000
         N     R5,=A(X'FFFF'-256*(ATTN+UC))  CLEAR ATTN AND UC          01100000
         NI    VDEVINTS,ATTN+UC    AND LEAVE IN DEVICE                  01101000
STTOTCSW EQU   *              HERE TO STORE CSW                @VA05104 01102000
         LA    R1,CSW         GET VIRTUAL ADDRESS              @VA05104 01103000
         SL    R6,VMCHSTRT    CHAN DISPOSITION                 @VA05104 01104000
         SL    R7,VMCUSTRT    CU DISPOSITION                   @VA05104 01105000
         SL    R8,VMDVSTRT    DEV DISPOSITION                  @VA05104 01106000
         TRANS 2,1,OPT=(BRING,DEFER)                           @VA05104 01107000
         AL    R6,VMCHSTRT    RESTORE CHAN ADDRESS             @VA05104 01108000
         AL    R7,VMCUSTRT    RESTORE CU ADDRESS               @VA05104 01109000
         AL    R8,VMDVSTRT    RESTORE DEV ADDRESS              @VA05104 01110000
         SLL   R5,16          MOVE CSW STATUS                  @VA05104 01111000
         B     STCSW          GO STORE TOTAL CSW               @VA05104 01112000
         EJECT                                                          01113000
STORECSW EQU   *  HERE TO STORE THE CSW                                 01114000
         LA    R1,CSW         GET VIRTUAL ADDRESS                       01115000
         SL    R6,VMCHSTRT    CHAN. DISP                       @VA01770 01116000
         SL    R7,VMCUSTRT    CU DISP                          @VA01770 01117000
         SL    R8,VMDVSTRT    DEV DISP                         @VA01770 01118000
         TRANS 2,1,OPT=(BRING,DEFER)    GET USER PAGE 0                 01119000
         AL    R6,VMCHSTRT    RESTORE CHAN ADDR                @VA01770 01120000
         AL    R7,VMCUSTRT    RESTORE CU ADDR                  @VA01770 01121000
         AL    R8,VMDVSTRT    RESTORE DEV ADDR                 @VA01770 01122000
         STH   R5,4(,R2)      STORE STATUS --                           01123000
         LTR   R4,R4          SAVE ENTIRE CSW ??                        01124000
         BZ    *+8            NO --                                     01125000
STCSW    STM   R4,R5,0(R2)    STORE THE WHOLE THING            @VA05104 01126000
         TM    5(R2),CDC+CCC+IFCC ANY CHANNEL ERRORS ?         @V508690 01127000
         BZ    NOCHAN         NO, CONTINUE NORMAL PROCESSING   @V508690 01128000
         ICM   R1,15,VDEVIOER GET ADDRESS OF IOERBLOK          @V508690 01129000
         BZ    NOCHAN         NO IOERBLOK, FORGET IT           @V508690 01130000
         CALL  DMKCCHRF       REFLECT CHANNEL ERROR TO VIRT.   @V508690 01131000
*                             MACH.                                     01132000
NOCHAN   EQU   *                                               @V508690 01133000
         AIF   (NOT &TRACE(9)).TR1                              **AIF** 01134000
         TM    TRACFLG2,TRAC0D     TRACING ACTIVE?                      01135000
         BZ    NOTRAC1        BRANCH IF NOT                             01136000
         TRACE CODE=TRCCSW,R15,R14,R3                          @V4075A0 01137000
         MVC   1(1,R15),VMINST     SAVE OPCODE OF IO INST.              01138000
         STH   R13,2(,R15)    SAVE VIRTUAL DEVICE ADDRESS               01139000
         ST    R11,4(,R15)    SAVE VMBLOK ADDRESS                       01140000
         MVC   8(8,R15),0(R2) SAVE CSW                                  01141000
NOTRAC1  EQU   *                                                        01142000
.TR1     ANOP                                                           01143000
         LA    R2,X'10'       SET CONDITION CODE ONE                    01144000
         SPACE                                                          01145000
         CLM   R2,B'1100',VDEVINTS      LAST INTERRUPT CLEARED ?        01146000
         BNE   VIOEXIT        NO --                                     01147000
         LH    R3,VDEVADD          GET DEVICE ADDRESS (0-F)             01148000
         AR    R3,R3               MULTIPLY BY 2                        01149000
         L     R15,=A(DMKVIOXK)    ADDRESS THE UNFLAG TABLE    @VA05037 01150000
         LA    R3,0(R3,R15)   POINT TO UNFLAGGING MASK         @VA05037 01151000
         NC    VCUDVINT,0(R3) UNFLAG INTERRUPTING DEVICE       @VA01232 01152000
         BNZ   VIOEXIT             MORE PENDING IN THE C.U.             01153000
         LH    R3,VCUADD           GET CONTROL UNIT ADDRESS (00-F0)     01154000
         SRL   R3,3                TIMES 2                              01155000
         LA    R3,0(R3,R15)   POINT TO UNFLAGGING MASK         @VA05037 01156000
         NC    VCHCUINT,0(R3) UNFLAG INTERRUPTING C.U.         @VA01232 01157000
         BNZ   VIOEXIT             MORE PENDING IN THE CHANNEL          01158000
         LH    R3,VCHADD           GET CHANNEL ADDRESS (000-600)        01159000
         SRL   R3,7                TIMES 2                              01160000
         LA    R3,0(R3,R15)   POINT TO MASK ENTRY              @VA05037 01161000
         NC    VMIOINT,0(R3)  UNFLAG PENDING CHANNEL           @VA07503 01162000
         BNZ   VIOEXIT        MORE INTERRUPTS PENDING                   01163000
         SPACE                                                          01164000
         NI    VMPEND,X'FF'-VMIOPND     UNFLAG SUMMARY PENDING BIT      01165000
         SPACE 3                                                        01166000
*                                                                       01167000
*        GENERAL EXIT FROM DMKVSIEX                                     01168000
*                                                                       01169000
         SPACE 3                                                        01170000
VIOEXIT  EQU   *                                                        01171000
*                                                                       01172000
*        TEST FOR A CONDITION CODE 3. IF FOUND, GO TO TEST              01173000
*              FOR THE SITUATION WHERE A VIRTUAL DEVICE IS              01174000
*              NOT YET DEFINED BECAUSE AN MSS MOUNT IS IN               01175000
*              PROCESS                                                  01176000
*                                                                       01177000
         LA    R0,CC3         CONDITION CODE 3                 @V60B6B8 01178000
         CR    R0,R2                                           @V60B6B8 01179000
         BE    CHKMOUNT       VIRT DEV NOT AVAIL, TEST FOR     @V60B6B8 01180000
*                             MSS MOUNT                                 01181000
TESTEC   EQU   *                                               @V60B6B8 01182000
         TM    VMESTAT,VMEXTCM     EXTENDED CONTROL MACHINE ??          01183000
         BZ    VIOSETC        NO --                                     01184000
         EX    R2,SETECC      SET EC-MODE PSW CC                        01185000
         B     VIOEXITX       AND LEAVE                                 01186000
VIOSETC  EQU   *                                                        01187000
         EX    R2,SETCC            SET CONDITION CODE                   01188000
         SPACE 2                                                        01189000
VIOEXITX EQU   *              FINISHED WITH SIMULATION                  01190000
         AIF   (NOT &TRACE(6)).TRA3                             **AIF** 01191000
         TM    VMTRCTL,VMTRSIO  V.M. SIO TRACING WANTED ?               01192000
         BZ    VIOEXITY       NOT TODAY.                                01193000
         SLR   R10,R10        YES - SIGNAL NO IOBLOK TO BE USED,        01194000
         LR    R1,R13         VIRTUAL ADDRESS INTO R1 PLEASE            01195000
         CALL  DMKTRDSI       CALL TRACE RTN SIO ENTRY POINT   @V4M0240 01196000
.TRA3    ANOP                                                           01197000
VIOEXITY EQU   *              CONTINUE:                                 01198000
         TM    VMDSTAT,VMTIO  VM IN TIO OR SIO BUSY LOOP ??             01199000
         BNO   VIONWAIT       NO- LEAVE DISPATCHABLE                    01200000
         CLI   VDEVTYPC,CLASTERM   SLOW SPEED TERMINAL DEVICE           01201000
         BNE   VIOGODSP            NO- LEAVE NON-DISPATCHABLE           01202000
         OI    VMRSTAT,VMIDLE      YES- DROP THE TERMINAL USER FROM Q   01203000
         B     VIOGODSP            AND LEAVE NON-DISPATCHABLE           01204000
VIONWAIT NI    VMRSTAT,X'FF'-VMEXWAIT   TAKE OUT OF SIMULATION WAIT     01205000
         AIF (NOT &AP).APCHK5                                           01206000
         TM    APSTAT1,APUOPER RUNNING AN AP SYSTEM?           @VA08305 01207000
         BNO   FASTDSP        NO, FAST DISPATCH                @VA08305 01208000
         L     R15,=A(DMKLOKSY+2) POINT AT SYSTEM LOCK         @VA08305 01209000
         CLC   LPUADDR,0(R15) IS THE LOCK ALREADY HELD         @VA08305 01210000
         BNE   FASTDSP        NO, CANNOT EXIT TO MAIN          @VA08305 01211000
         L     R15,=A(DMKDSPRQ) STACKED REQUEST BLOCK POINTER  @V408246 01212000
         C     R15,IOBFPNT-IOBLOK(,R15) ANY PRESENTS WAITING   @V408246 01213000
*                             FROM IOS?                                 01214000
         BNE   VIOGODSP       YES, BETTER CHECK ON THEM        @V408246 01215000
.APCHK5  ANOP                                                           01216000
FASTDSP  GOTO  DMKDSPA        FAST RESTART                     @VA08305 01217000
VIOGODSP EQU   *                                                        01218000
         GOTO  DMKDSPCH       AND TO TO DISPATCH                        01219000
GETLOCK  EQU   *              TEST IF LOCK ALREADY HELD        @VA08305 01220000
         AIF (NOT &AP).APCHK6                                           01221000
         TM    APSTAT1,APUOPER IS THIS AN AP SYSTEM?           @VA08305 01222000
         BNOR  R9             NO, RETURN TO CALLER             @VA08305 01223000
         L     R15,=A(DMKLOKSY) GET ADDRESS OF SYSTEM LOCK     @VA08305 01224000
         L     R15,0(R15)     PICK UP THE LOCK WORD            @VA08305 01225000
         LH    R14,LPUADDR    AND PROCESSOR ID                 @VA08305 01226000
         CR    R14,R15        IS THE SYSTEM LOCK HELD?         @VA08305 01227000
         BCR   8,R9           YES,LOCK HELD                    @VA08305 01228000
         LTR   R15,R15        IS THE LOCK AVAILABLE            @VA08305 01229000
         BNZ   DEFEREX        NO, DON'T WASTE TIME TRYING      @VA08305 01230000
         LOCK  OBTAIN,TYPE=SYS,SPIN=NO,SAVE                    @VA08305 01231000
         BCR   8,R9           GOT THE LOCK, RETURN TO CALLER   @VA08305 01232000
DEFEREX  L     R15,VMDFTPNT   LOCK NOT OBTAINABLE....          @VA08305 01233000
         USING CPEXBLOK,R15   GET DEFERRED EXECUTION-BLOCK,    @VA08305 01234000
         STM   R0,R14,CPEXREGS SAVE CALLERS REGS               @VA08305 01235000
         LA    R14,LOCKRTN    GET ADDR OF EXECUTION RETURN PT  @VA08305 01236000
         ST    R14,CPEXADD    AND EXECUTION RETURN POINT       @VA08305 01237000
         DROP  R15            IS IN REG 14                     @VA08305 01238000
         LR    R1,R15         AND DEFER EXECUTION OF           @VA08305 01239000
         CALL  DMKSTKDE                                        @VA08305 01240000
         GOTO  DMKDSPRU                                        @VA08305 01241000
LOCKRTN  DS    0H             DEFERRED EXECUTION RETURN POINT  @VA08305 01242000
         LCTL  C1,C1,VMSEG    RELOAD CONTROL REG 1 AFTER DEFER @VA08305 01243000
.APCHK6  ANOP                                                           01244000
         BR    R9             RETURN TO CALLER                 @VA08305 01245000
         SPACE 2                                                        01246000
SETCC    OI    VMPSW+4,0           EXECUTED TO SET CONDITION CODE       01247000
         SPACE                                                          01248000
SETECC   OI    VMPSW+2,0      EXECUTED TO SET CC IN EC-MODE PSW         01249000
         SPACE                                                          01250000
CC3      EQU   X'30'          CONDITION CODE 3                 @V60B6B8 01251000
         EJECT                                                          01252000
CHKMOUNT EQU   *                                               @V60B6B8 01253000
*                                                                       01254000
*        AT THIS POINT WE ARE ABOUT TO RETURN TO THE CALLER             01255000
*              WITH A CONDITION CODE 3 (DEVICE NOT AVAILABLE).          01256000
*              IF THE MSS IS IN THE SYSTEM, THE DEVICE MAY              01257000
*              BE "NOT AVAILABLE" BECAUSE AN MSS MOUNT IS IN            01258000
*              PROCESS. IF THAT IS THE CASE, STACK THIS VIRTUAL         01259000
*              REQUEST UNTIL THE MOUNT COMPLETES.                       01260000
*                                                                       01261000
         TM    PSAMSS,MSSPRES IS THE MSS IN THIS SYSTEM        @V60B6B8 01262000
         BZ    TESTEC         NO, STANDARD RETURN              @V60B6B8 01263000
         L     R3,=V(DMKSSSMQ) WAIT Q FOR MSS MOUNTS           @V60B6B8 01264000
         L     R3,0(R3)       PICK UP ACTUAL QUEUE             @V60B6B8 01265000
         USING OSVSCOM,R3     ASSEMBLER ADDRESSABILITY         @V60B6B8 01266000
TESTCOM  EQU   *              IS THERE A MSSCOM BLOCK          @V60B6B8 01267000
         LTR   R3,R3          IS THE CHAIN PTR 0               @V60B6B8 01268000
         BZ    TESTEC         YES, WERE NOT WAITING ON MSS     @V60B6B8 01269000
         CLC   VMUSER(VMUSERL),MSSUSER ARE WE WAITING          @V60B6B8 01270000
         BNE   NXTCOM         NOT ON THIS BLOCK                @V60B6B8 01271000
         L     R4,MSSTASK1    TASK THAT IS WAITING             @V60B6B8 01272000
         CH    R13,CPEXMISC-CPEXBLOK(R4) VIRT DEV WAITING      @V60B6B8 01273000
         BNE   NXTCOM         THIS VIRT DEV NOT WAITING        @V60B6B8 01274000
         LA    R0,CPEXSIZE    SIZE OF A CPEXBLOK               @V60B6B8 01275000
         CALL  DMKFREE        GET DYNAMIC STORAGE              @V60B6B8 01276000
         USING CPEXBLOK,R1                                     @V60B6B8 01277000
         ST    R1,MSSTASK3                                     @VMI2006 01278000
         STM   R0,R15,CPEXREGS SAVE REGS FOR LATER DISPATCH    @V60B6B8 01279000
         LA    R0,DMKVSIEX    RE-DISPATCH ADDRESS              @V60B6B8 01280000
         ST    R0,CPEXADD     FIELD FOR DISPATCHER LATER       @V60B6B8 01281000
         ST    R13,CPEXMISC   SAVE VADDR WHICH IS WAITING      @V60B6B8 01282000
         GOTO  DMKDSPCH       WAIT FOR THE MSS                 @V60B6B8 01283000
         DROP  R1                                              @V60B6B8 01284000
NXTCOM   EQU   *              GET NEXT MSSCOM BLOCK            @V60B6B8 01285000
         L     R3,MSSNEXT     CHAIN PTR                        @V60B6B8 01286000
         B     TESTCOM        SEE IF THERE IS ONE              @V60B6B8 01287000
         DROP  R3                                              @V60B6B8 01288000
VMUSERL  EQU   8              LENGTH OF VMUSER FIELD           @V60B6B8 01289000
         EJECT                                                          01290000
*.                                                                      01291000
* SUBROUTINE NAME -                                                     01292000
*                                                                       01293000
*        DMKVSISC                                                       01294000
*                                                                       01295000
* FUNCTION -                                                            01296000
*                                                                       01297000
*        TO SCAN A V=R CHANNEL PROGRAM FOR EXCEPTIONAL CONDITIONS,      01298000
*        SUCH AS SENSE COMMANDS, NO-OP'S, I/O TO/FROM PAGE 0, ETC.,     01299000
*        WITHOUT ACTUALLY TRANSLATING THE PROGRAM.                      01300000
*                                                                       01301000
* ATTRIBUTES -                                                          01302000
*                                                                       01303000
*        RESIDENT; SERIALLY REUSABLE; CALLED VIA BALR.                  01304000
*                                                                       01305000
* ENTRY POINT -                                                         01306000
*                                                                       01307000
*        DMKVSISC                                                       01308000
*                                                                       01309000
* ENTRY CONDITIONS -                                                    01310000
*                                                                       01311000
*        R8    = ADDRESS OF VDEVBLOK                                    01312000
*        R9    = ADDRESS OF CHANNEL PROGRAM (HIGH-ORDER BYTE = 0        01313000
*        R10   = ADDRESS OF IOBLOK                                      01314000
*        R14 = RETURN REGISTER                                          01315000
*        R15 = A(DMKVSISC)                                              01316000
*                                                                       01317000
* EXIT CONDITIONS -                                                     01318000
*                                                                       01319000
*        R0-R14 PRESERVED                                               01320000
*        R15 = 0 (AND CONDITION-CODE = 0):                              01321000
*              CHANNEL PROGRAM IS OSTENSIBLY LEGITIMATE,                01322000
*              AND WILL CLEAR ANY OLD SENSE BYTES.                      01323000
*        R15 = 4 (AND CONDITION-CODE = 2):                              01324000
*              CHANNEL PROGRAM CONTAINS A SENSE COMMAND                 01325000
*              BEFORE ANY CCW'S WHICH WOULD CLEAR SENSE BYTES           01326000
*        R15 = 8 (AND CONDITION-CODE = 2):                              01327000
*              CHANNEL PROGRAM CONTAINS ONLY NO-OP AND/OR TIC CCW'S     01328000
*              (ANY EXISTING SENSE BYTES WOULD NOT BE CLEARED)          01329000
*        R15 = 12 (AND CONDITION-CODE = 2):                             01330000
*              CHANNEL PROGRAM STARTS IN PAGE 0, BRANCHES OUT OF        01331000
*              THE V=R AREA, OR READS INTO OR WRITES FROM PAGE 0        01332000
*              (OR OUT OF THE V=R AREA).                                01333000
*                                                                       01334000
* CALLS TO OTHER ROUTINES -                                             01335000
*                                                                       01336000
*        NONE                                                           01337000
*                                                                       01338000
* EXTERNAL REFERENCES                                                   01339000
*                                                                       01340000
*        DMKSLC = END OF V=R AREA                                       01341000
*                                                                       01342000
* TABLES / WORKAREAS -                                                  01343000
*                                                                       01344000
*        NONE                                                           01345000
*                                                                       01346000
* REGISTER USAGE -                                                      01347000
*                                                                       01348000
*        GPR R0-R9 WORK REGISTERS                                       01349000
*        GPR 14 = RETURN REGISTER                                       01350000
*        GPR 15 = ADDRESSABILITY; RETURN-CODE AT EXIT                   01351000
*                                                                       01352000
* NOTES -                                                               01353000
*                                                                       01354000
*        USED TO DETERMINE WHETHER EXISTING SENSE BYTES (IF ANY)        01355000
*        NEED TO BE CLEARED, AND WHETHER IT APPEARS SAFE NOT TO         01356000
*        TRANSLATE THE CHANNEL PROGRAM, OR IF DMKCCW MUST BE CALLED.    01357000
*                                                                       01358000
* OPERATION -                                                           01359000
*                                                                       01360000
*        1. CHECKS TO ENSURE THAT THE CHANNEL PROGRAM DOES NOT START    01361000
*        IN PAGE 0, OR ABOVE THE V=R AREA (ERROR 12 IF IT DOES).        01362000
*                                                                       01363000
*        1A. IF CHANNEL PROGRAM IS FOR TAPE, THEN CHECK FOR             01364000
*        BACKSPACE FILE OR FORWARD SPACE FILE CCWS. IF SO               01365000
*        THE CONTROL UNIT MUST NOT BE RELEASED AT INITATION.            01366000
*                                                                       01367000
*        2. DETERMINES THE TYPE OF CCW FROM THE LAST 4 BITS OF THE OP   01368000
*        CODE (USING THE OP CODE OF THE PREVIOUS CCW IF THE PREVIOUS    01369000
*        CCW HAD CHAIN-DATA FLAG SET).                                  01370000
*                                                                       01371000
*        3. FOR "WRITE" CCW'S (OP CODE ENDING IN 01, 05, 09, OR 0D),    01372000
*        CHECKS THAT THE DATA ADDRESS IS NOT IN PAGE 0, AND THAT THE    01373000
*        ENDING ADDRESS IS NOT ABOVE THE V=R AREA (ERROR 12 IF IT IS).  01374000
*        IF OK, INCREMENTS INTERNAL COUNT OF "REGULAR" CCW'S.           01375000
*                                                                       01376000
*        4. FOR "READ" CCW'S (OP CODE ENDING IN 02, 06, 0A, OR 0E),     01377000
*        IF SKIP FLAG IS SET, JUST INCREMENTS THE INTERNAL COUNT OF     01378000
*        "REGULAR" CCW'S.  IF NOT, CHECKS DATA ADDRESS AS IN STEP 3.    01379000
*                                                                       01380000
*        5. FOR "READ BACKWARD" CCW (OP CODE OF 0C), COMPUTES THE       01381000
*        "ENDING ADDRESS" (DATA ADDRESS LESS BYTE COUNT), AND THEN      01382000
*        HANDLES AS OTHER READ CCW'S IN STEP 4.                         01383000
*                                                                       01384000
*        6. FOR A "SENSE" TYPE COMMAND (OP CODE OF 04, 94, OR B4),      01385000
*        SETS RETURN-CODE INDICATING SENSE WAS FOUND;  THEN CHECKS FOR  01386000
*        THE SKIP FLAG SET AND VALID DATA ADDRESS AS IN STEP 4, EXCEPT  01387000
*        THAT THE COUNT OF "REGULAR" CCW'S IS NOT INCREMENTED.          01388000
*                                                                       01389000
*        OTHER CCW OP CODES ENDING IN 04 ARE HANDLED AS READ-TYPE       01390000
*        CCW'S (STEP 4).                                                01391000
*                                                                       01392000
*        7. FOR A "NO-OP" CCW (OP CODE OF 03), NO ERROR CHECKING IS     01393000
*        DONE, AND NO COUNTS ARE INCREMENTED.  (IF NO "REGULAR" CCW'S   01394000
*        ARE ENCOUNTERED, RETURN-CODE 8 IS GIVEN UPON EXIT.)            01395000
*                                                                       01396000
*        OTHER CCW OP CODES ENDING IN 03 ARE HANDLED AS CONTROL-TYPE    01397000
*        CCW'S (STEP 8).                                                01398000
*                                                                       01399000
*        8. FOR CONTROL CCW'S (OP CODES ENDING IN 03, 07, 0B, OR 0F,    01400000
*        EXCEPT FOR NO-OP = 03), THE COUNT OF "REGULAR" CCW'S IS        01401000
*        INCREMENTED, BUT NO OTHER ERROR-CHECKING IS DONE.              01402000
*                                                                       01403000
*        9. FOR A CCW ENDING IN 00, THE CCW-SCANNING IS TERMINATED,     01404000
*        IN STEP 12.                                                    01405000
*                                                                       01406000
*        10. FOR A TIC CCW (OP CODE ENDING IN 08), THE ADDRESS IN       01407000
*        THE TIC IS CHECKED TO SEE IF IT FALLS WITHIN THE PORTION OF    01408000
*        THE CHANNEL PROGRAM CURRENTLY BEING CHECKED.  IF SO, THE       01409000
*        PREVIOUS CCW IS CHECKED FOR COMMAND-CHAIN OR DATA-CHAIN SET;   01410000
*        IF YES, GOES TO HANDLE "NEXT" CCW AS IN STEP 11;  IF NOT,      01411000
*        TERMINATES CCW-SCANNING IN STEP 12.                            01412000
*                                                                       01413000
*        IF THE TIC POINTS TO A NEW AREA, CHECKS IF IT IS THE FIRST     01414000
*        SUCH TIC;  IF NOT, TERMINATES CCW-SCANNING IN STEP 12;  IF     01415000
*        IT IS THE FIRST, POINTS TO NEW SECTION OF CHANNEL PROGRAM      01416000
*        AND STARTS CHECKING IT AT STEP 1.                              01417000
*                                                                       01418000
*        11. UPON COMPLETION OF CHECKING THE CCW (IN STEPS 3-8),        01419000
*        CHECKS IF THE CURRENT CCW HAS COMMAND-CHAIN OR DATA-CHAIN      01420000
*        SET;  IF YES, ADVANCES 8 BYTES TO NEXT CCW AND CONTINUES       01421000
*        SCANNING AT STEP 2;  IF NOT, TERMINATES SCANNING AT STEP 12.   01422000
*                                                                       01423000
*        12. WHEN SCANNING IS COMPLETE (FROM ERROR 12 OR FROM STEP 10   01424000
*        OR 11), DETERMINES FROM TENTATIVE RETURN CODE AND THE COUNT    01425000
*        OF THE REGULAR CCW'S WHICH RETURN-CODE SHOULD BE GIVEN.        01426000
*        SETS RETURN CODE (0, 4, 8, OR 12), SETS CONDITION CODE,        01427000
*        RESTORES NECESSARY REGISTERS, AND RETURNS TO CALLER.           01428000
*.                                                                      01429000
         SPACE                                                          01430000
         AIF   (NOT &VIRREAL).NOVR12                           @VA04320 01431000
         SPACE                                                          01432000
         ENTRY DMKVSISC                                        @VA04320 01433000
         USING DMKVSISC,R15   ADDRESSABILITY                   @VA04320 01434000
DMKVSISC STM   R0,R9,BALRSAVE SAVE ONLY REGS WE WILL USE       @VA04320 01435000
         SLR   R0,R0          CLEAR RETURN-CODE                @VA04320 01436000
         ST    R0,PRVCOMND    CLEAR TEMPORARY STORAGE BYTES    @VA04320 01437000
         SLR   R6,R6          CLEAR COUNT OF TIC CCW'S         @VA04320 01438000
         SLR   R7,R7          CLEAR COUNT OF "REGULAR" CCWS    @VA04320 01439000
CCWNXT1  LR    R2,R9          GET ADDRESS OF CHANNEL PROGRAM   @VA04320 01440000
         C     R2,F4096       IS IT IN PAGE 0 ?                @VA04320 01441000
         BNL   CCWNXT3        IF NOT, OK - START SCANNING.     @VA04320 01442000
* ERROR - CHANNEL PROGRAM STARTS IN PAGE 0, EXCEEDS V=R AREA,           01443000
* OR REFERENCES DATA WHICH DOES THE SAME:                               01444000
VIOSCERX LA    R0,12          ERROR-CODE INTO R0,              @VA04320 01445000
         B     CCWNXT12       GO EXIT.                         @VA04320 01446000
         SPACE                                                          01447000
* MAIN LOOP TO SCAN THE CHANNEL PROGRAM:                                01448000
CCWNXT2  LA    R2,8(,R2)      POINT TO NEXT USER CCW           @VA04320 01449000
CCWNXT3  C     R2,=V(DMKSLC)  CCW OUT OF V=R RANGE ?           @VA04320 01450000
         BNL   VIOSCERX       THAT'S A NO-NO.                  @VA04320 01451000
         LH    R3,VIRCOMND    REMEMBER "PREVIOUS" CCW COMMAND  @VA04320 01452000
*                             & FLAGS                                   01453000
         STH   R3,PRVCOMND    ...                              @VA04320 01454000
         LM    R3,R4,0(R2)    GET CCW COMMAND FROM USER'S PAGE,@VA04320 01455000
         LA    R1,0(,R3)      ADDRESS BITS ONLY INTO R1        @VA04320 01456000
         IC    R5,0(,R2)      PICK UP CCW OP-CODE              @VA04320 01457000
         CLI   0(R2),X'2F'    BACKSPACE FILE ?                 @VA08687 01458000
         BE    CHTAPE         YES, SEE IF FOR TAPE DEVICE      @VA08687 01459000
         CLI   0(R2),X'3F'    FORWARDSPACE FILE ?              @VA08687 01460000
         BNE   CCWOK          NO, CCW IS OK                    @VA08687 01461000
CHTAPE   EQU   *                                               @VA08687 01462000
         L     R8,BALR8       ADDRESS OF VDEVBLOK              @VA08687 01463000
         TM    VDEVTYPC,CLASTAPE TAPE DEVICE ?                 @VA08687 01464000
         BZ    CCWOK          NO, CCW IS OK                    @VA08890 01465000
         NI    IOBFLAG,255-IOBRELCU DO NOT RELEASE CU AT INIT  @VA08687 01466000
CCWOK    EQU   *                                               @VA08687 01467000
         N     R5,F15         ISOLATE LAST 4 BITS PLEASE       @VA04320 01468000
         TM    PRVFLAG,CD     DID "PREVIOUS" CCW HAVE          @VA04320 01469000
*                             CHAIN-DATA SET ?                          01470000
         BO    CCWNXT5        TRF IF YES - BEWARE OF POSSIBLE  @VA04320 01471000
*                             TIC                                       01472000
         STCM  R3,8,VIRCOMND  IF NOT, REMEMBER OPCODE.         @VA04320 01473000
CCWNXT4  STCM  R4,8,VIRFLAG   REMEMBER CCW+4 = FLAG BITS       @VA04320 01474000
         IC    R5,VIOSCJMP(R5) GET INDEXER FROM THE JUMP TABLE @VA04320 01475000
         ALR   R5,R5          MUST DOUBLE IT,                  @VA04320 01476000
         B     VIOJMP(R5)     AND GO "TO THE RIGHT PLACE",     @VA04320 01477000
*                             PER THE LAST 4 BITS OF THE CCW OP-CODE.   01478000
         SPACE                                                          01479000
* IF PREVIOUS CCW WAS DATA-CHAINED, LOOK FOR TIC AS THIS COMMAND:       01480000
CCWNXT5  CL    R5,F8          IS IT A 'TIC' = '08' ?           @VA04320 01481000
         BE    VIOSC08T       BRANCH IF YES.                   @VA04320 01482000
*                             OTHERWISE:                                01483000
         IC    R5,VIRCOMND    PICK UP OLD CCW OP-CODE          @VA04320 01484000
         N     R5,F15         ISOLATE LAST 4 BITS PLEASE       @VA04320 01485000
         B     CCWNXT4        AND PROCEED USING OLD OP-CODE.   @VA04320 01486000
         SPACE                                                          01487000
VIOJMP   DS    0H             "BASE" FOR CODE TO BE "JUMPED TO"@VA04320 01488000
         SPACE                                                          01489000
* TIC COMMAND CODE:                                                     01490000
VIOSC08  MVI   VIRFLAG,X'00'  CLEAR FLAG-BYTE,                 @VA04320 01491000
VIOSC08T CR    R1,R9          TIC TO SOME NEW PLACE ?          @VA04320 01492000
         BL    VIOSC08A       YES - BRANCH.                    @VA04320 01493000
         CR    R1,R2          IN PRECEDING SECTION OF CODE ?   @VA04320 01494000
         BNL   VIOSC08A       NO - BRANCH.                     @VA04320 01495000
         LA    R1,8(,R1)      8 BYTES BEYOND TIC-TO ADDRESS    @VA04320 01496000
         CR    R1,R2          IS THIS A TIC TO *-8 ?           @VA04320 01497000
         BNE   CCWNXT11       NO - TIME TO EXIT                @VA04320 01498000
         TM    PRVFLAG,CC+CD  TEST FLAG OF "PREVIOUS" COMMAND  @VA04320 01499000
         BO    CCWNXT2                                         @VA06110 01500000
         SPACE                                                          01501000
* TIC TO "SOME NEW PLACE":                                              01502000
VIOSC08A LA    R6,1(,R6)      BUMP COUNT OF NEW TIC'S          @VA04320 01503000
         C     R6,F1          MORE THAN 1 ?                    @VA04320 01504000
         BH    CCWNXT11       YES - THAT'S ENOUGH.             @VA04320 01505000
         TM    3(R2),07       IS ADDRESS DBL-WORD ALIGNED?     @VA05709 01506000
         BZ    TICOK          YES, CONTINUE                    @VA05709 01507000
         S     R1,F1          NO, REALIGN FOR DYNAMIC BUFFERING@VA05709 01508000
TICOK    LR    R9,R1          FIRST ONE - POINT TO NEW STRING  @VA05709 01509000
         B     CCWNXT1        AND START CHECKING IT.           @VA04320 01510000
         SPACE                                                          01511000
* POSSIBLE NO-OP CCW:                                                   01512000
VIOSC03  CLI   VIRCOMND,X'03' IS IT A NO-OP ?                  @VA04320 01513000
         BE    CCWNXT9        YES - JUST CHECK CC+CD FLAG.     @VA04320 01514000
         B     VIOSC07        NO - TREAT AS OTHER "CONTROL" CCW@VA04320 01515000
         SPACE                                                          01516000
* POSSIBLE SENSE-TYPE CCW:                                              01517000
VIOSC04  CLI   VIRCOMND,X'04' USUAL "SENSE" OP-CODE ?          @VA04320 01518000
         BE    VIOSC04A       YES.                             @VA04320 01519000
         CLI   VIRCOMND,X'94' OR RESERVE/RELEASE ?             @VA04320 01520000
         BE    VIOSC04A       YES.                             @VA04320 01521000
         CLI   VIRCOMND,X'B4' ONE MORE CHECK ...               @VA04320 01522000
         BNE   VIOSC02        BR. IF NOT SENSE/RESERVE/RELEASE @VA04320 01523000
* SENSE, RESERVE, OR RELEASE:                                           01524000
VIOSC04A S     R7,F1          HAVE WE HAD ANY OTHER CCW'S YET? @VA04320 01525000
*                             (DECR TO COMPENSATE FOR ADD BELOW)        01526000
         BNM   VIOSC02        YES - KEEP OLD RETURN CODE.      @VA04320 01527000
         LA    R0,4           NO - INDICATE SENSE FOUND        @VA04320 01528000
         B     VIOSC02        GO CHECK SKIP FLAG & ADDRESS     @VA04320 01529000
         SPACE                                                          01530000
* READ BACKWARD CCW:                                                    01531000
VIOSC0C  TM    VIRFLAG,IDA    IDA SET ONCE IN A MILLION YEARS? @VA04320 01532000
         BZ    CCWNXT7        NOT TODAY                        @VA04320 01533000
         L     R1,0(,R1)      YES - GET THE "REAL" ADDRESS     @VA04320 01534000
         C     R1,=V(DMKSLC)  IS IDAL ADDRESS TOO BIG?         @VA05892 01535000
         BNL   VIOSCERX       TOO BAD                          @VA05892 01536000
         C     R1,F4096       IS HIS PAGE 0?                   @VA05892 01537000
         BL    VIOSCERX       YES, HANDS OFF OURS              @VA05892 01538000
         NI    VIRFLAG,X'FF'-IDA TURN OFF THE FLAG (FOR BELOW) @VA04320 01539000
CCWNXT7  N     R4,XRIGHT16    ISOLATE BYTE COUNT,              @VA04320 01540000
         BCTR  R4,0           (LESS 1), AND COMPUTE            @VA04320 01541000
         SR    R1,R4          ADDRESS OF "LAST" BYTE OF DATA   @VA04320 01542000
*                             CONTINUE:                                 01543000
* READ (FORWARD) CCW:                                                   01544000
VIOSC02  TM    VIRFLAG,SKIP   SKIP FLAG ON ?                   @VA04320 01545000
         BO    VIOSC07        YES - ADDRESS IS IRRELEVANT.     @VA04320 01546000
*                             NO - CONTINUE:                            01547000
* "WRITE" CCW:                                                          01548000
VIOSC01  TM    VIRFLAG,IDA    IDA SET ONCE IN A GREAT WHILE ?  @VA04320 01549000
         BZ    CCWNXT8        NOT THIS TIME.                   @VA04320 01550000
         C     R1,=V(DMKSLC)  EXCEEDS V=R AREA ?               @VA08544 01551000
         BH    VIOSCERX       YES, NO CAN DO                   @VA08544 01552000
         L     R1,0(,R1)      YES - GET THE "REAL" ADDRESS     @VA04320 01553000
CCWNXT8  C     R1,F4096       DOES ADDRESS REFERENCE PAGE 0 ?  @VA04320 01554000
         BL    VIOSCERX       THAT'S A NO-NO.                  @VA04320 01555000
         N     R4,XRIGHT16    ISOLATE BYTE COUNT,              @VA04320 01556000
         AR    R1,R4          COMPUTE END OF DATA AREA,        @VA04320 01557000
         C     R1,=V(DMKSLC)  EXCEEDS V=R AREA ?               @VA04320 01558000
         BH    VIOSCERX       THAT'S NO GOOD, EITHER.          @VA04320 01559000
*                             OK - CONTINUE:                            01560000
* "CONTROL" CCW (OTHER THAN NO-OP):                                     01561000
VIOSC07  A     R7,F1          BUMP COUNT OF "REGULAR" CCW'S    @VA04320 01562000
*                             CONTINUE:                                 01563000
CCWNXT9  TM    VIRFLAG,CC+CD  COMMAND OR DATA-CHAINED ?        @VA04320 01564000
CCWNXT10 BNZ   CCWNXT2        YES - GO GET "NEXT" CCW.         @VA04320 01565000
         SPACE                                                          01566000
* WHEN ALL THRU, EXIT:                                                  01567000
CCWNXT11 LTR   R7,R7          ANY "REGULAR" CCW'S ?            @VA04320 01568000
         BP    CCWNXT12       YES - GO EXIT (R0 IS OK).        @VA04320 01569000
         LTR   R0,R0          IS R0 > 0 ?                      @VA04320 01570000
         BP    CCWNXT12       YES (= 4) - LEAVE IT AS IS       @VA04320 01571000
         LA    R0,8           IF NOT, SET RETURN-CODE = 8      @VA04320 01572000
CCWNXT12 LTR   R15,R0         RETURN-CODE INTO R15 (& SET CC)  @VA04320 01573000
         LM    R0,R9,BALRSAVE RESTORE REGS WE USED,            @VA04320 01574000
         BR    R14            AND RETURN TO CALLER.            @VA04320 01575000
         SPACE                                                          01576000
* "INVALID" COMMAND-CODE (LAST 4 BITS OF OP-CODE = 0)                   01577000
VIOSC00  EQU   CCWNXT11       (TREAT AS "OK", BUT TERMINATE    @VA04320 01578000
*                             SCAN)                                     01579000
         SPACE                                                          01580000
         LTORG                                                 @VA04320 01581000
         SPACE                                                          01582000
* JUMP TABLE DEPENDING ON LAST 4 BITS OF OP-CODE:                       01583000
*              WHERE TO GO:            OP-CODE:                         01584000
VIOSCJMP DC    AL1((VIOSC00-VIOJMP)/2) 00   ENDS STRING        @VA04320 01585000
         DC    AL1((VIOSC01-VIOJMP)/2) 01   WRITE              @VA04320 01586000
         DC    AL1((VIOSC02-VIOJMP)/2) 02   READ               @VA04320 01587000
         DC    AL1((VIOSC03-VIOJMP)/2) 03   NO-OP OR CONTROL   @VA04320 01588000
         DC    AL1((VIOSC04-VIOJMP)/2) 04   SENSE OR READ      @VA04320 01589000
         DC    AL1((VIOSC01-VIOJMP)/2) 05   WRITE              @VA04320 01590000
         DC    AL1((VIOSC02-VIOJMP)/2) 06   READ               @VA04320 01591000
         DC    AL1((VIOSC07-VIOJMP)/2) 07   CONTROL            @VA04320 01592000
         DC    AL1((VIOSC08-VIOJMP)/2) 08   TIC                @VA04320 01593000
         DC    AL1((VIOSC01-VIOJMP)/2) 09   WRITE              @VA04320 01594000
         DC    AL1((VIOSC02-VIOJMP)/2) 0A   READ               @VA04320 01595000
         DC    AL1((VIOSC07-VIOJMP)/2) 0B   CONTROL            @VA04320 01596000
         DC    AL1((VIOSC0C-VIOJMP)/2) 0C   READ BACKWARD      @VA04320 01597000
         DC    AL1((VIOSC01-VIOJMP)/2) 0D   WRITE              @VA04320 01598000
         DC    AL1((VIOSC02-VIOJMP)/2) 0E   READ               @VA04320 01599000
         DC    AL1((VIOSC07-VIOJMP)/2) 0F   CONTROL            @VA04320 01600000
         SPACE                                                          01601000
* TEMPORARY STORAGE:                                                    01602000
         DS    0F             KEEP THE FOLLOWING FOUR IN ORDER:@VA04320 01603000
PRVCOMND DC    1X'00'         "PREVIOUS" CCW COMMAND CODE      @VA04320 01604000
PRVFLAG  DC    1X'00'         "PREVIOUS" CCW FLAG BITS         @VA04320 01605000
VIRCOMND DC    1X'00'         "THIS" VIRTUAL CCW COMMAND CODE  @VA04320 01606000
VIRFLAG  DC    1X'00'         "THIS" VIRTUAL CCW FLAG BITS     @VA04320 01607000
         SPACE                                                          01608000
.NOVR12  ANOP                                                  @VA04320 01609000
         EJECT                                                          01610000
DMKVSICT DC    F'0'           COUNT OF TOTAL I/O INSTRUCTIONS           01611000
DMKVSICW DC    F'0'           COUNT OF CALLS TO DMKCCWTR                01612000
DMKVSISI DC    F'0'           COUNT OF VIRT. SIO'S             @V2B2638 01613000
DMKVSISF DC    F'0'           COUNT OF VIRT. SIOF'S            @V2B2638 01614000
DMKVSITI DC    F'0'           COUNT OF VIRT. TIO'S             @V2B2638 01615000
DMKVSICI DC    F'0'           COUNT OF VIRT. CLRIO'S           @V2B2638 01616000
DMKVSIHI DC    F'0'           COUNT OF VIRT. HIO'S             @V2B2638 01617000
DMKVSIHD DC    F'0'           COUNT OF VIRT. HDV'S             @V2B2638 01618000
DMKVSITC DC    F'0'           COUNT OF VIRT. TCH'S             @V2B2638 01619000
DMKVSICC DC    F'0'           COUNT OF VIRTUAL CLCH'S          @VMD0117 01620000
TCHOPER  DC    X'9F00'        OPERAND FOR TEST CHANNEL (TCH)   @VMD0117 01621000
         SPACE                                                          01622000
         LTORG                                                          01623000
         EJECT                                                          01624000
         COPY  VBLOKS                                          @VA04320 01625000
OSVSCOM  MSSCOM                                                @V60B6B8 01626000
         COPY  VCTCA                                           @VA04320 01627000
         COPY  RBLOKS                                          @VA04320 01628000
         COPY  VMBLOK                                          @VA04320 01629000
         COPY  TREXT                                           @VA04320 01630000
         COPY  IOBLOKS                                         @VA04320 01631000
         COPY  IOER                                            @VA04320 01632000
         PSA                                                   @VA04320 01633000
         COPY  DEVTYPES                                        @VA04320 01634000
         COPY  EQU                                             @VA04320 01635000
         COPY  SAVE                                            @VA08305 01636000
         END   DMKVSI                                          @VA04320 01637000