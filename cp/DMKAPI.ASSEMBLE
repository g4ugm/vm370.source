API      TITLE 'DMKAPI     (CP)        VM/370 - RELEASE 6'              00001000
         ISEQ  73,80          VALIDATE SEQUENCING OF INPUT              00002000
*                                                                       00003000
* MODULE NAME -                                                         00004000
*                                                                       00005000
*        DMKAPI                                                         00006000
*                                                                       00007000
* FUNCTION -                                                            00008000
*                                                                       00009000
*        READY THE ATTACHED PROCESSOR FOR SYSTEM USE.                   00010000
*                                                                       00011000
* ATTRIBUTES -                                                          00012000
*                                                                       00013000
*        NON-REUSABLE, PAGEABLE, ENTERED VIA SVC FROM DMKCPI.           00014000
*                                                                       00015000
* ENTRY POINTS -                                                        00016000
*                                                                       00017000
*        DMKAPIPR - PERFORM MAIN PROCESSOR INITIALIZATION TO            00018000
*        SUPPORT THE APU.                                               00019000
*                                                                       00020000
*        DMKAPIAP - PERFORM ATTACHED PROCESSOR INITIALIZATION.          00021000
*        ENTERED VIA SIGP PSW RESTART FROM DMKAPIPR.                    00022000
*                                                                       00023000
* ENTRY CONDITIONS -                                                    00024000
*                                                                       00025000
*        GPR1 - POINTER TO ADDRESSES OF REAL PSA'S (VALUES TO BE        00026000
*               INSERTED IN PREFIXA AND PREFIXB).                       00027000
*        GPR12 - DMKAPI ENTRY POINT ADDRESS.                            00028000
*        GPR13 - SAVEAREA ADDRESS.                                      00029000
*                                                                       00030000
* EXIT CONDITIONS -                                                     00031000
*                                                                       00032000
*        NORMAL - DMKAPIPR RETURNS TO DMKCPI VIA SVC.                   00033000
*                 DMKAPIAP LOADS AN ENABLED WAIT STATE PSW.             00034000
*                                                                       00035000
*        ERROR - LOAD DISABLED WAIT STATE PSW.                          00036000
*                                                                       00037000
* CALLS TO OTHER ROUTINES -                                             00038000
*                                                                       00039000
*        DMKIOGAP - INITIALIZE CR15 ON APU FOR EXTENDED LOGOUT.         00040000
*        DMKLOKSP - OBTAIN SYSTEM LOCK.                                 00041000
*        DMKLOKVM - OBTAIN VMBLOK LOCK.                                 00042000
*        DMKPTRAN - BRING IN AND LOCK DMKIOGAP.                         00043000
*        DMKPTRUL - UNLOCK DMKIOGAP.                                    00044000
*        DMKQCNWT - WRITE MESSAGES TO OPERATOR.                         00045000
*                                                                       00046000
* EXTERNAL REFERENCES -                                                 00047000
*                                                                       00048000
*        DMKFREAP - PTR TO FREE STORAGE.                                00049000
*        DMKPRGIN - ADDRESS OF PROGAM CHECK FLIH.                       00050000
*        DMKPSADU - ADDRESS OF SYSTEM RESTART ROUTINES.                 00051000
*        DMKSVCIN - ADDRESS OF SVC FLIH.                                00052000
*                                                                       00053000
* TABLES/WORK AREAS -                                                   00054000
*                                                                       00055000
*        PSA,VMBLOK                                                     00056000
*                                                                       00057000
* MACROS -                                                              00058000
*                                                                       00059000
*        TRANS, CALL, LOCK OBTAIN                                       00060000
*                                                                       00061000
* REGISTER USAGE -                                                      00062000
*                                                                       00063000
*        R11 - VMBLOK ADDRESS                                           00064000
*        R12 - BASE REGISTER                                            00065000
*        R13 - SAVEAREA ADDRESS                                         00066000
*                                                                       00067000
* NOTES -                                                               00068000
*                                                                       00069000
*        NONE                                                           00070000
*                                                                       00071000
* OPERATION - MAIN PROCESSOR (DMKAPIPR)                                 00072000
*                                                                       00073000
*        1. MOVE COMMON PSA FIELDS IN ABSOLUTE 0 TO STORAGE DEFINED     00074000
*           BY PREFIXA AND PREFIXB. INITIALIZE AP DATA.                 00075000
*        2. LOCK DMKIOG.                                                00076000
*        3. PSW RESTART THE APU AT DMKAPIAP AND SPIN UNTIL THE          00077000
*           ROUTINE COMPLETES APU INITIALIZATION.                       00078000
*        4. CHECK IF THE INTERVAL TIMER IS RUNNING ON THE APU.          00079000
*        5. SET THE PREFIX REGISTER TO PREFIXA AND INITIALIZE           00080000
*           THE CONTROL REGISTERS FOR THE MAIN PROCESSOR.               00081000
*        6. OBTAIN THE SYSTEM AND VMBLOK LOCKS.                         00082000
*        7. UNLOCK DMKIOG AND RETURN TO DMKCPI.                         00083000
*                                                                       00084000
* OPERATION - ATTACHED PROCESSOR (DMKAPIAP)                             00085000
*                                                                       00086000
*        1. RESTORE TRACSTRT AND RSTNPSW IN ABSOLUTE 0 (DESTROYED       00087000
*           BY THE SIGP RESTART).                                       00088000
*        2. SET THE CLOCK COMPARATOR AND CPU TIMER.                     00089000
*        3. LOAD CR'S FOR THE APU AND THE PREFIX REGISTER FROM OLD      00090000
*           PREFIXB (NOW IS PREFIXA).                                   00091000
*        4. CALL DMKIOGAP TO INITIALIZE CR15 FOR EXTENDED LOGOUT.       00092000
*        5. TEST FOR VM ASSIST AVAILABILITY ON THE APU.                 00093000
*        6. RESET PSA FIELDS THAT MAY HAVE BEEN USED DURING             00094000
*           INITIALIZATION BUT DO NOT REFLECT APU STATUS.               00095000
*        7. SET THE CPUID OF THE APU                                    00096000
*        8. LOAD AN ENABLE WAIT STATE PSW.                              00097000
*                                                                       00098000
* ERROR MESSAGES -                                                      00099000
*                                                                       00100000
*        NONE.                                                          00101000
*                                                                       00102000
* GENERAL MESSAGES -                                                    00103000
*                                                                       00104000
*        TURN ON THE ATTACHED PROCESSOR'S INTERVAL TIMER                00105000
*                                                                       00106000
* WAIT STATE CODES -                                                    00107000
*                                                                       00108000
*        15 - SIGP RESTART FAILED.                                      00109000
*                                                                       00110000
         EJECT                                                          00111000
DMKAPI   CSECT                                                 @V407595 00112000
         COPY  OPTIONS                                         @V407595 00113000
N0       EQU   0                                               @V407595 00114000
         DC    CL8'DMKAPI'                                     @V4M0106 00115000
N1       EQU   1                                               @V407595 00116000
N2       EQU   2                                               @V407595 00117000
N4       EQU   4                                               @V407595 00118000
N8       EQU   8                                               @V407595 00119000
L8       EQU   8                                               @V407595 00120000
N12      EQU   12                                              @V407595 00121000
N16      EQU   16                                              @V407595 00122000
FF       EQU   X'FF'                                           @V407595 00123000
CONDCODE EQU   X'08'          TO STCM CC IN WAIT PSW           @V407595 00124000
PROCAPU  EQU   X'40'          TRACE TABLE ID OF THE APU        @V407595 00125000
         EJECT                                                          00126000
         EXTRN DMKPRGIN                                        @V407595 00127000
         EXTRN DMKPSADU                                        @V407595 00128000
         EXTRN DMKPTRUL                                        @V407595 00129000
         EXTRN DMKSVCIN                                        @V407595 00130000
         EXTRN DMKQCNWT                                        @V407595 00131000
         EXTRN DMKIOGAP                                        @V407595 00132000
         USING SAVEAREA,R13                                    @V407595 00133000
DMKAPIPR RELOC                                                 @V407595 00134000
         USING PSA,R0                                          @V407595 00135000
         MVC   APIWORK,ZEROES CLEAR FLAG AND WORK AREA         @V407595 00136000
         MVC   PREFIXA(N8),N0(R1) SET PREFIX VALUES OF PREFIXA @V407595 00137000
*                             AND PREFIXB IN ABSOLUTE 0.                00138000
         SR    R14,R14        MVCL FROM ADDRESS IS 0           @V407595 00139000
         L     R15,F4096      MVCL FROM LENGTH IS PAGE SIZE    @V407595 00140000
         L     R2,PREFIXA     MVCL TO ADDR - MAIN PROC'S PSA   @V407595 00141000
         LR    R3,R15         MVCL TO LENGTH IS PAGE SIZE      @V407595 00142000
         MVCL  R2,R14         MOVE ABSOLUTE 0 TO PREFIX AREA   @V407595 00143000
         SR    R14,R14        MVCL FROM ADDRESS IS 0           @V407595 00144000
         L     R15,F4096      MVCL FROM LENGTH IS PAGE SIZE    @V407595 00145000
         L     R2,PREFIXB     MVCL TO ADDR - APU 'S PSA        @V407595 00146000
         LR    R3,R15         MVCL TO LENGTH IS PAGE SIZE      @V407595 00147000
         MVCL  R2,R14         MOVE ABSOLUTE 0 TO PREFIX AREA   @V407595 00148000
*                                                                       00149000
*        INITIALIZE THE ATTACHED PROCESSOR'S PSA SO THAT IPUADDR,       00150000
*        LPUADDR, AND PREFIXA, CORRESPOND TO THE ATTACHED PROCESSOR     00151000
*        UNIT ADDRESSES AND PSA RESPECTIVELY. IPUADDRX,LPUADDRX,        00152000
*        AND PREFIXB WILL CORRESPOND TO THE MAIN PROCESSOR CPU          00153000
*        ADDRESSES AND PSA RESPECTIVELY. THESE VALUES IN THE MAIN       00154000
*        PROCESSOR'S PSA WERE ESTABLISHED ABOVE VIA THE MVCL FROM       00155000
*        ABSOLUTE ZERO.                                        @V407595 00156000
*                                                                       00157000
         L     R2,PREFIXB     GET AP PSA ADDRESS               @VA07568 00158000
         SR    R1,R1          ZERO A REGISTER                  @VA07568 00159000
         ST    R1,ACTIVTRQ(R2) ZERO OUT ACTIVE TRQ POINTER     @VA07568 00160000
         MVI   APSTAT4-PSA(R2),X'00' CLEAR MCHCHK BIT AND THE  @VA08614 00161000
*                             REST OF THE BYTE                          00162000
         MVC   IPUADDR-PSA(N2,R2),IPUADDRX SET PHYSICAL CPU    @V407595 00163000
*                             ADDR OF APU IN ATTACHED PROCESSOR'S PSA   00164000
*                             (PREFIXB)                                 00165000
         MVC   IPUADDRX-PSA(N2,R2),IPUADDR SET PHYSICAL CPU    @V407595 00166000
*                             ADDR OF MAIN PROC IN ATTACHED PROCESSOR'S 00167000
*                             PSA (PREFIXB)                             00168000
         MVC   LPUADDR-PSA(N2,R2),LPUADDRX SET LOGICAL CPU     @V407595 00169000
*                             ADDR OF APU IN ATTACHED PROCESSOR'S PSA   00170000
*                             (PREFIXB)                                 00171000
         MVC   LPUADDRX-PSA(N2,R2),LPUADDR SET LOGICAL CPU     @V407595 00172000
*                             ADDR OF MAIN PROC IN ATTACHED PROCESSOR'S 00173000
*                             PSA (PREFIXB)                             00174000
         MVC   PREFIXB-PSA(N4,R2),PREFIXA SET ADDRESS OF MAIN  @V407595 00175000
*                             PROCESSOR'S PSA IN ATTACHED PROCESSOR'S   00176000
*                             PSA (PREFIXB). THIS PERMITS CROSS         00177000
*                             REFERENCING OF PSA'S                      00178000
         MVC   PREFIXA-PSA(N4,R2),PREFIXB SET ADDRESS OF APU'S @V407595 00179000
*                             PSA IN ATTACHED PROCESSOR'S PSA (PREFIXB) 00180000
*                             THIS PERMITS REFERENCES TO ABSOLUTE 0.    00181000
         MVC   LASTUSER-PSA(N4,R2),ASYSVM MAKE AP PSA LASTUSER @VA08415 00182000
*                                            THE SYSTEM VMBLOK          00183000
         L     R1,APIIOGAP    OBTAIN VIRT ADDR OF DMKIOGAP.    @V407595 00184000
*                             DMKIOGAP MUST BE LOADED AND LOCKED WHEN   00185000
*                             IT IS INVOKED BY DMKAPIAP ON THE APU.     00186000
         TRANS 2,1,OPT=(BRING,DEFER,SYSTEM,LOCK) LOCK DMKIOGAP @V407595 00187000
         ST    R2,REALSAVE    SAVE REAL ADDRESS OF DMKIOGAP    @V407595 00188000
*                             SO IT CAN BE UNLOCKED AT EXIT.            00189000
         STCTL C1,C14,BALR1    SAVE CR'S FOR APU TO RESTORE    @V407595 00190000
*                             NOTE CR0 IS RESTORED FROM CR0INTAP        00191000
         LM    R1,R2,RESTAP   LOAD PSW TO RESTART ON ATTACHED  @VMH0013 00192000
*                             PROCESSOR                                 00193000
         TM    APSTAT4,POFFLINE IS VARY PROCESSING ACTIVE?     @VMH0013 00194000
         BNO   STRSTNEW       NO, BRANCH                       @VMH0013 00195000
         L     R15,ASYSVM     GET SYSTEM VMBLOK ADDRESS        @VMH0013 00196000
         L     R14,PREFIXB    ATTACHED PROCESSOR'S PREFIX      @VMH0031 00197000
         ST    R15,LASTUSER-PSA(R14) SET LASTUSER TO ASYSVM    @VMH0031 00198000
         ST    R15,RUNUSER-PSA(R14) SET RUNUSER TO ASYSVM      @VMH0031 00199000
         MVC   TIMER-PSA(N4,R14),FFS SET ATTACHED PROCESSOR'S  @VMH0031 00200000
*                             INTERVAL TIMER TO A HIGH NEGATIVE         00201000
*                             NUMBER.  THIS WILL PREVENT AN INTERVAL    00202000
*                             TIMER INTERRUPT FROM OCCURING ON THE      00203000
*                             ATTACHED PROCESSOR BEFORE THE SYSTEM      00204000
*                             IS FULLY INITIALIZED FOR AP MODE.         00205000
         LCTL  C1,C1,VMSEG-VMBLOK(R15) USE SYSTEM CTRL REG 1   @VMH0013 00206000
         LRA   R2,0(0,R2)     GET REAL ADDRESS OF ROUTINE      @VMH0013 00207000
         LCTL  C1,C1,BALR1    RESTORE CONTROL REGISTER 1       @VMH0013 00208000
STRSTNEW DS    0H                                              @VMH0013 00209000
         STM   R1,R2,RSRTNPSW SET RESTART NEW TO RESTART THE   @VMH0013 00210000
*                             ATTACHED PROCESSOR               @VMH0013 00211000
SIGPREST EQU   *                                               @V407595 00212000
         ST    R12,TEMPSAVE   SAVE BASE REG FOR DMKAPIAP/IT    @V407595 00213000
         LA    R0,SIGREST     SAVE SIGP ORDER IN CASE OF ERROR @V407595 00214000
         SR    R1,R1          CLEAR SIGP STATUS REGISTER       @V407595 00215000
         LH    R2,IPUADDRX    ADDRESS OF APU FOR SIGP RESTART  @V407595 00216000
         SIGP  R1,R2,SIGREST  PSW RESTART THE APU              @V407595 00217000
         BC    7,APERROR      SHOULD ONLY RECEIVE CC=0, ELSE   @V407595 00218000
*                             ERROR.                                    00219000
         LCTL  C0,C0,MFAONLY  ENABLE FOR MFA ONLY DURING SIGP  @V407595 00220000
*                             RESTART.                                  00221000
WAITREST EQU   *                                               @V407595 00222000
         STOSM SYSMASK,EXTMASK ENABLE FOR EXTERNAL INTERRUPTS  @V407595 00223000
         STNSM SYSMASK,FF-EXTMASK CLOSE MFA WINDOW             @V407595 00224000
         TM    APIFLAG1,APUSPIN WAIT UNTIL DMKAPIAP COMPLETES  @V407595 00225000
         BNO   WAITREST       WAIT FOR RESTART TO COMPLETE     @V407595 00226000
*                                                                       00227000
*                             DETERMINE IF THE INTERVAL TIMER IS        00228000
*                             RUNNING ON THE APU. THE MAIN PROCESSOR'S  00229000
*                             HAS PREVIOUSLY BEEN TESTED.               00230000
*                                                                       00231000
         L     R4,PREFIXB     OBTAIN ADDRESS OF APU REAL 0     @V4M0106 00232000
         L     R3,TIMER(R4)   OBTAIN VALUE OF APU INTERVAL TMR @V4M0106 00233000
APINTTMR EQU   *                                               @V4M0106 00234000
         STIDP CPUID          ISSUE A PRIVILEGED INSTRUCTION   @V4M0143 00235000
*                             TO FORCE A TRIP THRU THE DISPATCHER       00236000
*                             WHEN RUNNING VM UNDER VM.                 00237000
         L     R2,F20000      LOAD A HIGH VALUE FOR LOOP CNTRL.@V4M0106 00238000
*                             NOTE THAT THE INTERVAL TIMER IS UPDATED   00239000
*                             IN BIT POSITION 23 APPROXIMATELY          00240000
*                             ONCE PER 1/300 SECOND. THE SEQUENCE       00241000
*                             OF INSTRUCTIONS IN 'TIMELOOP' MUST BE     00242000
*                             EXECUTED APPROXIMATELY 7,000 TIMES        00243000
*                             ON A MODEL 168 TO REACH THIS INTERVAL.    00244000
*                             A HIGHER VALUE IS SELECTED TO ENSURE      00245000
*                             THE TIMER IS NOT RUNNING BEFORE ISSUING   00246000
*                             MESSAGE.                                  00247000
TIMELOOP EQU   *                                               @V4M0106 00248000
         CL    R3,TIMER(R4)   TIMER CHANGING ON APU ?          @V4M0106 00249000
         BNE   APNOMSG        YES - TIMER IS RUNNING - CONTINUE@V4M0106 00250000
         BCT   R2,TIMELOOP    CONTINUE UNTIL COUNTER EXHAUSTED @VM40106 00251000
*                             OR INTERVAL TIMER RUNNING.                00252000
         LA    R1,TMSG        GET MESSAGE PTR.                 @V407595 00253000
         LA    R0,TMSGL       GET MESSAGE LENGTH.              @V407595 00254000
         CALL DMKQCNWT,PARM=0 TELL OPERATOR TO READY INT TIMER @V407595 00255000
         B     APINTTMR       RESTART THE TIMER LOOP           @V4M0106 00256000
APNOMSG  EQU   *                                               @V407595 00257000
         SPX   PREFIXA        ESTABLISH PREFIXING ON MAIN PROC @V407595 00258000
         TM    APSTAT1,CPINITD IS SYSTEM IN IPL?               @VMH0026 00259000
         BZ    SETTDISP       YES, BRANCH                      @VMH0026 00260000
         SPACE                                                          00261000
* THE FOLLOWING CODE GOES THROUGH THE CHAIN OF VMBLOKS AND     *        00262000
* OBTAINS A DEFERRED EXECUTION BLOCK FOR EACH.  ALSO, VMCPTIME *        00263000
* AND VMAPTIME ARE ADJUSTED TO THE AP MODE VALUES.             *        00264000
         SPACE                                                          00265000
         USING VMBLOK,R11                                      @VMH0026 00266000
         SPACE                                                          00267000
         L     R11,ASYSVM     GET ADDRESS OF SYSTEM VMBLOK     @VMH0026 00268000
         MVC   VMAPTIME,APSPTIME STORE THE AP SUP. TIME INITIAL VALUE  X00269000
                                                               @VMH0026 00270000
*                                                                       00271000
*THE FOLLOWING CODE ADJUSTS VMCPTIME TO VMTTIME-X'3FFFFFFFFFFFF000'     00272000
*                                                                       00273000
         LM    R0,R1,VMTTIME  GET VMTTIME IN EVEN-ODD REGISTERS        X00274000
                                                               @VMH0026 00275000
         SL    R0,SUB4        SUBTRACT X'4000000000000000'     @VMH0026 00276000
         AL    R1,ADD1        ADD BACK IN X'0000000000001000'  @VMH0026 00277000
         BC    12,NOCARRY     BRANCH IF NO CARRY ON THE ADDITION       X00278000
                                                               @VMH0026 00279000
         AL    R0,F1          ADD IN CARRY                     @VMH0026 00280000
NOCARRY  STM   R0,R1,VMCPTIME STORE ADJUSTED VMCPTIME VALUE    @VMH0026 00281000
*                                                                       00282000
         L     R11,VMPNT      GET FIRST VMBLOK ADDR IN CYCLIC CHAIN    X00283000
                                                               @VMH0026 00284000
         LR    R10,R11        SAVE ENDING ADDRESS              @VMH0026 00285000
VMLOOP   DS    0H                                              @VMH0026 00286000
         MVC   VMAPTIME,APSPTIME STORE THE AP SUP. TIME INITIAL VALUE  X00287000
                                                               @VMH0026 00288000
         LM    R0,R1,VMTTIME  GET VMTTIME IN REGISTERS         @VMH0026 00289000
         SL    R0,SUB4        SUBTRACT X'4000000000000000'     @VMH0026 00290000
         AL    R1,ADD1        ADD BACK IN X'0000000000001000'  @VMH0026 00291000
         BC    12,NOTCARRY    BRANCH IF NO CARRY               @VMH0026 00292000
         AL    R0,F1          ADD IN CARRY                     @VMH0026 00293000
NOTCARRY STM   R0,R1,VMCPTIME STORE ADJUSTED VMCPTIME VALUE    @VMH0026 00294000
         LA    R0,CPEXSIZE    GET SIZE OF BLOCK IN DOUBLE WORDS        X00295000
                                                               @VMH0026 00296000
         CALL  DMKFREE        OBTAIN STORAGE                   @VMH0026 00297000
         ST    R1,VMDFTPNT    SAVE ADDR OF DEFER EX.BLOK       @VMH0026 00298000
         L     R11,VMPNT      GET ADDR OF NEXT VMBLOK          @VMH0026 00299000
         CR    R10,R11        END OF CHAIN                     @VMH0026 00300000
         BNE   VMLOOP         NO, DO THEM ALL                  @VMH0026 00301000
         L     R11,SAVER11    RESTORE VMBLOK ADDRESS           @VMH0026 00302000
         SPACE                                                          00303000
SETTDISP DS    0H                                              @VMH0026 00304000
         LA    R0,VMCPTIME-VMBLOK(,R0) GET ADDR MAIN PROC TIMER@V4M0203 00305000
         ST    R0,TIMEDISP    SAVE DISPLACEMENT IN PSA         @V4M0203 00306000
         CHARGE START         START CHARGING OPERATOR          @V4M0203 00307000
         LCTL  C0,C0,CR0INTMN ESTABLISH VALUE OF CR0 ON MAIN   @V407595 00308000
*                             PROCESSOR. NOTE THAT TOD SYNC CHECKS WILL 00309000
*                             BE ENABLED BY DMKCLK. THIS WILL SUPPRESS  00310000
*                             ALL SYNC CHECKS UNTIL CLOCKS ARE SET.     00311000
         STCTL C0,C0,CPCREG0  INITIALIZE CR0 FOR MAIN PROC     @V407595 00312000
         OI    APSTAT1,APUOPER INDICATE THE APU IS NOW         @V407595 00313000
*                             OPERATIONAL                      @V407595 00314000
         LOCK  OBTAIN,TYPE=SYS,SPIN=NO                         @VA07480 00315000
         BNZ   APNOLOK        LOCK NOT AVAILABLE, TERM VM      @VA07611 00316000
         L     R1,SAVER11     ADDRESS OF VMBLOK TO R1          @VMH0001 00317000
         LOCK  OBTAIN,TYPE=VMBLOK,SPIN=NO LOCK THE OPERATOR'S  @V407595 00318000
*                             VMBLOK FOR THE DISPATCHER.                00319000
         BNZ   APNOLOK        LOCK NOT AVAILABLE, TERM VM      @VA07611 00320000
         C     R1,LASTUSER    WAS LASTUSER JUST LOCKED?        @VMH0001 00321000
         BE    USERSLKD       YES, BRANCH                      @VMH0001 00322000
         L     R1,LASTUSER    GET LASTUSER VMBLOK ADDRESS      @VMH0001 00323000
         C     R1,ASYSVM      IS LASTUSER THE SYSTEM VMBLOK?   @VMH0001 00324000
         BE    USERSLKD       YES, BRANCH                      @VMH0001 00325000
         LOCK  OBTAIN,TYPE=VMBLOK,SPIN=NO LOCK LASTUSER        @VMH0001 00326000
         BNZ   APNOLOK        LOCK NOT AVAILABLE, TERMINATE VM @VMH0001 00327000
USERSLKD DS    0H                                              @VMH0001 00328000
         L     R2,REALSAVE    RESTORE DMKIOGAP REAL ADDRESS    @V407595 00329000
         CALL  DMKPTRUL       UNLOCK DMKIOGAP.                 @V407595 00330000
         EXIT                                                  @V407595 00331000
APERROR  EQU   *                                               @V407595 00332000
         MVC   RSRTNPSW(L8),APIRSTNW RESTORE RESTART NEW PSW   @V407595 00333000
         BALR  R15,0          SET CONDITION CODE IN WORK REG   @V407595 00334000
         STCM  R15,CONDCODE,XWAIT4+N4 STORE CC IN WAIT PSW.    @V407595 00335000
*                             NOTE PSW IS IN BC FORMAT.                 00336000
         LPSW  XWAIT4         LOAD ERROR WAIT CODE =X'15'      @V407595 00337000
         SPACE                                                          00338000
APNOLOK  DS    0H             SYTEM/VMBLOK LOCK NOT AVAILABLE  @VA07611 00339000
         ABEND 1              TERMINATE VM/370                 @VA07611 00340000
         EJECT                                                          00341000
         ENTRY DMKAPIAP       APU INITIALIZATION ROUTINE       @V407595 00342000
DMKAPIAP DS    0D                                              @V407595 00343000
         L     R11,ASYSOP     OBTAIN OPERATOR VMBLOK ADDRESS   @V4M0106 00344000
*                             TO SATISFY SVC INTERFACE.                 00345000
         L     R12,TEMPSAVE    SET BASE TO MAINLINE DMKAPI     @V407595 00346000
         L     R14,PREFIXA    SET ADDRESSIBILITY TO MAIN PSA   @V407595 00347000
         L     R14,TRACSTRT(R14) OBTAIN VALUE OF TRACSTRT      @V407595 00348000
         ST    R14,TRACSTRT   RESTORE TRACE TABLE START        @V407595 00349000
*                             ADDRESS IN ABSOLUTE 0. IT WAS OVERLAID    00350000
*                             AS A RESULT OF THE DMKAPI PSW RESTART.    00351000
         MVC   RSRTNPSW(N8),APIRSTNW RESTORE RESTART NEW PSW   @V407595 00352000
*                             IN ABSOLUTE 0 IN CASE RESET AND RESTART   00353000
*                             ARE PRESSED BY THE OPERATOR.              00354000
         SCKC  FFS            INIT APU TOD CLOCK COMPARATOR    @V407595 00355000
         SPT   PROBTIME       INIT APU CPU TIMER               @V407595 00356000
         LCTL  C1,C14,BALR1   ESTABLISH CR'S FOR THE APU       @V407595 00357000
         LCTL  C0,C0,CR0INTAP ESTABLISH CR0 FOR THE APU -      @V407595 00358000
*                             DISABLED FOR TOD SYNC CHECKS.             00359000
         LCTL  C2,C2,ZEROES   INHIBIT I/O INTERRUPTS ON THE    @V407595 00360000
*                             APU.                                      00361000
         SPX   PREFIXB        ESTABLISH PREFIXING ON THE APU   @V407595 00362000
         STCTL C0,C0,CPCREG0  SET CR0 FOR THE APU.             @V407595 00363000
         OI    TRACPROC,PROCAPU SET TRACE TABLE IDENTIFIER OF  @V407595 00364000
*                             THE ATTACHED PROCESSOR                    00365000
         NI    APSTAT1,FF-PROCIO INDICATE THAT THIS PROCESSOR  @V407595 00366000
*                             LACKS I/O CAPABILITY.                     00367000
         CALL  DMKIOGAP       CALL MCH ROUTINE TO INITIALIZE   @V407595 00368000
*                             CR15 FOR EXTENDED LOGOUT                  00369000
         EJECT                                                          00370000
*                                                                       00371000
*              TEST FOR VM ASSIST                              @V407595 00372000
* TO DO THIS, DO AN SSM INSTRUCTION IN PROBLEM STATE.  IF CP RECEIVES   00373000
* THE PROGRAM INTERRUPT, VM ASSIST IS NOT PRESENT.  IF VM               00374000
* ASSIST HANDLES THE SSM, DO AN SVC TO GET BACK TO SUPERVISOR STATE.    00375000
*                                                                       00376000
         L     R11,ASYSVM     ADDRESS OF SYSTEM VMBLOK         @V407595 00377000
         USING VMBLOK,R11     EST ADDRESSIBILITY TO VMBLOK     @V407595 00378000
         LA    R1,APISVC      SET SVC NEW PSW TO POINT TO      @V407595 00379000
         ST    R1,SVCNPSW+N4  APISVC                           @V407595 00380000
         LA    R1,APIPROG     SET PROGRAM NEW PSW TO POINT     @V407595 00381000
         ST    R1,PRNPSW+N4   TO APIPROG                       @V407595 00382000
         MVC   RUNCR0(4),CPCREG0 SET UP REAL CR0               @V407595 00383000
         MVC   RUNCR1(4),VMSEG SET UP REAL CR1                 @V407595 00384000
* SET UP MICROCODE POINTER LIST                                         00385000
         MVC   TEMPR2,VMSEG   SYSTEM SEGMENT TABLE IN PTR LIST @V407595 00386000
         LA    R1,RUNCR0      VIRT CR0 SAME AS REAL CR0        @V407595 00387000
         ST    R1,TEMPR3                                       @V407595 00388000
         MVC   TEMPR4(4),ZEROES    VIRT. PSW POINTER           @V407595 00389000
         LA    R1,BALRSAVE    WORKSPACE ADDRESS                @V407595 00390000
         ST    R1,TEMPR5                                       @V407595 00391000
* SET UP C-REG 6 - USE TEMPR0 TO SET IT UP                              00392000
         LA    R1,TEMPR2      ADDRESS OF MICROCODE PTR LIST    @V407595 00393000
         ST    R1,TEMPR0      INTO C-REG 6                     @V407595 00394000
         OI    TEMPR0,VMMFE+VMMSVC TURN MICROCODE ON & SVCS OFF@V407595 00395000
         LCTL  C6,C6,TEMPR0   LOAD CR6                         @V407595 00396000
         LCTL  C0,C1,RUNCR0   LOAD REAL CR0 AND CR1            @V407595 00397000
         LPSW  TESTPSW        GO INTO PROBLM STATE & ISSUE SSM @V407595 00398000
         DS    0D                                              @V407595 00399000
TESTPSW  DC    X'040D0000'             PROB STATE PSW          @V407595 00400000
         DC    A(SSMTEST)                                               00401000
SSMTEST  SSM   *+1            WILL MICROCODE HANDLE THIS?      @V407595 00402000
         SVC   30             YES THEN MUST RETURN TO          @V407595 00403000
*                             SUPERVISOR STATE                          00404000
APIPROG  EQU   *              IF MICROCODE DOESNT HANDLE SSM,  @V407595 00405000
*                                  PROGRAM INTERRUPT COMES HERE         00406000
         NI    CPSTAT2,X'FF'-CPMICAVL-CPMICON INDICATE VM      @V407595 00407000
*                              ASSIST NOT AVAILABLE & NOT ON            00408000
         B     NPSWS                                           @V407595 00409000
APISVC   EQU   *              IF MICROCODE HANDLES SSM, SVC    @V407595 00410000
*                                  INTERRUPT COMES HERE                 00411000
         OI    CPSTAT2,CPMICAVL+CPMICON INDICATE VM ASSIST     @V407595 00412000
*                                         AVAILABLE & ON                00413000
NPSWS    MVC   SVCNPSW(8),APISVCNW  RESTORE SVC NEW PSW        @V407595 00414000
         MVC   PRNPSW(8),APIPGMNW   RESTORE PROGRAM NEW PSW    @V407595 00415000
         LCTL  C6,C6,ZEROES         RESTORE CR6                @V407595 00416000
         L     R11,ASYSOP     RESTORE PTR TO OPERATOR VMBLOK   @V4M0106 00417000
         EJECT                                                          00418000
         XC    PGREAD(CLRCNT),PGREAD CLEAR COUNTER AREA IN PSA @V407595 00419000
*                             ON APU THAT MAY HAVE BEEN USED WHILE IN   00420000
*                             ABSOLUTE 0 (I.E., BEFORE THE PSA MOVE)    00421000
         XC    EXOPSW(TIMER-EXOPSW),EXOPSW CLEAR LOW CORE      @VA07843 00422000
*                             BETWEEN EXTERNAL OLD AND INTERVAL TIMER.  00423000
         MVI   CPSTATUS,CPWAIT INDICATE CP IS IDLE             @V407595 00424000
         MVC   IDLEWAIT(N8),HIGHPOS TOTAL APU IDLE STATE TIME  @V407595 00425000
         MVC   PAGEWAIT(N8),HIGHPOS TOTAL PAGE IDLE WAIT TIME  @V407595 00426000
         MVC   IONTWAIT(N8),HIGHPOS TOTAL SYSTEM I/O WAIT TIME @V407595 00427000
         MVC   PROBTIME(N8),HIGHPOS TOTAL SYSTEM PROBLEM STATE @V407595 00428000
*                             TIME.                            @V407595 00429000
         STIDP CPUID          STORE CPU IDENTIFIER             @V407595 00430000
         OI    APSTAT1,APUOPER INDICATE APU NOW OPERATIONAL    @V407595 00431000
         LA    R0,VMAPTIME-VMBLOK(,R0) GET ADDR ATTACHED TIMER @V4M0203 00432000
         ST    R0,TIMEDISP    SAVE DISPLACEMENT IN PSA         @V4M0203 00433000
         OI    APIFLAG1,APUSPIN  LET MAIN PROCESSOR CONTINUE   @V407595 00434000
         LPSW  ENABLEWT       ENABLE FOR EXTERNAL INTERRUPTS.  @V407595 00435000
*                             NOTE THAT CR0 WAS PREVIOUSLY ESTABLISHED. 00436000
         EJECT                                                          00437000
*        START OF ATTACHED PROCESSOR DEFINITIONS                        00438000
         DS    0F                                              @V407595 00439000
APIIOGAP DC    V(DMKIOGAP)    PTR TO DMKIOGAP                  @V407595 00440000
         DS    0D             PSW'S ON DBW BOUNDARY            @V407595 00441000
XWAIT4   DC    X'0002000000000015'                             @V407595 00442000
APISVCNW DC    A(MCHEKENB,DMKSVCIN) SYSTEM SVC NEW PSW         @V407595 00443000
APIPGMNW DC    A(MCHEKENB,DMKPRGIN) SYSTEM PGM NEW PSW         @V407595 00444000
APIRSTNW  DC   A(MCHEKENB,DMKPSADU) SYSTEM RESTART NEW PSW     @V407595 00445000
RESTAP   DC    A(MCHEKENB,DMKAPIAP) RESTART NEW PSW FOR APU    @V407595 00446000
ENABLEWT DC    AL1(EXTMASK),AL3(WAITENB),AL4(0) ENABLED WAIT   @V407595 00447000
DISABLWT DC    AL1(0),AL1(EXTMODE+MCHEK+WAIT),AL4(0),AL2(0)    @V407595 00448000
CR0INTMN DC    AL1(BLKMPX,PAGE4K)                              @V407595 00449000
         DC    AL1(MFAMASK+EMSMASK+XCMASK+CKCMASK+CPTMASK)     @V4M0143 00450000
         DC    AL1(INTMASK+KEYMASK) BITMASK FOR CR0 ON MAIN P. @V407595 00451000
CR0INTAP DC    AL1(BLKMPX,PAGE4K)                              @V407595 00452000
         DC    AL1(MFAMASK+EMSMASK+XCMASK+CKCMASK+CPTMASK)     @V4M0143 00453000
         DC    AL1(INTMASK+KEYMASK) BITMASK FOR CR0 ON APU     @V407595 00454000
MFAONLY  DC    AL1(BLKMPX,PAGE4K,MFAMASK,N0) MFA ONLY FOR CR0  @V407595 00455000
*                                                                       00456000
*        DEFINE DMKAPI FLAGS, REGISTER SAVEAREAS AND CONSTANTS @V407595 00457000
*                                                                       00458000
SAVETIME DS    F              SAVE AREA FOR INTERVAL TIMER     @V407595 00459000
REALSAVE DS    F              REAL STORAGE ADDRESS OF DMKIOGAP @V407595 00460000
RETADDR  DS    F              RETURN TO DMKAPIAP FROM DMKAPIIT @V407595 00461000
APIPRFX  DS    2F             TEMPORARY SAVEAREA FOR PREFIXA/B @V407595 00462000
APIBASE  DS    2F             SAVEAREA FOR BASEREGS            @V407595 00463000
HIGHPOS  DC    X'7FFFFFFFFFFFF000' HIGHEST POSITIVE VALUE IN   @V4M0106 00464000
APSPTIME DC    X'3FFFFFFFFFFFF000' AP SUPERVISOR TIMER VALUE   @VMH0026 00465000
SUB4     DC    X'40000000'                                     @VMH0026 00466000
ADD1     DC    X'00001000'                                     @VMH0026 00467000
*                             DOUBLEWORD.                               00468000
F8192    DC    F'8192'        TWO PAGES                        @V407595 00469000
F20000   DC    F'20000'       LOOP CONTROL FOR INTERVAL TIMER  @V407595 00470000
H32      DC    H'32'          DECREMENT CORE TABLE PTR BELOW   @V407595 00471000
*                             PREFIX AREA (I.E., -8K)                   00472000
APIWORK  DS    H              DMKAPI INTERNAL FLAGS AND W.A.   @V407595 00473000
         ORG   APIWORK                                         @V407595 00474000
APIFLAG1 DS    CL1            FLAG BYTE                        @V407595 00475000
SYSMASK  DS    CL1            STOSM/STNSM WORK AREA            @V407595 00476000
*        DEFINE BITS FOR APIFLAG1                              @V407595 00477000
APUSPIN  EQU   X'80'          SPIN BIT                         @V407595 00478000
API958MG DC    X'151515'                                       @V407595 00479000
         DC    C'DMKAPI958I ATTACHED PROCESSOR NOW OPERATIONAL'         00480000
*                                                              @V407595 00481000
         DC    X'1515'                                         @V407595 00482000
API958LN EQU   *-API958MG                                      @V407595 00483000
TMSG     DC    X'151515'                                       @V407595 00484000
         DC    C'TURN ON THE ATTACHED PROCESSOR''S INTERVAL TIMER'      00485000
         DC    X'1515'                                         @V407595 00486000
TMSGL    EQU   *-TMSG                                          @V407595 00487000
         EJECT                                                          00488000
         PSA                                                   @V407595 00489000
         COPY  EQU                                             @V407595 00490000
         COPY  VMBLOK                                          @V407595 00491000
         COPY  SAVE                                            @V407595 00492000
MCHEKENB EQU   (MCHEK+EXTMODE)*X'10000'                        @V407595 00493000
WAITENB  EQU   (MCHEK+EXTMODE+WAIT)*X'10000'                   @V407595 00494000
PREFIX   EQU   PREFIXA-PSA                                     @V407595 00495000
CLRCNT   EQU   PSENDCLR-PGREAD                                 @V407595 00496000
         END   DMKAPI                                          @V407595 00497000