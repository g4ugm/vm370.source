FMT      TITLE 'DMKFMT     (CP)     VM/370 - RELEASE 6'                 00001990
         ISEQ  73,80          VALIDATE SEQUENCING OF SOURCE             00002980
*.1******************************************************************** 00003970
*                                                                       00004960
* MODULE NAME -           *----------------*                            00005950
*                         *     DMKFMT     *                            00006940
*                         *----------------*                            00007930
*                                                                       00008920
*        EXECUTABLE ENTRY POINTS -                                      00009910
*                                                                       00010900
*              DMKFMT - FORMAT/ALLOCATE PROGRAM ENTRY POINT             00011890
*                                                                       00012880
*                                                                       00013870
* DESCRIPTIVE NAME -                                                    00014860
*                                                                       00015850
*        FORMAT/ALLOCATE STAND-ALONE UTILITY PROGRAM                    00016840
*                                                                       00017830
* FUNCTION -                                                            00018820
*                                                                       00019810
*        USE THE FORMAT/ALLOCATE PROGRAM TO PERFORM PARTIAL OR COMPLETE 00020800
*        CP FORMATTING, ALLOCATION, AND LABELLING OF CP-OWNED DASD      00021790
*        PACKS.  PARAMETERS ARE ACCEPTED FROM A CONSOLE OR THE IPL      00022780
*        DEVICE (CARD READER).                                          00023770
*                                                                       00024760
* NOTES -                                                               00025750
*                                                                       00026740
*        DEPENDENCIES -                                                 00027730
*                                                                       00028720
*              MUST BE RUN IN A STAND-ALONE ENVIRONMENT, EITHER IN      00029710
*              A VIRTUAL MACHINE OR A BARE MACHINE.                     00030700
*                                                                       00031690
*        SYSTEM GLOBAL REGISTER USAGE -                                 00032680
*                                                                       00033670
*              NON-GLOBAL USAGE IS DEFINED IN ENTRY POINT PROLOG        00034660
*                                                                       00035650
*              R0  - PSA ADDRESSABILITY                                 00036640
*              R12 - DMKFMT BASE REGISTER                               00037630
*                                                                       00038620
*        TERMINOLOGY -                                                  00039610
*                                                                       00040600
*              FORMAT   - FILL THE PACK WITH ZERO DATA EXCEPT FOR       00041590
*                         CYLINDER 0, TRACK 0, WHICH IS FILLED WITH     00042580
*                         CP SPECIFIC DATA.                             00043570
*              ALLOCATE - DEFINE CERTAIN SECTIONS OF THE PACK AS        00044560
*                         SPACE TO BE USED BY CP FOR SPOOLING, PAGING,  00045550
*                         USER MINIDISKS, ETC.                          00046540
*                                                                       00047530
* MODULE TYPE - CSECT                                                   00048520
*                                                                       00049510
*        PROCESSOR - ASSEMBLER XF                                       00050500
*                                                                       00051490
*        MODULE DESIGN POINT - 24K                                      00052480
*                                                                       00053470
*        ATTRIBUTES - STAND-ALONE UTILITY PROGRAM                       00054460
*                                                                       00055450
* ENTRY POINT - SEE THE ENTRY POINT PROLOG                              00056440
*                                                                       00057430
* INPUT - SEE THE ENTRY POINT PROLOG                                    00058420
*                                                                       00059410
* OUTPUT - SEE THE ENTRY POINT PROLOG                                   00060400
*                                                                       00061390
* EXIT, NORMAL - SEE THE ENTRY POINT PROLOG                             00062380
*                                                                       00063370
* EXIT, ERROR - SEE THE ENTRY POINT PROLOG                              00064360
*                                                                       00065350
* EXTERNAL REFERENCES - SEE THE ENTRY POINT PROLOG                      00066340
*                                                                       00067330
* TABLES - SEE THE ENTRY POINT PROLOG                                   00068320
*                                                                       00069310
* MACROS - NONE                                                         00070300
*                                                                       00071290
* CHANGE ACTIVITY -                                                     00072280
*                                                                       00073270
*        THE S&D CODE OF EACH ADDED/CHANGED LINE WILL BE UPDATED TO     00074260
*        REFLECT SERVICE AND NEW DEVELOPMENT IN THIS MODULE.            00075250
*                                                                       00076240
*.$******************************************************************** 00077230
         EJECT ,                                                        00078220
*.2******************************************************************** 00079210
*                                                                       00080200
* ENTRY POINT NAME        *---------------*                             00081190
*                         *    DMKFMT     *                             00082180
*                         *---------------*                             00083170
*                                                                       00084160
* DESCRIPTIVE NAME -                                                    00085150
*                                                                       00086140
*        FORMAT/ALLOCATE PROGRAM ENTRY POINT                            00087130
*                                                                       00088120
* FUNCTION -                                                            00089110
*                                                                       00090100
* TO ACCEPT PARAMETERS FROM THE CONSOLE OR IPL DEVICE (CARD READER)     00091090
* AND PERFORM PARTIAL OR COMPLETE FORMATTING, ALLOCATION, AND LABELLING 00092080
* OF CKD TYPE DASD DEVICES.  THE FORMAT PROGRAM WILL ALSO DO            00093070
* WRITE CHECKING TO VERIFY THAT PAGES ARE FORMATTED CORRECTLY.  A COUNT 00094060
* OF "ERROR" PAGES WILL BE MAINTAINED.  NO ALTERNATES WILL BE ASSIGNED. 00095050
* ALL PARAMETER INPUT WILL BE VERIFIED FOR CORRECTNESS.  FOR COMMAND    00096040
* SYNTAX, REFER TO THE BLOCK COMMENTS.                                  00097030
*                                                                       00098020
* ENTRY CONDITIONS -                                                    00099010
*                                                                       00100000
*        NONE WHEN IN A STAND-ALONE ENVIRONMENT                         00100990
*                                                                       00101980
* NORMAL EXIT CONDITIONS -                                              00102970
*                                                                       00103960
*        IN A STAND-ALONE ENVIRONMENT, A WAIT STATE IS ENTERED AND      00104950
*        THE USER WILL HAVE TO RE-IPL.                                  00105940
*                                                                       00106930
* ERROR EXIT CONDITIONS -                                               00107920
*                                                                       00108910
*        RETURN CONTROL TO START OF PROGRAM                             00109900
*                                                                       00110890
* NOTES -                                                               00111880
*                                                                       00112870
*        NON-GLOBAL REGISTER USAGE -                                    00113860
*                                                                       00114850
*              R15 - 1ST BASE REGISTER                                  00115840
*              R12 - 2ND BASE REGISTER                                  00116830
*              R11 - 3RD BASE REGISTER                                  00117820
*              R13 - 4TH BASE REGISTER                                  00118810
*              R8  - 5TH BASE REGISTER                                  00119800
*              R14 - LINKAGE REGISTER                                   00120790
*                                                                       00121780
*              REGISTERS 0-7 AND 9-10 ARE USED AS WORK REGISTERS.       00122770
*                                                                       00123760
*        TABLE USAGE -                                                  00124750
*                                                                       00125740
*              DFODATA   - DEVICE DATA AND FORMATTING PROCEDURE TABLE   00126730
*              LOCDATA   - LOCATE RECORD DATA TABLE                     00127720
*              EXTMAP    - ALLOCATION EXTENT MAP                        00128710
*                                                                       00129700
*        NUMBERED MESSAGES                                              00130690
*                                                                       00131680
* DMKFMT536I XXX REPORTS DISABLED INTERFACE; FLT CODE = XXXX; NOTIFY CE 00132670
* DMKFMT730E DEV XXX NOT OPERATIONAL OR NOT READY                       00133660
* DMKFMT732E MACHINE CHECK                                              00134650
* DMKFMT733E VOLID READ IS VOLID1 NOT VOLID2                            00135640
*            (VOLID1 = VOLUME SERIAL NUMBER FROM THE DASD DEVICE.       00136630
*            VOLID2 = VOLUME SERIAL NUMBER FROM THE CONTROL STATEMENT.) 00137620
* DMKFMT734E TYPE OR CYL INVALID                                        00138610
* DMKFMT735E FATAL DASD I/O ERROR. CSW=XXXXXXXXXXXXXXX                  00139600
* DMKFMT736E IO ERROR XXX CCHHR = XXXXXXXXXX                            00140590
*            SENSE = XXXX...XXXX (UP TO 64 DIGITS)                      00141580
* DMKFMT737E INVALID OPERAND                                            00142570
* DMKFMT738A DEVICE XXX INTERVENTION REQUIRED                           00143560
* DMKFMT739E FLAGGED PRIMARY TRACK HAS NO ALTERNATE ASSIGNED, I/O ERROR 00144550
*            FOLLOWS                                                    00145540
* DMKFMT740E PACK MOUNTED IS 3340-35, NOT 3340-70.  MOUNT ANOTHER OR    00146530
*            RESPECIFY                                                  00147520
* DMKFMT741E DEVICE CUU IS YYYY, NOT YYYY-ZZ AS SPECIFIED.  RESPECIFY   00148510
*            OR NOTIFY SYSTEM SUPPORT                                   00149500
* DMKFMT742E ALLOCATION FUNCTION NOT ALLOWED - FORMAT OF VOLUME IS A    00150490
*            PREREQUISITE                                               00151480
* DMKFMT744E I/O ERROR XXX CODE=E4 CSW=XXXXXXXXXXXXXXXX                 00152470
* DMKFMT756E PROGRAM CHECK PSW = XXXXXXXXXXXXXXXX                       00153460
*                                                                       00154450
*        RESPONSES -                                                    00155440
*                                                                       00156430
*            VM/370 FORMAT/ALLOCATE PROGRAM RELEASE 6                   00157420
*            ENTER FORMAT OR ALLOCATE:                                  00158410
*            FORMAT FUNCTION SELECTED                                   00159400
*            ALLOCATE FUNCTION SELECTED                                 00160390
*            ENTER DEVICE ADDRESS (CUU):                                00161380
*            ENTER DEVICE TYPE:                                         00162370
*            ENTER ALLOCATION DATA FOR VOLUME xxxxxx                    00163360
*            TYPE CYL  CYL                                              00164350
*            .... .... .... (TYPE IN 3 OR 4 DIGIT NUMBERS)              00165340
*            DEVICE XXX VOLUME XXXXXX ALLOCATION ENDED                  00166330
*            ENTER START CYLINDER (XXX OR XXXX) OR "LABEL":             00167320
*            ENTER END CYLINDER (XXX OR XXXX):                          00168310
*            WRITE VERIFICATION NOT PERFORMED UNLESS REQUESTED.         00169300
*            ENTER "YES" FOR WRITE VERIFICATION:                        00170290
*            FORMAT STARTED                                             00171280
*            ENTER DEVICE LABEL:                                        00172270
*            FORMAT DONE                                                00173260
*            WRITE VERIFICATION WAS NOT PERFORMED                       00174250
*            XXXX PAGE RECORDS FLAGGED                                  00175240
*            ALLOCATION RESULTS                                         00176230
*            TEMP XXXX XXXX                                             00177220
*            PERM XXXX XXXX                                             00178210
*            TDSK XXXX XXXX                                             00179200
*            DRCT XXXX XXXX                                             00180190
*            LABEL IS NOW XXXXXX                                        00181180
*            XXXX NO. PAGE RECORDS WITH READ-CHECK ERRORS               00182170
*            NUMBER OF EXTENTS EXCEEDS MAXIMUM - RESPECIFY              00183160
*            NO VALID ALLOCATION RECORD.  ALLOCATE ENTIRE VOLUME OR     00184150
*               FORMAT PAGE 0                                           00185140
*            LOWEST ALLOCATABLE PAGE IS PAGE 2 - RESPECIFY              00186130
*            PAGE NUMBER INVALID - RESPECIFY                            00187120
*            TYPE IS INVALID - RESPECIFY                                00188110
*                                                                       00189100
* OPERATION -                                                           00190090
*                                                                       00191080
*        SEE BLOCK COMMENTS FOR DETAILED OPERATIONS                     00192070
*                                                                       00193060
*        THIS PROGRAM WILL FORMAT (FULL OR PARTIAL), ALLOCATE, AND      00194050
*        LABEL DASD DEVICES USING CONSOLE OR CARD INPUT.  THE DEVICES   00195040
*        WILL BE FORMATTED WITH 4K BYTE SIZE RECORDS.  THE CARD DEVICE  00196030
*        WILL BE SELECTED IF INPUT FOLLOWS THE IPL DECK AT IPL TIME.    00197020
*        IF NO INPUT FOLLOWS THE IPL DECK THEN THE CONSOLE WILL BE      00198010
*        SELECTED.  VOLUME LABELS WILL BE CHECKED FOR ALL OPERATIONS    00199000
*        THE FORMATTING OF CYLINDER OR PAGE 0 AND LABELLING.  CERTAIN   00199990
*        ERRORS DURING I/O ARE CONSIDERED FATAL AND THE FORMAT FUNCTION 00200980
*        IS ABORTED.  OTHER I/O ERRORS ARE TREATED AS SOFT ERRORS.  AT  00201970
*        THE END OF A RUN THE NUMBER OF "SOFT ERROR" RECORDS IS PRINTED 00202960
*        OUT.  FOR LABELLING, VOLUME LABELS MUST BE SIX CHARACTERS LONG 00203950
*        THE ALLOCATION FUNCTION OF THIS PROGRAM SIMPLY PROMPTS FOR THE 00204940
*        TYPE OF ALLOCATION AND UPDATES RECORD 4 ON CYLINDER 0 HEAD 0.  00205930
*                                                                       00206920
*        A. INITIALIZE PROGRAM, AND AFTER IPL, SAVE IPL DEVICE ADDRESS. 00207910
*           LOCATE CONSOLE AND GET CONSOLE ADDRESS.                     00208900
*                                                                       00209890
*        B. TEST FOR CARD INPUT OR CONSOLE INPUT AND WAIT FOR ATTENTION 00210880
*           INTERRUPT.                                                  00211870
*                                                                       00212860
*        C. IF PARAMETER INPUT IS IN IPL DEVICE, READ IN ONE FUNCTION   00213850
*           TO BE DONE AND VALIDATE CARD INPUT.  USE CONSOLE TO PRINT   00214840
*           FUNCTIONS TO BE EXECUTED.  IF NO IPL DEVICE INPUT, USE      00215830
*           CONSOLE TO PROMPT FOR FUNCTION TO BE PERFORMED.             00216820
*                                                                       00217810
*        D. GET DEVICE ADDRESS.                                         00218800
*                                                                       00219790
*        E. GET DEVICE TYPE.                                            00220780
*                                                                       00221770
*        F. ESTABLISH DEVICE CHARACTERISTICS.                           00222760
*                                                                       00223750
*        G. ISSUE SENSE ID COMMAND TO DEVICE.                           00224740
*                                                                       00225730
*        H. HANDLE PROGRAM CHECK/MACHINE CHECK.                         00226720
*                                                                       00227710
*        I. CARD/CONSOLE I/O INTERRUPT ROUTINE.                         00228700
*                                                                       00229690
*        J. VALIDATE CARD INPUT.                                        00230680
*                                                                       00231670
*        K. GET STARTING CYLINDER OR LABEL FOR CKD.                     00232660
*                                                                       00233650
*        M. ASK FOR LABEL.                                              00234640
*                                                                       00235630
*        N. HANDLE LABEL ONLY FUNCTION.                                 00236620
*                                                                       00237610
*        O. SAVE OS FORMAT 4 LABEL INFO FOR FORMATTING CKD CYLINDER 0.  00238600
*                                                                       00239590
*        P. *FORMAT*     - FORMAT FROM THE STARTING CYLINDER UP TO AND  00240580
*                          INCLUDING THE ENDING CYLINDER OF THE DASD    00241570
*                          AS REQUESTED BY CONSOLE OR IPL DEVICE INPUT. 00242560
*                          PROMPT FOR WRITE VERIFICATION IF THE DEVICE  00243550
*                          IS CKD 33XX SERIES.  WRITE VERIFICATION      00244540
*                          ONLY IF REQUESTED.                           00245530
*                                                                       00246520
*        Q. RESUME CKD FORMATTING FOLLOWING INTERRUPT RESOLUTION.       00247510
*                                                                       00248500
*        R. ADVANCE TO NEXT CYLINDER IN EXTENT FOR CKD FORMAT.          00249490
*                                                                       00250480
*        U. STIO - WRITE AND VERIFY PAGE SIZE RECORDS.                  00251470
*                                                                       00252460
*        V. CLEAN UP OPERATION; THEN GO GET NEW FUNCTION.               00253450
*                                                                       00254440
*        W. HANDLE FATAL ERROR ENCOUNTERED.                             00255430
*                                                                       00256420
*        X. ALLOCATE FUNCTION INITIALIZATION.                           00257410
*                                                                       00258400
*        Y. FETCH AND SET ALLOCATION TYPES.                             00259390
*                                                                       00260380
*        Z. *ALLOCATE*     - READ AND VERIFY CP VOLUME LABEL AND UPDATE 00261370
*                            ALLOCATION TABLE IN CORE FROM CONSOLE OR   00262360
*                            IPL DEVICE INPUT.                          00263350
*                                                                       00264340
*        BB. WRITE OUT ALLOCATION TABLE TO DASD.                        00265330
*                                                                       00266320
*        CC. WRITE OUT ALLOCATION TABLE TO CONSOLE.                     00267310
*                                                                       00268300
*        DD. HANDLE DASD I/O INTERRUPTS.                                00269290
*                                                                       00270280
*        EE. HANDLE TRACK CONDITION CHECK.                              00271270
*                                                                       00272260
*        FF. HANDLE READ OR SEARCH ID FAILURE.                          00273250
*                                                                       00274240
* SUBROUTINES:                                                          00275230
*                                                                       00276220
*    LNGCALC  - CALCULATE LENGTH OF WORD IN INDATA FIELD.               00277210
*                                                                       00278200
*    WMSG/WMSG2 - WRITE A MESSAGE ON THE CONSOLE.                       00279190
*                                                                       00280180
*    RMSG     - READ A RESPONSE FROM THE CONSOLE.                       00281170
*                                                                       00282160
*    GRAPHID  - GRAPHIC DEVICE INDICATOR ROUTINE CALLED TO READ FROM    00283150
*               OR WRITE TO GRAPHIC TYPE DEVICES.                       00284140
*                                                                       00285130
*    XBIN     - CHECK TO SEE IF INPUT IS VALID AND HAS CORRECT NUMBERS. 00286120
*               VALID NUMBERS ARE C1-C6 AND F0-F9.                      00287110
*                                                                       00288100
*    DIGBIN   - CONVERT EBCDIC NUMERIC VALUES TO BINARY.                00289090
*                                                                       00290080
*    CONVZER  - CONVERT BINARY NUMBERS TO PRINTABLE FORMAT.             00291070
*                                                                       00292060
*    DFOADSET - SCAN DFOTABLE UNTIL MATCHING DEVICE TYPE IS FOUND AND   00293050
*               GET THE ENTRY ADDRESS.                                  00294040
*                                                                       00295030
*    UPHDREC  - UPDATE THE RECORD NUMBERS AND HEAD NUMBERS IN CCW DATA  00296020
*               ACCORDING TO DFOTABLE ENTRY.                            00297010
*                                                                       00298000
*    SENSIT   - OBTAIN SENSE INFORMATION.                               00298990
*                                                                       00299980
*    SENSIT2  - PRINT SENSE AND CCHH ERROR INFORMATION.                 00300970
*                                                                       00301960
*    FMT744   - DISPLAY MESSAGE 744E FOLLOWING A SENSE ID FAILURE.      00302950
*                                                                       00303940
*    UNPKLOOP - UNPACK/TRANSLATE DATA, BLANK-FILL TO RIGHT BOUNDARY.    00304930
*                                                                       00305920
*    CORRCSW  - CORRECT THE CSW ADDRESS FOLLOWING AN IMPRECISE ENDING   00306910
*               CONDITION.                                              00307900
*                                                                       00308890
*    STRTIO   - ISSUE START I/O TO A DEVICE PRECEDED BY A TIO TO CLEAR  00309880
*               DEVICE STATUS.                                          00310870
*                                                                       00311860
*    STRTIO1  - ISSUE START I/O TO A DEVICE WITHOUT A TIO.              00312850
*                                                                       00313840
*    ALTCHK   - CHECK THE POINTERS IN FLAGGED PRIMARY TRACK AND         00314830
*               ALTERNATE TRACK TO SEE THAT EACH POINTS TO THE OTHER    00315820
*               AND RETURN CCHH ADDRESS OF WHICHEVER WE ARE CURRENTLY   00316810
*               NOT AT.                                                 00317800
*                                                                       00318790
*    SENSCCHH - COMPUTE CCHH FROM SENSE DATA READ PREVIOUSLY.           00319780
*                                                                       00320770
*.$******************************************************************** 00321760
         EJECT ,                                                        00322750
DMKFMT   START X'80'                                                    00323740
         SPACE ,                                                        00324730
*.3******************************************************************** 00325720
*                                                                       00326710
* OPERATION -                                                           00327700
*                                                                       00328690
* A. INITIALIZE PROGRAM AND SAVE IPL ADDRESS                            00329680
*                                                                       00330670
*        1. SET UP REGISTERS 8,11,12,13, AND 15 AS BASE REGISTERS.      00331660
*        2. GET IPL DEVICE ADDRESS FROM I/O OLD PSW AND STORE IT IN     00332650
*           IPLDEV.                                                     00333640
*        3. STORE PERTINENT INFORMATION CONCERNING OS LABELS AND        00334630
*           ALTERNATE TRACK INFORMATION.                                00335620
*        4. DISPLAY THE FMT TITLE MESSAGE.                              00336610
*        5. DETERMINE WHETHER INPUT IS FROM THE IPL DEVICE OR THE       00337600
*           CONSOLE.                                                    00338590
*                                                                       00339580
* LOCAL REGISTER USAGE -                                                00340570
*                                                                       00341560
*        R4  - TITLE MESSAGE ADDRESS                                    00342550
*        R10 - IPL UNIT ADDRESS                                         00343540
*        R14 - WORK                                                     00344530
*                                                                       00345520
*.$******************************************************************** 00346510
         SPACE ,                                                        00347500
         BALR  R15,0          FIRST BASE REGISTER                       00348490
         USING PSA,R0         PSA ADDRESSABILITY                        00349480
         USING *,R15,R12,R11,R13,R8 FMT BASE REGISTERS                  00350470
         LA    R12,2048(R15)  LOAD                                      00351460
         LA    R12,2048(R12)  SECOND BASE                               00352450
         LA    R11,2048(R12)  LOAD                                      00353440
         LA    R11,2048(R11)  THIRD BASE                                00354430
         LA    R13,2048(R11)  LOAD                                      00355420
         LA    R13,2048(R13)  FOURTH BASE                               00356410
         LA    R8,2048(R13)   LOAD                                      00357400
         LA    R8,2048(R8)    FIFTH BASE                                00358390
         LCTL  C2,C2,ENCHAN   ENABLE CHANNELS 6 THRU 15                 00359380
         SPACE ,                                                        00360370
*---------------------------------------------------------------------- 00361360
*        GET IPL DEVICE ADDRESS AND STORE IT                            00362350
*---------------------------------------------------------------------- 00363340
         SPACE ,                                                        00364330
         MVC   120(8),=A(0,IRA) SET UP I/O NEW PSW                      00365320
         LH    R14,2          GET IPL DEVICE FROM I/O OLD PSW           00366310
         TIO   0(R14)         CLEAR PENDING STATUS                      00367300
         BC    2,*-4          LOOP IF BUSY                              00368290
         STH   R14,IPLDEV     SAVE IPL DEVICE                           00369280
         MVC   104(8),PRNUPSW PROGRAM NEW PSW                           00370270
         MVC   112(8),MCNUPSW MACHINE CHECK NEW PSW                     00371260
         SPACE ,                                                        00372250
*---------------------------------------------------------------------- 00373240
*        IF CERTAIN INFORMATION IN THE OS FORMAT 4 LABEL ON TRACK 0     00374230
*        CYLINDER 0 IS DESTROYED, NO ADDITIONAL ALTERNATE TRACKS CAN BE 00375220
*        ASSIGNED UNTIL THE VOLUME IS RE-FORMATTED BY DSF (DEVICE       00376210
*        SUPPORT FACILITIES).  WHEN CP FORMAT/ALLOCATE OR DSF IS USED   00377200
*        TO FORMAT A VOLUME, THIS INFORMATION IS PRESERVED.             00378190
*---------------------------------------------------------------------- 00379180
         SPACE ,                                                        00380170
         MVC   SAVEVOL1(L'OSLABEL),OSLABEL SAVE OSLABEL INFO            00381160
         MVC   SAVEFMT4(96),FMT4DATA SAVE CP'S FMT4 CONTENTS            00382150
         MVC   WKSEEK(118),SEEKA SAVE SEEK FIELDS                       00383140
         MVC   RNSTUF(96),R1STUF SAVE 2314 RECORD FIELDS                00384130
         MVC   RNDATA(RNBYTE1),REC1 SAVE DASD RECORD FIELDS             00385120
         MVC   RNDATA+RNBYTE1(RNBYTE2),REC1+RNBYTE1   ...               00386110
         MVC   RNDATA1(RNBYTES1),RECXX3                                 00387100
         SPACE ,                                                        00388090
*---------------------------------------------------------------------- 00389080
*        DISPLAY TITLE MESSAGE 'VM/370 FORMAT/ALLOCATE PROGRAM'.        00390070
*---------------------------------------------------------------------- 00391060
         SPACE ,                                                        00392050
STMSG    EQU   *                                                        00393040
         XC    SAVE14(4),SAVE14 ZERO OUT FIELD                          00394030
         LA    R4,TITLE       GET TITLE ADDRESS                         00395020
         BAL   R14,WMSG2      AND PRINT TITLE MESSAGE                   00396010
         SPACE ,                                                        00397000
*---------------------------------------------------------------------- 00397990
*        DETERMINE WHETHER THIS IS CARD INPUT OR CONSOLE INPUT.  IF     00398980
*        THE CDSW2 SWITCH CONTAINS X'FF', THE IPL DEVICE IS STARTED     00399970
*        AND USED FOR INPUT.  OTHERWISE, CONSOLE INPUT IS ASSUMED.      00400960
*---------------------------------------------------------------------- 00401950
         SPACE ,                                                        00402940
GETCARD  MVC   CAW(4),=A(CARDCCW) SET CAW                               00403930
         MVC   120(8),CONSIRA     SET UP NEW IO PSW                     00404920
         TM    CDSW2,X'FF'    CARD SWITCH ON                            00405910
         BZ    NOCARD         NO- BRANCH                                00406900
         LH    R10,IPLDEV     IPL ADDRESS IN R10                        00407890
         TIO   0(R10)         CLEAR STATUS                              00408880
         BC    2,*-4          BRANCH BACK IF BUSY                       00409870
GETSIO   EQU   *                                                        00410860
         SIO   0(R10)         START IPL DEVICE                          00411850
         BC    8,XWAIT        IF STARTED WAIT                           00412840
         BC    2+1,NOCARD     CC2, CC3 (BUSY OR INOP), IGNORE           00413830
         TM    CSW+4,X'70'    DEV/CU BUSY OR CU END?                    00414820
         BNZ   GETSIO         YES, REDRIVE SIO                          00415810
NOCARD   MVC   CDSW(2),=X'0000' CLEAR CARD SWITCHES                     00416800
         XC    ALLOSW,ALLOSW    CLEAR ALLOC SWITCH USED IN CARD MODE    00417790
         XC    ALLOERR,ALLOERR  CLEAR ALLOC ERROR SWITCH - CARD MODE    00418780
         B     SELECT         NO, USE CONSOLE                           00419770
         EJECT ,                                                        00420760
*.3******************************************************************** 00421750
*                                                                       00422740
* OPERATION -                                                           00423730
*                                                                       00424720
* B. HANDLE CONSOLE ERRORS OR NORMAL ENDING CONDITIONS                  00425710
*                                                                       00426700
*        1. FOR 3215/3210/1052, THAT IS NOT DEVICE 009 OR 01F GO        00427690
*           WAIT FOR I/O INTERRUPT.                                     00428680
*        2. SET DEVICE 009 FOR GRAPHIC DEVICE.                          00429670
*        3. CHANGE DATA STEAM TO HANDLE 3277 SCREEN SIZE, GO TO         00430660
*           OPERATION A STEP 4.                                         00431650
*        4. IF NOT 3277, CHANGE DATA STREAM TO HANDLE 3278 MOD 2A       00432640
*           SCREEN SIZE, GO TO OPERATION A STEP 4.                      00433630
*        5. IF DEVICE 009 FAILS, SET DEVICE ADDRESS TO 01F AS 3215,     00434620
*           GO TO OPERATION A STEP 4.                                   00435610
*        6. IF DEVICE 01F IS NOT A 3215, CHANGE DATA STEAM TO           00436600
*           HANDLE 3277 SCREEN SIZE, GO TO OPERATION A STEP 4.          00437590
*        7. IF NOT 3277, CHANGE DATA STEAM TO HANDLE 3278 MOD 2A        00438580
*           SCREEN SIZE, GO TO OPERATION A STEP 4.                      00439570
*        8. IF DEVICE 01F FAILS, WAIT FOR I/O INTERRUPT.                00440560
*        9. AFTER I/O INTERRUPT OCCURS (FROM 'LPSW CONWAIT'), GET       00441550
*           ADDRESS AND TRY.                                            00442540
*                                                                       00443530
* LOCAL REGISTER USAGE -                                                00444520
*                                                                       00445510
*        NONE                                                           00446500
*                                                                       00447490
*.$******************************************************************** 00448480
         SPACE ,                                                        00449470
IRA      EQU   *                                                        00450460
         TM    PARM2,X'80'    IS NOT OPERATIONAL INDICATED              00451450
         BO    CONPARM        YES, GO TEST FOR CORRECT DEVICE           00452440
         TM    CSW+4,UC       IS UNIT CHECK INDICATED ?                 00453430
         BZ    CONSINT        NO, GO TO ERROR HANDLER                   00454420
         SPACE ,                                                        00455410
*---------------------------------------------------------------------- 00456400
*        IF A UNIT CHECK IS INDICATED, THEN ISSUE A SENSE TO CLEAR THE  00457390
*        CONTINGENT CONNECTION FROM A POSSIBLE CONTROL UNIT AT THIS     00458380
*        ADDRESS. THIS ALLOWS I/O TO CONTINUE FOR OTHER DEVICES ON THE  00459370
*        SAME CONTROLLER.                                               00460360
*        FOR A 3215/3210/1052 CONSOLE, GO WAIT FOR AN I/O INTERRUPT     00461350
*        BEFORE CONTINUING.  FOR AN ADDRESS OF 01F, THIS MUST BE A      00462340
*        GRAPHIC CONSOLE SO GO CHECK FOR IT.  IF NOT (WE USED X'009' AS 00463330
*        DEFAULT CONSOLE), THEN TRY WRITING TO A X'01F' ADDRESS NOW.    00464320
*---------------------------------------------------------------------- 00465310
         SPACE ,                                                        00466300
         LA    R1,CCWSENSE    GET SENSE CCW                             00467290
         ST    R1,CAW         SAVE ADDRESS IN LOW STORAGE               00468280
         XC    SENSE,SENSE    CLEAR SENSE BYTE SAVE AREA                00469270
SIOBSY   SIO   0(R10)         CLEAR CONTINGENT CONNECTION               00470260
         BC    2,SIOBSY       CC2, BUSY, RE-ISSUE SENSE                 00471250
         BC    8,CLRINT       CC0, CLEAR INTERRUPTS WITH TIO            00472240
         BC    1,CONPARM      CC3, DEVICE NOT OPERATIONAL               00473230
         CLI   CSW+4,SM+BUSY+CUE  TEMPORARY CONTROL UNIT BUSY?          00474220
         BE    SIOBSY         YES, GO RETRY                             00475210
CLRINT   DS    0H             AFTER GOOD SIO FOR SENSE                  00476200
TIOBSY   TIO   0(R10)         CLEAR ANY INTERRUPTS                      00477190
         BC    2,TIOBSY       CC2, BUSY, RE-ISSUE TIO                   00478180
         SPACE ,                                                        00479170
CONPARM  EQU   *                                                        00480160
         NI    PARM2,X'FF'-X'80' MASK OFF DEVICE NOT OPERAT.            00481150
         TM    PARM,PARM321   IS THIS A 3215/3210/1052                  00482140
         BNO   TESTGRAP       NO, TRY AS A GRAPHICS DEVICE              00483130
         CLC   LAB3270A+2(2),ADDR3 HAVE TRIED THIS AS 3278 2A           00484120
         BE    TESTMORE       YES, CHECK IF THIS IS DEV 01F             00485110
         SPACE ,                                                        00486100
*---------------------------------------------------------------------- 00487090
*        FOR GRAPHIC DISPLAY TERMINALS, CHANGE THE DATA STREAM TO       00488080
*        HANDLE THE VARYING SCREEN SIZES.  THE DATA TO DISPLAY ON THE   00489070
*        GRAPHIC SCREEN INCLUDES THE CURSOR AND THE STATUS IN THE       00490060
*        LOWER RIGHT HAND CORNER.  THE CONTROL CCWS ACCESS THE LAB3270X 00491050
*        AREAS TO PUT THESE ON THE SCREEN.  TABLE70 HAS THE ADDRESSES   00492040
*        OF EACH LINE AND COLUMN AND THESE ADDRESSES ARE SPECIFIED      00493030
*        WITHIN THE LAB3270X AREAS.                                     00494020
*---------------------------------------------------------------------- 00495010
         SPACE ,                                                        00496000
TESTGRAP EQU   *                                                        00496990
         TM    PARM,PARMGRP   IS THIS A GRAPHIC DEVICE ?                00497980
         BO    TES3270T       YES, GO TEST FOR 3270 DEVICE              00498970
         OI    PARM,PARMGRP+PARMCLE SET GRAPHIC & ERASE                 00499960
*                             INDICATORS                                00500950
*---------------------------------------------------------------------- 00501940
*        FOR A 3277, THE MAXIMUM ALLOWABLE SCREEN SIZE IS 24 LINES.     00502930
*        WE MUST THEREFORE CHANGE THE DATA STREAM TO HANDLE THIS SCREEN 00503920
*        SIZE.                                                          00504910
*---------------------------------------------------------------------- 00505900
         SPACE ,                                                        00506890
TES3270T EQU   *                                                        00507880
         TM    PARM,PARMGRP+PARM327 IS THIS A 3270 DEVICE ?             00508870
         BO    TEST3278       YES, GO CHECK IF 3278                     00509860
         OI    PARM,PARM327   SET THE 3270 INDICATOR                    00510850
         MVC   LAB3270A+2(2),ADDR1 CURSOR START-1                       00511840
         MVC   LAB3270A+8(2),ADDR2 RUNNING STATUS START-1               00512830
         MVC   LAB3270B+2(2),ADDR1 CURSOR START-1                       00513820
         MVC   LAB3270B+8(2),ADDR2 CP READ STATUS START-1               00514810
         MVC   LAB3270C+2(2),ADDR2 HOLDING STATUS START-1               00515800
         MVC   LAB3270D+2(2),ADDR1 CURSOR START-1                       00516790
         MVC   LAB3270E+5(2),ADDR1 CURSOR START-1                       00517780
         MVC   LAB3270E+12(2),ADDR2 STATUS AREA                         00518770
         MVC   ADDR5,ADDR6    ESTABLISH ADDR FOR CURSOR CHECK           00519760
         MVC   MAXLEN,LEN3270 SET THE MAXIMUM LENGTH                    00520750
         B     STMSG          GO TRY THIS ADDR FOR GRAPHICS             00521740
         SPACE ,                                                        00522730
*---------------------------------------------------------------------- 00523720
*        FOR A 3278 MOD 2A, THE MAXIMUM ALLOWABLE SCREEN SIZE IS 20     00524710
*        LINES.  WE MUST THEREFORE CHANGE THE DATA STREAM FOR THIS      00525700
*        SCREEN SIZE.                                                   00526690
*---------------------------------------------------------------------- 00527680
         SPACE ,                                                        00528670
TEST3278 EQU *                                                          00529660
         CLC   LAB3270A+2(2),ADDR3 HAVE WE TRIED 3278 LOGIC             00530650
         BE    TEST3215           MUST BE 3210-3215-1052                00531640
         MVC   LAB3270A+2(2),ADDR3 CURSOR START-1                       00532630
         MVC   LAB3270A+8(2),ADDR4 RUNNING STATUS START-1               00533620
         MVC   LAB3270B+2(2),ADDR3 CURSOR START-1                       00534610
         MVC   LAB3270B+8(2),ADDR4 CP READ STATUS START-1               00535600
         MVC   LAB3270C+2(2),ADDR4 HOLDING STATUS START-1               00536590
         MVC   LAB3270D+2(2),ADDR3 CURSOR START-1                       00537580
         MVC   LAB3270E+5(2),ADDR3 CURSOR START-1                       00538570
         MVC   LAB3270E+12(2),ADDR4 STATUS AREA                         00539560
         MVC   ADDR5,ADDR7    ESTABLISH ADDR FOR CURSOR CHECK           00540550
         MVC   MAXLEN,LEN3278 SET THE MAXIMUM LENGTH                    00541540
         B     STMSG          GO TRY THIS ADDR FOR GRAPHICS             00542530
         SPACE ,                                                        00543520
*---------------------------------------------------------------------- 00544510
*        TEST FOR 3215 DEVICE                                           00545500
*---------------------------------------------------------------------- 00546490
         SPACE ,                                                        00547480
TEST3215 EQU   *                                                        00548470
         MVI   PARM,PARM321   SET THE 3210-3215-1052 FLAG               00549460
         TM    PARM,PARM01F   HAVE WE TRIED DEVICE 01F?                 00550450
         BO    TESTMORE       YES, SEE IF THIS REALLY IS 01F            00551440
         OI    PARM,PARM01F   SET 01F FLAG                              00552430
         MVC   CONSOL,CON01F  SET DEVICE ADDRESS 01F                    00553420
         MVC   LAB3270A+2(2),ADDR5  RESET 3278 MOD 2A FLAG              00554410
         B     STMSG          TRY 01F AS A 3215                         00555400
TESTMORE DS    0H                                                       00556390
         CLC   CONSOL,CON01F  IS THIS REALLY DEVICE 01F                 00557380
         BNE   STMSG          NO, GO TRY THIS ADDRESS A 3215            00558370
         MVC   120(8),=A(0,CONRET) CHANGE THE I/O NEW PSW               00559360
FMTLPSW  DS    0H                                                       00560350
         NI    PARM,PARM01F   LEAVE ON ONLY 01F FLAG                    00561340
         LPSW  WAITCON        WAIT FOR I/O INTERRUPT                    00562330
CONRET   EQU   *                                                        00563320
         OC    CSW,CSW        CHANNEL AVAILABLE INTERRUPT ?             00564310
         BZ    FMTLPSW        YES, GO WAIT FOR INTERRUPT                00565300
         TM    CSW+4,CUE      CUE FROM IPL DEVICE?                      00566290
         BNO   GETADDR        NO, GET INTERRUPTING DEVICE ADDR          00567280
         LPSW  WAITCON        WAIT FOR A CONSOLE I/O INTERRUPT          00568270
         SPACE ,                                                        00569260
GETADDR  DS    0H                                                       00570250
         MVC   CONSOL(2),58   GET THE DEVICE ADDRESS                    00571240
         MVC   120(8),=A(0,IRA) CHANGE THE I/O NEW PSW                  00572230
         B     STMSG          GO TRY THIS ADDRESS                       00573220
*.3******************************************************************** 00574210
*                                                                       00575200
* OPERATION -                                                           00576190
*                                                                       00577180
* C. DISPLAY 'ENTER FORMAT OR ALLOCATE' MESSAGE AND READ IN RESPONSE.   00578170
*                                                                       00579160
*        1. LOAD FORMAT OR ALLOCATE MESSAGE AND GO READ RESPONSE.       00580150
*           IF CARD INPUT, THE PROMPTER MESSAGE INCLUDES THE RESPONSE   00581140
*           THAT WAS ALREADY SPECIFIED IN CARDS.                        00582130
*        2. ISSUE MESSAGE INDICATING WHICH FUNCTION WAS SELECTED.       00583120
*        3. GET DEVICE ADDRESS AT OP D.                                 00584110
*                                                                       00585100
* LOCAL REGISTER USAGE -                                                00586090
*                                                                       00587080
*        R4  - WORK                                                     00588070
*        R14 - LINKAGE                                                  00589060
*                                                                       00590050
*.$******************************************************************** 00591040
         SPACE ,                                                        00592030
*---------------------------------------------------------------------- 00593020
*        ISSUE MESSAGE 'ENTER FORMAT OR ALLOCATE:' AND READ THE         00594010
*        RESPONSE.  FOR CARD INPUT, THE CARD CONTAINS THE RESPONSE TO   00595000
*        READ.                                                          00595990
*---------------------------------------------------------------------- 00596980
         SPACE ,                                                        00597970
SELECT   LA    R4,FORA        SET UP TO PRINT FORMAT OR ALLOCATE        00598960
         BAL   R14,WMSG       FORMAT OR ALLOCATE MSG                    00599950
         MVI   FLAG,X'00'     CLEAR FLAG BTYE                           00600940
         BAL   R14,RMSG       GO READ RESPONSE                          00601930
         TM    CSW+4,UE       UNIT EXCEPTION OR UNIT CK                 00602920
         BO    SELECT         YES,BRANCH                                00603910
         XC    FIELDA,FIELDA  CLEAR FIELDA                              00604900
         XC    FIELDB,FIELDB  CLEAR FIELDB                              00605890
         BAL   R14,LNGCALC    GET WORD LENGTH                           00606880
         BNZ   SELECT         BR IF LENGTH = 0 OR GT 8                  00607870
         EX    R4,TSTALLOC    HOW ABOUT ALLOCATE ?                      00608860
         BE    ALLOC          IF SO, HANDLE IT ....                     00609850
         EX    R4,TSTFRMT     IS IT FORMAT ?                            00610840
         BNE   SELECT         IF NOT, TRY AGAIN                         00611830
         SPACE ,                                                        00612820
*---------------------------------------------------------------------- 00613810
*        FOR FORMAT, DISPLAY THE MESSAGE 'FORMAT FUNCTION SELECTED' AND 00614800
*        GO GET THE DEVICE ADDRESS.  FOR ALLOCATE, DISPLAY THE MESSAGE  00615790
*        'ALLOCATION FUNCTION SELECTED' AND GO GET DEVICE ADDRESS.      00616780
*---------------------------------------------------------------------- 00617770
         SPACE ,                                                        00618760
FORM     MVC   FLAG(1),COMWOK SET FLAG TO 'F'                           00619750
         LA    R4,FMTMSG      SET UP MESSAGE                            00620740
         BAL   R14,WMSG       WRITE MESSAGE                             00621730
         B     DEVICEAD       GO GET DEVICE ADDRESS                     00622720
         SPACE ,                                                        00623710
ALLOC    MVC   FLAG(1),COMWOK SET FLAG TO 'A'                           00624700
         NI    FLAG1,255-ALLOCWR TURN OFF FLAG TO WRITE                 00625690
         LA    R4,ALLOCMSG    SET UP ALLOCATE MESSAGE                   00626680
         BAL   R14,WMSG       WRITE MESSAGE                             00627670
*.3******************************************************************** 00628660
*                                                                       00629650
* OPERATION -                                                           00630640
*                                                                       00631630
* D. GET DEVICE ADDRESS                                                 00632620
*                                                                       00633610
*       1. WRITE DEVICE MESSAGE AND GET RESPONSE.                       00634600
*       2. MOVE THE DEVICE ADDRESS INTO ANY ERROR MESSAGES THAT MIGHT   00635590
*          HAVE TO BE ISSUED LATER.                                     00636580
*       3. ONLY THREE HEX DIGITS ALLOWED; MAKE SURE 3 ENTERED AND ARE   00637570
*          VALID.                                                       00638560
*       4. ISSUE SENSE AND VERIFY THAT THE DEVICE IS OPERATIONAL AND    00639550
*          READY.                                                       00640540
*                                                                       00641530
* LOCAL REGISTER USAGE                                                  00642520
*                                                                       00643510
*        R4  - MESSAGE ADDRESS                                          00644500
*        R5  - DASD ADDRESS FOR SIO                                     00645490
*        R7  - LINKAGE                                                  00646480
*        R8  - ADDRESS OF INPUT                                         00647470
*        R9  - MESSAGE LENGTH                                           00648460
*        R10 - HEX DEVICE ADDRESS                                       00649450
*        R14 - LINKAGE                                                  00650440
*                                                                       00651430
*.$******************************************************************** 00652420
         SPACE ,                                                        00653410
*---------------------------------------------------------------------- 00654400
*        ISSUE MESSAGE 'ENTER DEVICE ADDRESS (CUU):' AND READ RESPONSE. 00655390
*---------------------------------------------------------------------- 00656380
         SPACE ,                                                        00657370
DEVICEAD LA    R4,ADDRESS     REQUEST DEVICE ADDRESS                    00658360
         BAL   R14,WMSG       WRITE MESSAGE                             00659350
         BAL   R14,RMSG       READ RESPONSE                             00660340
         TM    CSW+4,UE       CANCEL KEY OR UNIT CHECK                  00661330
         BO    DEVICEAD       TRY AGAIN IF CANCEL                       00662320
*        'OR'ING ANYTHING WITH BLANKS SETS IT TO UPPER CASE.            00663310
         OC    INDATA(4),BLANKS8 CONVERT TO UPPER CASE                  00664300
         CLI   INDATA+3,X'40' ANYTHING EXTRA ?                          00665290
         BNE   DEVICEAD       YES, GO ISSUE DEVICE MESSAGE              00666280
         SPACE ,                                                        00667270
*---------------------------------------------------------------------- 00668260
*        MOVE DEVICE ADDRESS INTO MESSAGES IN CASE ERROR OCCURS LATER.  00669250
*---------------------------------------------------------------------- 00670240
         SPACE ,                                                        00671230
         MVC   WR1+16(3),INDATA    MOVE IN THE DEV ADD                  00672220
         MVC   ALLEND+8(3),INDATA  MOVE DEVICE ADD INTO MESSAGES        00673210
         MVC   IOERR+21(3),INDATA  MOVE DEVICE ADD INTO MESSAGES        00674200
         MVC   IPLERROR+17(3),INDATA   MOVE DEVICE ADD INTO MESSAGE     00675190
         MVC   WRDEV1AD,INDATA     DEVICE ADDRESS INTO MESSAGE          00676180
         LA    R9,3           PUT MESSAGE LENGTH IN REG9                00677170
         SPACE ,                                                        00678160
*---------------------------------------------------------------------- 00679150
*        PARAMETER MUST BE THREE HEX DIGITS LONG - MAKE SURE ONLY THREE 00680140
*        DIGITS ENTERED AND THAT THEY ARE VALID.                        00681130
*---------------------------------------------------------------------- 00682120
         SPACE ,                                                        00683110
         ST    R8,REG8SAVE    SAVE R8 ACROSS BAL                        00684100
         LA    R8,INDATA      ADDRESS OF INPUT IN R8                    00685090
         BAL   R7,XBIN        GO TO HEX CONVERSION ROUTINE              00686080
         L     R8,REG8SAVE    RESTORE R8 FROM SAVE                      00687070
         LTR   R10,R10        WAS IT BAD HEX ADDRESS                    00688060
         BM    DEVICEAD       YES, TRY AGAIN                            00689050
         SPACE ,                                                        00690040
*---------------------------------------------------------------------- 00691030
*        ISSUE SENSE TO THE DEVICE.  IF INTERVENTION REQUIRED OR NOT    00692020
*        READY DEVICE, THEN ISSUE 'DEV XXX NOT OPERATIONAL OR NOT       00693010
*        READY'.  RE-ISSUE REQUEST TO ENTER DEVICE ADDRESS.  OTHERWISE, 00694000
*        GO TO DEVTYPE TO GET DEVICE TYPE.                              00694990
*---------------------------------------------------------------------- 00695980
         SPACE ,                                                        00696970
         STH   R10,DSKADD     SAVE HEX DEVICE ADDRESS                   00697960
         MVC   CAW(4),=A(CCWSENSE) SET THE CAW.                         00698950
         LH    R5,DSKADD      GET THE DASD ADDRESS FOR STARTIO          00699940
         BAL   R14,STRTIO     GO START THE I/O. IS IT THERE?            00700930
         BC    1,NOTHERE      NOPE - ARGH.                              00701920
         TIO   0(R10)         YES - DRAIN THE INT.                      00702910
         BC    2,*-4          . . .                                     00703900
         TM    SENSEB0,INTREQ INTERVENTION REQUIRED (DISK NOT           00704890
*                             READY OR PACK NOT MOUNTED)?               00705880
         BZ    DEVTYPE        NO, IT'S READY.                           00706870
NOTHERE  EQU   *                                                        00707860
         LA    R4,WR1         NO,SET UP NOT AVAILABLE MESSAGE           00708850
         BAL   R14,WMSG       WRITE MESSAGE                             00709840
DVCAGAIN TM    CDSW2,X'FF'    IS SW ON?                                 00710830
         BO    BADINPUT       IF ON BRANCH                              00711820
         B     DEVICEAD       GIVE HIM A CHANCE TO ENTER                00712810
*                             CORRECTED ADDRESS OR TO READY THE         00713800
*                             DEVICE AND RE-ENTER SAME ADDRESS.         00714790
*.3******************************************************************** 00715780
*                                                                       00716770
* OPERATION -                                                           00717760
*                                                                       00718750
* E. GET DEVICE TYPE                                                    00719740
*                                                                       00720730
*        1. ISSUE 'ENTER DEVICE TYPE:' MESSAGE AND READ RESPONSE.       00721720
*        2. FOR CKD, GO TO OP F.                                        00722710
*        3. CALCULATE THE MAXIMUM PAGE SIZE ALLOWED TO BE SPECIFIED     00723700
*           BY THE USER AND THEN GO OP K OR OP L FOR FORMAT OR OP M     00724690
*           FOR LABEL OR ALLOCATE.                                      00725680
*                                                                       00726670
* LOCAL REGISTER USAGE -                                                00727660
*                                                                       00728650
*        R3  - WORK                                                     00729640
*        R4  - WORK/MESSAGE ADDRESS                                     00730630
*        R5  - WORK                                                     00731620
*        R6  - WORK                                                     00732610
*        R7  - WORK                                                     00733600
*        R9  - READ DEVICE CHARACTERISTICS CCW ADDRESS                  00734590
*        R10 - DEVICE ADDRESS                                           00735580
*        R14 - LINKAGE                                                  00736570
*                                                                       00737560
*.$******************************************************************** 00738550
         SPACE ,                                                        00739540
*---------------------------------------------------------------------- 00740530
*        ISSUE MESSAGE 'ENTER DEVICE TYPE:' AND READ THE USER RESPONSE. 00741520
*        CHECK FOR CORRECT DEVICE TYPE LENGTH AND THEN MOVE THE IT INTO 00742510
*        WRDEV1SP, WHICH IS THE USER-SPECIFIED DEVICE TYPE.             00743500
*---------------------------------------------------------------------- 00744490
         SPACE ,                                                        00745480
DEVTYPE  EQU   *                                                        00746470
         LA    R4,TYPMSG      SET UP TO TYPE MESSAGE                    00747460
         BAL   R14,WMSG       WRITE MESSAGE                             00748450
         BAL   R14,RMSG       READ RESPONSE                             00749440
         TM    CSW+4,UE       CANCEL KEY OR UNIT CHECK?                 00750430
         BO    DEVTYPE        YES, TRY AGAIN                            00751420
         OC    INDATA(8),BLANKS8 CONVERT TO UPPERCASE                   00752410
         MVC   OSLABEL,SAVEVOL1 AND USE CKD TYPE LABEL                  00753400
         BAL   R14,LNGCALC    GET INPUT LENGTH                          00754390
         BNZ   DEVTYPE        IF 0 OR GT 8                              00755380
         MVC   WRDEV1SP,BLANKS8 CLEAR 'SPECIFIED D/T' IN MSG            00756370
         MVC   WRDEV1SP,INDATA  MOVE SPECIFIED D/T INTO MSG             00757360
*.3******************************************************************** 00758350
*                                                                       00759340
* OPERATION -                                                           00760330
*                                                                       00761320
* F. ESTABLISH DEVICE CHARACTERISTICS                                   00762310
*                                                                       00763300
*        1. USE DEVTBL1 AND DEVTBL2 TO FIND DEVICE MATCH.               00764290
*        2. SET UP DEVICE SPECIFIC PARAMETERS:                          00765280
*                  GO (CCW ADDRESS)                                     00766270
*                  HIVALUE                                              00767260
*                  RECVALUE                                             00768250
*                  TYPE                                                 00769240
*                  WVFLAGS  - PROMPT FOR WRITE VERIFICATION             00770230
*        3. USE FEATURE INDEX FOR SPECIAL HANDLING:                     00771220
*                  3380 - SET UP HDVALUE+1                              00772210
*                  3330 AND 3330-11 - SET UP WR57 AND RD57              00773200
*                  3340 - VERIFY PACK SIZE SPECIFIED CORRECTLY          00774190
*                                                                       00775180
* LOCAL REGISTER USAGE -                                                00776170
*                                                                       00777160
*        R3  - DEVTBL1 - DEVICE TYPE SPECIFIC PARAMETERS                00778150
*        R4  - DEVTBL2 - DEVICE NAME COMPARISON TABLES                  00779140
*        R5  - WORK REGISTER                                            00780130
*                                                                       00781120
*.$******************************************************************** 00782110
         SPACE ,                                                        00783100
*---------------------------------------------------------------------- 00784090
* DEFAULT TO 1K ALLOCATION MAP AND 4K FILLER RECORD.                    00785080
*---------------------------------------------------------------------- 00786070
         SPACE ,                                                        00787060
CHECKCKD DS    0H             GET DEVICE CHARACTERISTICS                00788050
         MVC   R4DL,=H'1024'  DEFAULT RECORD 4 DATA LENGTH              00789040
         MVC   RF7DL,=H'4096' DEFAULT 3380 FILLER DATA LENGTH           00790030
         XC    HDVALUE,HDVALUE  CLEAR HIGHEST HEAD NUMBER               00791020
         SPACE ,                                                        00792010
*---------------------------------------------------------------------- 00793000
* INITIALIZE REGISTERS FOR TABLE SEARCH.                                00793990
*---------------------------------------------------------------------- 00794980
         SPACE ,                                                        00795970
         L     R3,=A(DEVTBL1) DEVICE PARAMETER TABLE ADDRESS            00796960
         L     R4,=A(DEVTBL2) DEVICE NAME TABLE ADDRESS                 00797950
         SR    R5,R5          CLEAR WORK REGISTER                       00798940
         SPACE ,                                                        00799930
*---------------------------------------------------------------------- 00800920
* SEARCH FOR MATCHING DEVICE TYPE.  IF MATCH NOT FOUND, THEN POINT TO   00801910
* THE NEXT ONE AND LOOP AT DEVSRCH.  IF NO MATCH FOUND IN TABLE, ASK    00802900
* USER FOR ANOTHER.                                                     00803890
*---------------------------------------------------------------------- 00804880
         SPACE ,                                                        00805870
DEVSRCH  DS    0H             SEARCH TABLE FOR MATCH                    00806860
         IC    R5,DEVARGLN(R3)  LOAD DEVICE NAME LENGTH-1               00807850
         EX    R5,DEVCHECK    PERFORM THE NAME COMPARE                  00808840
         BE    DEVFOUND       BRANCH IF MATCH NOT FOUND                 00809830
         LA    R3,DEVTBESZ(R3)  INDEX DEV PARM TBL TO NEXT              00810820
         LA    R4,1(R4,R5)    POINT TO NEXT DEVICE NAME                 00811810
         CLI   0(R3),DEVTBEND REACHED END OF TABLES?                    00812800
         BNE   DEVSRCH        BRANCH IF NO, KEEP LOOKING                00813790
         B     DEVTYPE        NO MATCH, ASK USER FOR ANOTHER            00814780
         SPACE ,                                                        00815770
DEVCHECK CLC   0(0,R4),INDATA                                           00816760
         SPACE ,                                                        00817750
*---------------------------------------------------------------------- 00818740
* MATCHING DEVICE FOUND, SET UP PARAMETERS AND THEN EXIT USING THE      00819730
* BRANCH TABLE DEVSFTB.                                                 00820720
*---------------------------------------------------------------------- 00821710
         SPACE ,                                                        00822700
DEVFOUND DS    0H                                                       00823690
         MVC   GO,DEVGO(R3)   SET UP TIC                                00824680
         MVC   HIVALUE,DEVHIVAL(R3)  SET UP HIGH CYL VAL                00825670
         MVC   RECVALUE,DEVRECVL(R3)  SET UP MAX RCD # ON TRK           00826660
         MVC   TYPE,DEVICETP(R3)  SET UP DEVICE TYPE                    00827650
*        MVC   WVFLAGS,DEVWVDEF(R3) PROMPT FOR WRT VERIFICATION         00828640
         XC    WVFLAGS,WVFLAGS    NEVER PROMPT FOR WRT VER              00829630
         IC    R5,DEVSFIX(R3) LOAD SPECIAL FEATURE INDEX                00830620
         B     DEVSFTB(R5)    EXIT ROUTINE                              00831610
DEVSFTB  DS    0H             BRANCH TO SPECIAL HANDLING                00832600
         B     DISK           NO SPECIAL HANDLING REQUIRED              00833590
         B     DVSF3380       3380                                      00834580
         B     DVSF3330       3330                                      00835570
         B     DVSF3340       3340                                      00836560
         SPACE ,                                                        00837550
*---------------------------------------------------------------------- 00838540
* 3380 SPECIAL HANDLING                                                 00839530
*---------------------------------------------------------------------- 00840520
         SPACE ,                                                        00841510
DVSF3380 DS    0H             SPECIAL HANDLING FOR 3380                 00842500
         MVI   HDVALUE+1,MHD3380  HIGHEST HEAD NUMBER FOR 3380          00843490
         B     SENSE4         CHECK FOR DEVICE CHARS                    00844480
         SPACE ,                                                        00845470
*---------------------------------------------------------------------- 00846460
* 3330 SPECIAL HANDLING                                                 00847450
*---------------------------------------------------------------------- 00848440
         SPACE ,                                                        00849430
DVSF3330 DS    0H             SPECIAL HANDLING FOR 3330                 00850420
         MVC   WR57,OFF57WRT  SET WRITE CCWS TO READ 12 RECS            00851410
         MVC   RD57,OFF57RD   SET READ CCWS FOR 12 RECORDS              00852400
         OI    BFORWR57+4,CC  RESTORE CMD CHAINING IN CCW               00853390
*                             IT MAY HAVE BEEN ALTERED                  00854380
         B     DISK           GO AND PROCESS                            00855370
         SPACE ,                                                        00856360
*---------------------------------------------------------------------- 00857350
* 3340 SPECIAL HANDLING -- USER SAYS 70MB PACK, SO NOW SEE IF SENSE     00858340
* AGREES.  WE DO NOT WANT TO STUMBLE INTO THE ALTERNATE CYLINDER OF A   00859330
* 35MB PACK WHILE THINKING WE ARE ON A 70MB PACK.  WE WOULD ALSO NOT    00860320
* WANT TO WRITE A 70MB ALLOCATION RECORD ON A 35MB PACK.                00861310
*---------------------------------------------------------------------- 00862300
         SPACE ,                                                        00863290
DVSF3340 DS    0H             3340 SPECIAL CHECKING                     00864280
         TM    SENSE+2,X'01'  IS IT A 35MB?                             00865270
         BZ    DISK           NO, SO IT MUST BE 70MB.                   00866260
         LA    R4,MSG35MB     SET UP FOR WRONG PACK MESSAGE             00867250
         BAL   R14,WMSG       WRITE MESSAGE.                            00868240
         B     DVCAGAIN       GO ASK AGAIN FOR UNIT ADDRESS             00869230
         SPACE ,                                                        00870220
DISK     CLI   FLAG,C'F'      FORMAT FUNCTION?                          00871210
         BE    FORMALL        YES, GET STARTING CYLINDER                00872200
         B     LAB            NO, START WITH LABEL PROCESSING           00873190
*.3******************************************************************** 00874180
*                                                                       00875170
* OPERATION -                                                           00876160
*                                                                       00877150
* G.                                                                    00878140
*                                                                       00879130
*        1. ISSUE THE SENSE ID COMMAND                                  00880120
*        2. FOR MISMATCH IN DEVICE TYPES, ISSUE MESSAGE AND ASK AGAIN   00881110
*           FOR DEVICE TYPE.                                            00882100
*                                                                       00883090
* LOCAL REGISTER USAGE -                                                00884080
*                                                                       00885070
*        R4  - ERROR MESSAGE ADDRESS                                    00886060
*        R5  - DEVICE ADDRESS                                           00887050
*        R14 - LINKAGE                                                  00888040
*                                                                       00889030
*.$******************************************************************** 00890020
         SPACE ,                                                        00891010
*---------------------------------------------------------------------- 00892000
*        ISSUE THE SENSE ID COMMAND.  FOR CC3 FROM SENSE, GO ISSUE      00892990
*        'DEV XXX NOT OPERATIONAL OR NOT READY' MESSAGE.  ANY           00893980
*        FAILING DIRECTOR CONDITION IS ALREADY REPORTED BY THE STRTIO   00894970
*        ROUTINE.  CE AND DE WILL COME IN TOGETHER WITH THE SENSE ID.   00895960
*        IF NOT OPERATIONAL OR CHANNEL ERRORS, QUIT IMMEDIATELY         00896950
*        FOR ANY OTHER I/O ERROR, RETRY THE OPERATION 10 TIMES          00897940
*        IF THE ERROR PERSISTS THROUGH 10 RETRIES, ISSUE MSG 744 AND    00898930
*        MAKE HIM START OVER, THE CONTROL UNIT IS REALLY SICK AND WE    00899920
*        DON'T KNOW FOR SURE WHAT DEVICE TYPE OR HOW BIG IT IS          00900910
*---------------------------------------------------------------------- 00901900
         SPACE ,                                                        00902890
SENSE4   DS    0H                                                       00903880
         XC    SENSE,SENSE    CLEAR SENSE AREA                          00904870
         LH    R5,DSKADD      GET DEVICE ADDRESS                        00905860
         MVC   CAW(L4),=A(CCWSNSE4) SETUP THE CAW                       00906850
         LA    R4,E4RTRYCT    LOAD I/O RETRY COUNT                      00907840
E4STIO   DS    0H                                                       00908830
         BAL   R14,STRTIO     GO ISSUE E4 SENSE                         00909820
         BC    NOPER,TIOCC3   NOTREADY ? TELL USER AND RESTART          00910810
         TM    CSW+D5,X'FF'   ANY BAD CHANNEL STATUS ?                  00911800
         BNZ   FATAL          YES, QUIT IMMEDIATELY                     00912790
         TM    CSW+D4,X'FF'-CE-DE  ANYTHING OTHER THAN CE+DE?           00913780
         BZ    E4COMPL        BR IF NO                                  00914770
         BCT   R4,E4STIO      RETRY IF COUNT NOT EXCEEDED               00915760
         B     FMT744         RETRY CNT EXCEEDED, SEND MSG 744          00916750
         SPACE ,                                                        00917740
E4COMPL  DS    0H                                                       00918730
         CLC   SENSEB4(2),=X'3380' IS IT FOR 3380?                      00919720
         BNE   E4CONT         NO, CONTINUE                              00920710
         TM    SENSEB6,RDEVMD82 IS IT MODEL 2 OR 3?                     00921700
         BZ    E4CONT         NO, EVERYTHING IS OK AS IS                00922690
         MVC   HIVALUE,MCYL3382 MODEL 2 HAS 1770 CYLINDERS              00923680
         MVC   R4DL,=H'2048'  RECORD 4 WILL BE 2K LONG                  00924670
         MVC   RF7DL,=H'3072' AND FILLER RECORD 247 IS 3K               00925660
         TM    SENSEB6,RDEVMD83  IS IT MODEL 3?                         00926650
         BNO   E4CONT         NO, EVERYTHING IS OK AS IS                00927640
         MVC   HIVALUE,MCYL3383  MODEL 3 HAS EXP FEATURE                00928630
         MVC   R4DL,=H'4096'  RECORD 4 WILL BE 4K LONG                  00929620
         MVC   RF7DL,=H'1024' FILLER RECORD 247 IS 1K                   00930610
         SPACE ,                                                        00931600
*---------------------------------------------------------------------- 00932590
*        NOW WE ASSUME THAT THE SENSE DATA IS VALID.  THE UNPACK INST   00933580
*        TRANSLATES THE SENSE TO A READABLE DEVICE TYPE, BUT OVERLAYS   00934570
*        A BYTE AT THE END OF THIS FIELD.                               00935560
*---------------------------------------------------------------------- 00936550
         SPACE ,                                                        00937540
E4CONT   DS    0H                                                       00938530
         UNPK  WRDEV1AC(L5),SENSEB4(L3) TRANSLATE DEV TYPE              00939520
         MVI   WRDEV1AC+L'WRDEV1AC,COMMA  RESTORE IT (A COMMA)          00940510
         CLC   WRDEV1AC,WRDEV1SP ACTUAL DEV.TYPE EQ SPECIFIED?          00941500
         BNE   SENSE4F        NO, NOTIFY USER                           00942490
         SPACE ,                                                        00943480
         B     DISK           GO SEE IF WE HAVE A FORMAT                00944470
         SPACE ,                                                        00945460
*---------------------------------------------------------------------- 00946450
*        MISMATCH IN DEVICE TYPES.  ISSUE MESSAGE 'DEVICE XXX IS XXXX   00947440
*        NOT XXXX-YY AS SPECIFIED.  RESPECIFY OR NOTIFY SYSTEM SUPPORT' 00948430
*        AND THEN GO BACK UP AND ASK FOR DEVICE TYPE AGAIN.             00949420
*---------------------------------------------------------------------- 00950410
         SPACE ,                                                        00951400
SENSE4F  EQU   *                                                        00952390
         LA    R4,WRDEV1      POINT TO MISMATCH MESSAGE                 00953380
         BAL   R14,WMSG       PRINT MISMATCH MESSAGE                    00954370
         LA    R4,WRDEV2      POINT TO 2ND PART OF MISMATCH MSG         00955360
         BAL   R14,WMSG       PRINT 2ND PART                            00956350
         B     DVCAGAIN       GIVE ANOTHER CHANCE, STARTING             00957340
*                             WITH DEVICE ADDRESS                       00958330
         SPACE ,                                                        00959320
*---------------------------------------------------------------------- 00960310
*   SENSE ID I/O ERROR RETRY COUNT                                      00961300
*---------------------------------------------------------------------- 00962290
         SPACE ,                                                        00963280
E4RTRYCT EQU   10                                                       00964270
*.3******************************************************************** 00965260
*                                                                       00966250
* OPERATION -                                                           00967240
*                                                                       00968230
* H. HANDLE PROGRAM CHECK/MACHINE CHECK                                 00969220
*                                                                       00970210
*        FOR PROGRAM CHECK:                                             00971200
*        1. FILL IN THE PROGRAM OLD PSW IN THE MESSAGE.                 00972190
*        2. ISSUE PROGRAM CHECK MESSAGE.                                00973180
*        3. ENTER WAIT STATE.                                           00974170
*                                                                       00975160
*        FOR MACHINE CHECK:                                             00976150
*        1. ISSUE MACHINE CHECK MESSAGE.                                00977140
*        2. ENTER WAIT STATE.                                           00978130
*                                                                       00979120
* LOCAL REGISTER USAGE -                                                00980110
*                                                                       00981100
*        R4  - ERROR MESSAGE ADDRESS                                    00982090
*        R14 - LINKAGE                                                  00983080
*                                                                       00984070
*.$******************************************************************** 00985060
         SPACE ,                                                        00986050
*---------------------------------------------------------------------- 00987040
*        THE ADDRESS(PRCHK) IS CONTAINED IN THE PROGRAM NEW PSW AT      00988030
*        ADDRESS 104 IN LOW STORAGE.  NOTE THAT DEPRESSING THE REQUEST  00989020
*        KEY ON THE CONSOLE WILL CAUSE AN ATTENTION INTERRUPT TO THE    00990010
*        PROGRAM AND PROCESSING WILL STOP AND THE PROGRAM WILL RESTART  00991000
*        AT THE BEGINNING.  MACHINE CHECKS AND PROGRAM CHECKS WILL      00991990
*        PRINT A MESSAGE AND PUT SYSTEM INTO WAIT STATE.                00992980
*        FOR PROGRAM CHECK ISSUE 'PROGRAM CHECK. PSW = XXXXXXXXXXXXXXX. 00993970
*---------------------------------------------------------------------- 00994960
         SPACE ,                                                        00995950
PRCHK    STM   R0,R15,PCREGS  SAVE REGISTERS 0 TO 15                    00996940
         UNPK  WORK(9),PROPSW(5)     FILL IN THE PROGRAM                00997930
         UNPK  WORK+8(9),PROPSW+4(5) OLD PSW.                           00998920
         TR    WORK(16),TTAB-240 TRANSLATE TO PRINTABLE CHARS           00999910
         MVC   PCMSG+32(16),WORK MOVE PSW INTO MESSAGE                  01000900
         LA    R4,PCMSG       SET PROG CK MESSAGE                       01001890
         BAL   R14,WMSG       WRITE MESSAGE                             01002880
         LPSW  WTPSW          HARD WAIT                                 01003870
         SPACE ,                                                        01004860
*---------------------------------------------------------------------- 01005850
*        THE ADDRESS(MCRTN) IS CONTAINED IN THE MACHINE CHECK NEW PSW   01006840
*        AT ADDRESS 112 IN LOW STORAGE.  ISSUE THE MESSAGE 'MACHINE     01007830
*        CHECK' AND LOAD A WAIT STATE.                                  01008820
*---------------------------------------------------------------------- 01009810
         SPACE ,                                                        01010800
MCRTN    LA    R4,MCMSG       SET UP MACH CK MESSAGE                    01011790
         BAL   R14,WMSG       WRITE MESSAGE                             01012780
         LPSW  WTPSW          HARD WAIT                                 01013770
         LTORG ,                                                        01014760
*.3******************************************************************** 01015750
*                                                                       01016740
* OPERATION -                                                           01017730
*                                                                       01018720
* I. CARD AND CONSOLE I/O INTERRUPT ROUTINE                             01019710
*                                                                       01020700
*        1. FOR CONSOLE INTERRUPT, CLEAR PENDING STATUS.  AFTER DEVICE  01021690
*           END, CONTINUE WITH NEXT OPERATION.                          01022680
*        2. FOR IPL DEVICE INTERRUPT AND AFTER GOOD CE+DE STATUS, GO    01023670
*           VALIDATE THE CARD INPUT.                                    01024660
*        3. FOR BAD STATUS FROM IPL DEVICE, ISSUE ERROR MESSAGE.        01025650
*        4. FOR UNIT EXCEPTION FROM IPL DEVICE, GO BACK TO START.       01026640
*                                                                       01027630
* LOCAL REGISTER USAGE -                                                01028620
*                                                                       01029610
*        R4  - MESSAGE ADDRESS                                          01030600
*        R10 - CONSOLE ADDRESS                                          01031590
*        R14 - RETURN ADDRESS                                           01032580
*                                                                       01033570
*.$******************************************************************** 01034560
         SPACE ,                                                        01035550
*---------------------------------------------------------------------- 01036540
*        IF THE INTERRUPT CAME FROM THE CONSOLE, THEN CLEAR ANY PENDING 01037530
*        STATUS.  FOR GOOD STATUS (NOT AN ATTENTION), WAIT FOR DEVICE   01038520
*        END.  IF WE GET CONTROL UNIT END, GO RESTART OPERATION.  ELSE, 01039510
*        GO BACK AND CONTINUE WITH NEXT OPERATION.                      01040500
*---------------------------------------------------------------------- 01041490
         SPACE ,                                                        01042480
CONSINT  CLC   CONSOL(2),58   WAS THIS A CONSOLE DEVICE?                01043470
         BNE   SELREAD        IF NOT CONSOLE BRANCH                     01044460
         MVC   STAT(2),CSW+4  SAVE STATUS                               01045450
         TIO   0(R10)         CLEAR PENDING STATUS                      01046440
         BC    2,*-4          LOOP IF BUSY                              01047430
         OC    STAT(2),CSW+4  SAVE ANY STATUS                           01048420
         TM    STAT,ATTN      IS THIS AN ATTENTION INTERRUPT ?          01049410
         BNO   CONUNITE       NO, GO CHECK FOR UNIT EXCEPTION           01050400
         TM    PARM,PARMGRP   IS THE GRAPHIC SUPPORT ACTIVE ?           01051390
         BZ    STMSG          NO, GO CLEAR CARD FLAG                    01052380
         TM    PARM,PARMATT   IS THIS A ATTENTION REQUEST ?             01053370
         BCR   1,R14          YES, GO CHECK FOR ATTENTION               01054360
*                             INTERRUPT                                 01055350
CONUNITE EQU   *                                                        01056340
         TM    STAT,UC        WAS THERE A UNIT CHECK                    01057330
         BNO   GOODSTA        NO,BRANCH REG 14                          01058320
         OI    STAT,UE        OR IN UNIT EXCEPTION TOO                  01059310
GOODSTA  TIO   0(R10)         WAIT FOR DEVICE END                       01060300
         BC    7,*-4          LOOP UNTIL CLEAR                          01061290
         OC    CSW+4(2),STAT  PUT BACK ALL THE STATUS                   01062280
         TM    CSW+4,CUE      IS THIS CONTROL UNIT END                  01063270
         BO    STARTIO1       GO RESTART I/O OPERATION                  01064260
         BR    R14            BRANCH BACK                               01065250
         SPACE ,                                                        01066240
*---------------------------------------------------------------------- 01067230
*        THE INTERRUPT WAS FROM THE IPL DEVICE (IF IT WAS NOT, JUST     01068220
*        LOAD A WAIT STATE).  FOR GOOD STATUS (CE+DE), GO VALIDATE THE  01069210
*        CARD.                                                          01070200
*---------------------------------------------------------------------- 01071190
         SPACE ,                                                        01072180
SELREAD  CLC   IPLDEV(2),58   IS IT IPL DEV                             01073170
         BNE   XWAIT          NO,WAIT                                   01074160
         TM    CSW+5,X'BF'    CHANNEL ERROR?                            01075150
         BNZ   ERRORMSG       PRINT ERROR MSG                           01076140
         TM    CSW+4,UC       IS IT UNIT CHECK?                         01077130
         BO    DETEST         GO CHECK FOR CHAN END                     01078120
         TM    CSW+4,UE       UNIT EXCEPTION?                           01079110
         BO    TESTDEV        YES,BRANCH                                01080100
         CLI   CSW+4,CE+DE    CH END DEV END?                           01081090
         BE    VALIDATE       YES VALIDATE CARD                         01082080
         TM    CSW+4,CE       IS IT CHANNEL END ONLY?                   01083070
         BO    DRAINDE        GO DRAIN DEV END                          01084060
         TM    CSW+4,DE       DEVICE END ONLY?                          01085050
         BO    GETCARD        YES MUST BE DEV MADE READY                01086040
         B     ERRORMSG       PRINT ERROR MESSAGE                       01087030
DETEST   TM    CSW+4,CE       IS IT CHAN END                            01088020
         BO    DRAINDE        DRAIN DEVICE END                          01089010
         B     ERRORMSG       PRINT ERROR MESSAGE                       01090000
DRAINDE  TIO   0(R10)         CLEAR DEVICE END                          01090990
         BC    7,*-4          LOOP UNTIL CLEAR                          01091980
         SPACE ,                                                        01092970
*---------------------------------------------------------------------- 01093960
*        HANDLE A CARD ERROR IF BAD STATUS RETURNED FROM IPL DEVICE.    01094950
*        ISSUE THE MESSAGE 'DEV XXX INTERVENTION REQUIRED'.  THEN LOAD  01095940
*        A WAIT STATE.                                                  01096930
*---------------------------------------------------------------------- 01097920
         SPACE ,                                                        01098910
ERRORMSG XC    ALLOSW,ALLOSW  CLEAR ALLOCATE SWITCH                     01099900
         XC    CDSW(2),CDSW   "   CARD       "                          01100890
         XC    ALLOERR,ALLOERR CLEAR ALLOCATE ERROR SWITCH              01101880
         LA    R4,IPLERROR    IPL ERROR MESSAGE                         01102870
         BAL   R14,WMSG       PRINT MESSAGE                             01103860
         B     XWAIT          WAIT FOR CARD DEVICE INTERRUPT            01104850
         SPACE ,                                                        01105840
*---------------------------------------------------------------------- 01106830
*        HERE FOR UNIT EXCEPTION FROM IPL DEVICE.  IF CARD SWITCH NOT   01107820
*        ON, THEN ISSUE BEGINNING MESSAGE TO CONSOLE.  ELSE, CLEAR ALL  01108810
*        CARD SWITCHES BEFORE GOING TO SELECT.                          01109800
*---------------------------------------------------------------------- 01110790
         SPACE ,                                                        01111780
TESTDEV  CLI   CDSW2,X'FF'    IS SW ON?                                 01112770
         BNE   SELECT         NO,USE CONSOLE                            01113760
         XC    CDSW(2),CDSW   TURN OFF 2 SWITCHES                       01114750
         B     NOCARD         BRANCH                                    01115740
*.3******************************************************************** 01116730
*                                                                       01117720
* OPERATION -                                                           01118710
*                                                                       01119700
* J. VALIDATE CARD INPUT FROM IPL DEVICE                                01120690
*                                                                       01121680
*         1. SCAN THE CARD FOR THE PROPER FORMAT.  IF INVALID, AN ERROR 01122670
*            MESSAGE WILL BE ISSUED AND THE ERRONEOUS CARD DISPLAYED.   01123660
*            IF THE ERROR EXISTS ON THE FIRST FORMAT OR ALLOCATE CARD,  01124650
*            AN ERROR MESSAGE WILL BE ISSUED, THE ERRONEOUS CARD        01125640
*            DISPLAYED, AND USER WILL BE PROMPTED VIA THE CONSOLE FOR   01126630
*            THE FUNCTION TO BE PERFORMED.  FOR ERRORS FOLLOWING THE    01127620
*            FIRST FORMAT OR ALLOCATE CARD, AN INVALID MESSAGE WILL     01128610
*            ISSUED AND FLUSH TO NEXT FORMAT OR ALLOCATE CARD.          01129600
*         2. AFTER SCAN IS COMPLETE, COMPARE INPUT TO SEE WHAT WAS      01130590
*            ENTERED.  FOR LABEL, FORMAT, OR ALLOCATE GO TO SELECT      01131580
*            (OP C) TO BEGIN THE OPERATION.                             01132570
*         3. FOR INVALID CARD INPUT, ISSUE ERROR MESSAGE.               01133560
*                                                                       01134550
*         VALID CARD FORMATS:                                           01135540
*                                                                       01136530
*            FORMAT EXAMPLES -                                          01137520
*                                                                       01138510
*            FORMAT,ADDRESS,TYPE,VOLUME LABEL,START CYL,END CYL         01139500
*                                                                       01140490
*            FORMAT,232,3330,MYDISK,000,006, (LAST COMMA MAY BE         01141480
*                       OR                    DROPPED)                  01142470
*            FORMAT,232,3330,MYDISK,000,006                             01143460
*                                                                       01144450
*            F,232,3330,MYDISK,,,            (DEFAULTS START AND END)   01145440
*            F,232,3330,MYDISK,,007          (DEFAULTS START CYL)       01146430
*            F,232,3330,MYDISK,001,,         (DEFAULTS END CYL)         01147420
*            F,232,3380,MYDISK,001,,YES      (PERFORM WRT VERIFICATION) 01148410
*                                                                       01149400
*          ALLOCATE EXAMPLES:                                           01150390
*                                                                       01151380
*            ALLOCATE,232,3330,MYDISK                                   01152370
*            TEMP,000,050                    (ALLOCATE CYLINDERS 0 TO   01153360
*            PERM,055,060                     50 AS TEMP SPACE)         01154350
*            TDSK,100,108                                               01155340
*            DRCT,110,120                                               01156330
*            END                                                        01157320
*                                                                       01158310
*            A,232,3330,MYDISK                                          01159300
*            ALLO,232,3330,MYDISK            (ABBREVIATE ALLOCATE)      01160290
*                                                                       01161280
*         LABEL ONLY EXAMPLES:                                          01162270
*                                                                       01163260
*           FO,232,3330,MYDISK,LABEL         (WORD 'LABEL' IN PLACE OF  01164250
*                                             CYLINDER)                 01165240
*           F,232,3330,MYDISK,LA             (WORD LABEL ABBREVIATED)   01166230
*                                                                       01167220
* LOCAL REGISTER USAGE -                                                01168210
*                                                                       01169200
*        R1  - OUTPUT AREA ADDRESS                                      01170190
*        R2  - WORK                                                     01171180
*        R3  - CARD INPUT                                               01172170
*        R4  - MESSAGE ADDRESS                                          01173160
*        R14 - LINKAGE                                                  01174150
*                                                                       01175140
*.$******************************************************************** 01176130
         SPACE ,                                                        01177120
*---------------------------------------------------------------------- 01178110
*        VALIDATE CARD INPUT.  ALLOERR IS TURNED ON IF THE TYPE OR CYL  01179100
*        WAS FOUND TO BE INVALID, OR IF THERE WAS A UNIT CHECK WHILE    01180090
*        READIN THE LABEL.  ALLOSW IS ON ALL THROUGH ALLOCATION         01181080
*        UNTIL AN 'END' CARD IS FOUND.                                  01182070
*---------------------------------------------------------------------- 01183060
         SPACE ,                                                        01184050
VALIDATE MVI   CDSW2,X'FF'    TURN ON CARD SW                           01185040
         CLI   CDINPUT,C'F'   FORMAT?                                   01186030
         BE    ALLSCAN        YES BRANCH                                01187020
         CLI   CDINPUT,C'A'   ALLOCATE?                                 01188010
         BE    ALLSCAN        YES,BRANCH                                01189000
         CLI   ALLOERR,X'FF'  ALLOCATE ERROR?                           01189990
         BE    GETCARD        YES,GET NEXT CARD                         01190980
         CLI   ALLOSW,X'FF'   IS ALLOCATE SW ON?                        01191970
         BE    ALLSCAN1       YES,BRANCH                                01192960
         B     BADINPUT       BAD INPUT                                 01193950
ALLSCAN  DS    0H                                                       01194940
         CLI   LABIOERR,X'FF' I/O ERROR READING LABEL?                  01195930
         BE    NOPRINT        YES, NO PRINT                             01196920
         CLI   ALLOSW,X'FF'   ALLOCATE OPERATION                        01197910
         BNE   NOPRINT        NO,NO PRINT                               01198900
         LA    R4,TYPERR      PRINT NO END CARD                         01199890
         BAL   R14,WMSG       WRITE MESSAGE                             01200880
NOPRINT  MVI   ALLOSW,X'00'   TURN ALLOCATE SW OFF                      01201870
         MVI   LABIOERR,X'00' TURN OFF LABEL I/O ERROR SW               01202860
ALLSCAN1 MVI   ALLOERR,X'00'  TURN OFF ALLOCATE ERROR SW                01203850
         SPACE ,                                                        01204840
*---------------------------------------------------------------------- 01205830
*        SCAN FOR NEXT FIELDS ON THE CARD.  SAVE THE CARD FIELDS IN     01206820
*        THE OUTPUT AREA STARTING AT CDFORA UNTIL THERE IS NO MORE      01207810
*        DATA ON THE CARD TO SAVE.                                      01208800
*---------------------------------------------------------------------- 01209790
         SPACE ,                                                        01210780
         LA    R1,CDFORA-8    R1 ADDRESS OF OUTPUT AREA-8               01211770
         LA    R3,CDINPUT     R3 POINTS TO CARD INPUT                   01212760
         XC    CDFORA(56),CDFORA CLEAR OUTPUT AREA                      01213750
NEWFIELD XR    R2,R2          R2 TO ZERO                                01214740
         MVC   DATA,0(R3)     SAVE FIRST FIELD                          01215730
         CL    R1,=A(CDLAST)  IS R1 AT LAST FIELD?                      01216720
         BE    ENDUP          YES,BRANCH                                01217710
SCAN     CLI   0(R3),C' '     IS IT BLANK?                              01218700
         BE    FIELD          YES,BRANCH                                01219690
         CLI   0(R3),C','     IS IT A COMMA?                            01220680
         BE    FIELD          YES,BRANCH                                01221670
         LA    R2,1(R2)       ADD 1                                     01222660
         LA    R3,1(R3)       ADD 1                                     01223650
         B     SCAN           BRANCH                                    01224640
FIELD    LA    R1,8(R1)       POINT TO NEXT FIELD                       01225630
         NR    R2,R2          IS R2 ZERO?                               01226620
         BM    NODEFALT       BRANCH IF NOT DEFAULT                     01227610
         XC    DATA,DATA      CLEAR DATA                                01228600
         LA    R2,8(R2)       UP LENGTH TO 8                            01229590
NODEFALT BCTR  R2,0           SUBTRACT 1 R2                             01230580
         EX    R2,MOVE        PUT DATA IN OUTPUT FIELD                  01231570
         CLI   0(R3),C' '     BLANK MEANS END OF INPUT                  01232560
         BE    ENDUP          YES,GO END                                01233550
         LA    R3,1(R3)       ADD 1 TO R3                               01234540
         CLI   0(R3),C' '     NEXT POSITION BLANK?                      01235530
         BE    ENDUP          YES,NO MORE DATA                          01236520
         B     NEWFIELD       BRANCH                                    01237510
MOVE     MVC   0(1,R1),DATA   PUT DATA IN OUTPUT                        01238500
         SPACE ,                                                        01239490
*---------------------------------------------------------------------- 01240480
*        COMPARE THE DATA TO SEE WHAT WAS ENTERED.  FOR VALID LABEL,    01241470
*        FORMAT, OR ALLOCATE FUNCTION, GO TO SELECT TO BEGIN THE        01242460
*        OPERATION.                                                     01243450
*---------------------------------------------------------------------- 01244440
         SPACE ,                                                        01245430
ENDUP    EQU   *                                                        01246420
         CLC   0(3,R3),BLANKS8 NEXT 3 POSITION BLANKS ?                 01247410
         BNE   BADINPUT       NO,THAT'S BAD INPUT                       01248400
         CL    R1,=A(CDSTART) IS LABEL ONLY OPERATION?                  01249390
         BE    LCHECK         GO CHECK INPUT                            01250380
         CL    R1,=A(CDLAST)  DID WE FILL LAST FIELD?                   01251370
         BE    FCHECK         YES,CHECK FOR FORMAT                      01252360
         SPACE ,                                                        01253350
*---------------------------------------------------------------------- 01254340
*        USER MAY NOT HAVE CHOSEN WRITE VERIFICATION.  IN THIS CASE     01255330
*        THE LAST FIELD WOULD BE END CYLINDER, THEREFORE CHECK.         01256320
*---------------------------------------------------------------------- 01257310
         SPACE ,                                                        01258300
         CL    R1,=A(CDENDCYL) END CYLINDER LAST FIELD?                 01259290
         BE    FCHECK         YES, CHECK FOR FORMAT                     01260280
         CL    R1,=A(CDLABEL) IS IT ALLOCATE OPERATOR                   01261270
         BE    ACHECK         CHECK FOR ALLOCATE                        01262260
         CLI   ALLOSW,X'FF'   IS SWITCH ON?                             01263250
         BNE   BADINPUT       NO,BAD                                    01264240
         CL    R1,=A(CDTYPE)  LAST FIELD ALLOCATE END                   01265230
         BE    REREAD         YES,ALLOCATE                              01266220
         CL    R1,=A(CDFORA)  IS IT END CARD?                           01267210
         BE    REREAD         YES,BRANCH                                01268200
         B     BADINPUT       NONE OF ABOVE BADINPUT                    01269190
LCHECK   CLI   CDSTART,C'L'   IS LABEL ONLY?                            01270180
         BNE   BADINPUT       NO,BAD INPUT                              01271170
FCHECK   CLI   CDFORA,C'F'    IS IT FORMAT?                             01272160
         BE    SELECT         YES, DO THE TASK                          01273150
         B     BADINPUT       NO,BAD                                    01274140
ACHECK   CLI   CDFORA,C'A'    IS IT ALLOCATE?                           01275130
         BNE   BADINPUT       NO,BAD                                    01276120
         MVI   ALLOSW,X'FF'   TURN ON ALLOCATE SWITCH                   01277110
         B     SELECT         DO ALLOCATE                               01278100
         SPACE ,                                                        01279090
*---------------------------------------------------------------------- 01280080
*        INVALID CARD INPUT.  ISSUE MESSAGE 'INVALID OPERAND' AND THEN  01281070
*        GO BACK TO START.                                              01282060
*---------------------------------------------------------------------- 01283050
         SPACE ,                                                        01284040
BADINPUT MVC   CDSW(2),=X'0000' TURN OFF 2 SWITCHES                     01285030
         MVI   ALLOERR,X'FF'  TURN ON TO FLUSH NEXT GOOD CARD           01286020
         XC    ALLOSW,ALLOSW  CLEAR ALLOCATE SWITCH                     01287010
         LA    R4,BAD         MSG ADDRESS IN R4                         01288000
         BAL   R14,WMSG       PRINT MSG                                 01288990
         LA    R4,CARDMESS    PRINT BAD CARD                            01289980
         BAL   R14,WMSG       PRINT MSG                                 01290970
         B     STMSG          BRANCH                                    01291960
*.3******************************************************************** 01292950
*                                                                       01293940
* OPERATION -                                                           01294930
*                                                                       01295920
* K. OBTAIN STARTING AND ENDING CYLINDER NUMBERS FOR CKD FORMAT         01296910
*                                                                       01297900
*        THIS ROUTINE ALLOWS DEFAULTS FOR STARTING AND ENDING DASD      01298890
*        LOCATIONS FOR FORMAT FROM CONSOLE OR IPL DEVICE INPUT.         01299880
*                                                                       01300870
*        1. ISSUE 'ENTER START CYLINDER' MESSAGE AND GET RESPONSE.      01301860
*        2. SAVE START CYLINDER.                                        01302850
*        3. ISSUE 'ENTER END CYLINDER' MESSAGE AND GET RESPONSE.        01303840
*        4. SAVE ENDING CYLINDER.                                       01304830
*        5. CONTINUE AT OP M.                                           01305820
*                                                                       01306810
* LOCAL REGISTER USAGE -                                                01307800
*                                                                       01308790
*        R3  - CHKDIGIT LINKAGE                                         01309780
*        R4  - MESSAGE ADDRESS                                          01310770
*        R7  - WORK                                                     01311760
*        R14 - LINKAGE                                                  01312750
*                                                                       01313740
*.$******************************************************************** 01314730
         SPACE ,                                                        01315720
*---------------------------------------------------------------------- 01316710
*        ISSUE 'ENTER START CYLINDER (XXX OR XXXX) OR "LABEL":'.  IF    01317700
*        NULL RESPONSE THEN DEFAULT TO CYLINDER 0.                      01318690
*---------------------------------------------------------------------- 01319680
         SPACE ,                                                        01320670
FORMALL  MVI   LOSW,X'00'              INITIAL LABEL ONLY FLAG          01321660
         LA    R4,STCYL                PUT CYLINDER IN MESSAGE          01322650
         BAL   R14,WMSG                WRITE MESSAGE                    01323640
         BAL   R14,RMSG                READ RESPONSE                    01324630
         TM    CSW+4,UE                CANCEL OR UNIT CHECK             01325620
         BO    FORMALL                 YES,TRY AGAIN                    01326610
         CLI   INDATA,X'00'            WAS IT EOB                       01327600
         MVC   BEGIN,=X'0000'          SET UP DEFAULT                   01328590
         BE    NEXT                    IF DEFAULT GO ON                 01329580
         SPACE ,                                                        01330570
*---------------------------------------------------------------------- 01331560
*        EVALUATE THE RESPONSE.  IF "LABEL", THEN GO HANDLE LABEL ONLY  01332550
*        FUNCTION.  ELSE, VERIFY THAT THE CYLINDER NUMBER IS VALID BY   01333540
*        CALLING CHKDIGIT.                                              01334530
*---------------------------------------------------------------------- 01335520
         SPACE ,                                                        01336510
         BAL   R14,LNGCALC             GET WORD LENGTH                  01337500
         BNZ   FORMALL                 IF LEN=0, GT 8 TRY AGAIN         01338490
         EX    R4,TSTLABL              IS IT LABEL?                     01339480
         BE    LAB                     YES,GO TO LABEL                  01340470
         BAL   R3,CHKDIGIT             CHECK INPUT CYL DIGIT            01341460
         BNZ   FORMALL                 TRY AGAIN IF CC ^= 0             01342450
         OC    INDATA(CYLNUM+BLANK),BLANKS8                             01343440
*                                      CONVERT X'00' TO BLANK           01344430
         CLI   INDATA+CYLNUM,X'40'     YES, ANYTHING EXTRA?             01345420
         BNE   FORMALL                 YES - DO IT OVER AGAIN           01346410
         PACK  FIELDA+5(3),INDATA(CYLNUM)      ALL NUMERIC,             01347400
*                                      PACK THE INPUT DATA              01348390
         CVB   R7,FIELDA               CONVERT TO BINARY                01349380
         SPACE ,                                                        01350370
*---------------------------------------------------------------------- 01351360
*        IF THE STARTING CYLINDER IS HIGHER THAN THE HIGHEST CYLINDER,  01352350
*        THEN RE-ISSUE MESSAGE.  ELSE SAVE THE STARTING CYLINDER.       01353340
*---------------------------------------------------------------------- 01354330
         SPACE ,                                                        01355320
         CH    R7,HIVALUE              IS START CYL HIGHER THAN LAST    01356310
         BH    FORMALL                 YES,ERROR                        01357300
         STH   R7,BEGIN                BEGIN=CYL START ADDRESS          01358290
         SPACE ,                                                        01359280
*---------------------------------------------------------------------- 01360270
*        NOW ISSUE 'ENTER END CYLINDER (XXX OR XXXX):' AND READ THE     01361260
*        RESPONSE.  FOR NULL RESPONSE DEFAULT TO HIGHEST CYLINDER ON    01362250
*        PACK.  ELSE, VERIFY THAT THE CYLINDER NUMBER IS VALID BY       01363240
*        CALLING CHKDIGIT.                                              01364230
*---------------------------------------------------------------------- 01365220
         SPACE ,                                                        01366210
NEXT     LA    R4,ENDCYL               USE END CYL MESSAGE              01367200
         BAL   R14,WMSG                PRINT MESSAGE                    01368190
         BAL   R14,RMSG                READ RESPONSE                    01369180
         TM    CSW+4,UE                CANCEL KEY OR UNIT CHECK         01370170
         BO    NEXT                    YES, TRY AGAIN                   01371160
         CLI   INDATA,X'00'            WAS DEFAULT SET                  01372150
         MVC   ENDING,HIVALUE          SAVE HIGHEST DEFAULT VALUE       01373140
         BE    LIMITS                  BRANCH IF DEFAULT                01374130
         BAL   R3,CHKDIGIT             CHECK INPUT CYL DIGIT            01375120
         BNZ   NEXT                    TRY AGAIN IF CC ^= 0             01376110
         OC    INDATA(CYLNUM+BLANK),BLANKS8                             01377100
*                                      CONVERT X'00' TO BLANK           01378090
         CLI   INDATA+CYLNUM,X'40'     ANYTHING EXTRA?                  01379080
         BNE   NEXT                    YES - WE DON'T WANT IT           01380070
         PACK  FIELDA+5(3),INDATA(CYLNUM)    PACK INPUT CYL #           01381060
         CVB   R7,FIELDA               CONVERT INDATA INTO BINARY       01382050
         SPACE ,                                                        01383040
*---------------------------------------------------------------------- 01384030
*        IF HIGHER THAN HIGHEST CYLINDER, THEN RE-ISSUE MESSAGE.  ELSE  01385020
*        SAVE THE ENDING CYLINDER.                                      01386010
*---------------------------------------------------------------------- 01387000
         SPACE ,                                                        01387990
         CH    R7,HIVALUE              END BEYOND LAST CYL?             01388980
         BH    NEXT                    YES, TRY AGAIN                   01389970
         STH   R7,ENDING               SAVE ENDING ADRESS               01390960
LIMITS   CLC   BEGIN,ENDING            IS BEGINING HIGHER THAN END      01391950
         BH    NEXT                    YES, ERROR, TRY AGAIN            01392940
         B     LAB                                                      01393930
         SPACE ,                                                        01394920
         SPACE ,                                                        01395910
*---------------------------------------------------------------------- 01396900
*        CHECK THE DIGIT FOR THE INPUT FORMAT CYLINDER NUMBER.          01397890
*---------------------------------------------------------------------- 01398880
         SPACE ,                                                        01399870
CHKDIGIT DS    0H                    CHK INPUT CYL # FOR FORMAT         01400860
         CLI   INDATA+3,C'0'         4TH DIGIT A NUMERIC?               01401850
         BNL   NUMCHKF               POSSIBLE, CHECK IT FURTHER         01402840
         CLI   INDATA+3,C' '         IF NOT, IS IT A BLANK?             01403830
         BE    INSERTF               YES, INSERT A LEADING 0            01404820
         CLI   INDATA+3,X'00'        OR COULD IT BE A X'00'?            01405810
         BE    INSERTF               YES, INSERT A LEADING 0            01406800
         LA    R4,TYPERR             NO, INPUT ERROR                    01407790
         BAL   R14,WMSG              TELL THE OPERATOR                  01408780
         CLI   F0,X'FF'              SET CONDITION CODE 1               01409770
         BR    R3                    AND TRY AGAIN                      01410760
         SPACE ,                                                        01411750
INSERTF  DS    0H                    INSERT A LEADING 0                 01412740
         MVC   CHARSAVE,CHARMASK     MOVE IN MASK CHARACTERS            01413730
         MVC   CHARSAVE+1(3),INDATA  STORE CYL # TEMPORARILY            01414720
         MVC   INDATA(4),CHARSAVE    SHIFT 1 BYTE TO THE RIGHT          01415710
NUMCHKF  DS    0H                    NUMERIC CHECK FOR FORMAT           01416700
         MVC   MASKB(CYLNUM),MASKA   REINITIALIZE MASKB                 01417690
         NC    MASKB(CYLNUM),INDATA  AND COMPARE WITH INPUT             01418680
         CLC   MASKB(CYLNUM),MASKA   IS INPUT CYL. NUMERIC?             01419670
         BR    R3                                                       01420660
*.3******************************************************************** 01421650
*                                                                       01422640
* OPERATION -                                                           01423630
*                                                                       01424620
* M. ASK FOR LABEL AND VERIFY                                           01425610
*                                                                       01426600
*        HERE FOR ALL OPERATIONS TO REQUEST A VOLUME LABEL.             01427590
*                                                                       01428580
*        1. REQUEST VOLUME LABEL AND READ THE RESPONSE.                 01429570
*        2. READ THE CURRENT LABEL FROM THE REAL PACK.  THIS IS READ    01430560
*           INTO 'CPLABEL'.                                             01431550
*        3. IF "LABEL" FUNCTION, GO TO OP N.                            01432540
*        4. IF "ALLOCATE", THEN VERIFY THAT THE LABELS MATCH AND GO     01433530
*           TO OP X.                                                    01434520
*        5. IF "FORMAT", VERIFY THAT THE LABELS MATCH IF WE ARE NOT     01435510
*           FORMATTING CYLINDER/PAGE 0 - THEN GO TO OP P.               01436500
*        6. IF "FORMAT" AND WE ARE FORMATTING CYLINDER 0 THEN           01437490
*           GO TO OP O.                                                 01438480
*        7. IF LABELS DO NOT MATCH, THEN ISSUE ERROR MESSAGE.           01439470
*                                                                       01440460
* LOCAL REGISTER USAGE -                                                01441450
*                                                                       01442440
*        R4  - MESSAGE ADDRESS                                          01443430
*        R7  - LINKAGE                                                  01444420
*        R9  - CCW STRING ADDRESS                                       01445410
*        R14 - LINKAGE                                                  01446400
*                                                                       01447390
*.&******************************************************************** 01448380
         SPACE ,                                                        01449370
*---------------------------------------------------------------------- 01450360
*        MOVE IN THE FIRST LETTER OF INDATA (WOULD BE 'L' FOR LABEL     01451350
*        ONLY.  ISSUE 'ENTER DEVICE LABEL:' MESSAGE AND THEN CALL RMSG  01452340
*        TO READ THE RESPONSE.  LABEL ENTERED MUST BE LESS THAN 7       01453330
*        CHARACTERS WITH THE FIRST CHARACTER NON-BLANK.                 01454320
*---------------------------------------------------------------------- 01455310
         SPACE ,                                                        01456300
LAB      MVC   LOSW(1),INDATA          CHECK FIRST BYTE INDATA SAVED    01457290
LAB2     LA    R4,RDLAB                REQUEST VOLUME LABEL             01458280
         BAL   R14,WMSG                WRITE MESSAGE                    01459270
         BAL   R14,RMSG                READ RESPONSE                    01460260
         TM    CSW+4,UE                CANCEL OR UNIT CHECK             01461250
         BO    LAB2                    YES, TRY AGAIN                   01462240
         OC    INDATA(7),BLANKS8       CONVERT TO UPPER CASE            01463230
         CLI   INDATA+6,X'40'          TOO MUCH DATA ENTER?             01464220
         BNE   LAB2                    YES, BRANCH                      01465210
         CLI   INDATA,C' '             FIRST BYTE BLANK?                01466200
         BE    LAB2                    YES, ERROR, DO IT AGAIN          01467190
         SPACE ,                                                        01468180
*---------------------------------------------------------------------- 01469170
*        PREPARE THE CCWS FOR READING THE CURRENT LABEL FROM THE PACK.  01470160
*        LBLREC CCW STRING READS THE LABEL FROM A CKD. CALL STRTIO      01471150
*        TO READ THE LABEL INTO OSLABEL/CPLABEL.                        01472140
*---------------------------------------------------------------------- 01473130
         SPACE ,                                                        01474120
         XC    SEEKA(6),SEEKA          CLEAR CCW DATA AREA              01475110
         MVC   CPLABEL,=X'009596958500' PLUG IN LOWER CASE LABEL 'NONE' 01476100
         L     R2,=A(TABLE)   LOAD ADD OF ALLOC TABLE                   01477090
         LH    R3,=AL2(DL4096-1) LOAD ALLOC TABLE LENGTH                01478080
         SR    R4,R4          ZERO R4 FOR FILL OPERATION                01479070
         SR    R5,R5          ZERO R5 FOR FILL OPERATION                01480060
         ICM   R5,8,=X'FE'    SET PAD BYTE TO X'FE'                     01481050
         MVCL  R2,R4          FILL ALLOC TABLE WITH X'FE'               01482040
         LA    R9,LBLREC               PUT LABEL CCW ADDRESS INTO R9    01483030
         ST    R9,CAW                  LABEL CCW ADDRESS INTO CAW       01484020
         LH    R5,DSKADD               DEVICE ADDRESS INTO R5           01485010
         BAL   R14,STRTIO              GO START THE DEVICE              01486000
         SPACE ,                                                        01486990
*---------------------------------------------------------------------- 01487980
*        IF DURING ALLOCATION WE GET A UNIT CHECK WHILE READING THE     01488970
*        LABEL, THEN ISSUE A SENSE TO THE DEVICE AND DISPLAY AN ERROR   01489960
*        MESSAGE (GO TO FATAL).                                         01490950
*---------------------------------------------------------------------- 01491940
         SPACE ,                                                        01492930
         CLI   FLAG,C'A'               IS IT ALLOCATE?                  01493920
         BNE   LABELIOG                NO, SKIP CHECK FOR UC            01494910
         TM    CSW+4,UC                DID WE GET A CLEAN I/O?          01495900
         BNO   LABELIOG                YES, CONTINUE NORMALLY           01496890
         BAL   R7,SENSIT               NO, GO GET SENSE FOR MSG         01497880
         MVC   CCHHR(5),R4ALLOC        MOVE IN CCHHR DATA               01498870
         BAL   R7,SENSIT2              TYPE THE MESSAGE                 01499860
         MVI   ALLOERR,X'FF'  SET ALLOC ERROR SW ON                     01500850
         MVI   LABIOERR,X'FF' SET LABEL I/O ERROR SW ON                 01501840
         B     FATAL                                                    01502830
         SPACE ,                                                        01503820
*---------------------------------------------------------------------- 01504810
*        FOR THE "LABEL" FUNCTION, GO TO LABONLY.                       01505800
*        FOR "ALLOCATE", VERIFY THAT THE LABEL READ OFF THE DEVICE      01506790
*        MATCHES THE LABEL ENTERED BY THE USER.  THEN CONTINUE TO       01507780
*        'ALLOCATE'.                                                    01508770
*        FOR THE "FORMAT" FUNCTION:                                     01509760
*        IF FORMATTING CKD STARTING AT CYL 0, THEN GO TO FMT WHICH      01510750
*           PRESERVES ANY EXISTING OS FORMAT 4 LABEL ON TRACK 0.        01511740
*        IF FORMATTING CKD OTHERWISE & LABELS EQUAL, GO TO 'REGFORM1'.  01512730
*---------------------------------------------------------------------- 01513720
         SPACE ,                                                        01514710
LABELIOG EQU   *                                                        01515700
         CLI   LOSW,C'L'               LABEL ONLY?                      01516690
         BE    LABONLY                 YES BRANCH                       01517680
         CLI   FLAG,C'A'               IS IT ALLOCATE?                  01518670
         BE    LABMATCH                VERIFY LABELS IF ALLOC           01519660
         CLC   BEGIN,=X'0000'          IS IT REGULAR FORMAT?            01520650
         BE    FMT                     YES, CONTINUE                    01521640
         SPACE ,                                                        01522630
*---------------------------------------------------------------------- 01523620
*        IF THE LABEL READ FROM THE VOLUME DOES NOT MATCH THE LABEL     01524610
*        ENTERED BY THE USER, THEN ISSUE 'VOLID READ IS XXXXXX NOT      01525600
*        XXXXXX'.  GO BACK TO LAB2 TO RE-ISSUE 'ENTER DEVICE LABEL:'.   01526590
*---------------------------------------------------------------------- 01527580
         SPACE ,                                                        01528570
LABMATCH CLC   CPLABEL,INDATA          DO LABELS MATCH?                 01529560
         BNE   LABELBAD                NO, BRANCH                       01530550
         CLI   FLAG,C'F'               FORMAT?                          01531540
         BE    REGFORM1                YES,BRANCH                       01532530
         B     ALLOCATE                MUST BE ALLOCATE                 01533520
         SPACE ,                                                        01534510
LABELBAD MVC   WRONG+37(6),INDATA      SET UP LABEL                     01535500
         MVC   WRONG+26(6),CPLABEL     SET UP LABEL                     01536490
         LA    R4,WRONG                PRINT WRONG LABEL                01537480
         BAL   R14,WMSG                PRINT MESSAGE                    01538470
         CLI   CDSW2,X'FF'             CARD SWITCH ON?                  01539460
         BE    BADINPUT                YES, BRANCH                      01540450
         B     LAB2                    BRANCH                           01541440
*.3******************************************************************** 01542430
*                                                                       01543420
* OPERATION -                                                           01544410
*                                                                       01545400
* N. HANDLE "LABEL ONLY" FUNCTION                                       01546390
*                                                                       01547380
*        1. WRITE NEW CP VOLUME LABEL IN CYLINDER 0 HEAD 0 RECORD 3.    01548370
*        2. HANDLE ANY BAD STATUS RESULTING FROM WRITING OUT THE LABEL. 01549360
*        3. GET ANOTHER TASK FROM CONSOLE OR IPL DEVICE WHEN LABELLING  01550350
*           IS COMPLETE.                                                01551340
*                                                                       01552330
* LOCAL REGISTER USAGE -                                                01553320
*                                                                       01554310
*        R5  - DEVICE ADDRESS                                           01555300
*        R9  - ADDRESS OF CHANNEL PROGRAM                               01556290
*                                                                       01557280
*.&******************************************************************** 01558270
         SPACE ,                                                        01559260
*---------------------------------------------------------------------- 01560250
*        FOR A NON-CMS DISK, MOVE 'VOL1' INTO OSLABEL.                  01561240
*---------------------------------------------------------------------- 01562230
         SPACE ,                                                        01563220
LABONLY  MVC   CPLABEL(6),INDATA       MOVE IN NEW LABEL NAME           01564210
         CLC   =C'CMS=',OSLABEL        IS THIS A CMS DISK?              01565200
         BE    LABCMS                  YES                              01566190
         CLC   =C'CMS1',OSLABEL        IS IT CMS EDF LABEL?             01567180
         BE    LABCMS                  YES                              01568170
         MVC   OSLABEL(4),VOL1         NO, MAKE IT VOL1 LABEL           01569160
LABCMS   DS    0H                                                       01570150
         SPACE ,                                                        01571140
*---------------------------------------------------------------------- 01572130
*        GET THE APPROPRIATE CCW STRING FOR WRITING THE LABEL.          01573120
*        LABWRITE - WRITE LABEL ON CKD DEVICE.                          01574110
*---------------------------------------------------------------------- 01575100
         SPACE ,                                                        01576090
         LH    R5,DSKADD               DEVICE ADDRESS INTO R5           01577080
         LA    R9,LABWRITE             LABEL CCW CHAIN INTO R9          01578070
         ST    R9,CAW                  CAW POINTS TO LABEL CCWS         01579060
         BAL   R14,STRTIO1             WRITE OUT THE LABEL              01580050
         SPACE ,                                                        01581040
*---------------------------------------------------------------------- 01582030
*        HANDLE ANY BAD STATUS RESULTING FROM WRITING OUT THE LABEL.    01583020
*        FOR CC3 FROM TIO, ISSUE 'DEV XXX NOT OPERATIONAL OR NOT READY' 01584010
*        FOR CHANNEL ERRORS OR UNIT CHECK, GO ISSUE SENSE TO DEVICE AND 01585000
*           ISSUE ERROR MESSAGE.                                        01585990
*        FOR CHANNEL END, ISSUE 'LABEL IS NOW XXXXXX'.                  01586980
*---------------------------------------------------------------------- 01587970
         SPACE ,                                                        01588960
TIO      TIO   0(R5)          DRAIN THE INT                             01589950
         BC    2,*-4          LOOP UNTIL DONE                           01590940
         BC    1,TIOCC3       CC=3 - HELP . . .                         01591930
         TM    CSW+5,X'FF'    ANY BAD CHANNEL STATUS                    01592920
         BNZ   VOL1ERR        YES- FATAL                                01593910
         TM    CSW+4,UC       UNIT CHECK                                01594900
         BO    VOL1ERR        YES- BRANCH                               01595890
         TM    CSW+4,CE       CHANNEL END                               01596880
         BO    VOL1OK         YES- BRANCH ALL OK                        01597870
         B     TIO            NO- GO GET IT                             01598860
         SPACE ,                                                        01599850
VOL1ERR  BAL   R7,SENSIT      GET THE SENSE DATA                        01600840
         MVC   CCHHR(5),R3VOL1     MOVE IN THE CCHHR DATA               01601830
         BAL   R7,SENSIT2     TYPE THE MSG                              01602820
         B     FATAL                                                    01603810
         SPACE ,                                                        01604800
VOL1OK   MVC   LABELOK+14(6),CPLABEL    MOVE THE LABEL INTO THE MSG     01605790
         LA    R4,LABELOK     POINT TO THE MSG                          01606780
         BAL   R14,WMSG       AND GO TYPE IT                            01607770
         B     GETCARD        GO PROMPT FOR ANOTHER TASK                01608760
         SPACE ,                                                        01609750
TIOCC3   EQU   *                                                        01610740
         LA    R4,WR1         TELL HIM ABOUT PROBLEMS                   01611730
         BAL   R14,WMSG       . . .                                     01612720
         B     GETCARD        SEE IF THERE'S ANY MORE WORK.             01613710
*.3******************************************************************** 01614700
*                                                                       01615690
* OPERATION -                                                           01616680
*                                                                       01617670
* O. HANDLE FORMAT CYLINDER 0 FOR CKD -- OBTAIN PERTINENT TRACK AND     01618660
*    LABEL INFORMATION                                                  01619650
*                                                                       01620640
*        1. SAVE THE FMT4 DSCB INFORMATION AND INCLUDE IT IN THE        01621630
*           FORMAT4 DSCB WRITTEN BY US.                                 01622620
*        2. PRESERVE THE ALTERNATE TRACK ASSIGNMENT AND OS FORMAT 4     01623610
*           LABEL.                                                      01624600
*                                                                       01625590
* LOCAL REGISTER USAGE -                                                01626580
*                                                                       01627570
*                                                                       01628560
*.&******************************************************************** 01629550
         SPACE ,                                                        01630540
*---------------------------------------------------------------------- 01631530
*        IF CPLABEL STILL EQUALS ' none ', THEN THERE WAS A PROBLEM     01632520
*        READING RECORD 3 - SKIP SAVING ALTERNATE TRACK INFO.           01633510
*        IF OSLABEL INDICATES CMS (NOT VOL1), THEN SKIP SAVING INFO.    01634500
*                                                                       01635490
*        THE IBCDASDI FORMATTING UTILITY KEEPS THE CCHH FOR THE NEXT    01636480
*        AVAILABLE ALTERNATE TRACK AND THE NUMBER OF ALTERNATE TRACKS   01637470
*        IN THE FMT4 DSCB.  WE DO NOT WANT TO DESTROY THIS INFORMATION  01638460
*        WHEN CP WRITES ITS FORMAT4 DSCB; THE INFO WILL BE SAVED AND    01639450
*        INCLUDED IN THE FORMAT4 DSCB WRITTEN BY DMKFMT.  IBCDASDI AND  01640440
*        DMKFMT WRITE R3 WITH "VOL1".  CMS FORMAT WRITES NO FMT4 DSCB   01641430
*        AND THEREFORE THERE IS NO POINT IN LOOKING FOR THE INFO.       01642420
*---------------------------------------------------------------------- 01643410
         SPACE ,                                                        01644400
FMT      CLC   CPLABEL,=X'009596958500' PROB. READING R3?               01645390
         BE    REGFORM        YES, DON'T SAVE ALT. TRK INFO             01646380
         CLC   OSLABEL(3),=CL3'VOL' STD. LABEL                          01647370
         BNE   REGFORM        NO, SKIP CMS LABEL                        01648360
         TM    TYPE,X'70'     3330,334X,3350 OR 3380?                   01649350
         BZ    REGFORM        NO, THEN REG FORMAT                       01650340
         SPACE ,                                                        01651330
*---------------------------------------------------------------------- 01652320
*        IF THE VTOC ADDRESS IS ZEROES OR BELOW CCHHR = 0000000005,     01653310
*        THEN DON'T READ.  IBCDASDI DOES NOT PERMIT VTOC ON TRACK 0.    01654300
*        CP'S DMKFMT PLACES VTOC ON CCHHR = 0000000005.                 01655290
*---------------------------------------------------------------------- 01656280
         SPACE ,                                                        01657270
         CLC   VTOCBEG,=F'0'  VERIFY VTOC ADDRESS                       01658260
         BNE   READFMT4       GO AHEAD AND READ                         01659250
         CLI   VTOCR,X'05'    CANNOT BE LESS THAN R5                    01660240
         BL    REGFORM        NO POINT IN READING FMT4                  01661230
         SPACE ,                                                        01662220
*---------------------------------------------------------------------- 01663210
*        PRESERVE ALTERNATE TRACK ASSIGNMENT AND OS FORMAT 4 LABEL.     01664200
*---------------------------------------------------------------------- 01665190
         SPACE ,                                                        01666180
         DS    0H                                                       01667170
READFMT4 LA    R9,RDFMT4      CH. PGM. TO RD FMT4                       01668160
         MVC   SEEKA+2(4),VTOCBEG SETUP THE SEEK ADDRESS                01669150
         ST    R9,CAW         SETUP FOR THE CHANNEL PROGRAM             01670140
         BAL   R14,STRTIO     READ FMT4 LABEL                           01671130
         CLC   NEXTCCHH(2),HIVALUE NEXT AVAILABLE ALT TRACK             01672120
*                             BETTER BE IN ALT CYL                      01673110
         BL    REGFORM        NO, DON'T SAVE INFO                       01674100
SAVEALT  MVC   ALTCCHH,NEXTCCHH SAVE NEXT AVAIL. ALT TRK &              01675090
*                             NO. OF ALT. TRKS FOR CP'S FMT4            01676080
*.3******************************************************************** 01677070
*                                                                       01678060
* OPERATION -                                                           01679050
*                                                                       01680040
* P. FORMAT CKD                                                         01681030
*                                                                       01682020
*        FORMAT FROM THE STARTING CYLINDER UP TO AND INCLUDING THE      01683010
*        ENDING CYLINDER OF THE DASD DEVICE AS REQUESTED BY CONSOLE     01684000
*        OR IPL DEVICE INPUT.  FORMATTED RECORDS ARE 4096 BYTES (PAGE   01684990
*        SIZE).  IF WVFLAGS IS SET THEN PROMPT USER FOR WRITE           01685980
*        VERIFICATION AND SET WVFLAGS TO REFLECT RESPONSE IF ANY.       01686970
*                                                                       01687960
*        FORMAT CKD CYLINDER 0 AS FOLLOWS:                              01688950
*                                                                       01689940
*        REC 0 PAGE BIT MAP      - FLAGS BAD OR IN-USE PAGES            01690930
*        REC 1 IPL RECORD        - SYSTEM WAIT STATE 00C                01691920
*        REC 2 CHECKPOINT RECORD - DMKCKP CHECKPOINT ROUTINE            01692910
*        REC 3 OS VOL1 LABEL     - CONTAINS CP VOLUME LABEL             01693900
*        REC 4 ALLOCATION MAP    - ALLOCATION TYPE FOR EACH CYLINDER    01694890
*        REC 5 OS FORMAT 4 LABEL                                        01695880
*        REC 6 OS FORMAT 5 LABEL                                        01696870
*                                                                       01697860
*        FOR 3330:                                                      01698850
*           RF3 PAGE SIZE FILLER RECORD FOR FUTURE CP USE.              01699840
*        FOR 2314 AND 2319:                                             01700830
*           RF4 FILLER RECORD                                           01701820
*        FOR 3380:                                                      01702810
*           RF4-RF7 PAGE SIZE FILLER RECORDS                            01703800
*           RF8 FILLER RECORD                                           01704790
*           R7-R10 VALID PAGE RECORDS                                   01705780
*                                                                       01706770
*        CKD FORMATTING GENERAL NOTES:                                  01707760
*                                                                       01708750
*           A. WRITE CP VOLUME LABEL WHEN CYLINDER 0 IS FORMATTED,      01709740
*              OTHERWISE READ AND COMPARE CP VOLUME LABEL TO INPUT.     01710730
*           B. WRITE PAGE SIZE RECORDS ON THE REST OF CYLINDER 0        01711720
*              AND ALL OTHER CYLINDERS REQUESTED.                       01712710
*           C. WRITE VERIFY THAT EACH PAGE RECORD WAS WRITTEN           01713700
*              CORRECTLY WHEN REQUESTED.                                01714690
*           D. RECORD ANY BAD PAGE RECORD IN THE "PAGE BIT MAP"         01715680
*              LOCATED ON TRACK 0 RECORD 0 OF EACH CYLINDER.            01716670
*           E. PRINT BAD PAGE ADDRESSES AS THEY ARE FOUND.              01717660
*           F. PRINT TOTAL OF BAD PAGES AS THEY ARE FOUND WHEN          01718650
*              FORMAT IS COMPLETE.                                      01719640
*           G. GET ANOTHER TASK FROM CONSOLE OR IPL DEVICE WHEN         01720630
*              FORMAT IS COMPLETE.                                      01721620
*                                                                       01722610
*        1. RESTORE OS LABEL INFORMATION AND FORMAT4 DSCB; CLEAR        01723600
*           ALLOCATION TABLE. FOR PAGE 0/CYLINDER 0.                    01724590
*        2. ISSUE 'FORMAT STARTED'.                                     01725580
*        3. FOR EACH CYLINDER, MODIFY THE SEEK.  RESTORE/CLEAR THE      01726570
*           FORMAT OF THE RECORD FIELDS AND SEEK FIELDS.                01727560
*        4. HANDLE 3350 FILLER MODIFICATIONS AND HEAD INITIALIZATION.   01728550
*        5. HANDLE 3340 HEAD INITIALIZATION.                            01729540
*        6. HANDLE 3380 HEAD INITIALIZATION.                            01730530
*        7. LOAD THE NUMBER OF SEEK FIELDS FOR A PARTICULAR DASD DEVICE 01731520
*        8. INSERT THE PROPER CYLINDER NUMBER INTO THE RECORD DATA AREA 01732510
*        9. GO BEGIN THE SIO FORMATTING AT OP U.                        01733500
*                                                                       01734490
* LOCAL REGISTER USAGE -                                                01735480
*                                                                       01736470
*        R4  - WORK                                                     01737460
*        R5  - WORK                                                     01738450
*        R6  - DEVICE FORMAT TABLE ADDRESSABILITY                       01739440
*        R7  - WORK                                                     01740430
*        R14 - LINKAGE                                                  01741420
*                                                                       01742410
*.$******************************************************************** 01743400
         SPACE ,                                                        01744390
*---------------------------------------------------------------------- 01745380
*        FORMATTING STARTING FROM PAGE/CYLINDER 0:                      01746370
*        RESTORE OS LABEL INFORMATION, RESTORE FORMAT4 DSCB, CLEAR      01747360
*        ALLOCATION TABLE.                                              01748350
*---------------------------------------------------------------------- 01749340
         SPACE ,                                                        01750330
REGFORM  DS    0H                                                       01751320
         MVC   OSLABEL,SAVEVOL1      RESTORE TO IPL'ED DATA             01752310
         MVC   FMT4DATA(96),SAVEFMT4 RESTORE TO CP'S FMT4               01753300
         MVC   NEXTCCHH(6),ALTCCHH MOVE NEXT AVAIL ALT TRK &            01754290
*                             NO. OF ALT. TRKS TO CP'S FMT4             01755280
         XC    ALTCCHH(6),ALTCCHH CLEAR IN CASE SECOND PASS             01756270
         L     R4,=A(TABLE)   POINT TO START OF ALLOC BUFFER            01757260
         LH    R5,=AL2(DL4096-1)  LOAD TABLE LENGTH                     01758250
         SR    R7,R7          SET TO LENGTH                             01759240
         MVCL  R4,R6          CLEAR REST OF BUFFER                      01760230
         SPACE ,                                                        01761220
*---------------------------------------------------------------------- 01762210
*        FOR CKD, INITIALIZE THE ALLOCATION TABLE.                      01763200
*---------------------------------------------------------------------- 01764190
         SPACE ,                                                        01765180
         L     R4,=A(TABLE)   POINT TO START OF ALLOC BUFFER            01766170
         AH    R4,HIVALUE     HIVALUE+1 POINTS TO END OF MAP            01767160
         MVI   1(R4),X'FF'    TURN ON THE END OF TABLE FLAG             01768150
         SPACE ,                                                        01769140
*---------------------------------------------------------------------- 01770130
*        DETERMINE IF WRITE VERIFICATION PROMPT IS NECESSARY.           01771120
*        NOT ALL DASD SUPPORT THIS OPTION, IN WHICH CASE PROMPTING      01772110
*        IS NOT NECESSARY.                                              01773100
*---------------------------------------------------------------------- 01774090
         SPACE ,                                                        01775080
REGFORM1 DS    0H                                                       01776070
         MVC   CPLABEL(6),INDATA MOVE IN LABEL                          01777060
         TM    WVFLAGS,WVPMT  IF  PROMPT NOT REQUIRED                   01778050
         BZ    ENDWVRTN          EXIT WRT VERIF RTN                     01779040
PMTFORWV DS    0H                                                       01780030
         LA    R4,WVMSG1      GET WRITE VERIF. MSG #1                   01781020
         BAL   R14,WMSG          AND WRITE TO CONSOLE                   01782010
         LA    R4,WVMSG2      GET WRITE VERIF. MSG #2                   01783000
         BAL   R14,WMSG          AND WRITE TO CONSOLE                   01783990
         BAL   R14,RMSG       READ MESSAGE                              01784980
         TM    CSW+4,UE       IF UNIT EXCEP.                            01785970
         BO    PMTFORWV          THEN PROMPT AGAIN                      01786960
         SPACE ,                                                        01787950
*---------------------------------------------------------------------- 01788940
*        CONVERT RESPONSE, CHECK, AND SET NECESSARY WVFLAGS BIT         01789930
*---------------------------------------------------------------------- 01790920
         SPACE ,                                                        01791910
         OC    INDATA(3),BLANKS8       CONVERT TO UPPER CASE            01792900
         CLC   INDATA(3),=C'YES'       WHEN 'YES' RESPONSE              01793890
         BE    SETWVFLG                   THEN GO SET WVFLAGS           01794880
         CLC   INDATA(3),=C'YE '       WHEN 'YE ' RESPONSE              01795870
         BE    SETWVFLG                   THEN GO SET WVFLAGS           01796860
         CLC   INDATA(3),=C'Y  '       WHEN 'Y  ' RESPONSE              01797850
         BE    SETWVFLG                   THEN GO SET WVFLAGS           01798840
         B     STRWVMSK                OTHERWISE GO MASK CCW            01799830
SETWVFLG DS    0H                                                       01800820
         OI    WVFLAGS,WVREQ           INDICATE WRITE VERIF.            01801810
         B     ENDWVRTN                EXIT WRT VERIF. RTN              01802800
         SPACE ,                                                        01803790
*---------------------------------------------------------------------- 01804780
*        IF WRITE VERIFICATION IS NOT REQUESTED, THEN MASK OUT          01805770
*        PROGRAM CHAINING TO THE WRITE VERIFICATION PROGRAM.            01806760
*---------------------------------------------------------------------- 01807750
         SPACE ,                                                        01808740
STRWVMSK DS    0H                                                       01809730
         SR    R7,R7                   SET UP FOR GETTING DEV.          01810720
         BAL   R14,DFOADSET   SET ADDRESS TO FIND DEVICE/FORMAT         01811710
*                             DATA FOR THIS DEVICE TYPE                 01812700
         USING DFODATA,R6     ON RETURN R6 POINTS TO ENTRY              01813690
*                             DEVICE/FORMAT TABLE                       01814680
         SPACE ,                                                        01815670
*---------------------------------------------------------------------- 01816660
*        ALL ALTERATIONS TO CHANNEL PROGRAMS MUST BE RESTORED           01817650
*        ONCE THIS TASK IS COMPLETED.  THEREFORE ANY CHANGES MUST       01818640
*        BE IDENTIFIED (CHNGCCW) FOR LATER HOUSEKEEPING.                01819630
*---------------------------------------------------------------------- 01820620
         SPACE ,                                                        01821610
         L     R7,DFOCAWEW        LAST WRITE CCW IN WRITE PROG          01822600
         ST    R7,CCWCHNG         STORE ADDRESS OF THIS CCW.            01823590
         NI    4(R7),X'FF'-CC     MASK THE CC BIT AT THIS CCW           01824580
*                                  WHICH WILL AVOID WRT VERIF.          01825570
         DROP  R6                 DROP BASE REGISTER                    01826560
         SPACE ,                                                        01827550
*---------------------------------------------------------------------- 01828540
*        FORMATTING STARTING FROM OTHER THAN PAGE/CYLINDER 0.           01829530
*        ISSUE MESSAGE 'FORMAT STARTED'.                                01830520
*---------------------------------------------------------------------- 01831510
         SPACE ,                                                        01832500
ENDWVRTN DS    0H                 END WRT. VERIF. STRUCTURE             01833490
         LA    R4,PROGFOR     SET UP MESSAGE FORMAT STARTED             01834480
         BAL   R14,WMSG       WRITE MESSAGE                             01835470
         SPACE ,                                                        01836460
*---------------------------------------------------------------------- 01837450
*        ONETIME IS A BRANCH ON EQUAL TO 'CHECK0' TO CHECK CYLINDER 0   01838440
*        FOR ERRORS.  FOR THE FIRST TIME THROUGH, WE WANT TO GO TO      01839430
*        CHECK0, BUT ONLY ONCE.  THE ONETIME BRANCH IS NO-OPED LATER.   01840420
*        PGCOUNT KEEPS A COUNT OF PAGE ERRORS FOUND.                    01841410
*---------------------------------------------------------------------- 01842400
         SPACE ,                                                        01843390
         MVI   ONETIME+1,X'80' SET UP FOR EQUAL COMPARE                 01844380
         MVI   ALTFLAG,0      INIT FLAG FOR DASD I/O INT. HNDLR         01845370
         MVC   IONPSW(8),NEWPSW CHANGE NEW IO PSW                       01846360
         XC    PGCOUNT(4),PGCOUNT CLEAR FIELD                           01847350
         SPACE ,                                                        01848340
*---------------------------------------------------------------------- 01849330
*        FOR EACH CYLINDER, MODIFY THE SEEK.  GOA1 IS BRANCHED TO AFTER 01850320
*        ADVANCING TO THE NEXT CYLINDER.  RESTORE/CLEAR THE FORMAT OF   01851310
*        THE RECORD FIELDS AND THE SEEK FIELDS.                         01852300
*---------------------------------------------------------------------- 01853290
         SPACE ,                                                        01854280
GOA1     XC    ERCOUNT(4),ERCOUNT CLEAR ERROR COUNT                     01855270
         MVC   SEEKA(118),WKSEEK RESTORE TO STARTING SEEKS              01856260
         MVC   REC1(RNBYTE1),RNDATA RESTORE DASD RECORD FIELDS          01857250
         MVC   REC1+RNBYTE1(RNBYTE2),RNDATA+RNBYTE1   ....              01858240
         MVC   RECXX3(RNBYTES1),RNDATA1               ....              01859230
         CLI   TYPE,TYP3350   MODIFY FOR 3350 FILLER LENGTH             01860220
         BNE   GOTST40        NO, BYPASS FILLER MODIFICATIONS           01861210
         SPACE ,                                                        01862200
*---------------------------------------------------------------------- 01863190
*        3350:  FILLER MODIFICATIONS + HEAD INITIALIZATION.             01864180
*                                                                       01865170
*        THERE ARE 11 300-BYTE FILLER RECORDS FOR A 3350 PER CYLINDER.  01866160
*        FOR THE HEAD NUMBERS, CHANGE THEM TO FIT THE MOLD FOR 3350S.   01867150
*        A 3350 WILL HAVE 4 RECORDS PER HEAD, NOT 3 AS IS DEFINED IN    01868140
*        THE TABLE FOR 3330S.  3350S HAVE 3 HEADS PER CYLINDER.         01869130
*---------------------------------------------------------------------- 01870120
         SPACE ,                                                        01871110
         LA    R7,11          NUMBER OF FILLER CCWS           @V304498  01872100
         LA    R5,RECX1+6     FIRST FILLER CCW                          01873090
         LA    R4,300         ACTUAL FILLER LENGTH                      01874080
FILL3350 STH   R4,0(0,R5)     MODIFY FILLER CCW                         01875070
         LA    R5,16(R5)      UPDATE FILLER CCW ADDRESS                 01876060
         BCT   R7,FILL3350    PROCESS ALL FILLER CCWS         @V304498  01877050
         SPACE ,                                                        01878040
         MVI   REC4+3,RECN0   CHANGE HEAD 1 TO HEAD 0                   01879030
         MVI   RECX4+3,RECN0  CHANGE HEAD 1 TO HEAD 0                   01880020
         MVI   REC7+3,RECN1   CHANGE HEAD 2 TO HEAD 1                   01881010
         MVI   RECX7+3,RECN1  CHANGE HEAD 2 TO HEAD 1                   01882000
         MVI   REC8+3,RECN1   CHANGE HEAD 2 TO HEAD 1                   01882990
         MVI   RECX8+3,RECN1  CHANGE HEAD 2 TO HEAD 1                   01883980
         MVI   REC10+3,RECN2  CHANGE HEAD 3 TO HEAD 2                   01884970
         MVI   RECX10+3,RECN2 CHANGE HEAD 3 TO HEAD 2                   01885960
         MVI   REC11+3,RECN2  CHANGE HEAD 3 TO HEAD 2                   01886950
         MVI   RECX11+3,RECN2 CHANGE HEAD 3 TO HEAD 2                   01887940
         MVI   REC12+3,RECN2  CHANGE HEAD 3 TO HEAD 2                   01888930
         B     GOA2           INITIALIZE SEEK FIELDS                    01889920
         SPACE ,                                                        01890910
*---------------------------------------------------------------------- 01891900
*        3340:  HEAD INITIALIZATION.                                    01892890
*                                                                       01893880
*        THERE ARE NO FILLER RECORDS.  FOR A 3340, THERE WILL BE 2      01894870
*        RECORDS PER HEAD AND 6 HEADS PER CYLINDER.                     01895860
*---------------------------------------------------------------------- 01896850
         SPACE ,                                                        01897840
GOTST40  EQU   *                                                        01898830
         CLI   TYPE,X'40'     3340 DEVICE TYPE ?                        01899820
         BNE   GOTST80        NO, BYPASS FILLER MODIFICATIONS           01900810
         MVI   REC3+3,X'01'   CHANGE HEAD 0 TO HEAD 1                   01901800
         MVI   REC4+3,X'01'   CHANGE HEAD 1 TO HEAD 1                   01902790
         MVI   REC5+3,X'02'   CHANGE HEAD 1 TO HEAD 2                   01903780
         MVI   REC6+3,X'02'   CHANGE HEAD 1 TO HEAD 2                   01904770
         MVI   REC7+3,X'03'   CHANGE HEAD 2 TO HEAD 3                   01905760
         MVI   REC8+3,X'03'   CHANGE HEAD 2 TO HEAD 3                   01906750
         MVI   REC9+3,X'04'   CHANGE HEAD 2 TO HEAD 4                   01907740
         MVI   REC10+3,X'04'  CHANGE HEAD 3 TO HEAD 4                   01908730
         MVI   REC11+3,X'05'  CHANGE HEAD 3 TO HEAD 5                   01909720
         MVI   REC12+3,X'05'  CHANGE HEAD 3 TO HEAD 5                   01910710
         B     GOA2           GO INITIALIZE SEEK FIELDS                 01911700
         SPACE ,                                                        01912690
*---------------------------------------------------------------------- 01913680
*        3380:  HEAD INITIALIZATION.                                    01914670
*                                                                       01915660
*        THERE ARE NO FILLER RECORDS.  FOR A 3380 THERE WILL BE 10      01916650
*        RECORDS PER HEAD AND 3 HEADS PER CYLINDER.                     01917640
*---------------------------------------------------------------------- 01918630
         SPACE ,                                                        01919620
GOTST80  EQU   *                                                        01920610
         CLI   TYPE,TYP3380   3380 DEVICE TYPE?                         01921600
         BNE   GOA2           NO, BYPASS HEAD MODIFICATIONS             01922590
         MVI   REC4+3,RECN0   CHANGE HEAD 1 TO HEAD 0                   01923580
         MVI   REC5+3,RECN0   CHANGE HEAD 1 TO HEAD 0                   01924570
         MVI   REC6+3,RECN0   CHANGE HEAD 1 TO HEAD 0                   01925560
         MVI   REC7+3,RECN0   CHANGE HEAD 2 TO HEAD 0                   01926550
         MVI   REC8+3,RECN0   CHANGE HEAD 2 TO HEAD 0                   01927540
         MVI   REC9+3,RECN0   CHANGE HEAD 2 TO HEAD 0                   01928530
         MVI   REC10+3,RECN0  CHANGE HEAD 3 TO HEAD 0                   01929520
         MVI   REC11+3,RECN1  CHANGE HEAD 3 TO HEAD 0                   01930510
         MVI   REC12+3,RECN1  CHANGE HEAD 3 TO HEAD 0                   01931500
         SPACE ,                                                        01932490
*---------------------------------------------------------------------- 01933480
*        LOAD THE NUMBER OF SEEK FIELDS FOR A PARTICULAR DASD DEVICE.   01934470
*        R4 IS THE BEGINNING SEEK ADDRESS FOR THE CURRENT CYLINDER.     01935460
*        INSERT THE CORRECT CYLINDER INTO EACH SEEK FIELD.              01936450
*---------------------------------------------------------------------- 01937440
         SPACE ,                                                        01938430
GOA2     MVC   R1STUF(96),RNSTUF RESTORE 2314 RECORD FIELDS             01939420
         XC    R0STUF,R0STUF  CLEAR FIELD                               01940410
         SR    R7,R7          THIS MEANS: LOOK FOR PLAIN DEVICE         01941400
*                             DATA, WITHOUT SPECIAL                     01942390
         BAL   R14,DFOADSET   SET ADDRESS TO FIND DEVICE/FORMAT         01943380
*                             DATA FOR THIS DEVICE TYPE                 01944370
         USING DFODATA,R6     ON RETURN R6 POINTS TO ENTRY              01945360
*                             DEVICE/FORMAT TABLE                       01946350
         LH    R7,DFOTRPAS    TRACKS PER PASS COUNT AS LOOP CNT         01947340
         LH    R4,BEGIN       GET BEGINNING OR NEW CYL TO SEEK          01948330
         STH   R4,SEEK0+2     BEGINNING CYLINDER INTO SEEK0             01949320
         LA    R5,SEEKA+2     GET CCHH FIELD ADDRESS                    01950310
         SPACE ,                                                        01951300
STORE    EQU   *                                                        01952290
         STH   R4,0(R5)       MOVE CYL INTO NEXT SEEK DATA              01953280
         LA    R5,NXTSEEK(,R5) BUMP TO NEXT SEEK DATA FIELD             01954270
         BCT   R7,STORE       LOOP MAX# OF SEEK DATA TO BE              01955260
*                             UPDATED IN R7                             01956250
         SPACE ,                                                        01957240
*---------------------------------------------------------------------- 01958230
*        INSERT THE PROPER CYLINDER NUMBER INTO THE RECORD DATA AREA.   01959220
*---------------------------------------------------------------------- 01960210
         SPACE ,                                                        01961200
         L     R5,DFO1REC     POINT TO FIRST CCW DATA TO BE UPD         01962190
         LH    R7,DFONRECS    LOOP CNT. # OF CCW DATA TO BE UPD         01963180
         MVC   CAW,DFOCAW     GET PROPER CAW                            01964170
         SPACE ,                                                        01965160
STR      EQU   *                                                        01966150
         STH   R4,0(,R5)      MOVE CYLINDER INTO RECORD DATA            01967140
         LA    R5,NXTREC(,R5) POINT TO NEXT RECORD'S CYL.PART           01968130
         BCT   R7,STR         GO THRU AS SPECIFIED FOR DEVICE           01969120
         DROP  R6                                                       01970110
         SPACE ,                                                        01971100
*---------------------------------------------------------------------- 01972090
*        THE CAW IS NOW SET CORRECTLY.  GO TO THE COMMON ROUTINE TO     01973080
*        START THE ACTUAL FORMATTING.                                   01974070
*---------------------------------------------------------------------- 01975060
         SPACE ,                                                        01976050
SETUPIO  DS    0H                                                       01977040
         LH    R5,DSKADD      R5 CONTAINS DEVICE ADDRESS                01978030
         B     STIO           START DEVICE                              01979020
*.3******************************************************************** 01980010
*                                                                       01981000
* OPERATION -                                                           01981990
*                                                                       01982980
* Q. RESUME CKD FORMATTING FOLLOWING INTERRUPT RESOLUTION               01983970
*                                                                       01984960
*        COME HERE FROM IOINT (OP DD) TO RESUME FORMATTING AFTER A      01985950
*        DASD INTERRUPT (CE+DE) HAS BEEN ACCEPTED.  SINCE WE HAVE A     01986940
*        CLEAN STATUS, WE CAN CONTINUE HERE WITH EITHER UPDATING THE    01987930
*        SEEKS OR ADVANCING TO A NEW CYLINDER.                          01988920
*                                                                       01989910
*        1. IF LAST RECORD ON THIS CYLINDER WAS ALREADY WRITTEN,        01990900
*           THEN GO TO OP R TO ADVANCE TO THE NEXT CYLINDER.  ELSE,     01991890
*           GO TO STEP 2 TO UPDATE SEEK DATA AND HEADS.                 01992880
*        2. UPDATE HEAD NUMBERS IN SEEK CCWS.                           01993870
*        3. UPDATE DATA RECORD NUMBERS IN CCWS.                         01994860
*        4. FOR A 3380, UPDATE THE FILLER RECORDS.                      01995850
*        5. CONTINUE FORMATTING.                                        01996840
*                                                                       01997830
* LOCAL REGISTER USAGE -                                                01998820
*                                                                       01999810
*        R4  - SEEK CCHH                                                02000800
*        R5  - WORK                                                     02001790
*        R6  - DFODATA ADDRESSABILITY                                   02002780
*        R7  - WORK                                                     02003770
*        R14 - LINKAGE                                                  02004760
*                                                                       02005750
*.&******************************************************************** 02006740
         SPACE ,                                                        02007730
*---------------------------------------------------------------------- 02008720
*        2314:  IF LAST RECORD ON THIS CYLINDER WRITTEN, GO TO NEWCYL.  02009710
*        ELSE, UPDATE SEEK DATA AND HEADS.                              02010700
*---------------------------------------------------------------------- 02011690
         SPACE ,                                                        02012680
RESUMP   EQU   *                                                        02013670
         CLI   TYPE,TYP2314   IS IT 2314 ?                              02014660
         BNE   RESUMP05       NO, GO CHECK FOR OTHER DEVICES            02015650
         CLC   R8STUF+D4(L1),RECVALUE LAST RECORD ON THIS CYL           02016640
*                             WRITTEN?                                  02017630
         BE    NEWCYL         YES, GO FOR NEW CYLINDER                  02018620
         B     MAIN2          GO FOR UPDATE SEEK DATA + HEADS           02019610
         SPACE ,                                                        02020600
*---------------------------------------------------------------------- 02021590
*        3380:  IF LAST RECORD ON THIS CYLINDER WRITTEN, GO TO NEWCYL.  02022580
*        ELSE, UPDATE SEEK DATA AND HEADS.                              02023570
*---------------------------------------------------------------------- 02024560
         SPACE ,                                                        02025550
RESUMP05 EQU   *                                                        02026540
         CLI   TYPE,TYP3380   IS IT 3380?                               02027530
         BNE   RECONT         NO, BRANCH                                02028520
         CLC   REC30+D4(L1),RECVALUE LAST RECORD ON THIS CYL            02029510
*                             WRITTEN?                                  02030500
         BE    NEWCYL         YES, NEW CYLINDER                         02031490
         B     MAIN2          NO, BRANCH                                02032480
*---------------------------------------------------------------------- 02033470
*        NORMAL CKD:  WE WRITE 12 RECORDS AT A TIME.  IF LAST RECORD    02034460
*        WAS WRITTEN FROM CYLINDER, GO TO NEXT CYLINDER.  ELSE, GET     02035450
*        SEEK FIELDS AND UPDATE HEAD AND RECORD NUMBERS.                02036440
*---------------------------------------------------------------------- 02037430
         SPACE ,                                                        02038420
RECONT   EQU   *                                                        02039410
         OI    BFORWR57+4,CC  RESTORE CMD CHAINING IN CCW               02040400
*                             IT MAY HAVE BEEN ALTERED                  02041390
         MVC   WR57(8),OFF57WRT WRITE 12REC AT A TIME                   02042380
         MVC   RD57(8),OFF57RD  DO NORMAL READ CKD IN CCW               02043370
         CLC   REC12+4(1),RECVALUE WAS LAST RECORD WRITTEN?             02044360
         BE    NEWCYL         YES,BRANCH                                02045350
         CLI   TYPE,TYP3330   3330 DEVICE ?                             02046340
         BNE   MAIN2          NO, BYPASS 3330 REC 57 TRK CHANGE         02047330
         CLI   REC12+4,X'30'  DID I JUST WRITE 48TH REC.                02048320
         BNE   MAIN2          NO,BRANCH                                 02049310
         MVC   WR57(8),ON57WRT DO NOT WRITE REC 58 TO 60                02050300
         MVC   RD57(8),ON57RD  ALTER NOT TO READ CK 58 TO 60            02051290
         SPACE ,                                                        02052280
*---------------------------------------------------------------------- 02053270
*        FOR 3330 DASD, PRIOR TO WRITING RECORDS 49-57, ALTER CCW       02054260
*        CHAINING TO WRITE VERIFICATION PROGRAM TO REFLECT USER         02055250
*        REQUIREMENTS                                                   02056240
*---------------------------------------------------------------------- 02057230
         SPACE ,                                                        02058220
         MVC   BFORWR57+4(1),EWT3330+4 ALTER CC BIT                     02059210
         SPACE ,                                                        02060200
*---------------------------------------------------------------------- 02061190
*        UPDATE HEAD NUMBERS IN SEEK CCWS.                              02062180
*---------------------------------------------------------------------- 02063170
         SPACE ,                                                        02064160
MAIN2    EQU   *                                                        02065150
         XC    ERCOUNT,ERCOUNT CLEAR                                    02066140
         SR    R7,R7          THIS MEANS: LOOK FOR PLAIN DEVICE         02067130
*                             DATA, WITHOUT SPECIAL                     02068120
         BAL   R14,DFOADSET   SET ADDRESS TO FIND DEVICE/FORMAT         02069110
*                             DATA FOR THIS DEVICE TYPE                 02070100
         USING DFODATA,R6     ON RETURN R6 POINTS TO                    02071090
*                             ... DEVICE/FORMAT DATA ENTRY              02072080
         LH    R7,DFOTRPAS    TRACKS PER PASS COUNT AS LOOP CNT         02073070
         LA    R4,SEEKA+D2    POINT TO CCHH OF 1ST SEEK                 02074060
         SPACE ,                                                        02075050
HDUPDATE EQU   *                                                        02076040
         LH    R5,D2(,R4)     GET HH PORTION OF SEEK DATA               02077030
         AH    R5,DFOTRPAS    INCREASE BY # OF TRACKS PER PASS          02078020
         STH   R5,D2(,R4)     PUT HEAD NUMBER ONLY                      02079010
         LA    R4,NXTSEEK(,R4) POINT TO NEXT SEEK CCHH PORTION          02080000
         BCT   R7,HDUPDATE    LOOP UNTIL ALL HEADS ARE UPDATED          02080990
         DROP  R6                                                       02081980
         SPACE ,                                                        02082970
*---------------------------------------------------------------------- 02083960
*        UPDATE DATA RECORD NUMBERS IN CCWS.                            02084950
*---------------------------------------------------------------------- 02085940
         SPACE ,                                                        02086930
         BAL   R14,UPHDREC    GO UPDATE CCW DATA RECORD NUMBERS         02087920
         USING DFODATA,R6     ON RETURN R6 POINTS TO ENTRY              02088910
*                             IN DEVICE/FORMAT TABLE                    02089900
         MVC   CAW,DFOCAW     SET CORRECT CAW                           02090890
         DROP  R6                                                       02091880
         SPACE ,                                                        02092870
*---------------------------------------------------------------------- 02093860
*        FOR A 3380, UPDATE THE FILLER RECORDS.  IN ANY CASE, GO BACK   02094850
*        UP TO SETUPIO TO CONTINUE FORMATTING.                          02095840
*---------------------------------------------------------------------- 02096830
         SPACE ,                                                        02097820
         CLI   TYPE,TYP3380   IS THIS 3380 DEVICE ...                   02098810
         BNE   SETUPIO        NO, PREPARE THE IO                        02099800
         LA    R7,DFOTBSPE    THIS MEANS: LOOK FOR SPECIAL              02100790
*                             ENTRY IN DEVICE/FORMAT TABLE TO           02101780
*                             UPDATE FILLER RECORDS FOR 3380            02102770
         BAL   R14,DFOADSET   SET ADDRESS TO FIND DEVICE/FORMAT         02103760
*                             DATA FOR THIS DEVICE TYPE                 02104750
         BAL   R14,UPHDREC    GO UPDATE FILLER RECORDS                  02105740
         B     SETUPIO        GO PREPARE THE IO                         02106730
*.3******************************************************************** 02107720
*                                                                       02108710
* OPERATION -                                                           02109700
*                                                                       02110690
* R. CKD FORMAT - ADVANCE TO NEXT CYLINDER / WRITE SPECIAL SYSTEM       02111680
*                 RECORDS ON CYLINDER 0                                 02112670
*                                                                       02113660
*        1. IF AT THE LAST CYLINDER IN THE EXTENT, GO TO CLEANUP AT     02114650
*           OP V.  ELSE, INCREASE CYLINDER NUMBER BY 1 AND GO BACK TO   02115640
*           OP P.                                                       02116630
*        2. CHECK CYLINDER 0 FOR ERRORS.  IF THERE ARE NO ERRORS, THEN  02117620
*           WRITE SPECIAL SYSTEM RECORDS.  THIS IS DONE ONLY ONCE FOR   02118610
*           CYLINDER 0.                                                 02119600
*                                                                       02120590
* LOCAL REGISTER USAGE -                                                02121580
*                                                                       02122570
*        R1  - WORK                                                     02123560
*        R4  - WORK                                                     02124550
*        R6  - DFODATA TABLE ADDRESS                                    02125540
*        R7  - LINKAGE                                                  02126530
*        R9  - CHANNEL PROGRAM ADDRESS                                  02127520
*        R14 - LINKAGE                                                  02128510
*                                                                       02129500
*.&******************************************************************** 02130490
         SPACE ,                                                        02131480
*---------------------------------------------------------------------- 02132470
*        FOR FIRST TIME THROUGH FOR CYLINDER 0, GO CHECK CYLINDER 0     02133460
*        FOR ERRORS AND NO-OP THE BRANCH TO CHECK0 FOR THE FUTURE.      02134450
*        IF WE ARE ON THE LAST CYLINDER IN EXTENT, THEN GO TO CLEANUP.  02135440
*        OTHERWISE, INCREASE CYLINDER NUMBER BY 1 AND GO ADJUST SEEKS   02136430
*        TO NEXT CYLINDER.                                              02137420
*---------------------------------------------------------------------- 02138410
         SPACE ,                                                        02139400
NEWCYL   CLC   SEEKA+2(2),=X'0000' IS IT CYLINDER 0                     02140390
ONETIME  BE    CHECK0         YES,BRANCH AND NOP THIS BRANCH            02141380
         CLC   SEEKA+2(2),ENDING IS IT THE LAST CYLINDER?               02142370
         BE    CLEANUP        YES,BRANCH                                02143360
         SR    R4,R4          CLEAR R4                                  02144350
         LH    R4,SEEKA+2     PUT CYL NUMBER INTO R4                    02145340
         LA    R4,1(R4)       INCREASE CYL BY 1                         02146330
         STH   R4,BEGIN       SAVE NEW STARTING CYLINDER                02147320
         B     GOA1           GO SEEK NEXT CYLINDER                     02148310
         SPACE ,                                                        02149300
*---------------------------------------------------------------------- 02150290
*        CHECK CYLINDER 0 FOR ERRORS.  IF THERE ARE NO ERRORS, WRITE    02151280
*        SPECIAL SYSTEM RECORDS.                                        02152270
*---------------------------------------------------------------------- 02153260
         SPACE ,                                                        02154250
CHECK0   MVI   ONETIME+1,X'00' NOP BRANCH AT ONETIME                    02155240
         BAL   R1,*+4         R1 POINTS TO NEXT INSTRUCTION             02156230
         CLI   TYPE,TYP3350   IS DEVICE A 3350 ?                        02157220
         BE    CYL03350       YES, TEST FOR ERR REC CYL0 HD0            02158210
         CLI   TYPE,TYP3380   IS THIS 3380 ?                            02159200
         BE    CYL03380       YES, GO CHECK ERROR RECORD                02160190
         TM    R0STUF,X'E0'   ERR IN REC 1,2,3 ON CYL0 HD0              02161180
         SPACE ,                                                        02162170
*---------------------------------------------------------------------- 02163160
*        FOR ERROR(S) FOUND ON CYLINDER 0, HEAD 0, GET SENSE INFO AND   02164150
*        WRITE MESSAGE ON CONSOLE.                                      02165140
*---------------------------------------------------------------------- 02166130
         SPACE ,                                                        02167120
CHECK5   EQU   *                                                        02168110
         BZ    OKCYL0         NO - CONTINUE                             02169100
         BAL   R7,SENSIT      YES - GET SENSE INFO.                     02170090
         BAL   R7,SENSIT2     PRINT SENSE, CCHHR FOR HIM                02171080
         B     FATAL          AND TELL HIM THE CONDITION'S              02172070
*                             FATAL                                     02173060
         SPACE ,                                                        02174050
*---------------------------------------------------------------------- 02175040
*        TEST ERROR RECORDS ON CYLINDER 0, HEAD 0.                      02176030
*---------------------------------------------------------------------- 02177020
         SPACE ,                                                        02178010
CYL03350 TM    R0STUF,X'F0'   TEST ERR REC 1,2,3,4 ON CYL0 HD0          02179000
         B     CHECK5         CONTINUE CYL0 HD0 ERROR TEST              02179990
CYL03380 EQU   *                                                        02180980
         TM    R0STUF,ERBT3380 TEST ERR REC1 THRU 6                     02181970
         B     CHECK5         CONTINUE CYL0 HD0 ERROR TEST              02182960
         SPACE ,                                                        02183950
*---------------------------------------------------------------------- 02184940
*        CYLINDER 0 IS ERROR FREE.  PREPARE TO WRITE SPECIAL SYSTEM     02185930
*        RECORDS ON IT.  INDICATE THAT THE RECORDS ARE "IN USE".        02186920
*---------------------------------------------------------------------- 02187910
         SPACE ,                                                        02188900
OKCYL0   EQU   *                                                        02189890
         MVI   R0STUF,ERBT3380 MARK RECS 1 THRU 6 IN USE                02190880
         CLI   TYPE,TYP3380   IS THIS 3380 ?                            02191870
         BE    CYL0CONT       YES, BRANCH                               02192860
         MVI   R0STUF,X'E0'   SET REC 1,2,3 IN USE                      02193850
         CLI   TYPE,TYP3350   IS DEVICE A 3350 ?                        02194840
         BNE   CYL0CONT       NO, CONTINUE CYL0 PROCESSING              02195830
         MVI   R0STUF,X'F0'   SET REC 1,2,3,4 IN USE                    02196820
         SPACE ,                                                        02197810
*---------------------------------------------------------------------- 02198800
*        SPEC2314 PROGRAM WRITES SPECIAL SYSTEM RECORDS FOR 2314.       02199790
*        SPEC3330 PROGRAM WRITES SPECIAL SYSTEM RECORDS FOR OTHER       02200780
*           NORMAL CKD DEVICES.                                         02201770
*---------------------------------------------------------------------- 02202760
         SPACE ,                                                        02203750
CYL0CONT EQU   *              WRITE CYL0 HD0 SYSTEM RECORDS             02204740
         L     R9,=A(R4COUNT) MOVE COUNT FIELD NEXT TO                  02205730
         MVC   0(L'R4COUNT,R9),R4ALLOC  ALLOC MAP BUFFER                02206720
         LA    R9,SPEC2314    R9 CONTAINS ADDRESS OF SPEC CCWS          02207710
         ST    R9,CAW         CAW CONTAINS ADDRESS OF CCWS              02208700
         CLI   TYPE,X'14'     IS IT 2314?                               02209690
         BE    MAIN4          YES, BRANCH                               02210680
         MVC   CAW(4),=A(SPEC3330) SET CAW FOR CYL 0 TK 0 CCWS          02211670
         CLI   TYPE,TYP3380   IS THIS 3380 ?                            02212660
         MVC   NOP3340,TIC3380 MOVE IN 3380 SPECIAL WRITES              02213650
         BE    MAIN4          YES, CONTINUE                             02214640
         MVC   NOP3340,WRT3340 MOVE BACK ORIGINAL CCW                   02215630
         CLI   TYPE,TYP334X   3340-35 OR 3340-70 DEVICE?                02216620
         BNE   MAIN4          BRANCH IF NOT                             02217610
         MVI   NOP3340,X'03'  SET RF3 CCW OP-CODE TO NOP                02218600
         SPACE ,                                                        02219590
MAIN4    MVI   SEEKA+5,X'00'  SET TO SEEK HEAD 0                        02220580
         MVI   SEEKB+5,X'01'  SET TO SEEK HEAD 1                        02221570
         LH    R5,DSKADD      DEVICE ADDRESS INTO R5                    02222560
         B     STIO           START DEVICE                              02223550
*.3******************************************************************** 02224540
*                                                                       02225530
* OPERATION -                                                           02226520
*                                                                       02227510
* U.  COME HERE TO WRITE AND VERIFY PAGE SIZE RECORDS                   02228500
*                                                                       02229490
*        1. BEGIN THE FORMATTING.  IF NON-ZERO CC FROM SIO, RETRY 100   02230480
*           TIMES.  FOR CC=0 FROM SIO, GO TO STEP 3.                    02231470
*        2. IF STILL NON-ZERO CC AFTER 100 TRIES, THEN OBTAIN THE       02232460
*           SENSE INFORMATION IF WE DO NOT ALREADY HAVE IT.             02233450
*        3. CALL SENSIT2 TO ISSUE THE ERROR MESSAGE TO THE USER GIVING  02234440
*           THE CCHHR AND THE SENSE DATA.                               02235430
*        4. LOAD A WAIT STATE AND WAIT FOR CE+DE FROM DEVICE.           02236420
*                                                                       02237410
* LOCAL REGISTER USAGE -                                                02238400
*                                                                       02239390
*        R7  - WORK                                                     02240380
*        R14 - LINKAGE                                                  02241370
*                                                                       02242360
*.$******************************************************************** 02243350
         SPACE ,                                                        02244340
*---------------------------------------------------------------------- 02245330
*        GO START THE CHANNEL PROGRAM FORMATTING THE DEVICE.  IF WE     02246320
*        RECEIVE CC0 FROM SIO, THEN WE STARTED OK SO LOAD A WAIT STATE  02247310
*        AT XWAIT AND WAIT FOR CE+DE.  FOR A CC3, ISSUE 'DEV XXX NOT    02248300
*        OPERATIONAL OR NOT READY' TO USER.  FOR BUSY CC2, RETRY 100    02249290
*        TIMES BEFORE ISSUING THE 'NOT OPERATIONAL' MESSAGE.            02250280
*        FOR CC1, AFTER RE-ISSUING SIO FOR 100 TIMES, CHECK THE CSW     02251270
*        STATUS AT RDCERR.                                              02252260
*---------------------------------------------------------------------- 02253250
STIO     MVC   CCHHR(5),FFS8  PUT F'S IN HEADER.                        02254240
STIO2    LA    R7,100         ERROR RETRY COUNT.                        02255230
START    BAL   R14,STRTIO1    GO START THE DEVICE                       02256220
         BC    8,XWAIT        IF STARTED OK GO WAIT                     02257210
         BC    1,TIOCC3       CC = 3, NOTIFY USER                       02258200
         BC    2,TIORT        BUSY                                      02259190
         TM    CSW+4,SM+BUSY  STATUS MODIFIER AND BUSY                  02260180
         BO    START          YES, RETRY                                02261170
         CLI   CSW+4,BUSY     DEVICE BUSY (RESERVED)                    02262160
         BE    START          LOOP UNTIL RELEASE                        02263150
TIORT    TIO   0(R5)          IF NO START CLEAR STATUS                  02264140
         BCT   R7,START       TRY A TOTAL OF 100 TIMES                  02265130
         BC    3,TIOCC3       SERIOUS PROBLEMS - LET HIM KNOW           02266120
         SPACE ,                                                        02267110
*---------------------------------------------------------------------- 02268100
*        FOR A UNIT CHECK, WE HAVE THE SENSE DATA.  ELSE, GET THE SENSE 02269090
*        DATA.  THEN ISSUE THE MESSAGE 'IO ERROR XXX CCHHR = XXXXXXXXXX 02270080
*        SENSE = XXXXXXXXXXXX' AND THEN GO TO FATAL.                    02271070
*---------------------------------------------------------------------- 02272060
         SPACE ,                                                        02273050
RDCERR   EQU   *                                                        02274040
         TM    CSW+4,UC       DID DEVICE HAVE UNIT CHECK                02275030
         BO    STARTER1       NO, ERROR SET UP MSG                      02276020
         XC    SENSE,SENSE    CLEAR SENSE AREA                          02277010
         XC    SENSTA(8),SENSTA CLEAR SENSE CSW                         02278000
         MVI   SENSTA+7,X'1A' INDICATE 6 SENSE BYTES                    02278990
         MVC   SAVEIT(20),IOOPSW SAVE CSW,CAW, AND IO OLD PSW           02279980
         B     STARTER2       GO SET UP BOTH ERROR MSG                  02280970
STARTER1 BAL   R7,SENSIT      GET SENSE DATA                            02281960
STARTER2 BAL   R7,SENSIT2     PRINT SENSE MESSAGE                       02282950
         B     FATAL          GO FATAL                                  02283940
         SPACE ,                                                        02284930
*---------------------------------------------------------------------- 02285920
*        FORMATTING STARTED -                                           02286910
*        LOAD THE WAIT PSW AND WAIT FOR A DEVICE INTERRUPT.             02287900
*---------------------------------------------------------------------- 02288890
         SPACE ,                                                        02289880
         CNOP  4,8                                                      02290870
XWAIT    LPSW  WAITCON                                                  02291860
WAITCON  DC    X'FE02'                                                  02292850
         SPACE ,                                                        02293840
         DC    A(255)                                                   02294830
*.3******************************************************************** 02295820
*                                                                       02296810
* OPERATION -                                                           02297800
*                                                                       02298790
* V. COME HERE AFTER FORMAT OPERATION IS COMPLETE.                      02299780
*                                                                       02300770
*        1. ISSUE 'FORMAT DONE'.                                        02301760
*        2. ISSUE MESSAGE INDICATING NUMBER OF PAGE ERROR RECORDS.      02302750
*        3. REPEAT PROMPTING FOR NEW FUNCTION TO PERFORM WHEN           02303740
*           USING CONSOLE AS INPUT OR READ NEXT FUNCTION FROM           02304730
*           THE IPL DEVICE.                                             02305720
*                                                                       02306710
* LOCAL REGISTER USAGE -                                                02307700
*                                                                       02308690
*        R3  - PAGE COUNT                                               02309680
*        R4  - MESSAGE ADDRESS                                          02310670
*        R14 - LINKAGE                                                  02311660
*                                                                       02312650
*.$******************************************************************** 02313640
         SPACE ,                                                        02314630
*---------------------------------------------------------------------- 02315620
*        ISSUE 'FORMAT DONE' MESSAGE.                                   02316610
*---------------------------------------------------------------------- 02317600
         SPACE ,                                                        02318590
CLEANUP  LA    R4,ENDFOR               SET UP FOR END OF FORMAT MSG     02319580
         MVC   IONPSW(8),CONSIRA       SET UP NEW IO PSW                02320570
         BAL   R14,WMSG                WRITE MESSAGE                    02321560
         SPACE ,                                                        02322550
*---------------------------------------------------------------------- 02323540
*        IF WRITE VERIFICATION IS NOT OPTIONAL FOR THIS DEVICE          02324530
*        (ALWAYS PERFORMED) OR WRITE VERIFICATION IS OPTIONAL AND       02325520
*        WAS REQUESTED THEN GO GET ERROR PAGE COUNT AND PRINT;          02326510
*        OTHERWISE, GO DO SOME HOUSEKEEPING.                            02327500
*---------------------------------------------------------------------- 02328490
         SPACE ,                                                        02329480
         CLI   WVFLAGS,WVNOTOPT IF WRITE VERIF. NOT OPTIONAL            02330470
         BE    PRTPGCNT            THEN GO PRINT PAGE COUNT             02331460
         TM    WVFLAGS,WVREQ  IF WRITE VERIF. WAS REQUESTED             02332450
         BO    PRTPGCNT          THEN GO PRINT PAGE COUNT               02333440
         LA    R4,WVMSG3      GET WRITE VERIFICATION MSG # 3            02334430
         BAL   R14,WMSG          AND WRITE TO CONSOLE                   02335420
         L     R7,CCWCHNG     GET ADDRESS OF CHANGED CCW AND            02336410
         OI    4(R7),CC          RESET CC BIT                           02337400
         XC    CCWCHNG,CCWCHNG CLEAR CCWCHNG FIELD                      02338390
         B     ENDWVCLP       EXIT TO COMMON CODE                       02339380
         SPACE ,                                                        02340370
*---------------------------------------------------------------------- 02341360
*        ISSUE 'XXXX NO. PAGE RECORDS WITH READ-CHECK ERRORS' MESSAGE   02342350
*---------------------------------------------------------------------- 02343340
         SPACE ,                                                        02344330
PRTPGCNT DS    0H                                                       02345320
         L     R3,PGCOUNT              GET ERROR PAGE COUNT             02346310
         CVD   R3,FIELDA               CONVERT ERROR COUNT TO DECIMAL   02347300
         OI    FIELDA+7,X'0F'          MAKE GOOD SIGN                   02348290
         UNPK  FIELDB+8-CYLNUM(CYLNUM),FIELDA+5(3)                      02349280
*                                    UNPACK TO PRINTABLE CHAR.          02350270
         MVC   PAGE+1(CYLNUM),FIELDB+8-CYLNUM                           02351260
*                                    PUT ERROR COUNT INTO MSG.          02352250
         LA    R4,PAGE                 SET UP ERROR PAGE MSG            02353240
         BAL   R14,WMSG                WRITE MESSAGE                    02354230
         SPACE ,                                                        02355220
*---------------------------------------------------------------------- 02356210
*        GET NEW FUNCTION TO PERFORM.                                   02357200
*---------------------------------------------------------------------- 02358190
         SPACE ,                                                        02359180
ENDWVCLP DS    0H                                                       02360170
         B     GETCARD                 END FORMAT, BRANCH               02361160
*.3******************************************************************** 02362150
*                                                                       02363140
* OPERATION -                                                           02364130
*                                                                       02365120
* W. FATAL ERROR ENCOUNTERED                                            02366110
*                                                                       02367100
*        1. ISSUE THE ERROR MESSAGE 'FATAL DASD IO ERROR  CSW = XXXXXXX 02368090
*           XXXX'.  THEN RETURN TO BEGINNING.                           02369080
*                                                                       02370070
* LOCAL REGISTER USAGE -                                                02371060
*                                                                       02372050
*        R4  - ADDRESS OF FATAL MESSAGE                                 02373040
*        R14 - LINKAGE                                                  02374030
*                                                                       02375020
*.&******************************************************************** 02376010
         SPACE ,                                                        02377000
FATAL    STM   R0,R15,PCREGS           SAVE R0 TO R15                   02377990
         MVC   SAVFATAL(20),IOOPSW     SAVE IOOLDPSW,CSW,CAW            02378980
         UNPK  WORK(9),SAVFATAL+8(5)   UNPACK THE CSW                   02379970
         UNPK  WORK+8(9),SAVFATAL+12(5) . . .                           02380960
         TR    WORK(16),TTAB-240       MAKE IT ALL READABLE             02381950
         MVC   FATLMSG+37(16),WORK     MOVE INTO MESSAGE                02382940
         LA    R4,FATLMSG              SET UP FATAL MSG                 02383930
         MVC   IONPSW(8),CONSIRA       SET UP NEW IO PSW                02384920
         BAL   R14,WMSG                WRITE MESSAGE                    02385910
         B     GETCARD                 YES,BRANCH                       02386900
*.3******************************************************************** 02387890
*                                                                       02388880
* OPERATION -                                                           02389870
*                                                                       02390860
* X. ALLOCATION ROUTINE                                                 02391850
*                                                                       02392840
*        CALLED FROM OP M AFTER VERIFYING THAT THE LABEL ENTERED BY THE 02393830
*        USER MATCHES THE REAL VOLUME LABEL.                            02394820
*                                                                       02395810
*        1. VERIFY THAT WE HAVE A CP-OWNED VOLUME.                      02396800
*        2. DISPLAY 'ENTER ALLOCATION DATA FOR VOLUME XXXXXX'.          02397790
*        3. ISSUE 'TYPE CYL CYL' AND GO TO OP Y.                        02398780
*                                                                       02399770
* LOCAL REGISTER USAGE -                                                02400760
*                                                                       02401750
*        R3  - ALLOCATION TABLE ADDRESSABILITY                          02402740
*        R4  - WORK/MESSAGE ADDRESS                                     02403730
*        R5  - WORK/NUMBER OF ENTRIES IN MAP                            02404720
*        R14 - LINKAGE                                                  02405710
*                                                                       02406700
*.$******************************************************************** 02407690
         SPACE ,                                                        02408680
*---------------------------------------------------------------------- 02409670
*        VERIFY THAT LABEL IS 'CP370' FOR A CP-OWNED VOLUME.  IF THIS   02410660
*        IS NOT TRUE, PRINT "ALLOCATION FUNCTION NOT ALLOWED, FORMAT OF 02411650
*        VOLUME IS A PREREQUISITE".  RE-DISPLAY "FORMAT OR ALLOCATE"    02412640
*        MESSAGE AT LABEL SELECT.                                       02413630
*---------------------------------------------------------------------- 02414620
         SPACE ,                                                        02415610
ALLOCATE EQU   *                                                        02416600
         CLC   LCP370,CP370   VOLUME OWNED BY CP                        02417590
         BE    ALLOC1         YES, ALLOCATION ALLOWED                   02418580
         MVC   LCP370,CP370   RESTORE CP370 SINCE READ CCW              02419570
         LA    R4,MSG742      OVERLAID IT                               02420560
         BAL   R14,WMSG       INFORM USER                               02421550
         LA    R4,MSG742A     GET PREREQ FORMATTING MSG                 02422540
         BAL   R14,WMSG       AND WRITE IT                              02423530
         TM    CDSW2,X'FF'    IS CARD SWITCH ON                         02424520
         BO    BADINPUT       YES, PRINT CARD AND QUIT                  02425510
         B     SELECT         ELSE  BACK TO SELECT                      02426500
         SPACE ,                                                        02427490
*---------------------------------------------------------------------- 02428480
*        VERIFY LABEL AND WRITE MESSAGE INDICATING USER EXTENTS.        02429470
*        DISPLAY THE MESSAGE - 'ENTER ALLOCATION DATA FOR VOLUME XXXXX' 02430460
*---------------------------------------------------------------------- 02431450
         SPACE ,                                                        02432440
ALLOC1   DS    0H             ALLOCATION FUNCTION IS OK                 02433430
         MVC   DATAMSG1(6),CPLABEL PUT LABEL INTO MESSAGE               02434420
         MVC   ALLEND+19(6),CPLABEL PUT LABEL INTO CONSOLE MSG          02435410
         LA    R4,DATAMSG     SET UP DATA MSG                           02436400
         BAL   R14,WMSG       WRITE MESSAGE                             02437390
         SPACE ,                                                        02438380
*---------------------------------------------------------------------- 02439370
*        ISSUE 'TYPE CYL CYL'.                                          02440360
*---------------------------------------------------------------------- 02441350
         LA    R4,ALMSG       SET UP CYLINDER ALLOCATION MSG            02442340
         BAL   R14,WMSG       WRITE MESSAGE                             02443330
*.3******************************************************************** 02444320
*                                                                       02445310
* OPERATION -                                                           02446300
*                                                                       02447290
* Y. ALLOCATION ROUTINE COMMON CODE FOR FETCHING AND SETTING THE        02448280
*    TYPE OF ALLOCATION                                                 02449270
*                                                                       02450260
*    +----------------------------------------------------------------+ 02451250
*    |TYPE  BYTE      DESCRIPTION OF ALLOCATION TYPE                  | 02452240
*    +----------------------------------------------------------------+ 02453230
*    |TEMP   00    TEMP STORAGE SPACE RESERVED FOR SPOOLING/PAGING    | 02454220
*    |PERM   01    CP NUCLEUS, LOGOUT AREA, USER MINIDISKS            | 02455210
*    |TDSK   02    TEMPORARY MINIDISK SPACE FOR VIRTUAL MACHINE USERS | 02456200
*    |DRCT   04    RESERVED FOR DIRECTORY FILES                       | 02457190
*    |       0C    DIRECTORY SPACE IN USE BY DMKDIR                   | 02458180
*    |       FF    END OF ALLOCATION EXTENT MAP                       | 02459170
*    +----------------------------------------------------------------+ 02460160
*                                                                       02461150
*    1. READ THE ALLOCATION TYPE AND EXTENTS FROM CONSOLE OR CARD       02462140
*       INPUT.                                                          02463130
*    2. HANDLE CONSOLE INPUT.  CHECK THE FIRST FIELD FOR VALID TYPE.    02464120
*       AFTER GETTING TYPE, GO TO OP Z.                                 02465110
*    3. HANDLE CARD INPUT.  CHECK THE FIRST FIELD FOR VALID TYPE.       02466100
*       AFTER GETTING TYPE, GO TO OP Z.                                 02467090
*    4. CHECK FOR 'END' SPECIFIED (NO OTHER VALID TYPE FOUND).          02468080
*       IF 'END' FOUND, THEN GO TO OP BB TO WRITE ALLOCATION TABLE      02469070
*       TO DASD OR CONSOLE OR BOTH.                                     02470060
*    5. IF 'END' NOT FOUND, THEN ISSUE ERROR MESSAGE.                   02471050
*                                                                       02472040
* LOCAL REGISTER USAGE -                                                02473030
*                                                                       02474020
*        R4  - MESSAGE ADDRESS                                          02475010
*        R14 - LINKAGE                                                  02476000
*                                                                       02476990
*.$******************************************************************** 02477980
         SPACE ,                                                        02478970
*---------------------------------------------------------------------- 02479960
*        READ THE ALLOCATION TYPE AND EXTENTS FROM CONSOLE OR CARD.     02480950
*---------------------------------------------------------------------- 02481940
         SPACE ,                                                        02482930
ANOTCARD EQU   *                                                        02483920
         CLI   CDSW2,X'FF'    IS IT CARD INPUT?                         02484910
         BE    GETCARD        YES GET ANOTHER CARD                      02485900
         SPACE ,                                                        02486890
REREAD   EQU   *                                                        02487880
         BAL   R14,RMSG       READ RESPONSE                             02488870
         TM    CSW+4,UE       WAS IT UNIT CK OR UNIT EXCEPTION          02489860
         BO    REREAD         YES,TRY AGAIN                             02490850
         CLI   CDSW2,X'FF'    IS IT CARD INPUT?                         02491840
         BE    CHECKCDS       YES....GO CHECK THEM                      02492830
         SPACE ,                                                        02493820
*---------------------------------------------------------------------- 02494810
*        HERE FOR CONSOLE INPUT - CHECK THE FIRST FIELD FOR TYPE.       02495800
*---------------------------------------------------------------------- 02496790
         OC    INDATA(5),BLANKS8 CONVERT TO UPPER CASE                  02497780
         CLC   INDATA(5),=C'TEMP ' IS IT TEMPORARY ?                    02498770
         MVI   ATYPE,X'00'    CLEAR TYPE TO 00                          02499760
         BE    AOKALL         BRANCH IF TEMP                            02500750
         CLC   INDATA(5),=C'PERM ' IS IT  PERMANENT ?                   02501740
         MVI   ATYPE,X'01'    TYPE IS 01                                02502730
         BE    AOKALL         BRANCH IF PERMANENT                       02503720
         CLC   INDATA(5),=C'TDSK ' IS IT TEMP DISK ?                    02504710
         MVI   ATYPE,X'02'    TYPE IS 02                                02505700
         BE    AOKALL         IF TEMP DISK BRANCH                       02506690
         CLC   INDATA(5),=C'DRCT ' IS IT DIRECTORY ?                    02507680
         MVI   ATYPE,X'04'    TYPE IS 04                                02508670
         BE    AOKALL         IF DIRECTORY BRANCH                       02509660
         B     CKEND          NOW GO CHECK FOR AN END                   02510650
         SPACE ,                                                        02511640
*---------------------------------------------------------------------- 02512630
*        HERE FOR CARD INPUT - CHECK THE FIRST FIELD FOR TYPE.          02513620
*---------------------------------------------------------------------- 02514610
         SPACE ,                                                        02515600
CHECKCDS MVC   INDATA(5),CDINPUT   MOVE TYPE FROM CARD                  02516590
         MVC   INDATA(80),CDINPUT GET THE CARD INPUT                    02517580
         OC    INDATA(5),BLANKS8 CONVERT TO UPPER CASE                  02518570
         CLC   INDATA(5),=C'TEMP,' IS IT TEMPORARY?                     02519560
         MVI   ATYPE,X'00'    CLEAR TYPE TO 00                          02520550
         BE    AOKALL         BRANCH IF TEMPORARY                       02521540
         CLC   INDATA(5),=C'PERM,' IS IT PERMANENT?                     02522530
         MVI   ATYPE,X'01'    TYPE IS 01                                02523520
         BE    AOKALL         BRANCH IF PERMANENT                       02524510
         CLC   INDATA(5),=C'TDSK,' IS IT TEMP DISK?                     02525500
         MVI   ATYPE,X'02'    TYPE IS 02                                02526490
         BE    AOKALL         BRANCH IF TEMP DISK                       02527480
         CLC   INDATA(5),=C'DRCT,' IS IT DIRECTORY?                     02528470
         MVI   ATYPE,X'04'    TYPE IS 04                                02529460
         BE    AOKALL         BRANCH IF DIRECTORY                       02530450
         SPACE ,                                                        02531440
*---------------------------------------------------------------------- 02532430
*        WHETHER ALLOCATION EXTENTS ARE ENTERED OR NOT, 'END' MUST BE   02533420
*        TYPED AT THIS POINT SINCE NOTHING ELSE WAS RECOGNIZED AS       02534410
*        VALID.  WRITE OUT THE ALLOCATION TABLE AT LABEL FINI.          02535400
*        IF 'END' WAS NOT FOUND, THEN ISSUE 'TYPE OR CYL INVALID'       02536390
*        FOR CARD INPUT DISPLAY THE CARD AND GO VALIDATE CARD INPUT.    02537380
*---------------------------------------------------------------------- 02538370
         SPACE ,                                                        02539360
CKEND    EQU   *                                                        02540350
         CLC   INDATA(4),=C'END ' WAS 'END' TYPED?                      02541340
         BE    FINI           IF END GO WRITE ALLOCATION TABLE          02542330
         LA    R4,TYPERR      SET UP TO PRINT ERROR                     02543320
         BAL   R14,WMSG       WRITE MESSAGE                             02544310
         TM    CDSW2,X'FF'    CARD INPUT?                               02545300
         BNO   REREAD         NO,BRANCH                                 02546290
         LA    R4,CARDMESS    SET UP ERROR MSG                          02547280
         BAL   R14,WMSG       WRITE MESSAGE                             02548270
         MVI   ALLOERR,X'FF'  ALLOCATE ERROR TURNED ON                  02549260
         B     VALIDATE       BRANCH                                    02550250
AOKALL   EQU   *                                                        02551240
*.3******************************************************************** 02552230
*                                                                       02553220
* OPERATION -                                                           02554210
*                                                                       02555200
* Z. ALLOCATE CKD                                                       02556190
*                                                                       02557180
*        COME HERE FROM OP Y ABOVE WITH THE 'ATYPE' BYTE EQUAL TO THE   02558170
*        ALLOCATION TYPE AND THE CYLINDER EXTENTS IN INDATA.            02559160
*                                                                       02560150
*        UPDATE ALLOCATION TABLE IN CORE FROM CONSOLE OR IPL DEVICE     02561140
*        INPUT.  WE THEN WRITE THE CYLINDER ALLOCATION INTO THE CYL     02562130
*        BYTE MAP LOCATED IN RECORD 4 OF CYLINDER 0 HEAD 0.  THIS MAP   02563120
*        WILL LATER BE DISPLAYED ON THE CONSOLE.                        02564110
*                                                                       02565100
*        1. PROCESS THE INPUT DATA TO DETERMINE STARTING AND ENDING     02566090
*           CYLINDERS.  MOVE THE CORRECT FORMAT OF THE STARTING AND     02567080
*           ENDING CYLINDER NUMBERS BACK INTO INDATA AFTER DELETING     02568070
*           ANY LEADING ZEROES OR CHECKING FOR 3 OR 4 DIGIT             02569060
*           SPECIFICATIONS.  CHECK IF INPUT CYLINDERS ARE 3, 4, OR      02570050
*           MIXED NUMBERS OF DIGITS AND HANDLE ACCORDINGLY.             02571040
*        2. SHOW EACH CYLINDER BY ITS RESPECTIVE ALLOCATION TYPE AND    02572030
*           PUT IT INTO THE CYLINDER BYTE MAP.                          02573020
*        3. IF AN INVALID CYLINDER WAS FOUND, ISSUE 'TYPE OR CYL        02574010
*           INVALID' MESSAGE.                                           02575000
*                                                                       02575990
* LOCAL REGISTER USAGE -                                                02576980
*                                                                       02577970
*        R4  - MESSAGE ADDRESS                                          02578960
*        R5  - WORK                                                     02579950
*        R7  - WORK                                                     02580940
*        R9  - ADDRESS OF CYLINDER BYTE MAP                             02581930
*        R14 - LINKAGE                                                  02582920
*                                                                       02583910
*.$******************************************************************** 02584900
         SPACE ,                                                        02585890
*---------------------------------------------------------------------- 02586880
*        3 OR 4 MIXED DIGIT INPUT WITH A SINGLE BLANK IN BETWEEN IS     02587870
*        ALLOWED.  CHECK FOR THE STARTING CYLINDER DIGIT FIRST.         02588860
*---------------------------------------------------------------------- 02589850
         SPACE ,                                                        02590840
         MVC   CHARSAVE,CHARMASK     REINTIALIZE CHARSAVE AREA          02591830
         CLI   INDATA+8,C'0'         IS STR CYL 4TH DIGIT NUM?          02592820
         BNL   CHKEND2               YES, CHECK ENDING CYL.             02593810
         CLI   INDATA+8,C' '         IF NOT, IS IT A BLANK?             02594800
         BE    CHKEND1               YES, CHECK ENDING CYL.             02595790
         CLI   INDATA+8,C','         OR IS IT FROM CARD INPUT?          02596780
         BNE   ERRCYL                NO, INPUT ERROR                    02597770
         SPACE ,                                                        02598760
*---------------------------------------------------------------------- 02599750
*        THE STARTING CYLINDER IS 3 DIGITS -- WE NEED TO MAKE SURE THE  02600740
*        4TH DIGIT OF THE ENDING CYLINDER IS EITHER A BLANK OR X'00'    02601730
*        SO THAT WE CAN INSERT LEADING 0'S FOR BOTH STARTING AND ENDING 02602720
*        CYLINDER NUMBERS.                                              02603710
*---------------------------------------------------------------------- 02604700
CHKEND1  DS    0H                    CHECK ENDING CYLINDER              02605690
         CLI   INDATA+12,C'0'        HOW ABOUT ENDING CYL?              02606680
         BNL   INSERTA2              YES, INSERT A LEADING 0            02607670
         CLI   INDATA+12,C' '        IS IT A BLANK ?                    02608660
         BE    INSERTA1              YES, INSERT 0 IN FRONT             02609650
         CLI   INDATA+12,X'00'       OR IS IT A X'00' ?                 02610640
         BNE   ERRCYL                NO, INPUT ERROR                    02611630
INSERTA1 DS    0H                    INSERT A LEADING 0                 02612620
         MVC   CHARSAVE+1(4),INDATA+5 STORE START CYL TEMPRRLY          02613610
         MVC   CHARSAVE+6(3),INDATA+9 STORE ENDT CYL TEMPRRILY          02614600
         B     MOVEBACK              MOVE BACK CYL NUMBERS              02615590
         SPACE ,                                                        02616580
*---------------------------------------------------------------------- 02617570
*        HERE, STARTING CYLINDER HAS 3 DIGITS AND ENDING CYLINDER HAS   02618560
*        AT LEAST 4.  MAKE SURE ENDING CYLINDER DOES NOT GO BEYOND 4    02619550
*        DIGITS.  INSERT A LEADING 0 FOR STARTING CYLINDER.             02620540
*---------------------------------------------------------------------- 02621530
         SPACE ,                                                        02622520
INSERTA2 DS    0H                                                       02623510
         CLI   INDATA+13,C' '        5TH DIGIT OF END CYL BLNK?         02624500
         BE    INSERTA3              YES, INS 0 FOR START CYL           02625490
         CLI   INDATA+13,X'00'       OR IS IT A X'00' ?                 02626480
         BNE   ERRCYL                NO, INPUT ERROR                    02627470
INSERTA3 DS    0H                                                       02628460
         MVC   CHARSAVE+1(8),INDATA+5 STORE START CYL TEMPRRLY          02629450
         B     MOVEBACK              MOVE BACK CYL NUMBERS              02630440
         SPACE ,                                                        02631430
*---------------------------------------------------------------------- 02632420
*        STARTING CYLINDER IS 4 DIGITS, NEED TO CHECK THE ENDING        02633410
*        CYLINDER DIGIT.                                                02634400
*---------------------------------------------------------------------- 02635390
         SPACE ,                                                        02636380
CHKEND2  DS    0H                    CHECK THE ENDING CYL. #            02637370
         CLI   INDATA+9,C' '         IS THE 5TH DIGIT A BLANK?          02638360
         BE    CHKEND3               YES, CHECK THE ENDING CYL          02639350
         CLI   INDATA+9,C','         NO, IS IT FROM CARD                02640340
         BNE   ERRCYL                NO, INPUT ERROR                    02641330
CHKEND3  DS    0H                    CHECK THE ENDING CYL. #            02642320
         CLI   INDATA+13,C'0'        IS END CYL A 3 DIGIT NUM?          02643310
         BNL   NUMCHKA               NO, GO CHECK IF NUMERIC            02644300
         CLI   INDATA+13,C' '        IS THE 4TH DIGIT A BLANK?          02645290
         BE    INSERTA4              YES, INSERT 0 IN FRONT             02646280
         CLI   INDATA+13,X'00'       OR IS IT A X'00' ?                 02647270
         BNE   ERRCYL                NO, INPUT ERROR                    02648260
INSERTA4 DS    0H                                                       02649250
         MVC   CHARSAVE(4),INDATA+5  STORE START CYL TEMPRRLY           02650240
         MVC   CHARSAVE+6(3),INDATA+10 STORE ENDT CYL TEMPRRILY         02651230
         MVC   INDATA+5(4),CHARSAVE  MOVE BACK THE START CYL #          02652220
         MVC   INDATA+10(4),CHARSAVE+5  MOVE BACK THE END CYL #         02653210
         B     NUMCHKA               GO CHECK IF NUMERIC                02654200
         SPACE ,                                                        02655190
*---------------------------------------------------------------------- 02656180
*        BOTH THE STARTING AND ENDING CYLINDERS ARE 4 DIGITS IN THE     02657170
*        CHARSAVE AREA.  NOW MOVE THEM BACK TO THE INDATA AREA.         02658160
*---------------------------------------------------------------------- 02659150
MOVEBACK DS    0H                                                       02660140
         MVC   INDATA+5(9),CHARSAVE  MOVE BACK THE INPUT CYL            02661130
         SPACE ,                                                        02662120
*---------------------------------------------------------------------- 02663110
*        BOTH THE STARTING AND ENDING CYLINDERS ARE 4 DIGITS NOW IN     02664100
*        INDATA.  CHECK TO VERIFY THAT THEY ARE ALL NUMERIC.  FIRST     02665090
*        CHECK THE STARTING CYLINDER.                                   02666080
*---------------------------------------------------------------------- 02667070
         SPACE ,                                                        02668060
NUMCHKA  DS    0H                                                       02669050
         MVC   MASKB(CYLNUM),MASKA  REINITIALIZE MASKB TO 'F0'          02670040
         NC    MASKB(CYLNUM),INDATA+NAMCHARS+BLANK                      02671030
*                             AND MASK IT WITH THE INDATA               02672020
         CLC   MASKA(CYLNUM),MASKB   ARE THEY ALL NUMERIC?              02673010
         BNE   ERRCYL         NO, ERROR IN INDATA                       02674000
         CLI   CDSW2,X'FF'    CARD INPUT?                               02674990
         BNE   CONSDATA       NO, MUST BE FROM THE CONSOLE              02675980
         CLI   INDATA+NAMCHARS+BLANK+CYLNUM,C','                        02676970
         BNE   ERRCYL         NO...HE GOOFED.                           02677960
         B     CKREST         GO CHECK THE REST OF IT                   02678950
         SPACE ,                                                        02679940
*---------------------------------------------------------------------- 02680930
*        IF INPUT IS FROM THE CONSOLE, THERE MUST BE A SINGLE BLANK     02681920
*        BETWEEN TYPE AND STARTING CYLINDER FIELDS.                     02682910
*---------------------------------------------------------------------- 02683900
         SPACE ,                                                        02684890
CONSDATA EQU   *                                                        02685880
         CLI   INDATA+NAMCHARS+BLANK+CYLNUM,C' ' IS IT A BLANK?         02686870
         BNE   ERRCYL         NOPE - REPEAT IT PLEASE                   02687860
         SPACE ,                                                        02688850
*---------------------------------------------------------------------- 02689840
*        NEXT CHECK THE ENDING CYLINDER - THERE MAY BE SOMETHING AFTER. 02690830
*---------------------------------------------------------------------- 02691820
         SPACE ,                                                        02692810
CKREST   NC    MASKB(CYLNUM),INDATA+NAMCHARS+BLANK+CYLNUM+BLANK         02693800
*                             MASK WITH THE ENDING CYLINDER             02694790
         CLC   MASKA(CYLNUM),MASKB  IS END CYLINDER NUMERIC?            02695780
         BNE   ERRCYL         NO,ERROR IN INDATA                        02696770
         OI    INDATA+NAMCHARS+BLANK+CYLNUM+BLANK+CYLNUM,X'40'          02697760
*                             MASK ENDING CYL WITH A BLANK              02698750
         CLI   INDATA+NAMCHARS+BLANK+CYLNUM+BLANK+CYLNUM,X'40'          02699740
*                             IS INPUT ENDED WITH A BLANK ?             02700730
*                             IF NOT, MEANS SOMETHING IS THERE          02701720
         BNE   ERRCYL         YEP - DO IT AGAIN.                        02702710
         SPACE ,                                                        02703700
*---------------------------------------------------------------------- 02704690
*        CHECK CYLINDER BOUNDARY FOR EACH TYPE.                         02705680
*---------------------------------------------------------------------- 02706670
         SPACE ,                                                        02707660
         PACK  FIELDA+5(3),INDATA+NAMCHARS+BLANK(CYLNUM)                02708650
*                                      PACK START CYL DATA              02709640
         PACK  FIELDB+5(3),INDATA+NAMCHARS+BLANK+CYLNUM+BLANK(CYLNUM)   02710630
*                                      PACK END CYL DATA                02711620
         CVB   R7,FIELDA               CONVERT TO BINARY START CYL      02712610
         ST    R7,FIELDA+4             SAVE BINARY RESULTS              02713600
         CVB   R7,FIELDB               CONVERT TO BINARY END CYL        02714590
         LH    R5,HIVALUE              MAX END CYLINDER                 02715580
         LA    R5,1(R5)                ADD ONE TO HI VALUE              02716570
         CH    R7,HIVALUE              HIGHER THAN LAST CYLINDER        02717560
         BH    ERRCYL                  YES,ERROR                        02718550
STORE2   ST    R7,FIELDB+4             SAVE END CYLINDER                02719540
         SPACE ,                                                        02720530
         CLC   FIELDA+4(4),FIELDB+4    IS START GREATER THAN END?       02721520
         BH    ERRCYL                  YES,THAT'S ERROR                 02722510
         SPACE ,                                                        02723500
*---------------------------------------------------------------------- 02724490
*        SHOW EACH CYLINDER BY ITS RESPECTIVE ALLOCATION TYPE AND PUT   02725480
*        IT INTO THE CYLINDER BYTE MAP.                                 02726470
*---------------------------------------------------------------------- 02727460
         SPACE ,                                                        02728450
         L     R9,=A(TABLE)   LOAD BYTE MAP START ADDRESS               02729440
         A     R9,FIELDA+4    ADD START CYL TO BYTE MAP ADDR            02730430
         L     R7,FIELDB+4             LOAD END CYL INTO R8             02731420
         S     R7,FIELDA+4             SUBTRACT START FROM END          02732410
         LA    R7,1(R7)                ADD 1 TO NUMBER OF CYL'S         02733400
         MVC   INDIC+1(1),ATYPE         ALTER INSTR TO CORRECT TYPE     02734390
INDIC    MVI   0(R9),X'00'             PUT TYPE INTO CYL BYTE MAP       02735380
         LA    R9,1(R9)                ADD 1 TO BYTE MAP ADDRESS        02736370
         BCT   R7,INDIC                REPEAT FOF THE NUMB CYL'         02737360
         SPACE ,                                                        02738350
         OI    FLAG1,ALLOCWR  SET FLAG TO WRITE ALLOC. TO DISK          02739340
         TM    CDSW2,X'FF'             IS CD SWITCH2 ON                 02740330
         BO    GETCARD                 YES,BRANCH                       02741320
         B     REREAD                  GET ANOTHER ENTRY                02742310
         SPACE ,                                                        02743300
*---------------------------------------------------------------------- 02744290
*        ISSUE 'TYPE OR CYL INVALID'.                                   02745280
*---------------------------------------------------------------------- 02746270
         SPACE ,                                                        02747260
ERRCYL   LA    R4,TYPERR               SET UP CYL ERROR MSG             02748250
OUTMSG   EQU   *                                                        02749240
         BAL   R14,WMSG                WRITE MESSAGE                    02750230
         TM    CDSW2,X'FF'             IS CD SWITCH2 ON                 02751220
         BO    BADINPUT                YES,BRANCH                       02752210
         B     REREAD                  GET ANOTHER ENTRY                02753200
*.3******************************************************************** 02754190
*                                                                       02755180
* OPERATION -                                                           02756170
*                                                                       02757160
* BB. WRITE ALLOCATION TABLE TO DASD                                    02758150
*                                                                       02759140
*        COME HERE AFTER 'END' WAS SPECIFIED FROM OP Y TO WRITE THE     02760130
*        ALLOCATION MAP TO DASD.  IF 'END' WAS SPECIFIED ALONE WITHOUT  02761120
*        ANY OTHER ALLOCATIONS, THEN DO NOT WRITE THE MAP TO DASD BUT   02762110
*        WRITE IT TO THE CONSOLE ONLY.                                  02763100
*                                                                       02764090
*        1. LOAD APPROPRIATE CCWS TO WRITE ALLOCATION.                  02765080
*        2. ISSUE SIO TO WRITE THE ALLOCATION MAP TO DASD.              02766070
*           WITH GOOD STATUS, GO TO OP CC.                              02767060
*        3. HANDLE ANY BAD STATUS RETURNED FROM THE SIO.                02768050
*                                                                       02769040
* LOCAL REGISTER USAGE -                                                02770030
*                                                                       02771020
*        R1  - CHANNEL PROGRAM ADDRESS                                  02772010
*        R2  - WORK                                                     02773000
*        R5  - DISK ADDRESS                                             02773990
*        R7  - LINKAGE                                                  02774980
*        R14 - LINKAGE                                                  02775970
*                                                                       02776960
*.&******************************************************************** 02777950
         SPACE ,                                                        02778940
FINI     EQU   *                                                        02779930
*---------------------------------------------------------------------- 02780920
*        LOAD ALLOCREC STRING TO WRITE ALLOC MAP TO DASD.               02781910
*---------------------------------------------------------------------- 02782900
         SPACE ,                                                        02783890
         L     R2,=A(TABLE)   LOAD MAP START ADDRESS                    02784880
         AH    R2,HIVALUE     ADD MAXIMUM CYLINDER NUMBER               02785870
         MVI   1(R2),X'FF'    SET END OF TABLE TO FF                    02786860
         TM    FLAG1,ALLOCWR  NEED TO WRITE ALLOC. TO DISK?             02787850
         BZ    PRINTALL       NO,'END' WAS ONLY COMMAND,SO              02788840
*                             JUST DISPLAY                              02789830
         LA    R1,ALLOREC     ALLOCATE TABLE CCWS                       02790820
         LH    R5,DSKADD      GET DEVICE ADD INTO R5                    02791810
         SPACE ,                                                        02792800
*---------------------------------------------------------------------- 02793790
*        ISSUE SIO TO WRITE THE ALLOCATION DATA ON DASD.                02794780
*---------------------------------------------------------------------- 02795770
         SPACE ,                                                        02796760
ALOCIO   EQU   *                                                        02797750
         ST    R1,CAW         LABEL CCWS INTO CAW                       02798740
         TIO   0(R5)          DRAIN IT                                  02799730
         BC    2,*-4          LOOP IF BUSY                              02800720
         BAL   R14,STRTIO1    WRITE OUT THE ALLO TABLE                  02801710
TIO1     TIO   0(R5)          DRAIN THE INT                             02802700
         BC    2,*-4          LOOP UNTIL DONE                           02803690
         BC    1,TIOCC3       DEVICE INOPER. - SAY SO                   02804680
         TM    CSW+5,X'FF'    ANY BAD CHANNEL STATUS                    02805670
         BNZ   ERROR          YES- BRANCH                               02806660
         TM    CSW+4,UC       UNIT CHECK                                02807650
         BO    ERROR          YES- BRANCH                               02808640
         TM    CSW+4,CE       CHANNEL END                               02809630
         BO    PRINTALL       YES- BRANCH ALL OK                        02810620
         B     TIO1           NO- GO GET IT                             02811610
         SPACE ,                                                        02812600
*---------------------------------------------------------------------- 02813590
*        FOR BAD STATUS FROM SIO, GET THE SENSE DATA AND ISSUE THE      02814580
*        ERROR MESSAGE.                                                 02815570
*---------------------------------------------------------------------- 02816560
         SPACE ,                                                        02817550
ERROR    BAL   R7,SENSIT      GET THE SENSE DATA                        02818540
         MVC   CCHHR(5),R4ALLOC  MOVE IN THE CCHHR DATA                 02819530
         BAL   R7,SENSIT2     TYPE THE MSG                              02820520
         B     FATAL                                                    02821510
*.3******************************************************************** 02822500
*                                                                       02823490
* OPERATION -                                                           02824480
*                                                                       02825470
* CC.  WRITE OUT ALLOCATION TABLE TO CONSOLE                            02826460
*                                                                       02827450
*        COME HERE AFTER 'END' WAS SPECIFIED FROM OP BB, FOLLOWING THE  02828440
*        WRITING OF THE ALLOCATION TABLE TO DASD IF REQUIRED.  'END'    02829430
*        WAS FIRST DETECTED IN OP Y.  IF 'END' WAS SPECIFIED BEFORE ANY 02830420
*        EXTENTS, THEN THE ALLOCATION MAP IS WRITTEN TO THE CONSOLE     02831410
*        ONLY.                                                          02832400
*                                                                       02833390
*        1. DISPLAY THE 'ALLOCATION RESULTS' MESSAGE ON THE CONSOLE.    02834380
*        2. FOR CKD, SHOW EACH ALLOCATION EXTENT.                       02835370
*        3. EACH BYTE REPRESENTS A CYLINDER - CHECK CYLINDER AND WRITE  02836360
*           TO ALLOCATION TYPE TO THE CONSOLE.                          02837350
*        4. DISPLAY 'ALLOCATION ENDED' MESSAGE AND GO BACK TO START     02838340
*           TO GET A NEW FUNCTION.                                      02839330
*                                                                       02840320
* LOCAL REGISTER USAGE -                                                02841310
*                                                                       02842300
*        R2  - WORK                                                     02843290
*        R3  - ALLOCATION TABLE ADDRESS                                 02844280
*        R4  - MESSAGE ADDRESS                                          02845270
*        R6  - WORK                                                     02846260
*        R7  - WORK                                                     02847250
*        R14 - LINKAGE                                                  02848240
*                                                                       02849230
*.$******************************************************************** 02850220
         SPACE ,                                                        02851210
*---------------------------------------------------------------------- 02852200
*        ISSUE MESSAGE 'ALLOCATION RESULTS' ON CONSOLE.                 02853190
*---------------------------------------------------------------------- 02854180
         SPACE ,                                                        02855170
PRINTALL DS    0H                      PRINT ALLOCATION DATA            02856160
         LA    R4,RESULTS              PRINT ALLOCATION RESULTS         02857150
         BAL   R14,WMSG2               PRINT MESSAGE                    02858140
         L     R3,=A(TABLE)            POINT TO TABLE                   02859130
         LR    R6,R3                   PUT TABLE ADDRESS IN R6          02860120
         SR    R7,R7                   CLEAR R7                         02861110
REENTER  DS    0H                                                       02862100
         CLI   0(R6),X'00'             IS FIRST BYTE 00?                02863090
         MVC   MAP+1(4),=C'TEMP'       MOVE IN TEMP                     02864080
         BE    CYLINDER                YES,BRANCH                       02865070
         CLI   0(R6),X'01'             IS BYTE 01?                      02866060
         MVC   MAP+1(4),=C'PERM'       MOVE IN PERM                     02867050
         BE    CYLINDER                YES,BRANCH                       02868040
         CLI   0(R6),X'02'             IS BTYE 02?                      02869030
         MVC   MAP+1(4),=C'TDSK'       MOVE IN TDSK                     02870020
         BE    CYLINDER                YES,BRANCH                       02871010
         MVC   MAP+1(4),=C'BAD '       SET UP FOR BAD ENTRY             02872000
DIRECT   EQU   *                                                        02872990
         TM    0(R6),DRCTINV           CYL INVALID FOR DRCT?            02873980
         LA    R7,1(,R7)               BUMP CYLINDER COUNT              02874970
         LA    R6,1(,R6)               TABLE ADDR ALSO                  02875960
         BNZ   CONT                    YES, CONTINUE                    02876950
         MVC   MAP+1(4),=C'DRCT'       MOVE IN DRCT                     02877940
         SPACE ,                                                        02878930
         CLI   0(R6),DRCTFREE          THIS FREE DRCT CYL?              02879920
         BE    DIRECT                  YES, COUNT IT                    02880910
         CLI   0(R6),DRCTDIR           CYL IN USE BY DMKDIR?            02881900
         BE    DIRECT                  YES, COUNT IT                    02882890
         SPACE ,                                                        02883880
         B     CONT                    NO, BRANCH                       02884870
         SPACE ,                                                        02885860
*---------------------------------------------------------------------- 02886850
*        CHECK TYPE, CYLINDER BY CYLINDER AND WRITE TO CONSOLE          02887840
*---------------------------------------------------------------------- 02888830
         SPACE ,                                                        02889820
CYLINDER CLC   0(1,R6),1(R6)           NEXT CYLINDER THE SAME?          02890810
         LA    R7,1(R7)                BUMP CYL COUNT BY 1              02891800
         LA    R6,1(R6)                BUMP BYTE TABLE ADDRESS BY 1     02892790
         BE    CYLINDER                IF SAME CYL LOOK AT NEXT BYTE    02893780
CONT     LR    R10,R6                  PUT BYTE LOCATION INTO R10       02894770
         SR    R10,R3                  PRESENT MINUS STRT ADDR          02895760
         SR    R10,R7                  GET START CYLINDER               02896750
         CVD   R10,FIELDA              CONVERT START TO DECIMAL         02897740
         AR    R10,R7                  GET END ADDRESS                  02898730
         BCTR  R10,0                   REDUCE BY 1                      02899720
         CVD   R10,FIELDB              CONVERT END TO DECIMAL           02900710
         OI    FIELDA+7,X'0F'          PLUG IN SIGN                     02901700
         OI    FIELDB+7,X'0F'          PLUG IN SIGN                     02902690
         UNPK  MAP+1+NAMCHARS+BLANK(CYLNUM),FIELDA+5(3)                 02903680
*                                UNPACK TO MAKE IT PRINTABLE            02904670
         UNPK  MAP+1+NAMCHARS+BLANK+CYLNUM+BLANK(CYLNUM),FIELDB+5(3)    02905660
*                                UNPACK TO MAKE IT PRINTABLE            02906650
         LA    R4,MAP                  SET UP PRINT MAP                 02907640
         BAL   R14,WMSG2               WRITE MESSAGE                    02908630
         SR    R7,R7                   CLEAR R7                         02909620
         CR    R6,R2                   IS R6 AT HIVALUE                 02910610
         BNH   REENTER                 NO- BRANCH                       02911600
         SPACE ,                                                        02912590
*---------------------------------------------------------------------- 02913580
*        ISSUE MESSAGE 'DEVICE XXX VOLUME XXXXXX ALLOCATION ENDED'.     02914570
*        GO BACK UP TO GETCARD TO FETCH A NEW FUNCTION.                 02915560
*---------------------------------------------------------------------- 02916550
         SPACE ,                                                        02917540
APRTDON  EQU   *                                                        02918530
         LA    R4,ALLEND               SET UP TO ALLOCATION END         02919520
         BAL   R14,WMSG                WRITE MESSAGE                    02920510
         MVI   ALLOSW,X'00'            TURN OFF ALLOCATE SWITCH         02921500
         B     GETCARD                 YES,BRANCH                       02922490
         SPACE ,                                                        02923480
*---------------------------------------------------------------------- 02924470
*        MISCELLANEOUS EXECUTED INSTRUCTIONS.                           02925460
*---------------------------------------------------------------------- 02926450
         SPACE ,                                                        02927440
TSTFRMT  CLC   COMWOK(*-*),=CL8'FORMAT'                                 02928430
TSTALLOC CLC   COMWOK(*-*),=CL8'ALLOCATE'                               02929420
TSTLABL  CLC   COMWOK(*-*),=CL8'LABEL   '                               02930410
MVCCOMW  MVC   COMWOK(*-*),INDATA                                       02931400
*.3******************************************************************** 02932390
*                                                                       02933380
* OPERATION -                                                           02934370
*                                                                       02935360
* DD. HANDLE DASD I/O INTERRUPTS                                        02936350
*                                                                       02937340
*        1. IF THE INTERRUPT IS FROM THE DEVICE WE STARTED, THEN HANDLE 02938330
*           THE CSW STATUS.  FOR A UNIT CHECK, GO TO STEP 4.            02939320
*        2. WE HAD A CLEAN CE+DE STATUS.  IF ALTERNATE TRACK RECOVERY   02940310
*           IS IN PROGRESS, THEN GO TO THE ALTCHK SUBROUTINE.           02941300
*        3. RESUME FORMATTING IN THE MAIN LOGIC AT EITHER OP Q.         02942290
*        4. UNIT CHECK RECOVERY - ISSUE SENSE AND EVALUATE SENSE BYTES. 02943280
*        5. CHECK FOR AND HANDLE AN IMPRECISE ENDING CONDITION.  IF     02944270
*           NOT A REPEAT ERROR, THEN GO RESTART THE DEVICE AT OP U.     02945260
*        6. INCREMENT REPEAT ERROR COUNT.  FOR CKD, RETRY FIRST OR      02946250
*           SECOND TIME THROUGH.  ELSE, GO TO STEP 16.                  02947240
*        7. IF CCW FAILED 10 TIMES, CONTINUE.  IF LESS THAN 10, GO      02948230
*           RESTART AT OP U.                                            02949220
*        8. HANDLE FAILING CKD CCW.  AFTER PRINTING THE SENSE MESSAGE,  02950210
*           POINT TO THE FAILING CCW AND HANDLE SPECIFIC CCW TYPE.      02951200
*        9. FOR A READ OR SEARCH ID EQUAL CCW, GO TO OP FF TO TRY TO    02952190
*           REBUILD THE STRING.                                         02953180
*       10. IF POSSIBLE, SEARCH FOR ANOTHER SEEK IN THE CHAIN.  IF ONE  02954170
*           FOUND, GO TO STEP 14.  IF NOT, ISSUE ERROR.                 02955160
*       11. FOR CKD, RESTART THE STRING BY TIC'ING TO THIS SEEK AND GO  02956150
*           TO OP U.                                                    02957140
*       12. HANDLE CONSOLE INTERRUPT FOUND BY THIS ROUTINE.             02958130
*       13. PERFORM A RECALIBRATION ON THE FAILING DEVICE.              02959120
*       14. FOR SECOND ERROR ON CKD CCW STRING, RETRY CCWS.             02960110
*                                                                       02961100
* LOCAL REGISTER USAGE -                                                02962090
*                                                                       02963080
*        R3  - WORK                                                     02964070
*        R4  - WORK/INTERRUPTING DEVICE ADDRESS                         02965060
*        R5  - DEVICE STARTED                                           02966050
*        R6  - WORK                                                     02967040
*        R7  - LINKAGE                                                  02968030
*        R9  - CHANNEL PROGRAM ADDRESS                                  02969020
*        R14 - WORK                                                     02970010
*                                                                       02971000
*.$******************************************************************** 02971990
         SPACE ,                                                        02972980
*---------------------------------------------------------------------- 02973970
*        IF THE INTERRUPT IS NOT FROM THE DEVICE WE STARTED, THEN       02974960
*        LEAVE IN A WAIT STATE.  ELSE, HANDLE CSW STATUS.  FOR UNIT     02975950
*        CHECK, TRY TO RECOVER AT ERRECOV.  FOR CE+DE, CONTINUE AT      02976940
*        CLEANEND.                                                      02977930
*---------------------------------------------------------------------- 02978920
         SPACE ,                                                        02979910
IOINT    LH    R4,IOOPSW+2    GET DEVICE ADDRESS                        02980900
         CH    R4,CONSOL      WAS IT CONSOLE DEVICE?                    02981890
         BE    ATNTST         YES,CHECK FOR ATTENTION                   02982880
         CH    R5,IOOPSW+2    WAS IT DEVICE STARTED?                    02983870
         BNE   XWAIT          NO,WAIT FOR CORRECT ONE                   02984860
         TM    CSW+5,X'BF'    ANYTHING BUT INCORRECT LENGTH?            02985850
         BM    FATAL          IF MIXED ERRORS,GO FATAL                  02986840
         TM    CSW+4,UC       UNIT CHECK?                               02987830
         BO    ERRECOV        YES,GO TO ERROR RECOVERY                  02988820
         CLI   CSW+4,CE+DE    WAS IT CHANNEL END OR DEVICE END          02989810
         BE    CLEANEND       YES, CHECK FOR ALTERNATE TRACK            02990800
         CLI   CSW+4,CUE+CE+DE DID CUE SNEAK IN TOO?                    02991790
         BNE   FATAL          NOT UC & NOT CLEAN END.                   02992780
         SPACE ,                                                        02993770
*---------------------------------------------------------------------- 02994760
*        THE INTERRUPT WAS A CLEAN CE+DE:                               02995750
*        IF ALTERNATE TRACK RECOVERY IS IN PROGRESS, THEN GO TO EITHER  02996740
*        ALTCHK2 OR ALTCHK3.                                            02997730
*---------------------------------------------------------------------- 02998720
         SPACE ,                                                        02999710
CLEANEND XC    ERCOUNT,ERCOUNT RESET.  THIS SUCCESSFUL CMPLETN          03000700
*                             COULD BE THE END OF AN ERROR RETRY.       03001690
         XC    TOTCNT,TOTCNT  CLEAR THE TOTAL ERROR COUNT               03002680
         TM    ALTFLAG,HAR0READ ALTERNATE TRACK RECOVERY IN             03003670
*                               PROGRESS?                               03004660
         BZ    RESUMP         NO, CONTINUE WITH MAIN LOGIC.             03005650
         L     R6,CONTINAD    ADDR OF CODE WHERE ALT TRACK              03006640
*                             RECOVERY PROCESSING IS TO CONTINUE.       03007630
         BR    R6                                                       03008620
         SPACE ,                                                        03009610
*---------------------------------------------------------------------- 03010600
*        UNIT CHECK RECOVERY.  ISSUE SENSE AND EVALUATE SENSE BYTES.    03011590
*        FOR A TRACK CONDITION CHECK, GO TO ALTTRACK TO SWITCH TRACK    03012580
*        TO ALTERNATE FOR 3340/3344.                                    03013570
*---------------------------------------------------------------------- 03014560
         SPACE ,                                                        03015550
ERRECOV  BAL   R7,SENSIT      READ SENSE DATA, THEN RESTORE             03016540
*                             CSW, CAW, IOOPSW.                         03017530
         L     R4,TOTCNT      GET TOTAL COUNT OF ERRORS ON SIO          03018520
         LA    R4,1(R4)       INCREMENT BY 1                            03019510
         ST    R4,TOTCNT      SAVE THE COUNT                            03020500
         C     R4,TOTLIMIT    TOO MANY SIO'S                            03021490
         BH    PRTMSG         YES, JUST TERMINATE WITH MESSAGE          03022480
         TM    SENSEB0,X'02'  TRACK CONDITION CHECK?                    03023470
         BNO   NOSWTCH        NO, TRACK NOT FLAGGED.                    03024460
         CLI   TYPE,TYP334X   DEVICE IS 3340/3344?                      03025450
         BE    ALTTRACK       YES.  GO SWITCH TRACKS.                   03026440
         SPACE ,                                                        03027430
*---------------------------------------------------------------------- 03028420
*        GO RESTART THE DEVICE AT STIO.                                 03029410
*---------------------------------------------------------------------- 03030400
         SPACE ,                                                        03031390
NOSWTCH  DS    0H                                                       03032380
         CLC   CSW(L8),SAVEDCSW SAME ERROR (AT SAME CCW) AS             03033370
*                             BEFORE?                                   03034360
         MVC   SAVEDCSW(L8),CSW SAVE FOR COMPARE NEXT TIME.             03035350
         BE    COUNT          IF SAME ERROR,BRANCH                      03036340
         XC    ERCOUNT(4),ERCOUNT CLEAR ERROR COUNT                     03037330
         B     STIO           START DEVICE                              03038320
*---------------------------------------------------------------------- 03039310
*        INCREMENT REPEAT ERROR COUNT.  FOR A NORMAL CKD, EITHER GO TO  03040300
*        RECAL TO RECALIBRATE THE DEVICE OR GO RETRY THE CCWS IF THIS   03041290
*        IS FIRST OR SECOND TIME THROUGH.                               03042280
*---------------------------------------------------------------------- 03043270
         SPACE ,                                                        03044260
COUNT    L     R4,ERCOUNT     PUT ERROR COUNT INTO R4                   03045250
         LA    R4,1(4)        UP ERROR COUNT BY 1                       03046240
         ST    R4,ERCOUNT     SAVE ERROR COUNT                          03047230
         C     R4,=F'1'       IS IT FIRST ERROR?                        03048220
         BE    RECAL          YES,RECALIBRATE DEVICE                    03049210
         C     R4,=F'2'       IS IT SECOND ERROR                        03050200
         BE    RESET          YES,RETRY CCWS                            03051190
         SPACE ,                                                        03052180
*---------------------------------------------------------------------- 03053170
*        IF THE CCW FAILED 10 TIMES, CONTINUE HANDLING POSSIBLE FATAL   03054160
*        ERROR CONDITION.  IF LESS THAN 10, GO RESTART DEVICE.          03055150
*---------------------------------------------------------------------- 03056140
         SPACE ,                                                        03057130
RSTRTN   C     R4,ERLIMIT     IS ERROR LIMIT OF 9 REACHED?              03058120
         BL    STIO           IF NO, TRY AGAIN                          03059110
         XC    ERCOUNT,ERCOUNT  IF YES,CLEAR ERROR COUNT                03060100
         XC    TOTCNT,TOTCNT  CLEAR TOTAL ERROR COUNT                   03061090
         XC    SAVEDCSW(8),SAVEDCSW CLEAR SAVED CSW                     03062080
         SPACE ,                                                        03063070
*---------------------------------------------------------------------- 03064060
*        HANDLE FAILING CKD CCW.  LOCATE THE SEEK CCW AND ADDR OF THE   03065050
*        DATA AREA FROM THE NON-SEEK CCW ALSO.  PICK UP THE CCHHR INFO  03066040
*        TO PUT IN THE ERROR MESSAGE.  AFTER PRINTING SENSE AND CCHH    03067030
*        MESSAGE, POINT TO THE FAILING CCW AND HANDLE SPECIFIC CCW      03068020
*        TYPE ACCORDINGLY.                                              03069010
*---------------------------------------------------------------------- 03070000
         SPACE ,                                                        03070990
FINDCCW  EQU   *                                                        03071980
         L     R4,CSW         PUT NEXT CCW ADDRESS INTO R4              03072970
SUB      S     R4,=F'8'       GET PREVIOUS CCW ADDRESS                  03073960
SUB2     CLI   0(4),X'07'     IS IT A SEEK?                             03074950
         BE    SUB3           NO,GET PREVIOUS CCW                       03075940
         CLI   0(R4),LOCREC   THIS A LOC REC CCW?                       03076930
         BNE   SUB            NO,CONTINUE TO SEARCH                     03077920
         L     R4,0(,R4)      GET 1ST HALF OF CCW                       03078910
         LA    R4,0(,R4)      CLEAR OP CODE                             03079900
         MVC   CCHHR(L5),D8(R4) PICK UP CCHHR INFO                      03080890
         B     PRTMSG         GO PRINT MESSAGE                          03081880
SUB3     DS    0H                                                       03082870
         L     R4,0(R4)       ADDRESS OF CCW DATA AREA IN R4            03083860
         LA    R4,0(R4)       CLEARS COMMAND CODE FROM R4               03084850
         MVC   CCHHR(5),2(R4) SAVE THE CCHHR THAT FAILED                03085840
PRTMSG   DS    0H                                                       03086830
         BAL   R7,SENSIT2     PRINT SENSE AND CCHH MESSAGE              03087820
         TM    SENSEB0,CMDREJ COMMAND REJECT?                           03088810
         BO    FATAL          YES, NO SENSE IN RECOVERY TRY             03089800
         L     R4,CSW         PUT NEXT CCW ADDRESS INTO R4              03090790
         S     R4,=F'8'       R4 NOW POINTS TO FAILING CCW              03091780
         SPACE ,                                                        03092770
*---------------------------------------------------------------------- 03093760
*        FOR A READ OR SEARCH ID EQUAL CCW, GO TO 'READER06' OR         03094750
*        'READER31' TO TRY TO REBUILD THE STRING AND THEN RESTART THE   03095740
*        DEVICE.                                                        03096730
*---------------------------------------------------------------------- 03097720
         SPACE ,                                                        03098710
         CLI   0(R4),SEEK     SEEK (07) CCW?                            03099700
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03100690
         CLI   0(R4),STSCTR   SET SECTOR (23) CCW?                      03101680
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03102670
         CLI   0(R4),WCKD     WRITE COUNT-KEY-DATA (1D) CCW?            03103660
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03104650
         CLI   0(R4),WHADDR   WRITE HOME ADDRESS (19) CCW?              03105640
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03106630
         CLI   0(R4),WTREC0   WRITE RECORD 0 (15) CCW?                  03107620
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03108610
         CLI   0(R4),WRTD     WRITE DATA (05) CCW?                      03109600
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03110590
         CLI   0(R4),SFM      SET FILE MASK (1F) CCW?                   03111580
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03112570
         CLI   0(R4),RHADDR   READ HOME ADDRESS (1A) CCW?               03113560
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03114550
         CLI   0(R4),RDREC0   READ RECORD 0 (16) CCW?                   03115540
         BE    FATAL          YES, FAILED TO WRITE CYL 0                03116530
         CLI   0(R4),RCKD     READ COUNT-KEY-DATA (1E) CCW?             03117520
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03118510
         CLI   0(R4),DEFEXT   DEFINE EXTENT (63) CCW?                   03119500
         BE    FATAL          YES, PRINT FATAL MESSAGE                  03120490
         CLI   0(R4),READ     READ (06) CCW?                            03121480
         BE    READER06       YES, GO REBUILD THE STRING                03122470
         CLI   0(R4),SIEQ     SEARCH ID EQUAL (31) CCW?                 03123460
         BE    READER31       YES, GO REBUILD THE STRING                03124450
         SPACE ,                                                        03125440
*---------------------------------------------------------------------- 03126430
*        IF THE FAILING CCW WAS SOMETHING OTHER THAN ABOVE, THEN POINT  03127420
*        TO NEXT CCW.  AS LONG AS COMMAND CHAINING IS ON, KEEP          03128410
*        SEARCHING FOR A SEEK CCW DOWN THE CHAIN.  WHEN FOUND GO TO     03129400
*        'FOUND'.                                                       03130390
*---------------------------------------------------------------------- 03131380
         SPACE ,                                                        03132370
CCWSRCH1 TM    4(R4),CC       COMMAND CHAINING ??                       03133360
         BZ    FATAL          NO, FATAL ERROR                           03134350
CCWSRCH  LA    R4,8(R4)       R4 POINTS TO NEXT CCW                     03135340
         CLI   0(R4),8        IS THIS A TIC CCW ?                       03136330
         BE    CCWTIC         YES, GO PROCESS                           03137320
         CLI   0(4),X'07'     WAS IT SEEK?                              03138310
         BE    FOUND          YES,GO FOUND                              03139300
         B     CCWSRCH1       NO, TRY AGAIN                             03140290
CCWTIC   CLM   (R4),B'0111',1(R4) TIC BACK OR FORWARD ?                 03141280
         BNH   CCWSRCH        BRANCH IF FORWARD                         03142270
         L     R4,0(,R4)      GET TIC TO ADDRESS                        03143260
         LA    R4,0(,R4)      CLEAR COMMAND CODE                        03144250
         B     CCWSRCH1       KEEP LOOKING FOR 07                       03145240
*---------------------------------------------------------------------- 03146230
*        THE NEXT SEEK IN THE STRING WAS FOUND FOLLOWING THE FAILING    03147220
*        CCW.  RESTART THE STRING BY TIC'ING TO THIS SEEK.  RESUMCCW    03148210
*        IS USED HERE ONLY TO PICK UP THE BROKEN CCW STRING.            03149200
*---------------------------------------------------------------------- 03150190
         SPACE ,                                                        03151180
FOUND    ST    R4,RESUMCCW+8  ADDRESS OF SEEK CCW INTO TIC              03152170
         MVI   RESUMCCW+8,X'08' RESTORE TO TIC COMMAND                  03153160
         LA    R9,RESUMCCW    CCW ADDRESS INTO R9                       03154150
         ST    R9,CAW         CCW ADDRESS INTO CAW                      03155140
         LH    R5,DSKADD      DEVICE INTO R5                            03156130
         B     STIO           START DEVICE                              03157120
         SPACE ,                                                        03158110
*---------------------------------------------------------------------- 03159100
*        CONSOLE INTERRUPT FOUND BY DASD I/O INTERRUPT ROUTINE.         03160090
*---------------------------------------------------------------------- 03161080
         SPACE ,                                                        03162070
ATNTST   TM    68,X'80'       WAS IT ATTENTION?                         03163060
         BCR   8,R14          NO,MUST BE FOR CONSOLE WRITE              03164050
         B     STMSG          START OVER                                03165040
         SPACE ,                                                        03166030
*---------------------------------------------------------------------- 03167020
*        PERFORM A RECALIBRATE ON THE FAILING DEVICE, THEN TIC TO THE   03168010
*        NORMAL 2314 CCW CHAIN.                                         03169000
*---------------------------------------------------------------------- 03169990
         SPACE ,                                                        03170980
RECAL    EQU   *              HERE TO SET UP FOR RECALIBRATE            03171970
         LA    R9,CALIBRAT    ADDRESS OF RECAL. CCW                     03172960
         C     R9,CAW         CAW ALREADY POINTING TO IT ??             03173950
         BE    RECAL1         YES, PREVENT TIC TO RECAL LOOP            03174940
         MVC   CALIBRAT+9(3),CAW+1 CAUSE TIC TO FORMAT CCWS             03175930
RECAL1   EQU   *              BR HERE MEANS TIC ALREADY SET             03176920
         ST    R9,CAW         CAW POINTS TO CALIBRATE CCWS              03177910
         LH    R5,DSKADD      DEVICE ADDRESS INTO R5                    03178900
         B     STIO           START DEVICE                              03179890
         SPACE ,                                                        03180880
*---------------------------------------------------------------------- 03181870
*        SECOND ERROR - RESET TO NORMAL 2314 CCW CHAIN.                 03182860
*---------------------------------------------------------------------- 03183850
         SPACE ,                                                        03184840
RESET    MVC   CAW+1(3),CALIBRAT+9  CAW POINTS TO NORMAL 2314 CCWS      03185830
         B     RSTRTN         GO CHECK ERROR COUNT                      03186820
*.3******************************************************************** 03187810
*                                                                       03188800
* OPERATION -                                                           03189790
*                                                                       03190780
* EE. HANDLE TRACK CONDITION CHECK                                      03191770
*                                                                       03192760
*        COME HERE FROM OP DD AFTER DASD INTERRUPT, DURING ERROR        03193750
*        RECOVERY FROM UNIT CHECK, FOR A TRACK CONDITION CHECK ON A     03194740
*        3340/3344.  RESTART WITH A SEEK TO THE ALTERNATE OR RESTART    03195730
*        WITH A SEEK BACK TO THE DEFECTIVE TRACK + 1.                   03196720
*                                                                       03197710
*        1. SAVE THE ADDRESS OF THE FAILING CCW.                        03198700
*        2. CALL ALTCHK TO DETERMINE WHETHER THE FLAGGED TRACK HAS AN   03199690
*           ALTERNATE TRACK.  IF NOT, GO TO STEP 4.                     03200680
*        3. RESTART THE BROKEN CCW CHAIN USING THE ALTERNATE TRACK.     03201670
*        4. ISSUE MESSAGE THAT THE FLAGGED PRIMARY TRACK DOES NOT HAVE  03202660
*           AN ALTERNATE.                                               03203650
*                                                                       03204640
* LOCAL REGISTER USAGE -                                                03205630
*                                                                       03206620
*        R0  - ALTCHK PARAMETER                                         03207610
*        R1  - WORK                                                     03208600
*        R4  - MESSAGE ADDRESS                                          03209590
*        R7  - LINKAGE                                                  03210580
*        R14 - LINKAGE                                                  03211570
*                                                                       03212560
*.$******************************************************************** 03213550
         SPACE ,                                                        03214540
ALTTRACK L     R1,CSW         GET FAILED CCW + 8.                       03215530
         SH    R1,=H'8'       POINT TO FAILING CCW.                     03216520
         STCM  R1,B'0111',ALTTIC+1 SAVE ITS ADDR IN TIC FOR             03217510
*                             RESTART LATER                             03218500
         SPACE ,                                                        03219490
*---------------------------------------------------------------------- 03220480
*        ALTCHK ROUTINE DETERMINES WHETHER OR NOT FLAGGED TRACK POINTS  03221470
*        TO AN ALTERNATE WITH ALTERNATE POINTING BACK.  IF POINTERS ARE 03222460
*        BAD, THEN R1 = -1 IS RETURNED.  IF POINTERS ARE GOOD, THEN     03223450
*        R1 = CCHH IS RETURNED, WITH CCHH BEING THE SEEK ADDRESS OF THE 03224440
*        OTHER TRACK (NOT THE ONE THAT GAVE THE TRACK CONDITION CHECK,  03225430
*        BUT THE ONE THAT THAT ONE POINTS TO).  R0 = 0 IF CCHH IN R1    03226420
*        IS THE ASSIGNED ALTERNATE TRACK OR R0 = 1 IF CCHH IN R1 IS THE 03227410
*        PRIMARY TRACK.                                                 03228400
*                                                                       03229390
*        IF CCHH IN R1 IS PRIMARY, THEN ADD R0 TO IT TO CAUSE SEEK      03230380
*        BACK TO PRIMARY + 1.  (NOTE:  DUE TO NATURE OF CHANNEL         03231370
*        PROGRAMS USED TO FORMAT, THIS WILL NEVER GO BEYOND LAST TRACK  03232360
*        IN CYLINDER.  IF LAST TRACK IS FLAGGED, THAT IS WHERE CHANNEL  03233350
*        PROGRAM ENDS ANYWAY, THERE IS NO SUBSEQUENT SEEK OFF OF        03234340
*        ALTERNATE TO CAUSE TRACK CONDITION CHECK FROM THERE.)          03235330
*---------------------------------------------------------------------- 03236320
         SPACE ,                                                        03237310
         BAL   R7,ALTCHK      CHECK FOR ALTERNATE TRACK                 03238300
         LTR   R1,R1          DOES FLAGGED TRK HAVE ALTERNATE?          03239290
         BM    ALTBAD         NO.  FATAL ERROR.  ISSUE MSGS.            03240280
         AR    R1,R0          SEEK BACK TO PRIMARY + 1.                 03241270
         STCM  R1,15,ALTSKADD+2 STORE FOR SEEK CCW.                     03242260
         SPACE ,                                                        03243250
*---------------------------------------------------------------------- 03244240
*        RESTART BROKEN CCW CHAIN                                       03245230
*---------------------------------------------------------------------- 03246220
         SPACE ,                                                        03247210
         LA    R1,ALTSEEK     RESTART CCWS APPENDED TO FAILED           03248200
*                             CCW.                                      03249190
         ST    R1,CAW         SET FOR SIO.                              03250180
         B     STIO           RESTART THE CHANNEL PROGRAM.              03251170
         SPACE ,                                                        03252160
*---------------------------------------------------------------------- 03253150
*        ISSUE MESSAGE 'FLAGGED PRIMARY TRACK HAS NO ALTERNATE          03254140
*        ASSIGNED, IO ERROR FOLLOWS'.  THEN ISSUE MESSAGE GIVING CCHH   03255130
*        OF BAD TRACK.                                                  03256120
*---------------------------------------------------------------------- 03257110
         SPACE ,                                                        03258100
ALTBAD   LA    R4,MSGATRK     MSG SAYS FLAGGED TRACK HAS NO             03259090
*                             ALTERNATE ASSIGNED.                       03260080
         BAL   R14,WMSG                                                 03261070
         BAL   R7,SENSIT2     PRT MSG GIVING CCHH OF BAD TRACK.         03262060
         B     FATAL          GIVE FATAL MSG, THEN RESTART.             03263050
*.3******************************************************************** 03264040
*                                                                       03265030
* OPERATION -                                                           03266020
*                                                                       03267010
* FF. HANDLE READ OR SEARCH ID FAILURE                                  03268000
*                                                                       03268990
*        1. IF THIS IS FOR A FILLER RECORD, THEN GO TO STEP 4.  IF THIS 03269980
*           IS FOR RECORD 0, FATAL ERROR.  IF NOT FOR CYLINDER BYTE MAP 03270970
*           GO TO STEP 3.                                               03271960
*        2. HANDLE CYLINDER BYTE MAP.                                   03272950
*        3. INCREMENT THE PAGE ERROR COUNT.                             03273940
*        4. POINT TO NEXT SEARCH ID AND THEN BACK UP TO THE SEEK.       03274930
*        5. BUILD THE SEEK CCW FOR THE RETRY STRING AND THEN GO RESTART 03275920
*           I/O TO THE DEVICE.                                          03276910
*                                                                       03277900
* LOCAL REGISTER USAGE -                                                03278890
*                                                                       03279880
*        R3  - RECORD NUMBER                                            03280870
*        R4  - CCW ADDRESS                                              03281860
*        R5  - DATA ADDRESS                                             03282850
*        R7  - WORK                                                     03283840
*        R9  - RETRY CHANNEL PROGRAM ADDRESS                            03284830
*                                                                       03285820
*.$******************************************************************** 03286810
         SPACE ,                                                        03287800
READER06 S     R4,=F'16'      R4 POINTS TO SEARCH ID CCW                03288790
READER31 L     R5,0(R4)       R5 CONTAINS DATA ADDRESS                  03289780
         SR    R3,R3          CLEAR R3                                  03290770
         ICM   R3,1,4(R5)     PUT REC NUMBER INTO R3                    03291760
         BM    READTRY        BRANCH IF FILLER RECORD                   03292750
         BZ    FATAL          BRANCH IF RECORD ZERO                     03293740
         CLC   SEEKA+2(2),=X'0000' IS IT CYLINDER 0                     03294730
         BNE   PAGECT         NO, BYPASS CYLINDER BIT MAP               03295720
         CLM   R3,1,RECN4     IS PAGE COUNT GREATER THAN 4              03296710
         BH    PAGECT         YES, BYPASS CYLINDER BIT MAP              03297700
         BCTR  R3,0           DECREASE RECORD NUMBER BY 1               03298690
         STC   R3,SHIFT+3     CAUSE SHIFT OF VALUE IN R3                03299680
         L     R7,SHIFTMSK    PUT 80 00 00 00 INTO R7                   03300670
SHIFT    SRL   R7,0           SHIFT RIGHT BY VALUE IN R3                03301660
         O     R7,R0STUF      OR IN R0 CYLINDER BIT MAP                 03302650
         ST    R7,R0STUF      PUT RESULT BACK                           03303640
PAGECT   EQU   *              COUNT PAGE ERRORS                         03304630
         L     R3,PGCOUNT     PUT PGCOUNT INTO R3                       03305620
         LA    R3,1(R3)       UP PAGE COUNT BY 1                        03306610
         ST    R3,PGCOUNT     SAVE UPDATED PGCOUNT                      03307600
         SPACE ,                                                        03308590
*---------------------------------------------------------------------- 03309580
*        USE TO RESTART CCW CHAIN AFTER ERROR                           03310570
*---------------------------------------------------------------------- 03311560
         SPACE ,                                                        03312550
READTRY  LA    R4,24(R4)      POINT TO NEXT SEARCH ID                   03313540
         ST    R4,PICKUP      BUILD TIC TO NEXT SEARCH ID               03314530
         MVI   PICKUP,X'08'   PUT TIC COMMAND IN CCW                    03315520
         CLI   0(R4),X'07'    IS NEXT SEARCH ID REALLY A SEEK?          03316510
         BE    SKFOUND        YES,BRANCH                                03317500
SEEKSEEK S     R4,=F'8'       NO,BACK UP 1 CCW                          03318490
         CLI   0(R4),X'07'    IS IT A SEEK?                             03319480
         BNE   SEEKSEEK       NO, BACK UP AGAIN                         03320470
SKFOUND  MVC   RDRTRY(8),0(R4)  BUILD SEEK CCW                          03321460
         LA    R9,RDRTRY      ADDRESS OF CCW INTO R9                    03322450
         ST    R9,CAW         ADDRESS OF CCW INTO CAW                   03323440
         LH    R5,DSKADD      DEVICE ADDRESS INTO R5                    03324430
         B     STIO           GO TO START DEVICE                        03325420
*---------------------------------------------------------------------- 03326410
*                                                                       03327400
*                                                                       03328390
*                                                                       03329380
*                                                                       03330370
*                                                                       03331360
*                                                                       03332350
*                                                                       03333340
*                                                                       03334330
*                                                                       03335320
*                                                                       03336310
*                                                                       03337300
*                                                                       03338290
*                                                                       03339280
*********************************************************************** 03340270
*********************************************************************** 03341260
**********************                       ************************** 03342250
********************** S U B R O U T I N E S ************************** 03343240
**********************                       ************************** 03344230
*********************************************************************** 03345220
*********************************************************************** 03346210
*                                                                       03347200
*                                                                       03348190
*                                                                       03349180
*                                                                       03350170
*                                                                       03351160
*                                                                       03352150
*                                                                       03353140
*                                                                       03354130
*                                                                       03355120
*                                                                       03356110
*                                                                       03357100
*                                                                       03358090
*                                                                       03359080
*---------------------------------------------------------------------- 03360070
*.4******************************************************************** 03361060
*                                                                       03362050
* SUBROUTINE NAME -       *----------------*                            03363040
*                         *    LNGCALC     *                            03364030
*                         *----------------*                            03365020
*                                                                       03366010
* FUNCTION -                                                            03367000
*                                                                       03367990
*        CALCULATE LENGTH OF WORD IN FIELD "INDATA" AND STORE INTO      03368980
*        COMMON WORK AREA.                                              03369970
*                                                                       03370960
* INPUT REGISTERS -                                                     03371950
*                                                                       03372940
*        R14 - RETURN ADDRESS                                           03373930
*                                                                       03374920
* OUTPUT REGISTERS -                                                    03375910
*                                                                       03376900
*        R4  - LENGTH(WORD) - 1                                         03377890
*                                                                       03378880
* LOCAL REGISTER USAGE -                                                03379870
*                                                                       03380860
*        R4  - LENGTH WORD-1 FOR EXECUTE                                03381850
*        R14 - INDATA                                                   03382840
*                                                                       03383830
* OPERATION -                                                           03384820
*                                                                       03385810
*        1. SCAN FIELD UNTIL BLANK IS FOUND.  RESIDUAL LENGTH WILL BE   03386800
*           IN R4.                                                      03387790
*        2. IF THE FIELD EXISTS, THEN SAVE IT INDATA FIELD IN THE       03388780
*           COMMON WORK AREA.                                           03389770
*        3. SET THE CONDITION CODE AND RETURN TO CALLER.                03390760
*           CC SET TO 0 IF 0 < L'WORD <= 8  AND  R4 = LENGTH-1.         03391750
*           ELSE CC ^=0 AND R4 IS UNPREDICTABLE.                        03392740
*                                                                       03393730
*.$******************************************************************** 03394720
         SPACE ,                                                        03395710
         DS    0F                                                       03396700
LNGCALC  EQU   *                                                        03397690
         ST    R14,REGSAV     SAVE CALLERS RETURN ADDRESS               03398680
         OC    INDATA(8),BLANKS8 SET TO UPPER CASE OR BLANKS            03399670
         OC    INDATA+8(2),BLANKS8 .....                                03400660
         LA    R14,INDATA     SCAN FOR L'INPUT-DATA                     03401650
         LA    R4,9           MAX LENGTH +1                             03402640
         SPACE ,                                                        03403630
*---------------------------------------------------------------------- 03404620
*        SCAN LENGTH OF WORD (UNTIL BLANK IS FOUND).                    03405610
*---------------------------------------------------------------------- 03406600
         SPACE ,                                                        03407590
SCNWRD   CLI   0(R14),X'40'   BLANK ?                                   03408580
         BE    ENDSCN         IF SO, END OF WORD                        03409570
         LA    R14,1(,R14)    NEXT BYTE PLEASE .....                    03410560
         BCT   R4,SCNWRD      CONTINUE SCAN .....                       03411550
         B     EXCC1          GT 8, EXIT CC ^= 0                        03412540
         SPACE ,                                                        03413530
*---------------------------------------------------------------------- 03414520
*        IF LENGTH IS NON-ZERO, THEN STORE INDATA IN THE COMMON WORK.   03415510
*---------------------------------------------------------------------- 03416500
         SPACE ,                                                        03417490
ENDSCN   LR    R14,R4         SAVE RESIDUAL LENGTH                      03418480
         LA    R4,8           CALC LENGTH (-1)                          03419470
         SR    R4,R14         LENGTH (-1)                               03420460
         BM    EXCC1          BR IF NOTHING THERE                       03421450
         EX    R4,MVCCOMW     MOVE TO WORK AREA                         03422440
         SPACE ,                                                        03423430
*---------------------------------------------------------------------- 03424420
*        SET CONDITION CODE AND RETURN.                                 03425410
*---------------------------------------------------------------------- 03426400
         SPACE ,                                                        03427390
         TM    *,X'00'        SET CC = 0                                03428380
         B     LNGEXIT        AND RETURN TO CALLER                      03429370
EXCC1    TM    *,X'FF'        SET CC ^= 0                               03430360
LNGEXIT  L     R14,REGSAV     RESTORE CALLERS REGS                      03431350
         BR    R14            AND RETURN ...........                    03432340
*.4******************************************************************** 03433330
*                                                                       03434320
* SUBROUTINE NAME -       *----------------*                            03435310
*                         *     WMSG       *                            03436300
*                         *     WMSG2      *                            03437290
*                         *----------------*                            03438280
*                                                                       03439270
* FUNCTION -                                                            03440260
*                                                                       03441250
*        WRITE TO THE CONSOLE.                                          03442240
*                                                                       03443230
* INPUT REGISTERS -                                                     03444220
*                                                                       03445210
*        R4  - MESSAGE ADDRESS                                          03446200
*        R14 - RETURN ADDRESS                                           03447190
*                                                                       03448180
* OUTPUT REGISTERS -                                                    03449170
*                                                                       03450160
*        R10 - CONSOLE ADDRESS                                          03451150
*                                                                       03452140
* LOCAL REGISTER USAGE -                                                03453130
*                                                                       03454120
*        R1  - WORK                                                     03455110
*        R4  - COUNT AND DATA POINTER                                   03456100
*        R9  - LENGTH OF MESSAGE TO BE PRINTED                          03457090
*        R10 - ADDRESS OF CONSOLE                                       03458080
*                                                                       03459070
* OPERATION -                                                           03460060
*                                                                       03461050
*        1. IF CARD INPUT COMPARE AND MAKE SURE NOT BAD INPUT.          03462040
*        2. LOAD ADDRESS OF CONSOLE AND STORE DATA LENGTH, DATA AREA,   03463030
*           AND PROPER WRITE COMMAND CODE IN WCCW.                      03464020
*        3. FOR GRAPHICS, SET UP PROPER CCWS.  ISSUE SIO TO DISPLAY     03465010
*           MESSAGE.                                                    03466000
*        4. HANDLE SIO CONDITION CODE APPROPRIATELY.                    03466990
*                                                                       03467980
*.$******************************************************************** 03468970
         SPACE ,                                                        03469960
*---------------------------------------------------------------------- 03470950
*        FOR CARD INPUT, SAVE14 IS USED TO SAVE THE RETURN ADDRESS FROM 03471940
*        EACH CALL.  IF THIS ROUTINE IS CALLED TWICE IN A ROW FROM THE  03472930
*        SAME PLACE, THEN PRINT INVALID OPERAND MESSAGE AND GO BACK TO  03473920
*        THE START AT STMSG.  SAVE4 IS USED BY RMSG ROUTINE TO          03474910
*        DETERMINE IF THE MESSAGE EXPECTS A RESPONSE.                   03475900
*---------------------------------------------------------------------- 03476890
         SPACE ,                                                        03477880
WMSG     CLI   CDSW2,X'00'    CARD SWITCH OFF?                          03478870
         BE    WMSG2          YES,BRANCH                                03479860
         LA    R14,0(,R14)    CLEAR HIGH ORDER BYTE .......             03480850
         CL    R14,SAVE14     IS R14 THE SAME?                          03481840
         BE    BADINPUT       THE SAME BRANCH                           03482830
         ST    R14,SAVE14     STORE NEW R14                             03483820
         ST    R4,SAVE4       SAVE R4                                   03484810
         SPACE ,                                                        03485800
*---------------------------------------------------------------------- 03486790
*        LOAD ADDRESS OF CONSOLE AND STORE DATA LENGTH, DATA AREA, AND  03487780
*        PROPER WRITE COMMAND CODE IN WCCW.                             03488770
*---------------------------------------------------------------------- 03489760
         SPACE ,                                                        03490750
WMSG2    LH    R10,CONSOL     WRITE MESSAGE                             03491740
         MVC   WCCW+7(1),0(R4) SET DATA LENGTH IN CCW                   03492730
         SR    R9,R9          ZERO IT                                   03493720
         IC    R9,0(,R4)      PICK UP THE LENGTH                        03494710
         LA    R9,0(R9,R4)    AND ADD IT TO THE MSG POINTER             03495700
         LA    R4,1(R4)       R4 NOW POINTS TO CCW DATA AREA            03496690
         ST    R4,WCCW        PUT ADDRESS OF DATA AREA IN CCW           03497680
         MVI   WCCW,X'09'     SET UP TO WRITE WITH CARR RETURN          03498670
*        IS IT, ENTER FORMAT OR ALLOCATE:                               03499660
         CLI   0(R9),C':'     DO I WANT A REPLY                         03500650
         BNE   *+8            NO- WRITE WITH CARR RETURN                03501640
         MVI   WCCW,X'01'     SET UP TO  WRITE WITHOUT CARR RETURN      03502630
         LA    R9,WCCW        R9 CONTAINS CCW ADDRESS                   03503620
         SPACE ,                                                        03504610
*---------------------------------------------------------------------- 03505600
*        FOR GRAPHIC DEVICES, SET UP THE PROPER CCW STRING TO HANDLE    03506590
*        GRAPHICS I/O.  THIS SUPPORT IS CHECKED FOR IN GRAPHID.  THEN   03507580
*        ISSUE THE SIO TO DISPLAY THE MESSAGE.                          03508570
*---------------------------------------------------------------------- 03509560
         SPACE ,                                                        03510550
STARTIO  EQU   *                                                        03511540
         BAL   R1,GRAPHID     GO CHECK FOR GRAPHIC SUPPORT              03512530
STARTIO1 EQU   *                                                        03513520
         XC    CSW,CSW        CLEAR CSW FIELD                           03514510
         ST    R9,CAW         SAVE CCW STRING ADDRESS IN CAW            03515500
         SIO   0(R10)         START DEVICE                              03516490
         BC    2,WAITIN       GO START LOOP AGAIN                       03517480
         BC    4,CSWSTOR      GO TEST STATUS                            03518470
         BC    1,NOTOPER      GO INDICATE NOT OPERATIONAL               03519460
         SPACE ,                                                        03520450
*---------------------------------------------------------------------- 03521440
*        GO TO INTERRUPT HANDLER AND WAIT UNTIL CONSOLE IS READY FOR US 03522430
*---------------------------------------------------------------------- 03523420
         SPACE ,                                                        03524410
WAITIN   EQU   *                                                        03525400
         LPSW  WAITCON        WAIT FOR CONSOLE TO GIVE                  03526390
         SPACE ,                                                        03527380
*---------------------------------------------------------------------- 03528370
*        NOT OPERATIONAL - GET DIFFERENT DEVICE ADDRESS AND TRY AGAIN.  03529360
*---------------------------------------------------------------------- 03530350
         SPACE ,                                                        03531340
NOTOPER  EQU   *                                                        03532330
         OI    PARM2,X'80'    SET NOT OPERATIONAL INDICATOR             03533320
         B     IRA            GO GET DEVICE ADDRESS                     03534310
         SPACE ,                                                        03535300
*---------------------------------------------------------------------- 03536290
*        CC1 FROM SIO -- CHECK THE CSW STATUS.                          03537280
*---------------------------------------------------------------------- 03538270
         SPACE ,                                                        03539260
CSWSTOR  EQU   *                                                        03540250
         TM    CSW+4,BUSY     IS THE UNIT BUSY                          03541240
         BZ    LOOKATCE       NO, GO LOOK AT CE                         03542230
         TM    CSW+4,DE+ATTN+CUE+CE IS THIS ENDING STATUS               03543220
         BNZ   STUADD         YES, GO STORE ADDRESS                     03544210
         LPSW  WAITCON        WAIT FOR I/O INTERRUPT                    03545200
         SPACE ,                                                        03546190
LOOKATCE EQU   *                                                        03547180
         TM    CSW+4,CE       IS THIS CHANNEL END                       03548170
         BZ    STUADD         NO, GO STORE ADDRESS                      03549160
         LA    R1,8(,R9)      GET ADDRESS OF FIRST CCW + 8              03550150
         ST    R1,CSW         SAVE ADDRESS IN CSW                       03551140
STUADD   EQU   *                                                        03552130
         TM    CSW+4,CUE      IS THIS A CONTROL UNIT END ?              03553120
         BO    STARTIO1       YES, GO RESTART I/O OPERATION             03554110
         STH   R10,58         SAVE THE INTERRUPT DEVICE                 03555100
         B     IRA            GO TO INTERRUPT HANDLER                   03556090
*.4******************************************************************** 03557080
*                                                                       03558070
* SUBROUTINE NAME -       *----------------*                            03559060
*                         *      RMSG      *                            03560050
*                         *----------------*                            03561040
*                                                                       03562030
* FUNCTION -                                                            03563020
*                                                                       03564010
*        READ FROM THE CONSOLE.                                         03565000
*                                                                       03565990
* LOCAL REGISTER USAGE -                                                03566980
*                                                                       03567970
*        R9  - CHANNEL PROGRAM ADDRESS                                  03568960
*        R10 - ADDRESS OF CONSOLE                                       03569950
*        R14 - RETURN ADDRESS                                           03570940
*                                                                       03571930
* OPERATION -                                                           03572920
*                                                                       03573910
*        1. FOR CONSOLE INPUT, GO TO STARTIO TO READ IN THE RESPONSE.   03574900
*        2. FOR CARD INPUT, COMPARE THE CARD TO VALID PARAMETERS UNTIL  03575890
*           A MATCH IS FOUND.                                           03576880
*        3. DISPLAY THE CARD INPUT RESPONSE BY CALLING WMSG.            03577870
*                                                                       03578860
*.$******************************************************************** 03579850
         SPACE ,                                                        03580840
*---------------------------------------------------------------------- 03581830
*        FOR CONSOLE INPUT, GET THE CONSOLE ADDRESS AND READ IN THE     03582820
*        RESPONSE INTO INDATA USING THE STARTIO ROUTINE.                03583810
*---------------------------------------------------------------------- 03584800
         SPACE ,                                                        03585790
RMSG     TM    CDSW2,X'FF'    IS CARD SWITCH ON ?                       03586780
         BO    GETDATA        YES, BRANCH                               03587770
         LH    R10,CONSOL     R10 CONTAINS CONSOLE ADDRESS              03588760
         XC    INDATA(80),INDATA CLEAR ROOM ENOUGH TO WORK              03589750
         LA    R9,RCCW        PUT CCW ADDRESS INTO CAW                  03590740
         B     STARTIO        GO ISSUE SIO                              03591730
         SPACE ,                                                        03592720
*---------------------------------------------------------------------- 03593710
*        FOR CARD INPUT, COMPARE THE CARD TO PARAMETERS.  MOVE THE      03594700
*        CORRESPONDING RESPONSE WORD(S) INTO INDATA.                    03595690
*---------------------------------------------------------------------- 03596680
         SPACE ,                                                        03597670
GETDATA  XC    INDATA+1(24),INDATA+1 CLEAR BUT 1ST POSITION @V6292B1    03598660
         CLC   SAVE4,=A(FORA) IS IT FORMAT OR ALLOCATE?                 03599650
         MVC   INDATA(8),CDFORA  MOVE IN FORMAT OR ALLOCATE             03600640
         BE    GETBACK        YES,BRANCH                                03601630
         CLC   SAVE4,=A(ADDRESS) DEVICE ADDRESS                         03602620
         MVC   INDATA(8),CDADD   PASS DATA CONSOLE READ                 03603610
         BE    GETBACK           YES,BRANCH                             03604600
         CLC   SAVE4,=A(TYPMSG)  IS IT DEV TYPE                         03605590
         MVC   INDATA(8),CDTYPE  PASS DATA CONSOLE READ                 03606580
         BE    GETBACK           YES,BRANCH                             03607570
         CLC   SAVE4,=A(RDLAB)   IS IT LABEL                            03608560
         MVC   INDATA(8),CDLABEL PASS DATA CONSOLE READ                 03609550
         BE    GETBACK           YES,BRANCH                             03610540
         CLC   SAVE4,=A(WVMSG2)  IS IT WRITE VERIFICATION?              03611530
         MVC   INDATA(8),CDWVERIF PASS DATA CONSOLE READ                03612520
         BE    GETBACK           YES, BRANCH                            03613510
         CLC   SAVE4,=A(STCYL)   IS IT START CYL?                       03614500
         MVC   INDATA(8),CDSTART PASS DATA CONSOLE READ                 03615490
         BE    GETBACK           YES,BRANCH                             03616480
         CLC   SAVE4,=A(ENDCYL)  IS IT END CYL?                         03617470
         MVC   INDATA(8),CDENDCYL PASS DATA CONSOLE READ                03618460
         BE    GETBACK           YES,BRANCH                             03619450
         MVC   INDATA(4),CDFORA  MOVE ALLOCATION TYPE                   03620440
         MVC   INDATA+NAMCHARS+BLANK(CYLNUM),CDADD                      03621430
*                                MOVE IN ALLOCATION START CYL           03622420
         MVC   INDATA+NAMCHARS+BLANK+CYLNUM+BLANK(CYLNUM),CDTYPE        03623410
*                                MOVE IN ALLOCATION END CYL             03624400
         SPACE ,                                                        03625390
*---------------------------------------------------------------------- 03626380
*        DISPLAY THE CARD INPUT RESPONSE BY CALLING WMSG.               03627370
*---------------------------------------------------------------------- 03628360
         SPACE ,                                                        03629350
GETBACK  ST    R14,REGSAV        SAVE R14                               03630340
         MVC   ANSWER,INDATA     SET UP INDATA TO PRINT                 03631330
         LA    R4,RESPONSE       ADDRESS OF MESSAGE INTO R4             03632320
         BAL   R14,WMSG2         WRITE MESSAGE                          03633310
         L     R14,REGSAV        RESTORE R14                            03634300
BY       LA    R14,8(R14)        UP R14 TO BYPASS TEST FOR UE           03635290
         BR    R14               BRANCH BACK                            03636280
*.4******************************************************************** 03637270
*                                                                       03638260
* SUBROUTINE NAME -       *----------------*                            03639250
*                         *    GRAPHID     *                            03640240
*                         *----------------*                            03641230
*                                                                       03642220
* FUNCTION -                                                            03643210
*                                                                       03644200
*        GRAPHIC DEVICE INDICATOR ROUTINE.  THIS IS CALLED TO READ      03645190
*        FROM OR WRITE TO GRAPHIC TYPE DEVICES.                         03646180
*                                                                       03647170
* INPUT REGISTERS -                                                     03648160
*                                                                       03649150
*        R1  - RETURN ADDRESS                                           03650140
*        R9  - CCW STRING ADDRESS                                       03651130
*                                                                       03652120
* OUTPUT REGISTERS -                                                    03653110
*                                                                       03654100
*        R9  - PROPER MODIFIED CCW STRING ADDRESS                       03655090
*                                                                       03656080
* LOCAL REGISTER USAGE -                                                03657070
*                                                                       03658060
*        R2  - WORK                                                     03659050
*        R3  - DATA COUNT                                               03660040
*        R4  - WORK                                                     03661030
*        R5  - WORK                                                     03662020
*        R9  - CHANNEL PROGRAM ADDRESS                                  03663010
*        R14 - WORK                                                     03664000
*                                                                       03664990
* OPERATION -                                                           03665980
*                                                                       03666970
*        1. GET ADDRESS OF CCW STRING                                   03667960
*        2. GET ADDRESS OF COMMAND OP TABLE                             03668950
*        3. TEST COMMAND OP CODE WITH TABLE CODE                        03669940
*        4. IS IT A 3270 GRAPHIC DEVICE?                                03670930
*        5. IF NOT, CLEAR LINE POINTER                                  03671920
*        6. GET CHANNEL PROGRAM                                         03672910
*        7. SAVE CURRENT LINE POINTER                                   03673900
*        8. SET COORDINATES                                             03674890
*        9. GET ADDRESS OF BUFFER                                       03675880
*       10. CHECK FOR DATA IN INPUT AREA                                03676870
*       11. CHECK FOR COMMAND CHAINING                                  03677860
*       12. UPDATE TO NEXT CCW                                          03678850
*                                                                       03679840
*.$******************************************************************** 03680830
         SPACE ,                                                        03681820
GRAPHID  DS    0H             HANDLE GRAPHICS DEVICES                   03682810
         TM    PARM,PARMGRP   IS THE GRAPHIC INDICATOR ACTIVE ?         03683800
         BCR   8,R1           NO, GO START THE I/O REQUEST              03684790
         STM   R14,R5,GRAPHSAV SAVE THE REGISTERS                       03685780
         LR    R4,R9          GET THE ADDRESS OF THE CCW STRING         03686770
         SPACE ,                                                        03687760
*---------------------------------------------------------------------- 03688750
*        SAVE THE DATA COUNT AND CCW ADDRESS FOR LATER RESTORE.         03689740
*---------------------------------------------------------------------- 03690730
         SPACE ,                                                        03691720
GETCCW   EQU   *                                                        03692710
         LH    R3,6(R4)       GET THE DATA COUNT FROM THE CCW           03693700
         STM   R3,R4,SAVEAREA SAVE THE DATA REGISTERS                   03694690
         NI    PARM,X'FF'-(PARMREA+PARMNDA) CLEAR THE READ              03695680
*                             REQUEST AND NO DATA INDICATOR             03696670
         LA    R2,5           SET THE LOOP COUNT                        03697660
         LA    R14,TABLGRAP   GET THE ADDRESS OF THE COMMAND            03698650
*                             OP TABLE                                  03699640
         ICM   R5,1,0(R4)     GET THE OP CODE                           03700630
         SPACE ,                                                        03701620
*---------------------------------------------------------------------- 03702610
*        COMPARE THE COMMAND OPCODE WITH THE CODE IN TABLGRAP UNTIL     03703600
*        THE CODE IS FOUND IN THE TABLE.  TABLGRAP CONTAINS THE         03704590
*        ADDRESSES OF THE CORRESPONDING SECTIONS FOR THE PROPER READ    03705580
*        OR WRITE ROUTINE.  GO TO THE PROPER SECTION.                   03706570
*---------------------------------------------------------------------- 03707560
         SPACE ,                                                        03708550
CCWEXEC  EQU   *                                                        03709540
         EX    R5,CLIP        TEST THE COMMAND OP CODE WITH             03710530
*                             TABLE CODE                                03711520
         BE    GRAPHADD       YES, FOUND THE COMMAND OP CODE            03712510
         LA    R14,4(R14)     UPDATE THE ADDRESS IN THE TABLE           03713500
         BCT   R2,CCWEXEC     GO TEST THE NEXT OP CODE                  03714490
         SPACE ,                                                        03715480
         B     STMSG          INVALID OP CODE - GO EXIT                 03716470
CLIP     CLI   0(R14),X'00'   TEST THE OP CODE IN THE TABLE             03717460
GRAPHADD EQU   *                                                        03718450
         ICM   R2,7,1(R14)    GET THE ADDRESS OF THE OP CODE            03719440
*                             ROUTINE                                   03720430
         BR    R2             GO TO THE ROUTINE                         03721420
         SPACE ,                                                        03722410
*---------------------------------------------------------------------- 03723400
*        OPCODE X'0A' : HANDLE GRAPHIC READ FOR 3270 GRAPHIC DEVICE.    03724390
*---------------------------------------------------------------------- 03725380
         SPACE ,                                                        03726370
READ66   EQU   *                                                        03727360
         OI    PARM,PARMREA+PARMATT INDICATE READ AND ATTENTION         03728350
*                             REQUESTS                                  03729340
         LA    R14,GRAPHIC0   RETURN ADDRESS FROM I/O HANDLER           03730330
         XC    BLNKLINE(140),BLNKLINE CLEAR THE READ AREA               03731320
         MVI   CSW+4,X'00'    CLEAR THE CSW STATUS                      03732310
         XC    RDMIDATA(6),RDMIDATA CLEAR THE READ DATA FIELD           03733300
         MVC   CPXYSTAT(20),REALABEL                                    03734290
         LA    R9,REQREAD     GET CHANNEL PROGRAM ADDRESS               03735280
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03736270
         BCR   8,R1           NO, GO ISSUE SIO                          03737260
         LA    R9,REQREAD1    GET CHANNEL PROGRAM ADDRESS               03738250
         BR    R1             GO TO THE I/O HANDLER                     03739240
         SPACE ,                                                        03740230
*---------------------------------------------------------------------- 03741220
*        OPCODE X'01', X'05', OR X'09' : HANDLE GRAPHIC WRITE.          03742210
*        FOR A NON-3270, GET THE APPROPRIATE 3066 CHANNEL PROGRAM AND   03743200
*        RETURN TO ISSUE SIO.                                           03744190
*---------------------------------------------------------------------- 03745180
         SPACE ,                                                        03746170
WRT66    EQU   *                                                        03747160
         MVC   CPXYSTAT(20),RUNLABEL                                    03748150
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03749140
         BO    YES3270        YES, GO TO 3270 SUPPORT                   03750130
         MVC   WRT3066+1(3),1(R4) GET THE MESSAGE ADDRESS               03751120
         STH   R3,WRT3066+6   SAVE THE DATA COUNT IN THE CCW            03752110
         LA    R9,WRTCRTXY    GET CHANNEL PROGRAM ADDRESS               03753100
         TM    PARM,PARMCLE   IS THE ERASE INDICATOR ON ?               03754090
         BZ    GRAPWRT        NO, GO TO SIO SECTION                     03755080
         LA    R9,ERSE3066    GET CHANNEL PROGRAM ADDRESS               03756070
         MVI   SBADDR,X'00'   CLEAR LINE POINTER                        03757060
GRAPWRT  EQU   *                                                        03758050
         LA    R14,GRAPHIC1   RETURN ADDRESS FROM I/O HANDLER           03759040
         BR    R1             GO TO THE I/O HANDLER                     03760030
         SPACE ,                                                        03761020
*---------------------------------------------------------------------- 03762010
*        OPCODE X'01', X'05', OR X'09' : HANDLE GRAPHIC WRITE.          03763000
*        FOR A 3270 GRAPHIC, GET THE APPROPRIATE 3270 CHANNEL PROGRAM   03763990
*        AND RETURN TO ISSUE SIO.                                       03764980
*---------------------------------------------------------------------- 03765970
         SPACE ,                                                        03766960
YES3270  EQU   *                                                        03767950
         SR    R14,R14        CLEAR REGISTER 14                         03768940
         LA    R9,WRTCRT70    GET CHANNEL PROGRAM ADDRESS               03769930
         TM    PARM,PARMCLE   IS THE ERASE INDICATOR ON ?               03770920
         BZ    NOCL3270       NO, DON'T CLEAR SCREEN                    03771910
         MVI   SBADDR,X'00'   CLEAR LINE POINTER                        03772900
         LA    R9,ERSE3270    GET CHANNEL PROGRAM ADDRESS               03773890
NOCL3270 EQU   *                                                        03774880
         IC    R14,SBADDR     GET THE CURRENT LINE POINTER              03775870
         SLL   R14,1          SETUP THE INDEX INTO THE TABLE            03776860
         LH    R14,TABLE70(R14) GET THE LINE ADDRESS                    03777850
         STCM  R14,3,LAB3270+2 SAVE THE CURRENT LINE POINTER            03778840
         MVC   WRTCR70+1(3),1(R4) GET THE MESSAGE ADDRESS               03779830
         STH   R3,WRTCR70+6   SAVE THE BYTE COUNT IN THE CCW            03780820
         B     GRAPWRT        GO GET THE RETURN ADDRESS                 03781810
         SPACE ,                                                        03782800
*---------------------------------------------------------------------- 03783790
*        GRAPHIC1 IS THE ADDRESS RETURNED TO FROM THE I/O INTERRUPT     03784780
*        HANDLER, FROM THE GRAPHIC WRITE ROUTINE ABOVE.                 03785770
*---------------------------------------------------------------------- 03786760
         SPACE ,                                                        03787750
GRAPHIC1 EQU   *                                                        03788740
         LM    R3,R4,SAVEAREA GET THE DATA REGISTERS                    03789730
         NI    PARM,X'FF'-PARMCLE CLEAR THE ERASE INDICATOR             03790720
         SR    R2,R2          CLEAR REGISTER 2                          03791710
         IC    R2,SBADDR      GET THE Y COORDINATE                      03792700
         LA    R2,1(R2)       UPDATE THE Y COORDINATE                   03793690
         CH    R3,=H'80'      IS THE DATA COUNT LONGER THAN 1           03794680
*                             LINE                                      03795670
         BNH   *+8            NO, GO SAVE Y COORDINATE                  03796660
         LA    R2,1(R2)       UPDATE THE Y COORDINATE AGAIN             03797650
         STC   R2,SBADDR      SAVE THE Y COORDINATE                     03798640
         MH    R2,=H'80'      GET THE BYTE LENGTH                       03799630
         L     R14,=F'2640'   GET THE MAX. LENGTH                       03800620
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03801610
         BZ    TEST3066       NO, GO TEST FOR END OF CRT                03802600
         L     R14,MAXLEN     GET THE MAX. LEN FOR 3270/3278            03803590
TEST3066 EQU   *                                                        03804580
         CR    R2,R14         Y COORDINATE AT END OF THE CRT?           03805570
         BL    RETWORD        NO, CHECK FOR CMD CHAINING                03806560
         OI    PARM,PARMATT   SET THE ATTENTION REQUEST                 03807550
         MVI   CSW+4,X'00'    CLEAR THE CSW STATUS                      03808540
         MVC   CPXYSTAT(20),MORLABEL                                    03809530
         LA    R14,GRAPHIC3   RETURN ADDRESS FROM I/O HANDLER           03810520
         LA    R9,CRTWORD     GET CHANNEL PROGRAM ADDRESS               03811510
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03812500
         BCR   8,R1           NO, GO ISSUE SIO                          03813490
         LA    R9,MORECCW1    GET CHANNEL PROGRAM ADDRESS               03814480
         BR    R1             GO ISSUE SIO                              03815470
         SPACE ,                                                        03816460
*---------------------------------------------------------------------- 03817450
*        GRAPHIC3 IS THE ADDRESS RETURNED TO FROM THE I/O INTERRUPT     03818440
*        HANDLER, FROM THE GRAPHIC1 WRITE ROUTINE ABOVE.                03819430
*---------------------------------------------------------------------- 03820420
         SPACE ,                                                        03821410
GRAPHIC3 EQU   *                                                        03822400
         TM    STAT,ATTN      IS THE ATTENTION FLAG ACTIVE ?            03823390
         BZ    GRAPPSW        NO, GO WAIT FOR AN ATTENTION              03824380
*                             INTERRUPT                                 03825370
         NI    PARM,X'FF'-PARMATT CLEAR THE ATTENTION INDICATOR         03826360
CANCEL1  EQU   *                                                        03827350
         LM    R3,R4,SAVEAREA GET THE DATA REGISTERS                    03828340
         MVI   SBADDR,X'00'   SET THE Y COORDINATE TO ZERO              03829330
         MVC   CPXYSTAT(20),RUNLABEL CRT DISPLAY RUN STATUS             03830320
         LA    R9,CNCL3066    GET CHANNEL PROGRAM ADDRESS               03831310
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03832300
         BZ    RETURNCN       NO, GO GET RETURN ADDRESS                 03833290
         LA    R9,CNCL3270    GET CHANNEL PROGRAM ADDRESS               03834280
RETURNCN EQU   *                                                        03835270
         LA    R14,READ66     GET THE ADDRESS OF THE READ               03836260
*                             SECTION                                   03837250
         TM    PARM,PARMREA   IS THIS A READ REQUEST ?                  03838240
         BCR   1,R1           YES, GO TO THE I/O HANDLER                03839230
         LA    R14,RETWORD    RETURN ADDRESS FROM I/O HANDLER           03840220
         BR    R1             GO TO THE I/O HANDLER                     03841210
         SPACE ,                                                        03842200
*---------------------------------------------------------------------- 03843190
*        GRAPHIC0 IS THE ADDRESS RETURNED TO FROM THE I/O INTERRUPT     03844180
*        HANDLER, FROM THE READ66 READ ROUTINE ABOVE.                   03845170
*---------------------------------------------------------------------- 03846160
         SPACE ,                                                        03847150
GRAPHIC0 EQU   *                                                        03848140
         TM    STAT,ATTN      IS THE ATTENTION FLAG ACTIVE ?            03849130
         BO    GRAPATTN       YES, GO SETUP CCW FOR READ                03850120
*                             MANUAL INPUT                              03851110
GRAPPSW  EQU   *                                                        03852100
         LPSW  WAITCON        GO WAIT FOR INTERRUPT                     03853090
         SPACE ,                                                        03854080
*---------------------------------------------------------------------- 03855070
*        ATTENTION FLAG WAS ON, SO SET UP THE CCW FOR READING MANUALLY. 03856060
*---------------------------------------------------------------------- 03857050
         SPACE ,                                                        03858040
GRAPATTN EQU   *                                                        03859030
         LM    R3,R4,SAVEAREA GET THE DATA REGISTERS                    03860020
         NI    PARM,X'FF'-PARMATT CLEAR ATTENTION REQUEST               03861010
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03862000
         BO    YES3270A       YES, GO TO 3270 SUPPORT                   03862990
         STH   R3,RD3066DA+6  STORE THE COUNT IN THE CCW                03863980
         MVC   RD3066DA+1(3),1(R4) MOVE THE ADDRESS OF THE READ         03864970
*                             BUFFER INTO THE CCW                       03865960
         LA    R9,RDMI3066    GET THE ADDRESS OF THE CHANNEL            03866950
*                             PROGRAM                                   03867940
RETURNAD EQU   *                                                        03868930
         LA    R14,RET66MI    RETURN ADDRESS FROM I/O HANDLER           03869920
         BR    R1             GO TO THE I/O HANDLER                     03870910
         SPACE ,                                                        03871900
*---------------------------------------------------------------------- 03872890
*        FOR 3270 GRAPHIC, READ INPUT FOR ATTENTION.                    03873880
*---------------------------------------------------------------------- 03874870
         SPACE ,                                                        03875860
YES3270A EQU   *                                                        03876850
         LA    R14,6(R3)      ADD  6 T0 THE TOTAL COUNT                 03877840
         STH   R14,RD3270DA+6 STORE THE COUNT IN THE CCW                03878830
         LA    R14,BLNKLINE   GET THE ADDRESS OF THE BUFFER             03879820
         STCM  R14,7,RD3270DA+1 MOVE THE ADDRESS OF THE READ            03880810
*                             BUFFER INTO THE CCW                       03881800
         LA    R9,RDMI3270    GET THE ADDRESS OF THE CHANNEL            03882790
*                             PROGRAM                                   03883780
         B     RETURNAD       GO GET THE RETURN ADDRESS                 03884770
         SPACE ,                                                        03885760
*---------------------------------------------------------------------- 03886750
*        RET66MI IS THE RETURN ADDRESS FROM THE I/O HANDLER AFTER       03887740
*        MANUALLY READING INPUT AFTER ATTENTION.                        03888730
*---------------------------------------------------------------------- 03889720
         SPACE ,                                                        03890710
RET66MI  EQU   *                                                        03891700
         LM    R3,R4,SAVEAREA GET THE DATA REGISTERS                    03892690
         MVC   CPXYSTAT(20),RUNLABEL CRT DISPLAY RUN STATUS             03893680
         LA    R9,CRTWORD     GET CHANNEL PROGRAM ADDRESS               03894670
         LA    R14,RETINPUT   RETURN ADDRESS FROM I/O HANDLER           03895660
         TM    PARM,PARM327   IS THIS A 3270 GRAPHIC ?                  03896650
         BO    YES3270B       YES, GO CHECK 3270 SUPPORT                03897640
         TM    RDMIDATA+2,X'40' DID THE OPERATOR HIT THE                03898630
*                             CANCEL KEY                                03899620
         BO    CANCEL1        YES, GO CLEAR SCREEN                      03900610
         CLC   RDMIDATA(2),SBAREAD DID THE CURSOR MOVE ?                03901600
         BCR   7,R1           YES, GO WRITE STATUS                      03902590
         OI    PARM,PARMNDA   SET INDICATOR FOR NO DATA                 03903580
         BR    R1             GO WRITE OUT STATUS                       03904570
         SPACE ,                                                        03905560
*---------------------------------------------------------------------- 03906550
*        FOR 3270 GRAPHIC, HANDLE WRITING STATUS AFTER RETURNING FROM   03907540
*        ATTENTION READ.                                                03908530
*---------------------------------------------------------------------- 03909520
         SPACE ,                                                        03910510
YES3270B EQU   *                                                        03911500
         CLI   BLNKLINE,X'6E' DID THE OPERATOR HIT THE CANCEL           03912490
*                             KEY                                       03913480
         BE    CANCEL1        YES, GO CLEAR SCREEN                      03914470
         CLI   BLNKLINE,X'6D' DID THE OPERATOR HIT THE CLEAR            03915460
*                             KEY                                       03916450
         BE    CANCEL1        YES, GO CLEAR SCREEN                      03917440
         CLI   BLNKLINE,X'6C' DID OPERATOR HIT PA1 KEY                  03918430
         BE    CANCEL1        YES, GO CLEAR SCREEN                      03919420
         OI    PARM,PARMNDA   SET INDICATOR FOR NO DATA                 03920410
         CLI   BLNKLINE,X'01' DID OPERATOR HIT TEST REQ. KEY            03921400
         BE    ENT3270        YES, GO WRITE STATUS                      03922390
         CLI   BLNKLINE,X'E6' IS THIS THE CARD READER                   03923380
         BE    ENT3270        YES, GO WRITE STATUS                      03924370
         CLI   BLNKLINE+6,X'00' DATA IN INPUT AREA ?                    03925360
         BNE   DATA3270       YES, GO DISPLAY DATA                      03926350
         CLC   BLNKLINE+1(2),ADDR5  DID CURSOR MOVE?                    03927340
         BE    ENT3270              NO                                  03928330
DATA3270 EQU   *                                                        03929320
         NI    PARM,X'FF'-PARMNDA SET INDICATOR FOR NO DATA             03930310
         ICM   R9,7,1(R4)     GET ADDRESS OF USER'S BUFFER              03931300
         BCTR  R3,R0          SUBTRACT ONE FROM COUNT (EX               03932290
*                             INSTR.)                                   03933280
         EX    R3,MOV3270     MOVE DATA INTO USER'S BUFFER              03934270
ENT3270  EQU   *                                                        03935260
         LA    R9,CRTWORD1    GET THE ADDRESS OF THE CHANNEL            03936250
*                             PROGRAM                                   03937240
         BR    R1             GO ISSUE SIO                              03938230
         SPACE ,                                                        03939220
MOV3270  MVC   0(0,R9),BLNKLINE+6 MOVE THE DATA INTO THE                03940210
*                             USER'S BUFFER                             03941200
         SPACE ,                                                        03942190
*---------------------------------------------------------------------- 03943180
*        RETURN ADDRESS AFTER WRITING STATUS.                           03944170
*---------------------------------------------------------------------- 03945160
         SPACE ,                                                        03946150
RETINPUT EQU   *                                                        03947140
         LM    R3,R4,SAVEAREA GET THE DATA REGISTERS                    03948130
         TM    PARM,PARMNDA   IS NO DATA INDICATED ?                    03949120
         BZ    WRT66          NO, GO DISPLAY INPUT ON CRT               03950110
         SPACE ,                                                        03951100
*---------------------------------------------------------------------- 03952090
*        FOR OPCODE X'03' NOOP : RETURN SECTION.                        03953080
*---------------------------------------------------------------------- 03954070
         SPACE ,                                                        03955060
RETWORD  EQU   *                                                        03956050
         TM    4(R4),CC       IS COMMAND CHAINING ON ?                  03957040
         LA    R4,8(R4)       UPDATE THE CCW ADDRESS TO NEXT            03958030
*                             CCW                                       03959020
         BO    GETCCW         YES, GET DATA COUNT FROM CCW              03960010
         LM    R14,R5,GRAPHSAV GET CALLER'S REGISTERS                   03961000
         BR    R14            RETURN TO CALLER                          03961990
*.4******************************************************************** 03962980
*                                                                       03963970
* SUBROUTINE NAME -       *----------------*                            03964960
*                         *      XBIN      *                            03965950
*                         *----------------*                            03966940
*                                                                       03967930
* FUNCTION -                                                            03968920
*                                                                       03969910
*        CHECK TO SEE IF THE INPUT IS VALID AND HAS CORRECT NUMBERS.    03970900
*        VALID NUMBERS ARE C1-C6 AND F0-F9.                             03971890
*                                                                       03972880
* INPUT REGISTERS -                                                     03973870
*                                                                       03974860
*        R7  - RETURN ADDRESS                                           03975850
*        R8  - INPUT NUMBER                                             03976840
*        R9  - COUNT                                                    03977830
*                                                                       03978820
* OUTPUT REGISTERS -                                                    03979810
*                                                                       03980800
*        R10 - VALID INPUT (THIS IS NEGATIVE IF INVALID INPUT)          03981790
*                                                                       03982780
* LOCAL REGISTER USAGE -                                                03983770
*                                                                       03984760
*        R4  - WORK                                                     03985750
*                                                                       03986740
*.$******************************************************************** 03987730
         SPACE ,                                                        03988720
XBIN     SR    R10,R10                 CLEAR REG 10                     03989710
         SPACE ,                                                        03990700
*---------------------------------------------------------------------- 03991690
*        CHECK FOR VALID NUMBER.                                        03992680
*---------------------------------------------------------------------- 03993670
         SPACE ,                                                        03994660
NEWNUM   IC    R4,0(R8)                PUT CHAR INTO R4                 03995650
         SLL   R4,28                   KEEP ONLY BITS 4TO7              03996640
         SRL   R4,28                   OF LAST BYTE                     03997630
         CLI   0(R8),X'F0'             LOWER THAN F0                    03998620
         BC    4,ALPHA                 COULD BE ALPHA                   03999610
         CLI   0(R8),X'F9'             IS IT GREATER THAN 9             04000600
         BC    2,ERRORX                IF GREATER ,ERROR                04001590
COMMON2  SLL   R10,4                   SHIFT LEFT 4 BITS                04002580
         OR    R10,R4                  OR R4 INTO R10                   04003570
         LA    R8,1(R8)                ADD 1 TO REG 11                  04004560
         BCT   R9,NEWNUM               LOOP IF MORE TO CHECK            04005550
         BR    R7                      GO WHENCE CAME YOU               04006540
         SPACE ,                                                        04007530
*---------------------------------------------------------------------- 04008520
*        CHECK FOR VALID LETTER.                                        04009510
*---------------------------------------------------------------------- 04010500
         SPACE ,                                                        04011490
ALPHA    CLI   0(R8),X'C1'             LOWER THAN A                     04012480
         BC    4,ERRORX                IF LOWER THAT'S ERROR            04013470
         CLI   0(R8),X'C6'             IS NUMBER HIGHER THAN F          04014460
         BC    2,ERRORX                IF HIGHER ERROR                  04015450
         LA    R4,9(R4)                CHANGE 1 TO 6 INTO A TO F        04016440
         B     COMMON2                 BRANCH                           04017430
ERRORX   ICM   R10,8,FFS8              R10 NEG TO SHOW ERROR            04018420
         BR     R7                     GO WHENCE CAME YOU               04019410
*.4******************************************************************** 04020400
*                                                                       04021390
* SUBROUTINE NAME -       *----------------*                            04022380
*                         *     DIGBIN     *                            04023370
*                         *----------------*                            04024360
*                                                                       04025350
* FUNCTION -                                                            04026340
*                                                                       04027330
*        CONVERT EBCDIC NUMERIC VALUE TO BINARY.  ON ENTRY, INDATA      04028320
*        CONTAINS EBCDIC VALUE, LEFT JUSTIFIED, UPPER CASE.  AT END,    04029310
*        CC IS NON-ZERO IF INPUT WAS NOT NUMERIC.                       04030300
*                                                                       04031290
* INPUT REGISTERS -                                                     04032280
*                                                                       04033270
*        R4  - LENGTH-1 OF FIELD TO CONVERT (OF INDATA)                 04034260
*        R14 - RETURN ADDRESS                                           04035250
*                                                                       04036240
* OUTPUT REGISTERS -                                                    04037230
*                                                                       04038220
*        R7  - BINARY VALUE RESULTING FROM CONVERSION                   04039210
*                                                                       04040200
*.$******************************************************************** 04041190
         SPACE ,                                                        04042180
DIGBIN   MVC   FIELDC,MASKA            SET UP F0'S IN FIELDC            04043170
         LA    R7,7                    * OFFSET INTO FIELDC TO          04044160
*                                      * MOVE INDATA VALUE SO           04045150
         SR    R7,R4                   * THAT IT BECOMES RIGHT          04046140
         LA    R7,FIELDC(R7)           * JUSTIFIED                      04047130
         EX    R4,MOVEBC               MOVE THE EBCDIC VALUE            04048120
*                                      TO FIELDC, AT APPROP             04049110
*                                      OFFSET                           04050100
         MVC   MASKB,MASKA             PUT F0'S IN MASKB                04051090
         NC    MASKB,FIELDC            AND F0'S WITH INPUT              04052080
         CLC   MASKB,MASKA             IS MASK ALL NUMERIC              04053070
         BCR   7,R14                   NO-GO EXIT WITH CC^=0            04054060
         PACK  FIELDC,FIELDC           FIRST PACKED, THEN               04055050
         CVB   R7,FIELDC               IN BINARY (PAGE NUM)             04056040
         TM    *,X'00'                 SET CC=0                         04057030
         BR    R14                     RETURN TO CALLER                 04058020
****     EXECUTED INSTRUCTION                                           04059010
MOVEBC   MVC   0(*-*,R7),INDATA                                         04060000
*.4******************************************************************** 04060990
*                                                                       04061980
* SUBROUTINE NAME -       *----------------*                            04062970
*                         *    CONVZER     *                            04063960
*                         *----------------*                            04064950
*                                                                       04065940
* FUNCTION -                                                            04066930
*                                                                       04067920
*        CONVERT BINARY NUMBERS TO PRINTABLE FORMAT, STORE IN           04068910
*        DESIGNATED OUTPUT AREA, AND REMOVE LEADING ZEROES.             04069900
*                                                                       04070890
* INPUT REGISTERS -                                                     04071880
*                                                                       04072870
*        R7  - NUMBER TO BE CONVERTED                                   04073860
*                                                                       04074850
* OUTPUT REGISTERS -                                                    04075840
*                                                                       04076830
*        R6  - OUTPUT AREA                                              04077820
*                                                                       04078810
* LOCAL REGISTER USAGE -                                                04079800
*                                                                       04080790
*        R1  - WORK                                                     04081780
*        R2  - WORK                                                     04082770
*                                                                       04083760
*.$******************************************************************** 04084750
         SPACE ,                                                        04085740
CONVZER  EQU   *                                                        04086730
         CVD   R7,FIELDA           CONVERT INPUT NUMBER TO DEC          04087720
         OI    FIELDA+7,X'0F'      CONVERT SIGN BYTE                    04088710
         UNPK  0(8,R6),FIELDA+3(5) UNPACK TO OUTPUT AREA                04089700
         TRT   0(8,R6),TRTZEROS-X'F0' FIND FIRST NON ZERO BYTE          04090690
         BZ    CONVZER1            BRANCH IF ALL ZEROS                  04091680
         SR    R1,R6               DISPLACEMENT TO NON ZERO BY          04092670
         BCTR  R1,0                DECR FOR EXECUTE                     04093660
         EX    R1,MVCBLNKS         MOVE BLANKS TO LEADING 0'S           04094650
         BR    R14                 RETURN                               04095640
CONVZER1 MVC   0(8,R6),BLANKS8     SET UP THE OUTPUT                    04096630
         MVI   7(R6),X'F0'         SO ONE ZERO WILL PRINT               04097620
         BR    R14                                                      04098610
MVCBLNKS MVC   0(*-*,R6),BLANKS8                                        04099600
*.4******************************************************************** 04100590
*                                                                       04101580
* SUBROUTINE NAME -       *----------------*                            04102570
*                         *    DFOADSET    *                            04103560
*                         *----------------*                            04104550
*                                                                       04105540
* FUNCTION -                                                            04106530
*                                                                       04107520
*        SCANS DFOTABLE UNTIL MATCHING DEVICE TYPE IS FOUND.  PUTS      04108510
*        ADDRESS OF THAT ENTRY INTO ADFOTYPE, SETTING THE ADDRESS OF    04109500
*        THE DEVICE/FORMAT TABLE ENTRY.  FIELD 'TYPE' CONTAINS THE      04110490
*        DEVICE TYPE.                                                   04111480
*                                                                       04112470
* INPUT REGISTERS -                                                     04113460
*                                                                       04114450
*        R7  - RIGHT-MOST BYTE CONTAINS SPECIAL REQUEST (FOR POSSIBLE   04115440
*              SPECIFICATION SEE DESCRIPTION IN DSECT DFODATA).  BYTES  04116430
*              0-3 MUST BE SET TO ZERO.                                 04117420
*                                                                       04118410
* OUTPUT REGISTERS -                                                    04119400
*                                                                       04120390
*        R6  - POINTS TO ENTRY OF DEVICE DATA/FORMAT PROCEDURE TABLE.   04121380
*              ADFOTYPE CONTAINS POINTER TO DEVICE/FORMAT ENTRY.        04122370
*        R7  - THIS VALUE IS CHANGED                                    04123360
*                                                                       04124350
*.$******************************************************************** 04125340
         SPACE ,                                                        04126330
DFOADSET DS    0H                                                       04127320
         L     R6,=A(DFOTABLE) ADDR OF DEVICE/FORMAT DATA TABLE         04128310
         USING DFODATA,R6                                               04129300
         SPACE ,                                                        04130290
DFOADLP1 EQU   *                                                        04131280
         TM    DFOENDFL,DFOTBEND   END OF TABLE ?                       04132270
         BO    DFOADS10       YES, TAKE LAST TABLE ENTRY                04133260
         CLC   TYPE,DFOTYPE   TYPE FOUND IN TABLE ?                     04134250
         BNE   DFOADL05       NO, KEEP LOOKING                          04135240
         LTR   R7,R7          SPECIAL REQUEST ?                         04136230
         BZ    DFOADS10       NO, THEN TAKE STANDARD ENTRY              04137220
         EX    R7,DFOADFL     SPECIAL REQUEST ENTRY FOUND ?             04138210
         BO    DFOADS10       YES, TAKE THIS ONE                        04139200
DFOADL05 EQU   *                                                        04140190
         LA    R6,DFOTELEN(,R6) POINT TO NEXT ENTRY IN TABLE            04141180
         B     DFOADLP1       TRY AGAIN                                 04142170
         SPACE ,                                                        04143160
DFOADS10 EQU   *                                                        04144150
         ST    R6,ADFOTYPE    SAVE ENTRY ADDRESS                        04145140
         SPACE ,                                                        04146130
DFOADSEX EQU   *                                                        04147120
         BR    R14            BACK TO CALLER                            04148110
DFOADFL  TM    DFOENDFL,*-*   CHECK FOR SPECIAL REQUEST                 04149100
         DROP  R6                                                       04150090
*.4******************************************************************** 04151080
*                                                                       04152070
* SUBROUTINE NAME -       *----------------*                            04153060
*                         *    UPHDREC     *                            04154050
*                         *----------------*                            04155040
*                                                                       04156030
* FUNCTION -                                                            04157020
*                                                                       04158010
*        UPDATES THE RECORD NUMBERS AND HEAD NUMBERS IN CCW DATA.       04159000
*        RECORDS AND HEADS ARE UPDATED ACCORDING TO THE DATA FOUND IN   04159990
*        DEVICE/FORMAT TABLE ENTRY.  ON ENTRY, ADFOTYPE POINTS TO ENTRY 04160980
*        IN DEVICE/FORMAT TABLE.                                        04161970
*                                                                       04162960
* OUTPUT REGISTERS -                                                    04163950
*                                                                       04164940
*        R4,R5,R7  - CHANGED                                            04165930
*        R6  - POINTS TO ENTRY OF DEVICE DATA/FORMAT PROCEDURE TABLE    04166920
*                                                                       04167910
*.$******************************************************************** 04168900
         SPACE ,                                                        04169890
UPHDREC  DS    0H                                                       04170880
         L     R6,ADFOTYPE    GET DEV/FORM. ENTRY ADDRESS               04171870
         USING DFODATA,R6                                               04172860
         L     R4,DFO1REC     POINT TO FIRST CCW DATA TO BE UPD         04173850
         LH    R7,DFONRECS    LOOP CNT. # OF CCW DATA TO BE UPD         04174840
         SPACE ,                                                        04175830
UPHDRL1  EQU   *                                                        04176820
         SPACE ,                                                        04177810
*    UPDATE RECORD NUMBER                                               04178800
         SR    R5,R5          PREPARE FOR OLD RECORD NUMBER             04179790
         IC    R5,D4(,R4)     GET RECORD NUMBER (FORM IS CCHHR)         04180780
         AH    R5,DFORPPAS    ADD NUMBER OF RECORDS/PASS(PAGES)         04181770
         STC   R5,D4(,R4)     STORE UPDATED VALUE BACK                  04182760
         SPACE ,                                                        04183750
*    UPDATE HEAD NUMBER                                                 04184740
         LH    R5,D2(,R4)     LOAD HH PORTION OF OLD CCHHR              04185730
         AH    R5,DFOTRPAS    ADD NUMBER OF TRACKS/PASS                 04186720
         STH   R5,D2(,R4)     STORE UPDATED VALUE BACK                  04187710
         SPACE ,                                                        04188700
         LA    R4,NXTREC(,R4) UPDATE R4 TO POINT TO NEXT CCHHR          04189690
         BCT   R7,UPHDRL1     LOOP BACK  MORE TIMES                     04190680
         SPACE ,                                                        04191670
         BR    R14            GO BACK TO CALLER                         04192660
         DROP  R6                                                       04193650
*.4******************************************************************** 04194640
*                                                                       04195630
* SUBROUTINE NAME -       *----------------*                            04196620
*                         *    SENSIT      *                            04197610
*                         *    SENSIT2     *                            04198600
*                         *----------------*                            04199590
*                                                                       04200580
* FUNCTION -                                                            04201570
*                                                                       04202560
*        ISSUE SENSE TO OBTAIN SENSE INFORMATION/ISSUE MESSAGE TO USER  04203550
*        INCORPORATING THE SENSE BYTES AND FAILING CCHHR/BLOCK.         04204540
*                                                                       04205530
* LOCAL REGISTER USAGE -                                                04206520
*                                                                       04207510
*        R1  - SENSE CCW ADDRESS                                        04208500
*        R4  - WORK/MESSAGE ADDRESS                                     04209490
*        R5  - DEVICE ADDRESS                                           04210480
*        R14 - LINKAGE                                                  04211470
*                                                                       04212460
* OPERATION -                                                           04213450
*                                                                       04214440
*        SENSIT:                                                        04215430
*        1. CLEAR DEVICE STATUS AND ISSUE SENSE.  SAVE SENSE BYTES AND  04216420
*           RETURN TO CALLER.                                           04217410
*                                                                       04218400
*        SENSIT2:                                                       04219390
*        1. SET UP THE ERROR MESSAGE INCORPORATING THE CCHHR/BLOCK      04220380
*           NUMBER AND THE SENSE BYTES (EITHER 6 OR 24 BYTES).          04221370
*        2. PRINT THE MESSAGE AND RETURN.                               04222360
*                                                                       04223350
*.$******************************************************************** 04224340
         SPACE ,                                                        04225330
*---------------------------------------------------------------------- 04226320
*        CLEAR DEVICE STATUS AND ISSUE THE SENSE TO THE DEVICE.  WHEN   04227310
*        DEVICE IS READY WITH THE SENSE INFO, SAVE THE CSW AND RETURN   04228300
*        TO THE CALLER.                                                 04229290
*---------------------------------------------------------------------- 04230280
         SPACE ,                                                        04231270
SENSIT   LA    R1,CCWSENSE    ADDRESS OF SENSE CCW INTO R1              04232260
         XC    SENSE,SENSE    CLEAR SENSE AREA                          04233250
         MVC   SAVEIT(20),IOOPSW SAVE CSW,CAW,AND IO OLD PSW            04234240
         ST    R1,CAW         PUT ADDRESS OF CCW INTO CAW               04235230
SENSTIO  TIO   0(R5)          CLEAR STATUS                              04236220
         BC    2,*-4          LOOP IF BUSY                              04237210
         BC    4,SENSDE       IF CC=1, GO CHECK FOR DE                  04238200
SENSSIO  BAL   R14,STRTIO1    START DEVICE                              04239190
         TIO   0(R5)          DEVICE DONE?                              04240180
         BC    2,*-4          LOOP IF BUSY                              04241170
         MVC   SENSTA(8),CSW  SAVE CSW                                  04242160
         MVC   IOOPSW(20),SAVEIT RESTORE CSW,CAW,AND IO OLD PSW         04243150
         BR    R7             GO-WHENCE CAME YOU-                       04244140
SENSDE   TM    CSW+4,DE       DEVICE END                                04245130
         BO    SENSSIO        YES, GO DO SIO                            04246120
         B     SENSTIO                                                  04247110
*---------------------------------------------------------------------- 04248100
*        SENSIT2 IS CALLED TO PRINT THE SENSE AND CCHH ERROR INFO       04249090
*        WITHIN AN ERROR MESSAGE.                                       04250080
*---------------------------------------------------------------------- 04251070
         SPACE ,                                                        04252060
SENSIT2  DS    0H                                                       04253050
         MVC   SAVEIT(L20),IOOPSW  SAVE CSW,CAW AND IO OLD PSW          04254040
         MVC   IOERR+25(5),=C'CCHHR'  SET UP FOR CKD MESSAGE            04255030
         SPACE ,                                                        04256020
*---------------------------------------------------------------------- 04257010
*        ISSUE THE MESSAGE 'IO ERROR XXX CCHHR = XXXXXXXXXX SENSE = XXX 04258000
*        XXXXXXXXX'.  IF MORE THAN SIX SENSE BYTES, THEN PUT THE 18     04258990
*        EXTRA SENSE BYTES INTO THE ERROR MESSAGE AND PRINT THE SECOND  04259980
*        LINE OF THE ERROR MESSAGE TO INCLUDE THESE SENSE BYTES.        04260970
*---------------------------------------------------------------------- 04261960
         SPACE ,                                                        04262950
MSGLNK   EQU   *                                                        04263940
         UNPK  WORK+12(11),CCHHR(6) CHANGE CCHHR DATA TO ZONED          04264930
         TR    WORK(22),TTAB-240 TRANSLATE TO PRINTABLE CHAR            04265920
         MVC   IOERR+33(10),WORK+12 PUT CCHHR INTO THE MSG              04266910
MSGLNK1  EQU   *                                                        04267900
         LA    R4,IOERR       ADDRESS OF ERROR MESSAGE INTO R4          04268890
         BAL   R14,WMSG       WRITE MESSAGE                             04269880
         SPACE ,                                                        04270870
*---------------------------------------------------------------------- 04271860
* PUT SENSE DATA INTO MESSAGE.  FIRST ENSURE ALL ZONE BITS ARE ON, THEN 04272850
* CALCULATE NUMBER OF SENSE BYTES AND NUMBER OF BLANKS, SET UP DATA     04273840
* AREA POINTERS, AND WRITE THE MESSAGE.                                 04274830
*---------------------------------------------------------------------- 04275820
         SPACE ,                                                        04276810
         STM   R0,R3,PCREGS   SAVE REGISTERS FOR NOW                    04277800
         OI    IOERR2+7,X'F0' ENSURE ALL ZONE BITS ARE ON               04278790
         OC    IOERR2+8(63),IOERR2+7 ...                                04279780
         LA    R1,L'SENSE     MAXIMUM NUMBER OF SENSE BYTES             04280770
         LH    R2,SENSTA+6    RESIDUAL COUNT, BYTES TO BLANK            04281760
         SR    R1,R2          RESULT IS NUMBER OF SENSE BYTES           04282750
         LA    R3,SENSE       POINT TO SENSE DATA                       04283740
         LA    R4,IOERR2+7    START OF SENSE DATA IN MESSAGE            04284730
         BAL   R14,UNPKLOOP   UNPACK SUBROUTINE DOES THE WORK           04285720
         LM    R0,R3,PCREGS   RESTORE THE REGISTERS                     04286710
         LA    R4,IOERR2      ADDRESS OF 2ND LINE OF ERROR MSG          04287700
         BAL   R14,WMSG       WRITE MESSAGE                             04288690
         SPACE ,                                                        04289680
SENSIT3  DS    0H             RESTORE INFO AND RETURN                   04290670
         MVC   IOOPSW(20),SAVEIT  RESTORE CSW, CAW, I/O PSW             04291660
         BR    R7             RETURN TO CALLER                          04292650
*.4******************************************************************** 04293640
*                                                                       04294630
* SUBROUTINE NAME -       *----------------*                            04295620
*                         *     FMT744     *                            04296610
*                         *----------------*                            04297600
*                                                                       04298590
* FUNCTION -                                                            04299580
*                                                                       04300570
*        DISPLAY MESSAGE 744 AFTER SENSE ID FAILURE.  DASD CONTROL      04301560
*        UNIT IS IN DEEP TROUBLE IF IT CANNOT DO A SENSE ID, SO         04302550
*        DISPLAY THE MESSAGE AND TREAT LIKE FATAL I/O ERROR.            04303540
*                                                                       04304530
* LOCAL REGISTER USAGE -                                                04305520
*                                                                       04306510
*        R14  - LINKAGE                                                 04307500
*        R1-R5 ARE WORK REGISTERS.                                      04308490
*                                                                       04309480
* OPERATION -                                                           04310470
*                                                                       04311460
*        1. SAVE INPUT ENVIRONMENT.                                     04312450
*        2. INSERT DEVICE ADDRESS AND CSW DATA INTO THE MESSAGE.        04313440
*        3. SEND THE MESSAGE, RESTORE THE ENVIRONMENT, AND EXIT.        04314430
*                                                                       04315420
*.$******************************************************************** 04316410
         SPACE ,                                                        04317400
FMT744   DS    0H             DISPLAY ERROR MESSAGE 744                 04318390
         STM   R0,R15,PCREGS  SAVE REGISTERS                            04319380
         MVC   SAVEIT(20),IOOPSW  SAVE CSW, CAW, I/O OLD PSW            04320370
         SPACE ,                                                        04321360
*---------------------------------------------------------------------- 04322350
* INSERT DEVICE ADDRESS IN MESSAGE.                                     04323340
*---------------------------------------------------------------------- 04324330
         SPACE ,                                                        04325320
         LA    R1,2           NUMBER OF BYTES TO TRANSLATE              04326310
         SR    R2,R2          NUMBER OF BYTES TO BLANK-FILL             04327300
         STH   R5,WORK        STORE DEVICE ADDRESS                      04328290
         LA    R3,WORK        SOURCE DATA POINTER                       04329280
         LA    R4,MSG744+21   DESTINATION POINTER                       04330270
         BAL   R14,UNPKLOOP   PUT DEVICE ADDRESS IN MESSAGE             04331260
         MVI   MSG744+21,C' ' BLANK OUT LEADING ZERO                    04332250
         SPACE ,                                                        04333240
*---------------------------------------------------------------------- 04334230
* INSERT CSW IN MESSAGE.                                                04335220
*---------------------------------------------------------------------- 04336210
         SPACE ,                                                        04337200
         LA    R1,8           SOURCE DATA LENGTH                        04338190
         LA    R3,CSW         SOURCE DATA ADDRESS                       04339180
         LA    R4,MSG744+42   DESTINATION DATA ADDRESS                  04340170
         BAL   R14,UNPKLOOP   GO TRANSLATE DATA                         04341160
         SPACE ,                                                        04342150
         LA    R4,MSG744      POINT TO MESSAGE                          04343140
         BAL   R14,WMSG       GO SEND IT                                04344130
         MVC   IOOPSW(20),SAVEIT  RESTORE CAW, CSW, I/O PSW             04345120
         LM    R0,R15,PCREGS  RESTORE REGISTERS                         04346110
         B     GETCARD        GO START OVER                             04347100
*.4******************************************************************** 04348090
*                                                                       04349080
* SUBROUTINE NAME -       *----------------*                            04350070
*                         *    UNPKLOOP    *                            04351060
*                         *----------------*                            04352050
*                                                                       04353040
* FUNCTION -                                                            04354030
*                                                                       04355020
*        UNPACK AND TRANSLATE DATA, AND BLANK-FILL TO RIGHT BOUNDARY.   04356010
*                                                                       04357000
* INPUT REGISTERS -                                                     04357990
*                                                                       04358980
*        R1  - NUMBER OF BYTES TO TRANSLATE                             04359970
*        R2  - NUMBER OF BYTES TO BLANK-FILL                            04360960
*        R3  - SOURCE DATA POINTER                                      04361950
*        R4  - DESTINATION DATA POINTER                                 04362940
*                                                                       04363930
* LOCAL REGISTER USAGE -                                                04364920
*                                                                       04365910
*        R0 IS A WORK REGISTER.                                         04366900
*                                                                       04367890
* OPERATION -                                                           04368880
*                                                                       04369870
*        1. UNPACK AND TRANSLATE DATA.                                  04370860
*        2. BLANK-FILL TO RIGHT BOUNDARY.                               04371850
*                                                                       04372840
*.$******************************************************************** 04373830
         SPACE ,                                                        04374820
UNPKLOOP DS    0H             TRANSLATE DATA                            04375810
         IC    R0,0(R3)       MOVE IN FIRST HALF OF BYTE                04376800
         SRL   R0,4           ...                                       04377790
         STC   R0,0(R4)       ...                                       04378780
         OI    0(R4),X'F0'    ...                                       04379770
         MVN   1(1,R4),0(R3)  MOVE IN SECOND HALF OF BYTE               04380760
         TR    0(2,R4),TTAB-240  TRANSLATE BOTH TO EBCDIC               04381750
         SPACE ,                                                        04382740
*---------------------------------------------------------------------- 04383730
* UPDATE DATA POINTERS, CHECK FOR TRANSLATE BYTES DONE.                 04384720
*---------------------------------------------------------------------- 04385710
         SPACE ,                                                        04386700
         LA    R3,1(R3)       POINT TO NEXT SOURCE BYTE                 04387690
         LA    R4,2(R4)       POINT TO NEXT DESTINATION BYTE            04388680
         BCT   R1,UNPKLOOP    LOOP IF MORE SOURCE DATA                  04389670
         SPACE ,                                                        04390660
*---------------------------------------------------------------------- 04391650
* BLANK-FILL TWO BYTES FOR EACH ONE IN R2, IF ANY.                      04392640
*---------------------------------------------------------------------- 04393630
         SPACE ,                                                        04394620
         LTR   R2,R2          ANY BYTES LEFT?                           04395610
         BZ    BLNKDONE       NO, JUST RETURN TO CALLER                 04396600
BLNKLOOP DS    0H                                                       04397590
         MVC   0(2,R4),=C'  ' MOVE IN TWO BLANKS                        04398580
         LA    R4,2(R4)       POINT TO NEXT DIGIT                       04399570
         BCT   R2,BLNKLOOP    LOOP IF MORE TO DO                        04400560
BLNKDONE DS    0H             ALL DONE, EXIT                            04401550
         BR    R14            RETURN TO CALLER                          04402540
*.4******************************************************************** 04403530
*                                                                       04404520
* SUBROUTINE NAME -       *----------------*                            04405510
*                         *    CORRCSW     *                            04406500
*                         *----------------*                            04407490
*                                                                       04408480
* FUNCTION -                                                            04409470
*                                                                       04410460
*        TO CALL THIS ROUTINE WE HAVE AN IMPRECISE ENDING CONDITION     04411450
*        WHICH INDICATES THAT THE CSW DOES NOT CORRECTLY REFLECT THE    04412440
*        FAILING CCW.  THIS ROUTINE WILL CORRECT THE CSW.  ONCE WE      04413430
*        ARE DONE CORRECTING THE CSW, TURN OFF THE IMPRECISE ENDING     04414420
*        CONDITION IN THE SENSE BYTES.  THE USER HAS NO NEED TO KNOW    04415410
*        THIS CONDITION EVER EXISTED SINCE WE HAVE CORRECTED THE CSW.   04416400
*                                                                       04417390
* OPERATION -                                                           04418380
*                                                                       04419370
*        1. SCAN CCW STRING FOR A LOCATE RECORD CCW AND SAVE THIS       04420360
*           ADDRESS.                                                    04421350
*        2. CALCULATE # OF RECORDS READ =                               04422340
*           (# RECS FROM LOC REC DATA ) - RESIDUAL CNT IN SENSE BYTE3)  04423330
*        3. FAILING CCW =                                               04424320
*           (# REC READ) + (LOC REC ADDR) + 8                           04425310
*           (ADD 8 TO CORRECT FOR CONTROL UNIT POINTER)                 04426300
*                                                                       04427290
*.$******************************************************************** 04428280
         SPACE ,                                                        04429270
CORRCSW  DS    0H                                                       04430260
         STM   R14,R10,STRTSAVE SAVE REGISTERS                          04431250
         L     R3,CSW         GET THE CSW                               04432240
         LA    R3,0(,R3)      CLEAR THE KEYS OUT                        04433230
         L     R4,CAW         GET THE CAW                               04434220
         LA    R4,0(,R4)      CLEAR KEYS OUT                            04435210
FINDLR   DS    0H                                                       04436200
         CLI   0(R4),TIC      BY CHANCE THIS A TIC CCW?                 04437190
         BE    TICHK          GO SEE WHERE IT GOES                      04438180
         CLI   0(R4),LOCREC   THIS A LOC REC CCW?                       04439170
         BNE   GTNXT          NO, GET THE NEXT CCW                      04440160
         ST    R4,SAVLOCR     SAVE THIS LOC REC IN CASE NXT             04441150
*                             ..ONE PASS THE FAILING CCW                04442140
GTNXT    DS    0H                                                       04443130
         CR    R4,R3          ARE WE PASSED THE FAILING CCW?            04444120
         BH    GTLOCREC       YES,GO GET LOC REC DATA                   04445110
         LA    R4,8(,R4)      GET NEXT CCW                              04446100
         B     FINDLR         CONTINUE TO FIND LOC REC CCW              04447090
         SPACE ,                                                        04448080
TICHK    DS    0H                                                       04449070
         CLM   R4,B'0111',D1(R4) TIC BACKWARD OR FORWARD?               04450060
         BNL   GTNXT          TICS BACKWARD, IGNORE IT                  04451050
         L     R4,0(,R4)      GET TIC TO ADDRESS                        04452040
         LA    R4,0(,R4)      CLEAR OP CODE                             04453030
         B     FINDLR         CONTINUE TO FIND LOC REC CCW              04454020
GTLOCREC DS    0H                                                       04455010
         L     R4,SAVLOCR     RETRIEVE LAST LOC REC CCW ADDR            04456000
         L     R5,0(,R4)      PICK UP LOC REC DATA ADDRESS              04456990
         LA    R5,0(,R5)      CLEAR THE OP CODE FROM ADDRESS            04457980
         SR    R2,R2          CLEAR WORK REG                            04458970
         IC    R2,D3(,R5)     PICK UP THE RECORD COUNT                  04459960
         SR    R5,R5          CLEAR WORK REGISTER                       04460950
         IC    R5,SENSEB3     GET THE RESIDUAL COUNT                    04461940
         SR    R2,R5          REC CNT - RES CNT = # OF REC READ         04462930
         LA    R2,2(,R2)      ADD CORRECTION FACTOR                     04463920
         SLL   R2,3           GET REC CNT IN BYTES                      04464910
         AR    R2,R4          R2= ADDR OF FAILING CCW                   04465900
         STCM  R2,B'0111',CSW+1 CORRECT THE CSW                         04466890
         NI    SENSEB2,X'FF'-IMPREND CLEAR IMPRECISE END COND.          04467880
         LM    R14,R10,STRTSAVE RESTORE REGISTERS                       04468870
         BR    R6             RETURN TO CALLER                          04469860
*.4******************************************************************** 04470850
*                                                                       04471840
* SUBROUTINE NAME -       *----------------*                            04472830
*                         *    STRTIO      *                            04473820
*                         *    STRTIO1     *                            04474810
*                         *----------------*                            04475800
*                                                                       04476790
* FUNCTION -                                                            04477780
*                                                                       04478770
*        START A DEVICE AND TRAP THE FAILING DIRECTOR CONDITION.        04479760
*        THE OUTPUT IS THE CONDITION CODE FROM THE START I/O.           04480750
*        ALL REGISTERS EXCEPT R11-R13 ARE SAVED.  CSW, SENSE, AND CAW   04481740
*        ARE SAVED WHEN SENSE IS DONE.                                  04482730
*                                                                       04483720
* INPUT REGISTERS -                                                     04484710
*                                                                       04485700
*        R5  - ADDRESS OF DEVICE                                        04486690
*                                                                       04487680
* LOCAL REGISTER USAGE -                                                04488670
*                                                                       04489660
*        R3  - SAVE ADDRESS FOR POSSIBLE RESTART                        04490650
*                                                                       04491640
* OPERATION -                                                           04492630
*                                                                       04493620
*        1. CHECK FOR ERROR, IF ERROR SAVE ADDRESS FOR RESTART          04494610
*        2. START DEVICE                                                04495600
*        3. OBTAIN RESTART CCW CHAIN IF ERROR OCCURS                    04496590
*        4. RECALIBRATE FAILING DEVICE                                  04497580
*        5. ERROR RESET                                                 04498570
*                                                                       04499560
*.$******************************************************************** 04500550
         SPACE ,                                                        04501540
*---------------------------------------------------------------------- 04502530
*        HERE, SIO IS ISSUED WITHOUT THE NEED TO CLEAR DEVICE STATUS    04503520
*        WITH A TIO.  FOR CC0 OR CC3, RETURN TO CALLER.                 04504510
*---------------------------------------------------------------------- 04505500
         SPACE ,                                                        04506490
STRTIO1  EQU   *              START I/O WITHOUT TIO                     04507480
         STM   R14,R10,STRTSAVE SAVE REGS.                              04508470
         XC    EDPERCNT,EDPERCNT ZERO EDP RETRY COUNTER                 04509460
         LA    R3,RESTRT1     SAVE ADDR. FOR POSSIBLE RESTART           04510450
RESTRT1  SIO   0(R5)          START THE DEVICE                          04511440
         BC    BSY,*-4        SPIN ON CHANNEL BUSY                      04512430
         BC    CSWCDE,CSWSTRD IF CSW WAS STORED GO CHECK IT OUT         04513420
         B     STRTRET        CALLER HANDLES ANY OTHER COND.            04514410
         SPACE ,                                                        04515400
*---------------------------------------------------------------------- 04516390
*        STRTIO IS CALLED TO EITHER ISSUE A SENSE OR READ A LABEL FROM  04517380
*        A DEVICE.  THIS IS PRECEDED BY A TIO TO CLEAR DEVICE STATUS    04518370
*        FIRST.  START I/O TO THE DEVICE.  FOR CC0 OR CC3, RETURN TO    04519360
*        THE CALLER.                                                    04520350
*---------------------------------------------------------------------- 04521340
         SPACE ,                                                        04522330
STRTIO   EQU   *              START I/O WITH TIO                        04523320
         STM   R14,R10,STRTSAVE SAVE REGS.                              04524310
         TIO   0(R5)          CLEAR STATUS OF DEVICE                    04525300
         BC    BSY,*-4        IF NOT CLEAR TRY AGAIN                    04526290
         XC    EDPERCNT,EDPERCNT ZERO EDP RETRY COUNTER                 04527280
         LA    R3,RESTRTIO    ADDRESS FOR POSSIBLE RESTART              04528270
RESTRTIO EQU   *                                                        04529260
         SIO   0(R5)          START THE DEVICE                          04530250
         BC    BSY,*-4        SPIN ON CHANNEL BUSY                      04531240
         BC    CSWCDE,CKCSW1  IF CSW WAS STORED, GO CHECK               04532230
         TIO   0(R5)          LET DEVICE FINISH                         04533220
         BC    BSY,*-4        IF BUSY KEEP TRYING                       04534210
STRTRET  EQU   *                                                        04535200
         LM    R14,R10,STRTSAVE RELOAD REGS.                            04536190
         BR    R14            RETURN TO CALLER                          04537180
         SPACE ,                                                        04538170
*---------------------------------------------------------------------- 04539160
*        FOR CC1 FROM THE SIO, CHECK THE CSW STATUS.  CSWSTRD IS CALLED 04540150
*        FROM STRTIO1.  FOR DEVICE BUSY, RE-ISSUE SIO.                  04541140
*---------------------------------------------------------------------- 04542130
         SPACE ,                                                        04543120
CKCSW1   BALR  R6,0           SAVE CONDITION CODE                       04544110
         TM    CSW+4,BUSY     WAS DEVICE BUSY?                          04545100
         BO    RESTRTIO       YES, RESTART I/O                          04546090
         B     NOTBUSY        NO, CHECK FOR 3380                        04547080
         SPACE ,                                                        04548070
CSWSTRD  EQU   *                                                        04549060
         BALR  R6,0           SAVE CONDITION CODE                       04550050
NOTBUSY  EQU   *                                                        04551040
         TM    CSW+4,CUBSY+CUEND CONTROL UNIT BUSY OR END?              04552030
         BNZR  R3             YES, TRY SIO AGAIN.                       04553020
         CLI   TYPE,TYP3380   IS DEVICE A 3380 DEVICE                   04554010
         BNE   SETCCRET       NO, DON'T WORRY ABOUT FAILING DM          04555000
         SPACE ,                                                        04555990
*---------------------------------------------------------------------- 04556980
*        FOR 3380 - CHECK FOR FAILING DIRECTOR MODULE.  FOR A           04557970
*        UNIT CHECK ISSUE A SENSE TO THE FAILING DIRECTOR.  IF THE      04558960
*        SENSE INDICATES THAT THE DIRECTOR MODULE FAILED, THEN GO ISSUE 04559950
*        MESSAGE.  ELSE, RESTORE SENSE INFORMATION AND RETURN.          04560940
*---------------------------------------------------------------------- 04561930
         SPACE ,                                                        04562920
CKFLD    EQU   *                                                        04563910
         TM    UNSTAT,UC      WAS THIS UNIT CHECK?                      04564900
         BNO   SETCCRET       NO, GO REFLECT TO USER                    04565890
         MVC   STRTSVSN,SENSE SAVE THE OLD SENSE                        04566880
         LA    R2,CCWSENSE    ADDRESS OF SENSE CCW IN REG               04567870
         XC    SENSE,SENSE    CLEAR SENSE AREA                          04568860
         MVC   STRTSVIO,IOOPSW SAVE CAW,CSW AND IO OLD PSW              04569850
         ST    R2,CAW         STORE CAW                                 04570840
         SIO   0(R5)          SENSE FOR FAILING DIRECTOR                04571830
         TIO   0(R5)          WAIT FOR DEVICE TO FINISH                 04572820
         BC    BSY,*-4        STILL BUSY, KEEP TRYING                   04573810
         MVC   IOOPSW(LSAVE),STRTSVIO REST. CAW,CSW AND IOOLD           04574800
         SPACE ,                                                        04575790
*---------------------------------------------------------------------- 04576780
*        HANDLE ENVIRONMENTAL DATA PRESENT ON START I/O                 04577770
*                                                                       04578760
*           IF THERE IS NO EDP IN SENSE                                 04579750
*              THEN EXIT THIS ROUTINE                                   04580740
*           IF THIS IS FIRST EDP                                        04581730
*              THEN MOVE SENSE DATA TO SPECIAL SAVE AREA                04582720
*           IF EDP RETRY COUNT >= 255                                   04583710
*              THEN RESTORE SENSE FROM SPECIAL SAVE AREA                04584700
*                   ISSUE MESSAGE 736                                   04585690
*                   GO TO FATAL ROUTINE                                 04586680
*           INCREMENT EDP RETRY COUNT                                   04587670
*           RESTORE DEVICE ADDRESS AND RETURN TO SIO ROUTINE            04588660
*---------------------------------------------------------------------- 04589650
         SPACE ,                                                        04590640
         TM    SENSEB2,ENVDATA IF SENSE BYTE 2 DOES NOT HAVE            04591630
         BZ    EQCHKRTN           EDP THEN EXIT THIS ROUTINE            04592620
*                                 AND CHECK FOR EQUIPMENT CHECK         04593610
         LH    R4,EDPERCNT    LOAD AND CHECK EDP COUNT                  04594600
         LTR   R4,R4          IS THIS FIRST EDP?                        04595590
         BNZ   CKEDPLMT       NO, GO CHECK EDP LIMIT                    04596580
         MVC   EDPSENSE,SENSE MOVE SENSE TO SAVE AREA                   04597570
         SPACE ,                                                        04598560
CKEDPLMT DS    0H                                                       04599550
         CLC   EDPERCNT,EDPLIMIT IS RETRY COUNT >= 255?                 04600540
         BNL   EDPFATAL       YES, FATAL, TAKE ACTION                   04601530
         LA    R4,1(R4)       INCREMENT EDP RETRY COUNT                 04602520
         STH   R4,EDPERCNT    REPLACE EDP ERROR COUNT                   04603510
         L     R5,STRTSAVE+D28 RESTORE DEVICE ADDRESS                   04604500
         BR    R3             RETURN TO SIO ROUTINE                     04605490
         SPACE ,                                                        04606480
EDPFATAL DS    0H             FATAL CONDITIONS EXIST                    04607470
         MVC   SENSE,EDPSENSE RESTORE SENSE                             04608460
         BAL   R7,SENSIT2     PRT SENSE AND CCHH MESSAGE                04609450
         B     FATAL          GO TO FATAL AND ABORT                     04610440
         SPACE ,                                                        04611430
*---------------------------------------------------------------------- 04612420
*        MUST CHECK FOR EQUIPMENT CHECK AND FAILING DIRECTOR            04613410
*        IT IS NOT FAILING DIRECTOR UNLESS BOTH ARE ON                  04614400
*---------------------------------------------------------------------- 04615390
         SPACE ,                                                        04616380
EQCHKRTN DS    0H                                                       04617370
         TM    SENSE,EQCHK    ANY EQUIPMENT CHECK?                      04618360
         BZ    NOTEQCHK       NO EQUIPMENT CHECK, BRANCH                04619350
         TM    SENSEB1,FLNGDRCT WAS IT THE DIRECTOR MODULE ?            04620340
         BO    CSWMSG         YES, TELL USER WHAT HAPPENED              04621330
NOTEQCHK DS    0H             NO FAILING DIRECTOR                       04622320
         MVC   IOOPSW(LSAVE),STRTSVIO REST. CAW,CSW AND IO OLD          04623310
         MVC   SENSE,STRTSVSN RESTORE SENSE INFORMATION                 04624300
         B     SETCCRET       SET CC AND RETURN                         04625290
         SPACE ,                                                        04626280
*---------------------------------------------------------------------- 04627270
*        BYTE 1, BIT 3 INDICATES THAT A PERMANENT FAILURE OCCURRED IN   04628260
*        THE OTHER STORAGE DIRECTOR IN THE SAME 3880 OR WITH A STATE    04629250
*        SAVE OPERATION IN THE REPORTING STORAGE DIRECTOR.  BYTE 0,     04630240
*        BIT 3 INDICATES AN EQUIPMENT CHECK.  THESE TWO BITS COMBINED   04631230
*        INDICATE A PERMANENT FAILURE OF THE ALTERNATE STORAGE          04632220
*        DIRECTOR.                                                      04633210
*                                                                       04634200
*        FOR 3380 - ISSUE MESSAGE 'XXX REPORTS DISABLED INTERFACE;      04635190
*        FLT CODE = XXXX; NOTIFY CE' AND THEN GO RESTART THE I/O.       04636180
*                                                                       04637170
*                                                                       04638160
*     TRANSLATION PROCESS:                                              04639150
*                                                                       04640140
*      HEX DASD ADDRESS                  PRELIMINARY DASD ADDRESS       04641130
*     +----+----+----+        UNPK         +----+----+----+----+        04642120
*     | 01 | 9A | XX |        ----->       | F1 | F9 | FA | XX |        04643110
*     +----+----+----+                     +----+----+----+----+        04644100
*                                                                       04645090
*      HEX FAULT CODE          PRELIMINARY DASD ADDRESS AND FAULT CODE  04646080
*     +----+----+----+  UNPK  +----+----+----+----+----+----+----+----+ 04647070
*     | D6 | CB | XX | -----> | F1 | F9 | FA | FD | F6 | FC | FB | XX | 04648060
*     +----+----+----+        +----+----+----+----+----+----+----+----+ 04649050
*                                                                       04650040
*     PRELIMINARY DATA           EBCDIC DASD ADDRESS AND FAULT CODE     04651030
*     +----+----+----+  TR    +----+----+----+----+----+----+----+      04652020
*     |    |    |    | -----> | F1 | F9 | C1 | C4 | F6 | C3 | C2 |      04653010
*     +----+----+----+        +----+----+----+----+----+----+----+      04654000
*                              DASD ADDRESS  |    FAULT CODE            04654990
*                                                                       04655980
*---------------------------------------------------------------------- 04656970
         SPACE ,                                                        04657960
CSWMSG   EQU   *                                                        04658950
         UNPK  WORK(L4),DSKADD(L3) CONVERT DEVICE ADDRESS               04659940
         UNPK  WORK+D3(L5),FLTCDE(L3) CONVERT FAULT CODE                04660930
         TR    WORK(L7),TTAB-D240 ......                                04661920
         MVC   DRCTFAIL+D12(L3),WORK MOVE DEVICE ADDR INTO MSG          04662910
         MVC   DRCTFAIL+D55(L4),WORK+D3 MOVE FLT CODE INTO MSG          04663900
         LA    R4,DRCTFAIL    ADDRESS OF MESSAGE INTO R4                04664890
         BAL   R14,WMSG       GO WRITE THE MESSAGE                      04665880
         L     R5,STRTSAVE+D28 RESTORE THE DEVICE ADDRESS.              04666870
         MVC   IOOPSW(LSAVE),STRTSVIO REST. THE CSW,CAW, IOPSW          04667860
         MVC   SENSE,STRTSVSN RESTORE SENSE INFORMATION                 04668850
         BR    R3             GO RESTART THE IO                         04669840
         SPACE ,                                                        04670830
*---------------------------------------------------------------------- 04671820
*        RESTORE THE SIO CONDITION CODE AND THEN RETURN TO THE CALLER.  04672810
*---------------------------------------------------------------------- 04673800
         SPACE ,                                                        04674790
SETCCRET EQU   *                                                        04675780
         SPM   R6             SET CC FROM SIO                           04676770
         B     STRTRET        AND RETURN TO USER                        04677760
*.4******************************************************************** 04678750
*                                                                       04679740
* SUBROUTINE NAME -       *----------------*                            04680730
*                         *     ALTCHK     *                            04681720
*                         *----------------*                            04682710
*                                                                       04683700
* FUNCTION -                                                            04684690
*                                                                       04685680
*        CHECK POINTERS IN FLAGGED PRIMARY TRACK AND ALTERNATE TRACK    04686670
*        TO SEE THAT EACH POINTS TO THE OTHER AND RETURN THE CCHH       04687660
*        ADDRESS OF WHICHEVER WE ARE CURRENTLY NOT AT.                  04688650
*                                                                       04689640
* INPUT REGISTERS -                                                     04690630
*                                                                       04691620
*        R7  - RETURN ADDRESS                                           04692610
*                                                                       04693600
* OUTPUT REGISTERS -                                                    04694590
*                                                                       04695580
*        R0  - =0 IF CCHH IN R1 POINTS TO THE ASSIGNED ALTERNATE        04696570
*              =1 IF CCHH IN R1 POINTS TO THE DEFECTIVE PRIMARY         04697560
*        R1  - (-1) IF TRACKS DO NOT POINT TO EACH OTHER CORRECTLY,     04698550
*              OTHERWISE R1 = CCHH ADDRESS OF WHICHEVER OF THE TWO      04699540
*              TRACKS WE ARE NOT AT WHEN THE TRACK CONDITION CHECK      04700530
*              WAS DETECTED.                                            04701520
*                                                                       04702510
* LOCAL REGISTER USAGE -                                                04703500
*                                                                       04704490
*        R0  - TRACK USAGE BIT                                          04705480
*        R1  - WORK                                                     04706470
*        R6  - ADDRESSABILITY                                           04707460
*        R7  - LINKAGE                                                  04708450
*                                                                       04709440
* OPERATION -                                                           04710430
*                                                                       04711420
*        TWO I/O OPERATIONS HAVE TO BE SCHEDULED FROM HERE WHICH MEANS  04712410
*        THAT TWICE CONTROL WILL HAVE TO LEAVE THIS SUBROUTINE AND      04713400
*        COME BACK IN BEFORE WE CAN RETURN TO OUR CALLER.  THIS IS      04714390
*        ACCOMPLISHED BY GOING TO OP V (STIO) AFTER SETTING A FLAG THAT 04715380
*        THE I/O INTERRUPT HANDLER RECOGNIZES AS A SIGNAL TO RE-ENTER   04716370
*        THIS ROUTINE.  THE I/O HANDLER CHECKS FOR ERRORS BEFORE        04717360
*        CHECKING OUR FLAG, SO ERROR RECOVERY CAN BE TRIED ON OUR I/O   04718350
*        IF NECESSARY.                                                  04719340
*                                                                       04720330
*        1. GET THE CCHH ADDRESS OF THE TRACK WE ARE CURRENTLY ON.      04721320
*        2. READ THE HOME ADDRESS AND RECORD 0 OF THIS TRACK.           04722310
*        3. READ THE HOME ADDRESS AND RECORD 0 OF THE SECOND TRACK      04723300
*           (WHICH WOULD BE EITHER THE ALTERNATE TRACK OR THE DEFECTIVE 04724290
*           PRIMARY TRACK).                                             04725280
*        4. TEST THE TRACK USAGE BITS OF THIS TRACK.  IF NOT MIXED,     04726270
*           THEN EXIT.                                                  04727260
*        5. CHECK THE TRACK USAGE BITS TO VERIFY THAT ONE AND ONLY ONE  04728250
*           OF THE TRACKS IS AN ASSIGNED ALTERNATE.                     04729240
*        6. RETURN IN R1 THE CCHH OF THE SECOND TRACK AND RETURN IN R0  04730230
*           THE TRACK USAGE (ASSIGNED ALTERNATE OR DEFECTIVE PRIMARY).  04731220
*                                                                       04732210
*.$******************************************************************** 04733200
         SPACE ,                                                        04734190
*---------------------------------------------------------------------- 04735180
*        CALL THE SENSCCHH SUBROUTINE WHICH RETURNS IN R1 THE CCHH      04736170
*        ADDRESS OF THE TRACK WE ARE CURRENTLY ON.  THIS IS OBTAINED    04737160
*        FROM THE SENSE DATA READ AT THE TIME OF THE TRACK CONDITION    04738150
*        CHECK.                                                         04739140
*---------------------------------------------------------------------- 04740130
         SPACE ,                                                        04741120
ALTCHK   STM   R2,R7,ALTCHKSV                                           04742110
         BAL   R7,SENSCCHH    GET CCHH TO THE FLAGGED TRACK             04743100
         STCM  R1,15,CCHHR    SAVE CCHH FOR POSSIBLE CALL TO            04744090
*                             SENSIT2.                                  04745080
         MVI   CCHHR+4,X'00'  SET R OF CCHHR TO 0 FOR SENSIT2.          04746070
         ST    R1,CCHHSV      SAVE CURRENT TRK FOR COMPARISON           04747060
*                             WITH BACKWARD POINTER LATER               04748050
         STCM  R1,15,HAR0SKAD+2 STORE CCHH FOR SEEK CCW TO              04749040
*                             ACCESS                                    04750030
         SPACE ,                                                        04751020
*---------------------------------------------------------------------- 04752010
*        HAR0READ FLAG INDICATES TO THE DASD INTERRUPT HANDLER THAT     04753000
*        ALTERNATE TRACK RECOVERY IS IN PROGRESS AND THAT CONTROL IS TO 04753990
*        BE RETURNED TO THIS ROUTINE.  GO START THE CHANNEL PROGRAM TO  04754980
*        READ THE HOME ADDRESS AND RECORD 0 AND THEN RETURN TO ALTCHK2. 04755970
*---------------------------------------------------------------------- 04756960
         SPACE ,                                                        04757950
         LA    R1,READHAR0    ADDR OF CHNL PRG TO READ HA, R0.          04758940
         ST    R1,CAW         SET FOR SIO.                              04759930
         MVI   ALTFLAG,HAR0READ ALT TRK RECOVERY IN PROGRESS            04760920
         LA    R1,ALTCHK2     POINT TO GET CONTROL UPON                 04761910
*                             RETURN HERE AFTER I/O COMPLETES.          04762900
         ST    R1,CONTINAD    SAVE FOR INTERRUPT HANDLER.               04763890
         B     STIO2          START CHNL PRG TO READ HA, R0.            04764880
         SPACE ,                                                        04765870
*---------------------------------------------------------------------- 04766860
*        RETURN HERE AFTER READING HOME ADDRESS AND RECORD 0.           04767850
*        NOW ISSUE SIO TO SEEK TO CCHH READ FROM HOME ADDRESS ABOVE AND 04768840
*        READ NEXT HOME ADDRESS AND RECORD 0.  CONTROL RETURNS HERE     04769830
*        TO ALTCHK3.                                                    04770820
*---------------------------------------------------------------------- 04771810
         SPACE ,                                                        04772800
         USING ALTCHK2,R6                                               04773790
ALTCHK2  MVC   HAFLAGSV(L1),HADATA SAVE FLAG BYTE FROM HA.              04774780
         MVC   HAR0SKAD+2(L4),R0DATA USE CCHH POINTER TO OTHER          04775770
*                                    TRK AS NEXT SEEK ADDR.             04776760
         LA    R1,ALTCHK3     POINT TO GET CONTROL AFTER IO END         04777750
         ST    R1,CONTINAD    SAVE FOR INTERRUPT HANDLER.               04778740
         B     STIO2          START SAME CHNL PRG TO READ HA,           04779730
*                             R0, BUT FROM THE OTHER TRACK THIS TIME.   04780720
         SPACE ,                                                        04781710
*---------------------------------------------------------------------- 04782700
*        RETURN HERE AFTER READING HOME ADDRESS AND RECORD 0 THE SECOND 04783690
*        TIME.  TEST THE TRACK USAGE BITS IN THE HOME ADDRESS HADATA    04784680
*        FLAG BYTE.  THIS FLAG CAN BE FROM EITHER THE PRIMARY OR THE    04785670
*        ALTERNATE DEPENDING ON WHERE WE WERE WHEN THIS ROUTINE WAS     04786660
*        CALLED.  IF NOT MIXED BITS, EXIT WITH ERROR FLAG IN R1 (BOTH   04787650
*        BITS THE SAME ARE FORBIDDEN).                                  04788640
*---------------------------------------------------------------------- 04789630
         SPACE ,                                                        04790620
         USING ALTCHK3,R6                                               04791610
ALTCHK3  SR    R0,R0                                                    04792600
         SR    R1,R1          0 IN R1.                                  04793590
         BCTR  R1,0           -1 IN R1 IN CASE OF ERROR EXIT.           04794580
         TM    HADATA,X'03'   TEST TRACK USAGE BITS IN HA FLAG          04795570
         BNM   ALTCHKEX       IF NOT MIXED, EXIT WITH ERROR             04796560
         CLC   CCHHSV(L4),R0DATA DOES 2ND TRK POINT BACK TO 1ST         04797550
         BNE   ALTCHKEX       NO, EXIT WITH -1 IN R1.                   04798540
         SPACE ,                                                        04799530
*---------------------------------------------------------------------- 04800520
*        WE STILL MIGHT HAVE A SINGLE TRACK POINTING TO ITSELF.  CHECK  04801510
*        THE FLAG BYTES TO SEE IF ONE AND ONLY ONE OF THEM IS AN        04802500
*        ASSIGNED ALTERNATE.  IF NEITHER WAS THE ALTERNATE, EXIT.       04803490
*---------------------------------------------------------------------- 04804480
         SPACE ,                                                        04805470
         XC    HADATA(L1),HAFLAGSV XC OLD FLAG BYTE INTO NEW            04806460
*                                  FLAG BYTE.                           04807450
         TM    HADATA,X'01'   BIT REMAINING ON IN FLAG BYTE             04808440
*                             MEANS ONE AND ONLY ONE WAS ALTERNATE.     04809430
         BNO   ALTCHKEX       ERROR, NEITHER WAS ALTERNATE.             04810420
         SPACE ,                                                        04811410
*---------------------------------------------------------------------- 04812400
*        WE HAVE AN ALTERNATE - RETURN IN R1 THE CCHH OF THE SECOND     04813390
*        TRACK AND RETURN IN R0 0 IF R1 POINTS TO ASSIGNED ALTERNATE    04814380
*        OR 1 IF R1 POINTS TO DEFECTIVE PRIMARY.                        04815370
*---------------------------------------------------------------------- 04816360
         SPACE ,                                                        04817350
         ICM   R1,15,HAR0SKAD+2 RETURN CCHH OF 2ND TRACK.               04818340
         NI    HAFLAGSV,X'01' CLEAR 1ST BYTE OF ALL BUT 'TRACK          04819330
*                             USAGE' BIT.                               04820320
         IC    R0,HAFLAGSV    'TRACK USAGE' BIT IN 1ST FLAG             04821310
*                             BYTE IS INVERSE OF BIT IN 2ND FLAG BYTE   04822300
*                             THAT CCHH IN R1 POINTS TO.                04823290
ALTCHKEX MVI   ALTFLAG,0      TURN OFF SIGNAL TO INTERRUPT HDLR         04824280
         LM    R2,R7,ALTCHKSV                                           04825270
         BR    R7             RETURN                                    04826260
         DROP  R6                                                       04827250
*.4******************************************************************** 04828240
*                                                                       04829230
* SUBROUTINE NAME -       *----------------*                            04830220
*                         *   SENSCCHH     *                            04831210
*                         *----------------*                            04832200
*                                                                       04833190
* FUNCTION -                                                            04834180
*                                                                       04835170
*        COMPUTE CCHH FROM SENSE DATA READ PREVIOUSLY.                  04836160
*                                                                       04837150
* INPUT REGISTERS -                                                     04838140
*                                                                       04839130
*        R7  - RETURN ADDRESS                                           04840120
*                                                                       04841110
* OUTPUT REGISTERS -                                                    04842100
*                                                                       04843090
*        R1  - CCHH DATA TAKEN FROM SENSE DATA BUFFER.                  04844080
*                                                                       04845070
*.$******************************************************************** 04846060
         SPACE ,                                                        04847050
SENSCCHH IC    R1,SENSE+6                                               04848040
         SRL   R1,5           CYL BITS 512, 256 RIGHT JUSTIFIED         04849030
         STC   R1,SENSWORK                                              04850020
         NI    SENSWORK,X'03' CLEAR ALL BUT BITS 512, 256.              04851010
         MVC   SENSWORK+1(L1),SENSE+5 LOW ORDER CYL ADDR.               04852000
         MVN   SENSWORK+3(L1),SENSE+6 HEAD ADDRESS.                     04852990
         L     R1,SENSWORK                                              04853980
         BR    R7                                                       04854970
SENSWORK DC    F'0'                                                     04855960
*---------------------------------------------------------------------- 04856950
*                                                                       04857940
*        CONSOLE MESSAGES                                               04858930
*                                                                       04859920
*---------------------------------------------------------------------- 04860910
         SPACE ,                                                        04861900
LABELOK  DC    AL1(TITLE-*-1)                                           04862890
         DC    C'LABEL IS NOW XXXXXX'                                   04863880
TITLE    DC    AL1(FORA-*-1)                                            04864870
         DC    C'VM/370 FORMAT/ALLOCATE PROGRAM '                       04865860
         DC    C'RELEASE 6'                                             04866850
FORA     DC    AL1(FMTMSG-*-1)                                          04867840
         DC    C'ENTER FORMAT OR ALLOCATE:'                             04868830
FMTMSG   DC    AL1(ALLOCMSG-*-1)                                        04869820
         DC    C'FORMAT FUNCTION SELECTED'                              04870810
ALLOCMSG DC    AL1(ADDRESS-*-1)                                         04871800
         DC    C'ALLOCATE FUNCTION SELECTED'                            04872790
ADDRESS  DC    AL1(WR1-*-1)                                             04873780
         DC    C'ENTER DEVICE ADDRESS (CUU):'                           04874770
WR1      DC    AL1(TYPMSG-*-1)                                          04875760
         DC    C'DMKFMT730E DEV XXX NOT OPERATIONAL OR '                04876750
         DC    C'NOT READY.'                                            04877740
TYPMSG   DC    AL1(PCMSG-*-1)                                           04878730
         DC    C'ENTER DEVICE TYPE:'                                    04879720
PCMSG    DC    AL1(MCMSG-*-1)                                           04880710
         DC    C'DMKFMT756E PROGRAM CHECK PSW = '                       04881700
         DC    C'XXXXXXXXXXXXXXXX'                                      04882690
MCMSG    DC    AL1(ALMSG-*-1)                                           04883680
         DC    C'DMKFMT732E MACHINE CHECK'                              04884670
ALMSG    DC    AL1(ALMSG1-*-1)                                          04885660
         DC    C'TYPE CYL  CYL'                                         04886650
ALMSG1   DC    AL1(WRONG-*-1)                                           04887640
         DC    C'.... ... ...'                                          04888630
WRONG    DC    AL1(WRDEV1-*-1)                                          04889620
         DC    C'DMKFMT733E VOLID READ IS XXXXXX NOT XXXXXX'            04890610
WRDEV1   DC    AL1(WRDEV2-*-1)                                          04891600
         DC    C'DMKFMT741E DEVICE '                                    04892590
WRDEV1AD DC    C'CUU'                                                   04893580
         DC    C' IS '                                                  04894570
WRDEV1AC DC    C'XXXX'                                                  04895560
         DC    C', NOT '                                                04896550
WRDEV1SP DC    C'XXXX-YY'                                               04897540
         DC    C' AS SPECIFIED'                                         04898530
WRDEV2   DC    AL1(DATAMSG-*-1)                                         04899520
         DC    C'RESPECIFY OR NOTIFY SYSTEM SUPPORT'                    04900510
DATAMSG  DC    AL1(TYPERR-*-1)                                          04901500
         DC    C'ENTER ALLOCATION DATA FOR VOLUME '                     04902490
DATAMSG1 DC    C'XXXXXX '                                               04903480
TYPERR   DC    AL1(MAP-*-1)                                             04904470
         DC    C'DMKFMT734E TYPE OR CYL INVALID'                        04905460
MAP      DC    AL1(ALLEND-*-1)                                          04906450
         DC    C'XXXX 0000 0000'                                        04907440
ALLEND   DC    AL1(STCYL-*-1)                                           04908430
         DC    C'DEVICE XXX VOLUME XXXXXX ALLOCATION ENDED'             04909420
STCYL    DC    AL1(ENDCYL-*-1)                                          04910410
         DC    C'ENTER START CYLINDER (XXX OR XXXX) OR "LABEL":'        04911400
*                                                                       04912390
ENDCYL   DC    AL1(PROGFOR-*-1)                                         04913380
         DC    C'ENTER END CYLINDER (XXX OR XXXX):'                     04914370
PROGFOR  DC    AL1(RDLAB-*-1)                                           04915360
         DC    C'FORMAT STARTED'                                        04916350
RDLAB    DC    AL1(WVMSG1-*-1)                                          04917340
         DC    C'ENTER DEVICE LABEL:'                                   04918330
WVMSG1   DC    AL1(WVMSG2-*-1)                                          04919320
         DC    C'WRITE VERIFICATION NOT PERFORMED UNLESS REQUESTED.'    04920310
WVMSG2   DC    AL1(WVMSG3-*-1)                                          04921300
         DC    C'ENTER "YES" FOR WRITE VERIFICATION:'                   04922290
WVMSG3   DC    AL1(ENDFOR-*-1)                                          04923280
         DC    C'WRITE VERIFICATION WAS NOT PERFORMED'                  04924270
ENDFOR   DC    AL1(FATLMSG-*-1)                                         04925260
         DC    C'FORMAT DONE'                                           04926250
FATLMSG  DC    AL1(PAGE-*-1)                                            04927240
         DC    C'DMKFMT735E FATAL DASD I/O ERROR'                       04928230
         DC    C' CSW=XXXXXXXXXXXXXXXX'                                 04929220
PAGE     DC    AL1(IOERR-*-1)                                           04930210
         DC    C'XXXX NO. PAGE RECORDS WITH READ-CHECK ERRORS'          04931200
IOERR    DC    AL1(M736L)                                               04932190
         DC    C'DMKFMT736E IO ERROR XXX CCHHR = 0000000000'            04933180
M736L    EQU   *-IOERR-1                                                04934170
IOERR2   DC    AL1(M736L2)                                              04935160
         DC    C'SENSE=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'                04936150
         DC    C'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'                      04937140
M736L2   EQU   *-IOERR2-1                                               04938130
BAD      DC    AL1(IPLERROR-*-1)                                        04939120
BADMSG   DC    C'DMKFMT737E INVALID OPERAND'                            04940110
IPLERROR DC    AL1(IPLERRL)                                             04941100
         DC    C'DMKFMT738A DEV XXX INTERVENTION REQUIRED'              04942090
IPLERRL  EQU   *-IPLERROR-1                                             04943080
MSGATRK  DC    AL1(MSGATRKL)                                            04944070
         DC    C'DMKFMT739E FLAGGED PRIMARY TRACK HAS NO '              04945060
         DC    C'ALTERNATE ASSIGNED, I/O ERROR FOLLOWS'                 04946050
MSGATRKL EQU   *-MSGATRK-1                                              04947040
MSG35MB  DC    AL1(MSG35MBL)                                            04948030
         DC    C'DMKFMT740E PACK MOUNTED IS 3340-35, NOT '              04949020
         DC    C'3340-70.  MOUNT ANOTHER OR RESPECIFY.'                 04950010
MSG35MBL EQU   *-MSG35MB-1                                              04951000
MSG744   DC    AL1(M744L)                                               04951990
         DC    C'DMKFMT744E I/O ERROR 000 CODE = E4'                    04952980
         DC    C' CSW = 0000000000000000'                               04953970
M744L    EQU   *-MSG744-1                                               04954960
DRCTFAIL DC    AL1(DRCTFLLN)                                            04955950
         DC    C'DMKFMT536I XXX REPORTS DISABLED INTERFACE;'            04956940
         DC    C' FLT CODE = XXXX; NOTIFY CE'                           04957930
DRCTFLLN EQU   *-DRCTFAIL-1                                             04958920
CARDMESS DC    AL1(RESPONSE-*-1)                                        04959910
CDINPUT  DC    80C' '         CARD INPUT - VIA CARDCCW                  04960900
RESPONSE DC    AL1(RESULTS-*-1)                                         04961890
ANSWER   DC    C'                       '                               04962880
RESULTS  DC    AL1(END-*-1)                                             04963870
         DC    C'ALLOCATION RESULTS'                                    04964860
END      EQU   *                                                        04965850
MSG742   DC    AL1(MSG742X)                                    @VA15782 04966840
         DC    C'DMKFMT742E ALLOCATION FUNCTION NOT ALLOWED '  @VA15782 04967830
MSG742X  EQU   *-MSG742-1                                      @VA15782 04968820
MSG742A  DC    AL1(MSG742AX)                                   @VA15782 04969810
         DC    C'           FORMAT OF VOLUME IS A PREREQUISITE '        04970800
MSG742AX EQU   *-MSG742A-1                                     @VA15782 04971790
*---------------------------------------------------------------------- 04972780
*                                                                       04973770
*        CONSTANTS FOR CARD AND COMMUNICATION PROCESSING                04974760
*                                                                       04975750
*---------------------------------------------------------------------- 04976740
         SPACE ,                                                        04977730
CONSIRA  DS    0D             I/O NEW PSW AT X'120'                     04978720
         DC    X'00040000'                                              04979710
         DC    A(CONSINT)     CONSOLE I/O INTERRUPT ROUTINE             04980700
         SPACE ,                                                        04981690
CDFORA   DC    D'0'           CARD FORMAT OR ALLOCATE / ALLOC TYPE      04982680
CDADD    DC    D'0'           CARD DEVICE ADDRESS / ALLOC START         04983670
CDTYPE   DC    D'0'           CARD DEVICE TYPE / ALLOC END              04984660
CDLABEL  DC    D'0'           CARD LABEL                                04985650
CDSTART  DC    XL8'00'        CARD START CYLINDER/PAGE                  04986640
CDENDCYL DC    XL8'00'        CARD END CYLINDER/PAGE                    04987630
CDWVERIF DC    XL8'00'        CARD WRITE VERIFICATION                   04988620
CDLAST   EQU   CDWVERIF       CARD LAST INPUT FIELD                     04989610
DATA     DC    D'0'           CARD INPUT DATA SAVE AREA                 04990600
         SPACE ,                                                        04991590
SAVE14   DC    F'0'           WMSG RETURN ADDRESS SAVER                 04992580
SAVE4    DC    F'0'           RMSG MESSAGE SAVER (RESPONSE?)            04993570
STAT     DC    H'0'           SAVE CSW STATUS DURING INTERRUPT          04994560
LOSW     DC    X'00'          LABEL ONLY FLAG                           04995550
CDSW     DC    X'00'          CARD SELECTION SWITCH                     04996540
CDSW2    DC    X'FF'          CARD INPUT SWITCH (X'FF'=YES)             04997530
ALLOSW   DC    X'00'          ALLOCATION ONLY INDICATOR                 04998520
ALLOERR  DC    X'00'          ALLOCATE ERROR INDICATOR                  04999510
LABIOERR DC    X'00'          LABEL I/O ERROR INDICATOR                 05000500
CCHHR    DC    CL5'X'         CCHHR DATA FOR MESSAGE                    05001490
         SPACE ,                                                        05002480
HIVALUE  DC    H'00'          HIGHEST CYLINDER ADDRESS                  05003470
HDVALUE  DC    H'0'           HIGHEST HEAD VALUE FOR DEVICE             05004460
BEGIN    DC    H'00'          CYLINDER START ADDRESS                    05005450
ENDING   DC    H'00'          CYLINDER ENDING ADDRESS                   05006440
         SPACE ,                                                        05007430
PGCOUNT  DC    F'0'           PAGE ERROR COUNT                          05008420
SAVEIT   DC    5F'0'          SAVE CSW, CAW, AND I/O OLD PSW            05009410
SAVFATAL DC    5F'0'          SAVE CSW, CAW, AND I/O OLD PSW            05010400
WORK     DC    17F'0'         WORK AREA FOR PACKS/UNPACKS               05011390
         DS    0F             FULLWORD ALIGNMENT                        05012380
SEEK0    DC    XL7'00'        STARTING BBCCHHR                          05013370
         SPACE ,                                                        05014360
PCREGS   DC    16F'0'         SAVE REGS DURING PROGRAM CHECK            05015350
SENSE    DC    XL32'00'       SENSE AREA                                05016340
ENCHAN   DC    X'03FF0000'    ENABLE DEVICES ON CHANNELS 6-15           05017330
SENSEB0  EQU   SENSE          SENSE BYTE 0                              05018320
SENSEB1  EQU   SENSE+1        SENSE BYTE 1                              05019310
SENSEB2  EQU   SENSE+2        SENSE BYTE 2                              05020300
ENVDATA  EQU   X'10'          ENVIRON. DATA PRESENT ON SENSE+2          05021290
SENSEB3  EQU   SENSE+3        SENSE BYTE 3                              05022280
SENSEB4  EQU   SENSE+4        SENSE BYTE 4 (DEVTYPE)                    05023270
SENSEB6  EQU   SENSE+6        SENSE BYTE 6                              05024260
FLTCDE   EQU   SENSE+22       SENSE BYTE 22 (FAULT CODE)                05025250
*---------------------------------------------------------------------- 05026240
*                                                                       05027230
*        STRTIO/STRTIO1 SUBROUTINE CCWS AND CONSTANTS                   05028220
*                                                                       05029210
*---------------------------------------------------------------------- 05030200
         SPACE ,                                                        05031190
*---------------------------------------------------------------------- 05032180
*        RESTART CCW CHAIN AFTER ERROR 2305,2314,3330,3340,3350,        05033170
*        3380 CHANNEL PROGRAM                                           05034160
*---------------------------------------------------------------------- 05035150
         SPACE ,                                                        05036140
         DS    0D                                                       05037130
RDRTRY   CCW   07,SEEKA,CC,6  PHONY SEEKA                               05038120
         CCW   31,FILEMASK,CC+SILI,1                                    05039110
PICKUP   CCW   08,0,0,0                                                 05040100
SHIFTMSK DC    X'80',3X'00'                                             05041090
         SPACE ,                                                        05042080
*---------------------------------------------------------------------- 05043070
*        RECALIBRATE AND RESTART FORMATTING                             05044060
*---------------------------------------------------------------------- 05045050
         SPACE ,                                                        05046040
         SPACE ,                                                        05047030
CALIBRAT CCW   19,0,CC+SILI,1 RECALIBRATE                               05048020
CALTIC   CCW   08,FMT2314,0,0 TIC TO NORMAL CCWS                        05049010
*---------------------------------------------------------------------- 05050000
*                                                                       05050990
*        GENERAL AND MISCELLANEOUS CONSTANTS                            05051980
*                                                                       05052970
*---------------------------------------------------------------------- 05053960
         SPACE ,                                                        05054950
SAVEDCSW DC    2F'0'          ERROR RECOVERY CSW SAVE AREA              05055940
CONTINAD DC    F'0'           ADDR OF CODE WHERE ALT TRACK              05056930
*                             PROCESSING IS TO RESUME.                  05057920
ERCOUNT  DC    F'0'           ERROR RECOVERY ERROR COUNT                05058910
ERLIMIT  DC    F'9'           ERROR RECOVERY RETRY LIMIT                05059900
TOTCNT   DC    F'0'           TOTAL ACCUMULATED ERRORS ON SIO           05060890
TOTLIMIT DC    F'25'          MAXIMUM ALLOWED ON 1 CHAN PROG            05061880
SENSTA   DC    2F'0'          SENSE CSW STATUS                          05062870
NEWPSW   DC    X'00040000'    I/O NEW PSW FOR DASD INTERRUPTS           05063860
         DC    A(IOINT)                                                 05064850
RNSTUF   DS    24F            2314 RECORD FIELDS SAVE AREA              05065840
WKSEEK   DS    30F            SEEK FIELDS SAVE AREA                     05066830
STRTSAVE DS    13F            REG SAVE FOR STRTIO                       05067820
STRTSVIO DS    XL20           IO STATUS SAVE AREA FOR STRTIO            05068810
LSAVE    EQU   L'STRTSVIO     LENGTH OF SAVE AREA FOR MVC               05069800
STRTSVSN DS    XL32           SENSE INFORMATION SAVE AREA               05070790
SAVEVOL1 DC    24F'0'         OS LABEL SAVE AREA                        05071780
SAVEFMT4 DC    24F'0'         SAVE CONTENTS OF CP'S FMT4                05072770
ALTCCHH  DC    XL6'0'         CCHH OF NEXT AVAIL. ALT TRK               05073760
*                             PLUS COUNT OF NO. OF ALT. TRKS            05074750
EDPSENSE DS    XL32           SAVE AREA FOR SENSE WITH EDP              05075740
EDPERCNT DC    H'0'           EDP RETRY COUNT                           05076730
EDPLIMIT DC    H'255'         EDP RETRY LIMIT                           05077720
         SPACE ,                                                        05078710
CP370    DC    CL5'CP370'     CP370 IS VOLUME OWNER                     05079700
         SPACE ,                                                        05080690
REGSAV   DC    F'0'           SAVE CALLER'S RETURN ADDRESS              05081680
ZERO     DC    XL8'00'        CCW ZERO DATA AREA                        05082670
ATYPE    DC    X'00'          ALLOCATION TYPE                           05083660
RECVALUE DC    X'00'          HIGHEST RECORD NUMBER                     05084650
FLAG1    DC    X'00'          WRITE ALLOCATION TO DISK FLAG             05085640
ALLOCWR  EQU   X'01'          WRITE ALLOCATION TO DISK BIT              05086630
COMWOK   DC    XL9'00'        INPUT DATA WORK AREA                      05087620
         DS    0D                                                       05088610
IPLDEV   DC    X'0000'        IPL DEVICE ADDRESS                        05089600
ADFOTYPE DS    A              ADDRESS OF ENTRY IN DEVICE/FORMAT         05090590
*                             TABLE                                     05091580
*---------------------------------------------------------------------- 05092570
*                                                                       05093560
*        ALTERNATE TRACK PROCESSING CONSTANTS AND CCWS                  05094550
*                                                                       05095540
*---------------------------------------------------------------------- 05096530
         SPACE ,                                                        05097520
ALTSEEK  CCW   07,ALTSKADD,CC+SILI,6  RESTART SEEK ALTERNATE            05098510
         CCW   31,FILEMASK,CC+SILI,1                                    05099500
ALTTIC   CCW   08,*-*,0,0                                               05100490
ALTSKADD DC    XL6'0'         SEEK ADDRESS NEXT TRACK                   05101480
         SPACE ,                                                        05102470
ALTFLAG  DC    AL1(0)         FLAG FOR 3340/3344 ALT TRACK              05103460
         SPACE ,                                                        05104450
HAR0READ EQU   128            HA/R0 READ IN PROGRESS                    05105440
         SPACE ,                                                        05106430
         SPACE ,                                                        05107420
READHAR0 CCW   X'07',HAR0SKAD,CC+SILI,6 SEEK                            05108410
         CCW   X'1A',HADATA,CC+SILI,5 READ HA                           05109400
         CCW   X'16',R0DATA,SILI,4 READ R0                              05110390
HAR0SKAD DC    XL6'0'         00CCHH SEEK ADDRESS                       05111380
HADATA   DS    XL5            FLAG BYTE + CCHH READ FROM HA.            05112370
HAFLAGSV DS    XL1            FLAG BYTE FROM 1ST OF 2 READS             05113360
*                             SAVED HERE.                               05114350
CCHHSV   DS    XL4            CURRENT TRACK ADDRESS SAVE AREA           05115340
R0DATA   DS    XL4            CCHH DATA FROM COUNT FLD OF R0.           05116330
ALTCHKSV DS    6F             REGISTER SAVE AREA.                       05117320
*---------------------------------------------------------------------- 05118310
*        WRITE MESSAGE TO THE CONSOLE                                   05119300
*---------------------------------------------------------------------- 05120290
         SPACE ,                                                        05121280
         DS    0D             ALIGNMENT                                 05122270
WCCW     CCW   1,TITLE,CC+SILI,1 CCW FOR WRITING TO CONSOLE             05123260
         CCW   3,0,SILI,1        NOP TO ASSURE COMPLETION               05124250
         SPACE ,                                                        05125240
*---------------------------------------------------------------------- 05126230
*        READ RESPONSE FROM THE CONSOLE                                 05127220
*---------------------------------------------------------------------- 05128210
         SPACE ,                                                        05129200
RCCW     CCW   10,INDATA,CC+SILI,80 CONSOLE READ CCW                    05130190
         CCW   3,0,SILI,1     NOOP                                      05131180
         SPACE ,                                                        05132170
*---------------------------------------------------------------------- 05133160
*        READ INPUT FROM CARDS                                          05134150
*---------------------------------------------------------------------- 05135140
         SPACE ,                                                        05136130
CARDCCW  CCW   02,CDINPUT,CC+SILI,80  START IPL DEVICE AND USE          05137120
         CCW   03,0,SILI,1    FOR INPUT (CARDS)                         05138110
         SPACE ,                                                        05139100
*---------------------------------------------------------------------- 05140090
*        ISSUE 04 SENSE CCW                                             05141080
*---------------------------------------------------------------------- 05142070
         SPACE ,                                                        05143060
CCWSENSE CCW   4,SENSE,SILI,L'SENSE  SENSE CCW                          05144050
*---------------------------------------------------------------------- 05145040
*                                                                       05146030
*        GRAPHIC SUPPORT CCWS AND CONSTANTS                             05147020
*                                                                       05148010
*---------------------------------------------------------------------- 05149000
         SPACE ,                                                        05149990
CRTWORD  CCW   X'27',SBACP,SILI+CC,2   SET BAR TO (STATUS WORD)         05150980
         CCW   X'01',CPXYSTAT,SILI+CC,20 WRITE 'RUNNING' ON             05151970
*                                      SCREEN                           05152960
         CCW   X'27',SBAREAD,SILI+CC,2 SET BUFFER ADDR FOR              05153950
*                                      WRITE                            05154940
         CCW   X'01',BLNKZERO,SILI+CC,140 CLEAR INPUT AREA              05155930
CURS3066 CCW   X'0F',SBAREAD,SILI+CC,2 REPOSITION CURSOR                05156920
         CCW   X'03',*-*,SILI,3        END OF READ CCW STRING           05157910
         SPACE ,                                                        05158900
CRTWORD1 CCW   X'01',LAB3270A,SILI+CC,LEN THE CONTROL DATA              05159890
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05160880
         SPACE ,                                                        05161870
REQREAD  CCW   X'27',SBACP,SILI+CC,2   SET BUFF ADDR TO CP X-Y          05162860
         CCW   X'01',CPXYSTAT,SILI+CC,20 WRITE SCREEN STATUS            05163850
         CCW   X'08',CURS3066,SILI,1   RESET CURSOR POSITION            05164840
         SPACE ,                                                        05165830
REQREAD1 CCW   X'01',LAB3270B,SILI+CC,LEN1 THE CONTROL DATA             05166820
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05167810
         SPACE ,                                                        05168800
ERSE3066 CCW   X'07',*-*,SILI+CC,1     ERASE ENTIRE SCREEN              05169790
WRTCRTXY CCW   X'27',SBADDR,SILI+CC,2  SET CORRECT LINE IN              05170780
*                                      BUFFER                           05171770
WRT3066  CCW   X'01',*-*,SILI+CC,140   WRITE OUT USER DATA              05172760
         CCW   X'08',CRTWORD,SILI,1    NOW DISPLAY STATUS               05173750
         SPACE ,                                                        05174740
ERSE3270 CCW   X'05',LAB3270E,SILI+CD,LEN3 ERASE THE SCREEN             05175730
         CCW   X'00',CPXYSTAT,SILI+CC,20 WRITE SCREEN STATUS            05176720
WRTCRT70 CCW   X'01',LAB3270,SILI+CD,4 THE CONTROL DATA                 05177710
WRTCR70  CCW   X'00',*-*,SILI+CD,0     WRITE CCW                        05178700
         CCW   X'00',LAB3270A+1,SILI+CC,LEN-1 WRITE SCREEN              05179690
*                                      STATUS                           05180680
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05181670
         SPACE ,                                                        05182660
RDMI3066 CCW   X'0E',RDMIDATA,SILI+CC,3 READ CCW FOR MI COMMAND         05183650
RD3066   CCW   X'27',SBAREAD,SILI+CC,2 SET BUFFER ADDR FOR READ         05184640
RD3066DA CCW   X'06',*-*,SILI+CC,140   READ INPUT DATA                  05185630
         CCW   X'08',CURS3066,SILI,1   REPOSITION CURSOR                05186620
         SPACE ,                                                        05187610
RDMI3270 CCW   X'01',LAB3270D,SILI+CC,4 WRITE SPECIAL CKD               05188600
RD3270DA CCW   X'06',*-*,SILI+CC,0     CCW FOR READ                     05189590
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05190580
         SPACE ,                                                        05191570
CNCL3270 CCW   X'01',LAB3270E,SILI+CD,LEN3 THE CONTROL DATA             05192560
         CCW   X'00',CPXYSTAT,SILI+CC,20 WRITE SCREEN STATUS            05193550
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05194540
         SPACE ,                                                        05195530
CNCL3066 CCW   X'07',*-*,SILI+CC,1     ERASE THE SCREEN                 05196520
         CCW   X'08',CRTWORD,SILI,1    NOW DISPLAY STATUS               05197510
         SPACE ,                                                        05198500
MORECCW1 CCW   X'01',LAB3270C,SILI+CC,LEN2 THE CONTROL DATA             05199490
         CCW   X'03',*-*,SILI,2        NO-OPERATION                     05200480
         SPACE ,                                                        05201470
*---------------------------------------------------------------------- 05202460
*        FIRST DC ARE ADDRESSES FOR LINES 1 -6                          05203450
*        SECOND DC ARE ADDRESSES FOR LINES 7 - 12                       05204440
*        THIRD DC ARE ADDRESSES FOR LINES 13 - 18                       05205430
*        FOURTH DC ARE ADDRESSES FOR LINES 19 - 24                      05206420
*---------------------------------------------------------------------- 05207410
         SPACE ,                                                        05208400
TABLE70  DS    0D                                                       05209390
         DC    X'4040C150C260C3F0C540C650'                              05210380
         DC    X'C760C8F04A404B504C604DF0'                              05211370
         DC    X'4F405050D160D2F0D440D550'                              05212360
         DC    X'D660D7F0D9405A505B605CF0'                              05213350
         SPACE ,                                                        05214340
TABLGRAP EQU   *                                                        05215330
         DC    X'0A',AL3(READ66) ADDRESS OF THE READ SECTION            05216320
         DC    X'01',AL3(WRT66) ADDRESS OF THE WRITE SECTION            05217310
         DC    X'09',AL3(WRT66) ADDRESS OF THE WRITE SECTION            05218300
         DC    X'05',AL3(WRT66) ADDRESS OF THE WRITE SECTION            05219290
         DC    X'03',AL3(RETWORD) ADDRESS OF THE RETURN SECTION         05220280
         SPACE ,                                                        05221270
*        X'5B60' - LINE 23, COL. 1                                      05222260
*        X'5D6A' - LINE 24, COL. 59                                     05223250
WC6      EQU   X'C2'          WRITE CONTROL BIT 6                       05224240
AT7      EQU   X'C1'          ATTRIBUTE BIT 7                           05225230
AT2      EQU   X'E0'          ATTRIBUTE BIT 2                           05226220
LAC      EQU   X'C0'                                                    05227210
SF       EQU   X'1D'          START OF FIELD CONTROL                    05228200
SBA      EQU   X'11'          SET BUFFER ADDRESS                        05229190
IC       EQU   X'13'          INSERT CURSOR                             05230180
EUA      EQU   X'12'          ERASE UNPROTECTED                         05231170
RA       EQU   X'3C'          REPEAT TO ADDRESS                         05232160
         SPACE ,                                                        05233150
LAB3270A DC    AL1(WC6),AL1(SBA),X'5B60',AL1(SF),AL1(AT7)               05234140
         DC    AL1(IC),AL1(EUA),X'5D6B',AL1(SF),AL1(AT2)                05235130
RUNLABEL DC    CL20'RUNNING'                                            05236120
LEN      EQU   *-LAB3270A                                               05237110
LAB3270B DC    AL1(WC6),AL1(SBA),X'5B60',AL1(SF),AL1(AT7)               05238100
         DC    AL1(IC),AL1(SBA),X'5D6B',AL1(SF),AL1(AT2)                05239090
REALABEL DC    CL20'CP READ'                                            05240080
LEN1     EQU   *-LAB3270B                                               05241070
LAB3270C DC    AL1(WC6),AL1(SBA),X'5D6B',AL1(SF),AL1(AT2)               05242060
MORLABEL DC    CL20'HOLDING'                                            05243050
LEN2     EQU   *-LAB3270C                                               05244040
LAB3270D DC    AL1(LAC),AL1(SBA),X'5B60'                                05245030
LAB3270  DC    AL1(WC6),AL1(SBA),X'0000'                                05246020
LAB3270E DC    AL1(WC6),AL1(SBA),X'4040',AL1(RA),X'5B60',X'00'          05247010
         DC    AL1(SF),AL1(AT7),AL1(IC),AL1(SBA)                        05248000
         DC    X'5D6B',AL1(SF),AL1(AT2)                                 05248990
LEN3     EQU   *-LAB3270E                                               05249980
PARM     DC    X'00'          THE GRAPHIC FLAG BYTE                     05250970
PARMATT  EQU   X'80'          ATTENTION REQUEST                         05251960
PARMGRP  EQU   X'40'          GRAPHIC SUPPORT                           05252950
PARMREA  EQU   X'20'          READ REQUEST                              05253940
PARMCLE  EQU   X'10'          CLEAR/ERASE REQUEST                       05254930
PARM327  EQU   X'08'          3270 GRAPHIC                              05255920
PARMNDA  EQU   X'04'          NO DATA INDICATED                         05256910
PARM01F  EQU   X'02'          01F REQUESTED                             05257900
PARM321  EQU   X'01'          3215/3210/1052                            05258890
PARM2    DC    X'00'          SIO SWITCHES                              05259880
SIONOP   EQU   X'80'          DEVICE NOT OPERATIONAL                    05260870
SBADDR   DC    AL1(00,00)     CURRENT OUTPUT LINE COORDINATES           05261860
*                             FOR THE 3066                              05262850
SBACP    DC    AL1(34,60)     COORDINATES FOR SCREEN 'STATUS'           05263840
*                             WORD                                      05264830
SBAREAD  DC    AL1(33,00)     COORDINATES FOR CURSOR POSITION           05265820
RDMIDATA DC    XL6'00'        READ DATA FROM 'MI' COMMAND               05266810
CPXYSTAT DC    CL20' '        SCREEN 'STATUS' WORD                      05267800
BLNKLINE DC    XL140'00'      CLEAR INPUT AREA FOR DATA                 05268790
BLNKZERO DC    CL140' '       BLANKS FOR READ AREA                      05269780
GRAPHSAV DC    8F'00'         SAVE AREA FOR GRAPHIC SUPPORT             05270770
SAVEAREA DC    2F'00'         SAVE AREA FOR GRAPHIC DATA                05271760
*                             REGISTERS                                 05272750
*---------------------------------------------------------------------- 05273740
*        CKD CCWS FOR READING AND WRITING LABELS.                       05274730
*---------------------------------------------------------------------- 05275720
         SPACE ,                                                        05276710
         DS    0D                                                       05277700
LBLREC   CCW   7,SEEKA,CC,6                                             05278690
         CCW   31,FILEMASK,CC,1                                         05279680
         CCW   49,R3VOL1,CC+SILI,5     FIND REC 3 VOL1 LABEL RECORD     05280670
         CCW   8,*-8,0,0                                                05281660
         CCW   6,OSLABEL,SILI+CC,80    READ LABELS                      05282650
         CCW   49,R4ALLOC,CC+SILI,5    SEARCH ID EQUAL                  05283640
         CCW   08,*-8,0,0              TIC                              05284630
         CCW   06,TABLE,SILI,DL4096    READ ALLOCATION TABLE            05285620
         SPACE ,                                                        05286610
LABWRITE CCW   7,SEEKA,CC,6            SEEK                             05287600
         CCW   31,FILEMASK,CC,1        SET FILE MASK                    05288590
         CCW   49,R3VOL1,CC+SILI,5     FIND VOL1 LABEL RECORD           05289580
         CCW   8,*-8,0,0               TIC                              05290570
         CCW   5,OSLABEL,SILI,80       WRITE LABEL                      05291560
*---------------------------------------------------------------------- 05292550
*        ALLOCATION CONSTANTS, EQUATES, AND WORK AREAS                  05293540
*---------------------------------------------------------------------- 05294530
REG8SAVE DS    F                       SAVE AREA HOLDS R8      @V6292B1 05295520
         SPACE ,                                                        05296510
TWDIND   DC    X'0004080C1014181C' INDICES INTO TYPWDS FOR              05297500
*                             EACH TYPE OF SPACE                        05298490
TYPWDS   DC    C'TEMP'        THE ONE BYTE TYPE FIELD IN THE            05299480
         DC    C'PERM'        EXTENT MAP IS CONVERTED TO A              05300470
         DC    C'TDSK'        VALUE FROM TWDIND - THIS IS               05301460
         DC    C'BAD '        USED TO INDEX TYPWDS.                     05302450
         DC    C'DRCT'        TOKEN FOR DIRECTORY EXTENTS               05303440
         DC    C'PAGE'        TOKEN FOR PAGE TYPE EXTENTS               05304430
         DC    C'DUMP'        DUMP TYPE EXTENT                          05305420
         DC    C'OVRD'        OVERRIDE TYPE EXTENT                      05306410
         SPACE ,                                                        05307400
TRWORK   DS    C              WORK AREA                                 05308390
TRTZEROS DC    X'00010203040506070809' TRANSLATE TABLE STOPS            05309380
*                             ON X'F0', CONTINUES FOR OTHERS            05310370
         SPACE ,                                                        05311360
DRCTFREE EQU   X'04'          DRCT TYPE EXTENT                          05312350
DRCTDIR  EQU   X'0C'          DRCT EXTENT IN USE BY DMKDIR              05313340
DRCTINV  EQU   X'F3'          INVALID DRCT CYLINDER MASK                05314330
*---------------------------------------------------------------------- 05315320
*        NORMAL DATA RECORDS (3330/2305 DEFAULT)                        05316310
*---------------------------------------------------------------------- 05317300
         SPACE ,                                                        05318290
         SPACE ,                                                        05319280
REC1     DC    F'0'                    CCHH                             05320270
         DC    AL1(1),AL3(4096)        REC NUMBER KL DL DL              05321260
NXTREC   EQU   *-REC1                                                   05322250
RECX1    DC    F'0'                    CCHH                             05323240
         DC    AL1(128+01),AL3(50)     REC NUMBER KL DL DL              05324230
REC2     DC    F'0'                    CCHH                             05325220
         DC    AL1(2),AL3(4096)        REC NUMBER KL DL DL              05326210
RECX2    DC    F'0'                    CCHH                             05327200
         DC    AL1(128+02),AL3(50)     REC NUMBER KL DL DL              05328190
REC3     DC    F'0'                    CCHH                             05329180
         DC    AL1(3),AL3(4096)        REC NUMBER KL DL DL              05330170
RECX3    DC    F'0'                    CCHH                             05331160
         DC    AL1(128+03),AL3(50)     REC NUMBER KL DL DL              05332150
REC4     DC    F'1'                    CCHH                             05333140
         DC    AL1(4),AL3(4096)        REC NUMBER KL DL DL              05334130
RECX4    DC    F'1'                    CCHH                             05335120
         DC    AL1(128+04),AL3(50)     REC NUMBER KL DL DL              05336110
REC5     DC    F'1'                    CCHH                             05337100
         DC    AL1(5),AL3(4096)        REC NUMBER KL DL DL              05338090
RECX5    DC    F'1'                    CCHH                             05339080
         DC    AL1(128+05),AL3(50)     REC NUMBER KL DL DL              05340070
REC6     DC    F'1'                    CCHH                             05341060
         DC    AL1(6),AL3(4096)        REC NUMBER KL DL DL              05342050
RECX6    DC    F'1'                    CCHH                             05343040
         DC    AL1(128+06),AL3(50)     REC NUMBER KL DL DL              05344030
REC7     DC    F'2'                    CCHH                             05345020
         DC    AL1(7),AL3(4096)        REC NUMBER KL DL DL              05346010
RECX7    DC    F'2'                    CCHH                             05347000
         DC    AL1(128+07),AL3(50)     REC NUMBER KL DL DL              05347990
REC8     DC    F'2'                    CCHH                             05348980
         DC    AL1(8),AL3(4096)        REC NUMBER KL DL DL              05349970
RECX8    DC    F'2'                    CCHH                             05350960
         DC    AL1(128+08),AL3(50)     REC NUMBER KL DL DL              05351950
REC9     DC    F'2'                    CCHH                             05352940
         DC    AL1(9),AL3(4096)        REC NUMBER KL DL DL              05353930
RECX9    DC    F'2'                    CCHH                             05354920
         DC    AL1(128+09),AL3(50)     REC NUMBER KL DL DL              05355910
REC10    DC    F'3'                    CCHH                             05356900
         DC    AL1(10),AL3(4096)       REC NUMBER KL DL DL              05357890
RECX10   DC    F'3'                    CCHH                             05358880
         DC    AL1(128+10),AL3(50)     REC NUMBER KL DL DL              05359870
REC11    DC    F'3'                    CCHH                             05360860
         DC    AL1(11),AL3(4096)       REC NUMBER KL DL DL              05361850
RECX11   DC    F'3'                    CCHH                             05362840
         DC    AL1(128+11),AL3(50)     REC NUMBER KL DL DL              05363830
REC12    DC    F'3'                    CCHH                             05364820
         DC    AL1(12),AL3(4096)       REC NUMBER KL DL DL              05365810
         SPACE ,                                                        05366800
RNBYTE1  EQU   *-REC1         NUMBER OF BYTES TO APP MIDDLE             05367790
RNMDLE   EQU   *              APP. MIDDLE OF RECORDS                    05368780
REC13    DC    F'1'           CCHH                                      05369770
         DC    AL1(13),AL3(4096) REC NUMBER KL DL DL                    05370760
REC14    DC    F'1'           CCHH                                      05371750
         DC    AL1(14),AL3(4096) REC NUMBER KL DL DL                    05372740
REC15    DC    F'1'           CCHH                                      05373730
         DC    AL1(15),AL3(4096) REC NUMBER KL DL DL                    05374720
REC16    DC    F'1'           CCHH                                      05375710
         DC    AL1(16),AL3(4096) REC NUMBER KL DL DL                    05376700
REC17    DC    F'1'           CCHH                                      05377690
         DC    AL1(17),AL3(4096) REC NUMBER KL DL DL                    05378680
REC18    DC    F'1'           CCHH                                      05379670
         DC    AL1(18),AL3(4096) REC NUMBER KL DL DL                    05380660
REC19    DC    F'1'           CCHH                                      05381650
         DC    AL1(19),AL3(4096) REC NUMBER KL DL DL                    05382640
REC20    DC    F'1'           CCHH                                      05383630
         DC    AL1(20),AL3(4096) REC NUMBER KL DL DL                    05384620
REC21    DC    F'2'           CCHH SECOND PART OF RECORD 21             05385610
         DC    AL1(21),AL3(4096) REC NUMBER KL DL DL                    05386600
REC22    DC    F'2'           CCHH                                      05387590
         DC    AL1(22),AL3(4096) REC NUMBER KL DL DL                    05388580
REC23    DC    F'2'           CCHH                                      05389570
         DC    AL1(23),AL3(4096) REC NUMBER KL DL DL                    05390560
REC24    DC    F'2'           CCHH                                      05391550
         DC    AL1(24),AL3(4096) REC NUMBER KL DL DL                    05392540
REC25    DC    F'2'           CCHH                                      05393530
         DC    AL1(25),AL3(4096) REC NUMBER KL DL DL                    05394520
REC26    DC    F'2'           CCHH                                      05395510
         DC    AL1(26),AL3(4096) REC NUMBER KL DL DL                    05396500
REC27    DC    F'2'           CCHH                                      05397490
         DC    AL1(27),AL3(4096) REC NUMBER KL DL DL                    05398480
REC28    DC    F'2'           CCHH                                      05399470
         DC    AL1(28),AL3(4096) REC NUMBER KL DL DL                    05400460
REC29    DC    F'2'           CCHH                                      05401450
         DC    AL1(29),AL3(4096) REC NUMBER KL DL DL                    05402440
REC30    DC    F'2'           CCHH                                      05403430
         DC    AL1(30),AL3(4096) REC NUMBER KL DL DL                    05404420
         SPACE ,                                                        05405410
RECEND   EQU   *                                                        05406400
         SPACE ,                                                        05407390
RNBYTE2  EQU   RECEND-RNMDLE  NUMBER OF BYTES OF COUNT FIELDS           05408380
RNBYTES  EQU   RECEND-REC1    TOTAL NUMBER OF BYTES IN FIELD            05409370
RNWRDS   EQU   RNBYTES/4      NUMBER OF WORDS IN COUNT FIELDS           05410360
         SPACE ,                                                        05411350
RNDATA   DC    (RNWRDS)F'0'   SAVE AREA FOR COUNT RECORDS               05412340
RECXX3   DC    F'0'                CCHH                                 05413330
         DC    AL1(192+01),AL3(412) REC NUMBER KL DL DL                 05414320
RECXX6   DC    F'0'                CCHH                                 05415310
         DC    AL1(192+02),AL3(412) REC NUMBER KL DL DL                 05416300
RECXX13  DC    F'1'                CCHH                                 05417290
         DC    AL1(192+03),AL3(412) REC NUMBER KL DL DL                 05418280
RECXX16  DC    F'1'                CCHH                                 05419270
         DC    AL1(192+04),AL3(412) REC NUMBER KL DL DL                 05420260
RECXX23  DC    F'2'                CCHH                                 05421250
         DC    AL1(192+05),AL3(412) REC NUMBER KL DL DL                 05422240
RECXX26  DC    F'2'                CCHH                                 05423230
         DC    AL1(192+06),AL3(412) REC NUMBER KL DL DL                 05424220
RECEND1  EQU   *                                                        05425210
RNBYTES1 EQU   RECEND1-RECXX3 TOTAL NUMBER OF BYTES IN FIELD            05426200
RNWRDS1  EQU   RNBYTES1/4     NUMBER OF WORDS IN COUNT FIELDS           05427190
RNRECS1  EQU   RNWRDS1/2      NUMBER OF RECORDS                         05428180
RNDATA1  DC    (RNWRDS1)F'0'  SAVE AREA FOR COUNT RECORDS               05429170
         SPACE ,                                                        05430160
*---------------------------------------------------------------------- 05431150
*        WRITE VERIFICATION FLAGS & ASSOCIATED CCW                      05432140
*---------------------------------------------------------------------- 05433130
         SPACE ,                                                        05434120
CCWCHNG  DS    A              ADDRESS OF AFFECTED CCW IN                05435110
*                             CHAINING SEQUENCE FOR WRT VERIF.          05436100
WVFLAGS  DC    X'00'          WRITE VERIFICATION FLAGS                  05437090
WVPMT    EQU   X'80'          PROMPT FOR WRITE VERIFICATION             05438080
WVREQ    EQU   X'40'          WRITE VERIFICATION REQUESTED              05439070
WVNOTOPT EQU   X'00'          WRITE VERIFICATION IS NOT                 05440060
*                             OPTIONAL AND WILL ALWAYS BE PERFORMED     05441050
*---------------------------------------------------------------------- 05442040
*        WITH A SET SECTOR ARGUMENT OF ZERO, RECONNECTION IS            05443030
*        ATTEMPTED JUST BEFORE INDEX, AND THE TRACK IS ORIENTED         05444020
*        TO INDEX.                                                      05445010
*---------------------------------------------------------------------- 05446000
         SPACE ,                                                        05446990
R0SEC    DC    XL8'00'                  ZERO DATA ADDRESS               05447980
         SPACE ,                                                        05448970
*---------------------------------------------------------------------- 05449960
*        SECTOR VALUES FOR DIFFERENT DASD TYPES:                        05450950
*                                                                       05451940
*        2305 MODEL 1   ---   2,32,62                                   05452930
*        2305 MODEL 2   ---   3,57,111                                  05453920
*        3330           ---   2,44,86                                   05454910
*        3340           ---   2,32                                      05455900
*        3350           ---   2,33,63,94                                05456890
*        3380           ---   5,26,46,71,92,112,137,157,178,199         05457880
*                                                                       05458870
*        USING A SET SECTOR TO 0 INSTEAD OF SECTOR VALUES BELOW         05459860
*        GUARANTEES THAT RECORD 0 WILL BE WRITTEN.  IF SOMETHING ELSE   05460850
*        IS USED, IT MAY NOT ALLOW TIME TO PROCESS AN INDEX, WHICH      05461840
*        IS REQUIRED FOR A WRITE RECORD 0.  IF THERE WAS NOT SUFFICIENT 05462830
*        TIME TO PROCESS AN INDEX, A FULL ROTATION OF THE DISK WOULD BE 05463820
*        REQUIRED.  THE VALUES IN THE TABLE ABOVE ARE INFORMATIONAL.    05464810
*                                                                       05465800
*---------------------------------------------------------------------- 05466790
SAVLOCR  DC    F'0'           SAVE ADDRESS OF LOCATE RECORD CCW@V6AFDD9 05467780
IMPREND  EQU   X'04'          IMPRECISE ENDING CONDITION       @V6AFDD9 05468770
*---------------------------------------------------------------------- 05469760
*        CKD CCW PROGRAM TO WRITE ALLOCATION TABLE                      05470750
*---------------------------------------------------------------------- 05471740
         SPACE ,                                                        05472730
         SPACE ,                                                        05473720
ALLOREC  CCW   07,R4SEEK,CC+SILI,6     SEEK TO WRITE ALLOC              05474710
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    05475700
         CCW   49,R4ALLOC,CC+SILI,5    SEARCH ID EQ                     05476690
         CCW   08,*-8,0,0              TIC BACK TO SEARCH               05477680
         CCW   05,TABLE,CC+SILI,DL4096  WRITE DATA                      05478670
         CCW   49,R4ALLOC,CC+SILI,5    SEARCH ID EQ                     05479660
         CCW   08,*-8,0,0              TIC BACK TO SEARCH               05480650
         CCW   06,TABLE,SILI,DL4096    READ DATA                        05481640
*---------------------------------------------------------------------- 05482630
*                                                                       05483620
*        3330 FORMAT CCWS                                               05484610
*                                                                       05485600
*        THESE COMMENTS APPLY TO THE STRINGS USED FOR THE FORMATTING OF 05486590
*        3330S, 3340S, 3350S AND 3380S IN GENERAL, SO WILL NOT          05487580
*        BE REPEATED.  THE SEEK TRANSFERS A SEEK ADDRESS FROM MAIN      05488570
*        STORAGE TO THE STORAGE DIRECTOR (CHANNEL, POSSIBLY A 3880),    05489560
*        WHICH SAVES THE ADDRESS AND ALLOWS POSITIONING OF THE ACCESS   05490550
*        MECHANISM AT A LATER TIME.  THE FIRST TWO BYTES ARE ALWAYS     05491540
*        ZERO, THE CYLINDER NUMBER IS IN BYTES 3 AND 4, AND THE         05492530
*        REQUIRED HEAD IN 5 AND 6.  THE SEEK IS NOT STARTED UNTIL A SET 05493520
*        SECTOR, READ, SEARCH, OR WRITE COMMAND.  NEXT, THE SET FILE    05494510
*        MASK TRANSFERS A MASK BYTE DEFINING THE WRITE AND SEEK         05495500
*        OPERATIONS THAT CAN BE USED.  ANY VIOLATION CAUSES A UC.  SET  05496490
*        SECTOR WITH AN ARGUMENT OF ZERO ORIENTS THE TRACK TO INDEX.    05497480
*        DURING THE TIME THE STORAGE DIRECTOR IS WAITING FOR INDEX, THE 05498470
*        CHANNEL IS AVAILABLE TO PERFORM OTHER OPERATIONS.  IF THE      05499460
*        PREVIOUS SEEK COMMAND INDICATED THAT ACCESS MOTION WAS         05500450
*        REQUIRED, THE ACCESS MECHANISM IS POSITIONED WHILE THE STORAGE 05501440
*        DIRECTOR IS DISCONNECTED FROM THE CHANNEL.  THE SEARCH ID      05502430
*        EQUAL COMMAND CAUSES THE FIRST ID FOUND ON THE TRACK TO BE     05503420
*        COMPARED WITH THE ARGUMENT.  ALL UNEQUAL COMPARISONS OF IDS    05504410
*        CAUSES THE DIRECTOR TO SIGNAL CE AND DE CAUSING THE TIC BACK   05505400
*        TO SEARCH TO EXECUTE.  WHEN ID OF RECORD 0 IS FOUND, CE+DE+SM  05506390
*        IS SIGNALLED.  THE STATUS MODIFIER CAUSES THE TIC TO BE        05507380
*        SKIPPED AND THE FIRST WRITE CKD COMMAND TO BE EXECUTED.  THIS  05508370
*        CAUSES A COUNT AREA, KEY AREA, AND DATA AREA WITH THE LENGTH   05509360
*        SPECIFIED TO BE WRITTEN ON THE DISK.  THE DATA LENGTH WHICH    05510350
*        IS FOUND AT THE CCW DATA ADDRESS SPECIFIES A NORMAL RECORD     05511340
*        DATA LENGTH OF 4096 BYTES.  ALTHOUGH THE CCW COUNT IS ONLY     05512330
*        EIGHT, 4096 BYTES ARE WRITTEN WITH ZEROES INSERTED IN THE      05513320
*        TRACK POSITIONS UNTIL THE BYTE COUNT REACHES ZERO.  NEXT,      05514310
*        A WRITE DATA COMMAND (X'05') IS ISSUED.  THIS MUST BE          05515300
*        CHAINED FROM A SEARCH ID EQUAL COMMAND THAT COMPARED EQUALLY   05516290
*        ON ALL BYTES OF THE SEARCHED FIELD.  HERE THIS IS USED TO      05517280
*        PERFORM RECORD UPDATING AFTER TRACK FORMATTING, AND RECORD 0   05518270
*        IS UPDATED WITH ZEROES.  THE ABOVE DESCRIPTION IS REPEATED     05519260
*        SEVERAL TIMES SO THAT A NUMBER OF TRACKS ARE FORMATTED IN      05520250
*        ONE STRING.  FOR A 3350, FOR EXAMPLE, THE STRINGS FORMAT       05521240
*        FOUR RECORDS PER TRACK, THREE TRACKS AT A TIME, AND CREATES    05522230
*        THIRTY TRACKS PER CYLINDER.                                    05523220
*                                                                       05524210
*        AT THE USER'S OPTION, THE DATA JUST WRITTEN OUT                05525200
*        WITH THE FORMATTING STRING IS THEN VERIFIED FOR CORRECTNESS    05526190
*        BY CHAINING THE FOLLOWING CCWS TO THE LAST WRITE DATA COMMAND  05527180
*        AND IS DONE FOR EACH TRACK:                                    05528170
*            SEEK                                                       05529160
*            SET SECTOR                                                 05530150
*            SEARCH ID EQUAL (RN)                                       05531140
*            TIC *-8                                                    05532130
*            READ DATA (1 PAGE)                                         05533120
*                                                                       05534110
*        THE FORMAT WRITE STRINGS HAVE BEEN MODIFIED HERE TO WRITE      05535100
*        ZERO DATA UPDATING RECORD 0 FOR EACH TRACK LAST FOR BETTER     05536090
*        PERFORMANCE.  RECORD 0 USED TO BE UPDATED FIRST (MORE          05537080
*        LOGICAL?) - BUT THIS WAS NOT NECESSARY.  ISSUING THE WRITE     05538070
*        DATA COMMAND FIRST WOULD CAUSE ADDITIONAL SEARCH TIME FOR      05539060
*        RECORD 0 AND POSSIBLY EXTRA REVOLUTIONS.  THIS MODIFICATION    05540050
*        IMPROVES USER PERFORMANCE IN FORMATTING.                       05541040
*                                                                       05542030
*---------------------------------------------------------------------- 05543020
         SPACE ,                                                        05544010
         DS    0D                                                       05545000
FMT3330  CCW   07,SEEKA,CC+SILI,6      SEEK                             05545990
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    05546980
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05547970
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05548960
         CCW   08,*-8,0,0              TIC BACK TO SEARCH               05549950
         CCW   29,REC1,CC+SILI,8       WRITE 4096 PAGE                  05550940
         CCW   29,RECX1,CC+SILI,8      WRITE FILLER                     05551930
         CCW   29,REC2,CC+SILI,8       WRITE 4096 PAGE                  05552920
         CCW   29,RECX2,CC+SILI,8      WRITE FILLER                     05553910
         CCW   29,REC3,CC+SILI,8       WRITE 4096 PAGE                  05554900
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05555890
         CCW   08,*-8,0,0              TIC BACK                         05556880
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   05557870
         CCW   07,SEEKB,CC+SILI,6      SEEK                             05558860
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05559850
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05560840
         CCW   08,*-8,0,0              TIC BACK                         05561830
         CCW   29,REC4,CC+SILI,8       WRITE 4096 PAGE                  05562820
         CCW   29,RECX4,CC+SILI,8      WRITE FILLER                     05563810
         CCW   29,REC5,CC+SILI,8       WRITE 4096 PAGE                  05564800
         CCW   29,RECX5,CC+SILI,8      WRITE FILLER                     05565790
         CCW   29,REC6,CC+SILI,8       WRITE 4096 PAGE                  05566780
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05567770
         CCW   08,*-8,0,0              TIC                              05568760
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   05569750
         CCW   07,SEEKC,CC+SILI,6      SEEK                             05570740
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05571730
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05572720
         CCW   08,*-8,0,0              TIC                              05573710
         CCW   29,REC7,CC+SILI,8       WRITE 4096 PAGE                  05574700
         CCW   29,RECX7,CC+SILI,8      WRITE FILLER                     05575690
         CCW   29,REC8,CC+SILI,8       WRITE 4096 PAGE                  05576680
         CCW   29,RECX8,CC+SILI,8      WRITE FILLER                     05577670
         CCW   29,REC9,CC+SILI,8       WRITE 4096 PAGE                  05578660
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05579650
         CCW   08,*-8,0,0              TIC BACK                         05580640
         SPACE ,                                                        05581630
*---------------------------------------------------------------------- 05582620
* NEXT EQU STMT IS USED FOR WRITE VERIFICATION SUPPORT/NON-SUPPORT      05583610
*---------------------------------------------------------------------- 05584600
         SPACE ,                                                        05585590
BFORWR57 EQU   *                       CCW BEFORE WR57 LABEL            05586580
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   05587570
WR57     CCW   08,NEXTWRT,0,0          USED ON 57TH RECORD              05588560
NEXTWRT  CCW   07,SEEKD,CC+SILI,6      SEEK                             05589550
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05590540
         CCW   49,SEEKD+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05591530
         CCW   08,*-8,0,0              TIC                              05592520
         CCW   29,REC10,CC+SILI,8      WRITE 4096 PAGE                  05593510
         CCW   29,RECX10,CC+SILI,8     WRITE FILLER                     05594500
         CCW   29,REC11,CC+SILI,8      WRITE 4096 PAGE                  05595490
         CCW   29,RECX11,CC+SILI,8     WRITE FILLER                     05596480
         CCW   29,REC12,CC+SILI,8      WRITE 4096 PAGE                  05597470
         CCW   49,SEEKD+2,CC+SILI,5    SEARCH ID EQ RECORD 0            05598460
         CCW   08,*-8,0,0              TIC BACK                         05599450
EWT3330  EQU   *                       ADDRESS OF LAST WRT CCW          05600440
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   05601430
         CCW   8,READCCW,0,0           GO READ/VERIFY TRACKS            05602420
         SPACE ,                                                        05603410
*---------------------------------------------------------------------- 05604400
*        2305 FORMAT CCWS                                               05605390
*---------------------------------------------------------------------- 05606380
         SPACE ,                                                        05607370
         DS    0D                                                       05608360
FMT2305  CCW   07,SEEKA,CC+SILI,6      SEEK                             05609350
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    05610340
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05611330
         CCW   21,SEEKA+2,CC+SILI,16   WRITE RECORD ZERO                05612320
         CCW   29,REC1,CC+SILI,8       WRITE 4096 PAGE                  05613310
         CCW   29,RECX1,CC+SILI,8      WRITE FILLER                     05614300
         CCW   29,REC2,CC+SILI,8       WRITE 4096 PAGE                  05615290
         CCW   29,RECX2,CC+SILI,8      WRITE FILLER                     05616280
         CCW   29,REC3,CC+SILI,8       WRITE 4096 PAGE                  05617270
         CCW   07,SEEKB,CC+SILI,6      SEEK                             05618260
         CCW   21,SEEKB+2,CC+SILI,16   WRITE RECORD ZERO                05619250
         CCW   29,REC4,CC+SILI,8       WRITE 4096 PAGE                  05620240
         CCW   29,RECX4,CC+SILI,8      WRITE FILLER                     05621230
         CCW   29,REC5,CC+SILI,8       WRITE 4096 PAGE                  05622220
         CCW   29,RECX5,CC+SILI,8      WRITE FILLER                     05623210
         CCW   29,REC6,CC+SILI,8       WRITE 4096 PAGE                  05624200
         CCW   07,SEEKC,CC+SILI,6      SEEK                             05625190
         CCW   21,SEEKC+2,CC+SILI,16   WRITE RECORD ZERO                05626180
         CCW   29,REC7,CC+SILI,8       WRITE 4096 PAGE                  05627170
         CCW   29,RECX7,CC+SILI,8      WRITE FILLER                     05628160
         CCW   29,REC8,CC+SILI,8       WRITE 4096 PAGE                  05629150
         CCW   29,RECX8,CC+SILI,8      WRITE FILLER                     05630140
         CCW   29,REC9,CC+SILI,8       WRITE 4096 PAGE                  05631130
         CCW   07,SEEKD,CC+SILI,6      SEEK                             05632120
         CCW   21,SEEKD+2,CC+SILI,16   WRITE RECORD ZERO                05633110
         CCW   29,REC10,CC+SILI,8      WRITE 4096 PAGE                  05634100
         CCW   29,RECX10,CC+SILI,8     WRITE FILLER                     05635090
         CCW   29,REC11,CC+SILI,8      WRITE 4096 PAGE                  05636080
         CCW   29,RECX11,CC+SILI,8     WRITE FILLER                     05637070
         CCW   29,REC12,CC+SILI,8      WRITE 4096 PAGE                  05638060
         CCW   TIC,READCCW,0,0         GO READ THE TRACKS               05639050
         SPACE ,                                                        05640040
*---------------------------------------------------------------------- 05641030
*        READ/VERIFY CCWS FOR NORMAL RECORDS (3330 AND 2305)            05642020
*---------------------------------------------------------------------- 05643010
         SPACE ,                                                        05644000
READCCW  CCW   07,SEEKA,CC+SILI,6      SEEK                             05644990
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05645980
         CCW   49,REC1,CC+SILI,5       SEARCH ID EQUAL                  05646970
         CCW   08,*-8,0,0              TIC BACK                         05647960
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05648950
         CCW   49,REC2,CC+SILI,5       SEARCH ID EQUAL                  05649940
         CCW   08,*-8,0,0              TIC BACK                         05650930
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05651920
         CCW   49,REC3,CC+SILI,5       SEARCH ID EQUAL                  05652910
         CCW   08,*-8,0,0              TIC BACK                         05653900
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05654890
         CCW   07,SEEKB,CC+SILI,6      SEEK                             05655880
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05656870
         CCW   49,REC4,CC+SILI,5       SEARCH ID EQUAL                  05657860
         CCW   08,*-8,0,0              TIC BACK                         05658850
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05659840
         CCW   49,REC5,CC+SILI,5       SEARCH ID EQUAL                  05660830
         CCW   08,*-8,0,0              TIC BACK                         05661820
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05662810
         CCW   49,REC6,CC+SILI,5       SEARCH ID EQUAL                  05663800
         CCW   08,*-8,0,0              TIC BACK                         05664790
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05665780
         CCW   07,SEEKC,CC+SILI,6      SEEK                             05666770
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05667760
         CCW   49,REC7,CC+SILI,5       SEARCH ID EQUAL                  05668750
         CCW   08,*-8,0,0              TIC BACK                         05669740
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05670730
         CCW   49,REC8,CC+SILI,5       SEARCH ID EQUAL                  05671720
         CCW   08,*-8,0,0              TIC BACK                         05672710
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05673700
         CCW   49,REC9,CC+SILI,5       SEARCH ID EQUAL                  05674690
         CCW   08,*-8,0,0              TIC BACK                         05675680
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               05676670
RD57     CCW   08,NEXTREAD,0,0         USED ON 57TH REC                 05677660
NEXTREAD CCW   07,SEEKD,CC+SILI,6      SEEK                             05678650
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       05679640
         CCW   49,REC10,CC+SILI,5      SEARCH ID EQUAL                  05680630
         CCW   08,*-8,0,0              TIC BACK                         05681620
         CCW   06,0,CC+SKIP,4096       READ DATA 1 PAGE                 05682610
         CCW   49,REC11,CC+SILI,5      SEARCH ID EQUAL                  05683600
         CCW   08,*-8,0,0              TIC BACK                         05684590
         CCW   06,0,CC+SKIP,4096       READ DATA 1 PAGE                 05685580
         CCW   49,REC12,CC+SILI,5      SEARCH ID EQUAL                  05686570
         CCW   08,*-8,0,0              TIC BACK                         05687560
         CCW   06,0,CC+SKIP,4096       READ DATA 1 PAGE                 05688550
         CCW   08,BITMAP,0,0           TIC TO WRITE REC 0 BIT MAP       05689540
         SPACE ,                                                        05690530
ON57WRT  CCW   08,READCCW,0,0          USED TO ALTER OTHER TICS         05691520
OFF57WRT CCW   08,NEXTWRT,0,0          USED TO ALTER OTHER TICS         05692510
ON57RD   CCW   08,BITMAP,0,0           USED TO ALTER OTHER TICS         05693500
OFF57RD  CCW   08,NEXTREAD,0,0         USED TO ALTER OTHER TICS         05694490
*---------------------------------------------------------------------- 05695480
*        CCWS FOR SPECIAL INFORMATION ON CYLINDER 0                     05696470
*---------------------------------------------------------------------- 05697460
         SPACE ,                                                        05698450
SPEC2314 CCW   07,SEEKA,CC+SILI,6      SEEK CYLINDER 0 HEAD 0           05699440
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    05700430
         CCW   25,SEEKA+1,CC+SILI,5    WRITE HOME ADDRESS               05701420
         CCW   21,SEEKA+2,CC+SILI,16   WRITE RECORD 0                   05702410
         CCW   29,R1SPEC,CC+SILI,8+24  WRITE IPL RECORD                 05703400
         CCW   29,R2SPEC,CC+SILI,8     WRITE RECORD 2                   05704390
         CCW   29,R3VOL1,CC+SILI,8+84  WRITE VOL1 OS LABEL              05705380
         CCW   29,R4COUNT,CC+SILI,8+1024 WRITE ALLOCATION MAP           05706370
         CCW   29,FORMAT4,CC+SILI,8+140  WRITE FORMAT4 RECORD           05707360
         CCW   29,FORMAT5,CC+SILI,8+140  WRITE FORMAT5 RECORD           05708350
         CCW   07,SEEKB,CC+SILI,6      SEEK                             05709340
         CCW   25,SEEKB+1,CC+SILI,5    WRITE HOME ADDRESS               05710330
         CCW   21,SEEKB+2,CC+SILI,16   WRITE RECORD 0                   05711320
         CCW   29,RF3,CC+SILI,8        WRITE ONE PAGE RECORD            05712310
         CCW   29,RF4SPEC,CC+SILI,8    WRITE FILLER                     05713300
         CCW   01,R4SPEC,CC+SILI,8     WRITE SPECIAL CKD INFO           05714290
VERIFY   CCW   07,SEEKA,CC+SILI,6      SEEK                             05715280
         CCW   26,0,CC+SKIP,5          READ HOME ADDRESS                05716270
         CCW   22,0,CC+SKIP,16         READ RECORD 0                    05717260
         CCW   30,0,CC+SKIP,8+24       READ CKD IPL RECORD              05718250
         CCW   30,0,CC+SKIP,8+4096     READ CKD PAGE RECORD             05719240
         CCW   30,0,CC+SKIP,8+84       READ CKD VOL1 LABEL              05720230
         CCW   30,0,CC+SKIP+SILI,8+2048 READ CKD ALLO MAP               05721220
         CCW   30,0,CC+SKIP,8+140      READ CKD FORMAT4 RECORD          05722210
         CCW   30,0,CC+SKIP,8+140      READ CKD FORMAT5 RECORD          05723200
GO       CCW   08,GO2314,0,0           2314, 3330, 3340, 3380           05724190
*                                      DEPENDS ON DEVICE                05725180
GO2314   CCW   07,SEEKB,CC+SILI,6      SEEK TRACK 1                     05726170
         CCW   26,0,CC+SKIP,5          READ HOME ADDRESS                05727160
         CCW   22,0,CC+SKIP,16         READ RECORD 0                    05728150
         CCW   30,0,CC+SKIP,8+4096     READ CKD F3 PAGE                 05729140
         CCW   30,0,CC+SKIP,8+1624     READ CKD FILLER                  05730130
         CCW   49,R4SPEC,CC+SILI,5     SEARCH ID EQUAL REC 4            05731120
         CCW   08,*-8,0,0              TIC BACK                         05732110
         CCW   06,0,SKIP,4096          READ RECORD 4 FULLY              05733100
         SPACE ,                                                        05734090
GO3330   CCW   30,0,SKIP+SILI,8+4096   READ F3 PAGE RECORD              05735080
*---------------------------------------------------------------------- 05736070
*        CCW TO PICKUP BROKEN CCW CHAIN                                 05737060
*---------------------------------------------------------------------- 05738050
         SPACE ,                                                        05739040
RESUMCCW CCW   31,FILEMASK,CC+SILI,1                                    05740030
         CCW   08,0,0,0                                                 05741020
         DS    0F                                                       05742010
         DS    1H                                                       05743000
SEEKA    DC    H'0'           BB                                        05743990
         DC    F'0'           CCHH  -  SEEK HEAD 0                      05744980
         DC    F'8'           REC NO. AND DL OR R0                      05745970
R0STUF   DC    2F'0'          DATA FIELD OF R0 CYL BIT MAP              05746960
         DS    1H                                                       05747950
NXTSEEK  EQU   *-SEEKA        LENGTH OF ONE SEEK DATA FIELD             05748940
SEEKB    DC    H'0'           BB                                        05749930
         DC    F'1'           CCHH  -  SEEK HEAD 1                      05750920
         DC    F'8'           REC NO. AND DL OR R0                      05751910
         DC    2F'0'                                                    05752900
         DS    1H                                                       05753890
SEEKC    DC    H'0'                                                     05754880
         DC    F'2'                                                     05755870
         DC    F'8'                                                     05756860
         DC    2F'0'                                                    05757850
         DS    1H                                                       05758840
SEEKD    DC    H'0'                                                     05759830
         DC    F'3'                                                     05760820
         DC    F'8'                                                     05761810
         DC    2F'0'                                                    05762800
         DS    1H                                                       05763790
SEEKE    DC    H'0'                                                     05764780
         DC    F'4'                                                     05765770
         DC    F'8'                                                     05766760
         DC    2F'0'                                                    05767750
         DS    1H                                                       05768740
SEEKF    DC    H'0'                                                     05769730
         DC    F'5'                                                     05770720
         DC    F'8'                                                     05771710
         DC    2F'0'                                                    05772700
*---------------------------------------------------------------------- 05773690
*        SAVE RECORD INFORMATION                                        05774680
*---------------------------------------------------------------------- 05775670
         SPACE ,                                                        05776660
R1SPEC   DC    F'0'           IPL RECORD SAVE AREA                      05777650
         DC    AL1(1),AL3(24) AREA SIZE = 8+24 BYTES                    05778640
IPLREC   DC    X'000200000000000C' IPL RECORD (24 BYTES)                05779630
         DC    X'0300',H'0'                                             05780620
         DC    X'2000',H'0'                                             05781610
         DC    2F'0'                                                    05782600
         SPACE ,                                                        05783590
R2SPEC   DC    F'0'           RECORD 2 (DMKCKP) SAVE AREA               05784580
         DC    AL1(2),AL3(4096)                                         05785570
         SPACE ,                                                        05786560
R3VOL1   DC    F'0'           VOL1 OS LABEL RECORD - VOL1 COUNT         05787550
         DC    AL1(3),AL1(4),AL2(80)  REC KL DL DL                      05788540
VOL1     DC    C'VOL1'                KEY                               05789530
DSFLABEL DS    0CL512                 512 BYTES FOR USER LABEL          05790520
OSLABEL  DS    0CL80                   80 BYTES FOR OS LABEL            05791510
         DC    C'VOL1'                                                  05792500
CPLABEL  DC    C' NONE '      LABEL PLACED HERE                         05793490
         DC    X'F0'                                                    05794480
VTOCBEG  DC    XL4'0'         PTR TO VTOC IN R3 (CCHH)                  05795470
VTOCR    DC    X'05'          PTR TO VTOC IN R3 (R)                     05796460
         DC    XL5'0'                                                   05797450
         DC    20XL1'40'                                                05798440
         DC    XL5'00'                                                  05799430
         SPACE ,                                                        05800420
LCP370   DC    CL5'CP370'     VOLUME OWNER                              05801410
         DC    29XL1'40'                                                05802400
* END OF OS LABEL AREA                                                  05803390
         DS    CL432                                                    05804380
* END OF USER LABEL AREA                                                05805370
         CNOP  2,4                                                      05806360
R4SEEK   DC    H'0'                                                     05807350
R4ALLOC  DC    F'0'           CCHH                                      05808340
         DC    AL1(04)        RECORD NUMBER = 4                         05809330
         DC    AL1(0)         KL = 0                                    05810320
R4DL     DC    AL2(0)         DL=1024, 2048, OR 4096                    05811310
CHARSAVE DS    CL9            SAVE AREA FOR INPUT CYL NUMBERS           05812300
CHARMASK DC    XL9'F0F0F0F040F0F0F0F0'  MASK FOR CYL NUMBERS            05813290
         SPACE ,                                                        05814280
FORMAT4  DC    F'00'                        CCHH                        05815270
         DC    AL1(5),AL1(44),AL2(96)       REC KL DL DL                05816260
         DC    44XL1'04'            KEY OF HEX 04                       05817250
FMT4DATA DC    X'F4'          FMT4 DSCB IDENTIFIER                      05818240
         DC    X'0000000000'          CCHHR                             05819230
         DC    X'0000'                                                  05820220
         SPACE ,                                                        05821210
NEXTCCHH DC    XL4'0'         CCHH OF NEXT AVAIL. ALT TRK               05822200
         DC    X'0000'                                                  05823190
         DC    X'00'          VTOC INDICATORS                           05824180
         DC    X'01003C00140014'                                        05825170
         DC    X'1C7E922D2D'                                            05826160
         DC    X'0102160202'                                            05827150
         DC    XL29'00'                                                 05828140
         DC    X'00'          TRACK ZERO                                05829130
         DC    XL8'00'                                                  05830120
         DC    X'00'          TRACK ZERO                                05831110
         DC    XL25'00'                                                 05832100
         SPACE ,                                                        05833090
FORMAT5  DC    F'0'                         CCHH                        05834080
         DC    AL1(6),AL1(44),AL2(96)       REC KL DL DL                05835070
         DC    4XL1'05'                                                 05836060
         DC    X'0001000000'  TRACK ZERO NO CYLINDERS NO TRACKS         05837050
         DC    XL35'00'                                                 05838040
         DC    X'F5'                                                    05839030
         DC    XL90'00'                                                 05840020
         DC    XL5'00'                                                  05841010
         SPACE ,                                                        05842000
RF3      DC    F'1'           PAGE SIZE FILLER RECORD                   05842990
         DC    X'F3',AL3(4096)                                          05843980
RF4SPEC  DC    F'1'           FILLER RECORD                             05844970
         DC    X'F4',AL3(1624)                                          05845960
R4SPEC   DC    F'1'           SPECIAL CKD INFO                          05846950
         DC    AL1(4),AL3(824)                                          05847940
RF33330  DC    F'0'           FILLER RECORD FOR 3330/2305               05848930
         DC    X'F3',AL3(4096)                                          05849920
         SPACE ,                                                        05850910
*---------------------------------------------------------------------- 05851900
*        SPECIAL RECORDS FOR 3380 CYL0 TRK0                             05852890
*---------------------------------------------------------------------- 05853880
         SPACE ,                                                        05854870
RF43380  DC    F'0'           FILLER RECORDS FOR 3380                   05855860
         DC    AL1(244),AL3(4096) REC NUMBER KL DL DL                   05856850
RF53380  DC    F'0'           CCHH FOR FILLER                           05857840
         DC    AL1(245),AL3(4096) REC NUMBER KL DL DL                   05858830
RF63380  DC    F'0'           CCHH FOR FILLER                           05859820
         DC    AL1(246),AL3(4096) REC NUMBER KL DL DL                   05860810
RF73380  DC    F'0'           CCHH FOR FILLER                           05861800
         DC    AL1(247)       RECORD NUMBER = 247                       05862790
         DC    AL1(0)         KEY LENGTH = 0                            05863780
RF7DL    DC    AL2(0)         DATA LENGTH IS 4K FOR 3380 MOD1          C05864770
                              3K FOR 3380-2, 1K FOR 3380-3              05865760
RF83380  DC    F'0'           CCHH FOR FILLER                           05866750
         DC    AL1(248),AL3(400)  REC NUMBER KL DL DL                   05867740
RS73380  DC    F'0'           VALID PAGE RECORDS FOR 3380               05868730
         DC    AL1(007),AL3(4096) REC NUMBER KL DL DL                   05869720
RS83380  DC    F'0'           CCHH FOR RECORD                           05870710
         DC    AL1(008),AL3(4096) REC NUMBER KL DL DL                   05871700
RS93380  DC    F'0'           CCHH FOR RECORD                           05872690
         DC    AL1(009),AL3(4096) REC NUMBER KL DL DL                   05873680
RSA3380  DC    F'0'           CCHH FOR RECORD                           05874670
         DC    AL1(010),AL3(4096) REC NUMBER KL DL DL                   05875660
         SPACE ,                                                        05876650
*---------------------------------------------------------------------- 05877640
*        2314 NORMAL DATA RECORDS                                       05878630
*---------------------------------------------------------------------- 05879620
         SPACE ,                                                        05880610
R1STUF   DC    F'0'                                                     05881600
         DC    AL1(1),AL3(4096)                                         05882590
R2STUF   DC    F'0'                                                     05883580
         DC    AL1(2),AL3(2472)                                         05884570
R2ASTUF  DC    F'1'                                                     05885560
         DC    AL1(2),AL3(1624)                                         05886550
R3STUF   DC    F'1'                                                     05887540
         DC    AL1(3),AL3(4096)                                         05888530
R4STUF   DC    F'1'                                                     05889520
         DC    AL1(4),AL3(824)                                          05890510
R4ASTUF  DC    F'2'                                                     05891500
         DC    AL1(4),AL3(3272)                                         05892490
R5STUF   DC    F'2'                                                     05893480
         DC    AL1(5),AL3(3296)                                         05894470
R5ASTUF  DC    F'3'                                                     05895460
         DC    AL1(5),AL3(800)                                          05896450
R6STUF   DC    F'3'                                                     05897440
         DC    AL1(6),AL3(4096)                                         05898430
R7STUF   DC    F'3'           SPECIAL CKD RECORD                        05899420
         DC    AL1(7),AL3(1648)                                         05900410
R7ASTUF  DC    F'4'                                                     05901400
         DC    AL1(7),AL3(2448)                                         05902390
R8STUF   DC    F'4'                                                     05903380
         DC    AL1(8),AL3(4096)                                         05904370
RNR1STUF EQU   *-R1STUF       NUMBER OF BYTES FOR 2314 CCW DATA         05905360
         LTORG ,                                                        05906350
MCYL3382 DC    H'1769'        HIGHEST CYLINDER ON 3380-2                05907340
MCYL3383 DC    H'2654'        3380 EXPANDED FEATURE                     05908330
FLAG     DC    X'00'          A OR F                                    05909320
         SPACE ,                                                        05910310
TYPE     DC    X'00'          DEVICE TYPE                               05911300
*        THIS FIELD AND THE BITS IN IT ARE USED DIFFERENTLY THAN THE    05912290
*        FIELD RDEVTYPE IN THE REST OF THE VM/SP CODE.                  05913280
*        TESTED WITH CLI INSTRUCTION EXCEPT FOR DEVICE TYPE TYP2305X    05914270
*        WHERE TM IS USED SOMETIMES                                     05915260
TYP2314  EQU   X'14'          2314 DEVICE CODE                          05916250
TYP2319  EQU   X'14'          2319 DEVICE CODE, SAME AS 2314            05917240
TYP23051 EQU   X'51'          2305 DEVICE CODE MODEL 1                  05918230
TYP23052 EQU   X'52'          2305 DEVICE CODE MODEL 2                  05919220
TYP3330  EQU   X'30'          3330 DEVICE CODE                          05920210
TYP334X  EQU   X'40'          3340/3344 DEVICE CODE                     05921200
TYP3350  EQU   X'60'          3350 DEVICE CODE                          05922190
TYP3380  EQU   X'20'          3380 DEVICE CODE                          05923180
RDEVMD82 EQU   X'08'          3380 MODEL 2                              05924170
RDEVMD83 EQU   X'0C'          3380 MODEL 3                              05925160
         SPACE ,                                                        05926150
CUBSY    EQU   X'50'          CONTROL UNIT BUSY IN CSW                  05927140
CUEND    EQU   X'20'          CONTROL UNIT END IN CSW                   05928130
         SPACE ,                                                        05929120
CSWCDE   EQU   X'04'          MASK FOR CSW STORED CC AFTER IO           05930110
BSY      EQU   X'02'          MASK FOR BUSY CC AFTER IO OP              05931100
NOPER    EQU   X'01'          MASK FOR NOT OPERATIONAL CC               05932090
         SPACE ,                                                        05933080
FLNGDRCT EQU   X'10'          SENSE CODE FOR FAILING DIRECTOR           05934070
         SPACE ,                                                        05935060
*---------------------------------------------------------------------- 05936050
*        CYLINDER IS FORMATTED IN A CERTAIN NUMBER OF PASSES DEPENDING  05937040
*        ON THE D/T OF THE DASD. A PASS CONSISTS OF 3 OR MORE WHOLE     05938030
*        TRACKS.                                                        05939020
*---------------------------------------------------------------------- 05940010
         SPACE ,                                                        05941000
RN3380   EQU   30             NUMBER OF PAGES/PASS FOR 3380             05941990
RN3350   EQU   12             NUMBER OF PAGES/PASS FOR 3350             05942980
RN3340   EQU   12             NUMBER OF PAGES/PASS FOR 3340             05943970
RN3330   EQU   12             NUMBER OF PAGES/PASS FOR 3330             05944960
RN2314   EQU   8              NUMBER OF PAGES/PASS FOR 2314             05945950
RN2305   EQU   12             NUMBER OF PAGES/PASS FOR 2305             05946940
         SPACE ,                                                        05947930
TRPP3380 EQU   3              NUMBER OF TRACKS/PASS FOR 3380            05948920
TRPP3350 EQU   3              NUMBER OF TRACKS/PASS FOR 3350            05949910
TRPP3340 EQU   6              NUMBER OF TRACKS/PASS FOR 3340            05950900
TRPP3330 EQU   4              NUMBER OF TRACKS/PASS FOR 3330            05951890
TRPP2314 EQU   5              NUMBER OF TRACKS/PASS FOR 2314            05952880
TRPP2305 EQU   4              NUMBER OF TRACKS/PASS FOR 2305            05953870
         SPACE ,                                                        05954860
*---------------------------------------------------------------------- 05955850
*        THE FOLLOWING RECORD/PASS NUMBERS CONTAIN PAGE RECORDS AND     05956840
*        FILLER RECORDS. ACCORDING TO THE DATA STRUCTURE, FOR SOME D/T, 05957830
*        MORE RECORDS ARE UPDATED THAN ARE ACTUALLY WRITTEN.            05958820
*---------------------------------------------------------------------- 05959810
         SPACE ,                                                        05960800
RNRC3380 EQU   RNBYTES/8      NUMBER OF 3380 RECORDS TO UPDATE          05961790
RNRC3350 EQU   RNBYTE1/8      NUMBER OF 3350 RECORDS TO UPDATE          05962780
RNRC3340 EQU   RNBYTE1/8      NUMBER OF 3340 RECORDS TO UPDATE          05963770
RNRC3330 EQU   RNBYTE1/8      NUMBER OF 3330 RECORDS TO UPDATE          05964760
RNRC2314 EQU   RNR1STUF/8     NUMBER OF 2314 RECORDS TO UPDATE          05965750
RNRC2305 EQU   RNBYTE1/8      NUMBER OF 2305 RECORDS TO UPDATE          05966740
         SPACE ,                                                        05967730
MREC3380 EQU   150            NUMBER OF PAGES  /CYL FOR 3380            05968720
         SPACE ,                                                        05969710
RNTR3380 EQU   13             #RECS IN 1 LOC REC 3380 = 1 TRACK         05970700
         SPACE ,                                                        05971690
*---------------------------------------------------------------------- 05972680
*        NUMBER OF RECORDS PER LOCATE RECORD WHEN WRITING TO            05973670
*        CYL. 0, TRACK 0:                                               05974660
*        RECORD 0                                                       05975650
*        STANDARD RECORDS 1 TO 6                                        05976640
*        X FILLER RECORDS                                               05977630
*        Y PAGE RECORDS                                                 05978620
*        (BOTH ARE DEVICE DEPENDENT)                                    05979610
*---------------------------------------------------------------------- 05980600
         SPACE ,                                                        05981590
RNT03380 EQU   7+5+4          NO. RECS IN LOC. REC FOR CYL0/TR0         05982580
*                             3380: X = 5, Y = 4                        05983570
         SPACE ,                                                        05984560
MHD3380  EQU   14             MAX HEAD # FOR 3380 (HEADS 0-14)          05985550
         SPACE ,                                                        05986540
*---------------------------------------------------------------------- 05987530
*        THE TRANSFER LENGTH FACTOR FOR VARIABLE LENGTH RECORDS         05988520
*        IS CALCULATED AS FOLLOWS:                                      05989510
*        SUMMATION (DATA LENGTH + KEY LENGTH)/ ( # OF RECORDS)          05990500
*        (EXCLUDING RECORD 0 IN THE RECORD COUNT)                       05991490
*---------------------------------------------------------------------- 05992480
         SPACE ,                                                        05993470
TLFM3380 EQU   3482           AVERAGE TLF FOR FORMATTING 3380           05994460
         SPACE ,                                                        05995450
TLFX3380 EQU   2578           AVERAGE TLF FOR WRITING CYL0 TRK0         05996440
         SPACE ,                                                        05997430
ERBT3380 EQU   X'FC'          RECORDS TO CHECK/RECORDS TO SHOW IN USE   05998420
RECN0    EQU   X'00'          RECORD NUMBER 0                           05999410
RECN1    EQU   X'01'          RECORD NUMBER 1                           06000400
RECN2    EQU   X'02'          RECORD NUMBER 2                           06001390
RECN4    DC    X'04'          RECORD NUMBER 4                           06002380
         SPACE ,                                                        06003370
DEFEXT   EQU   X'63'          DEFINE EXTENT OP CODE                     06004360
E4       EQU   X'E4'          E4 SENSE OP CODE                          06005350
LOCREC   EQU   X'47'          LOCATE RECORD OP CODE                     06006340
SEEK     EQU   X'07'          SEEK                                      06007330
SFM      EQU   X'1F'          SET FILE MASK                             06008320
STSCTR   EQU   X'23'          SET SECTOR                                06009310
SIEQ     EQU   X'31'          SEARCH ID EQUAL                           06010300
TIC      EQU   X'08'          TRANSFER IN CHANNEL PROGRAM               06011290
READ     EQU   X'06'          READ DATA                                 06012280
RDREC0   EQU   X'16'          READ RECORD ZERO OP CODE                  06013270
RHADDR   EQU   X'1A'          READ HOME ADDRESS OP CODE                 06014260
RCKD     EQU   X'1E'          READ COUNT-KEY-DATA OP CODE               06015250
WCKD     EQU   X'1D'          WRITE COUNT-KEY-DATA                      06016240
WSCKD    EQU   X'01'          WRITE SPECIAL COUNT-KEY-DATA              06017230
WRTD     EQU   X'05'          WRITE DATA                                06018220
WTREC0   EQU   X'15'          WRITE RECORD 0 OP CODE                    06019210
WHADDR   EQU   X'19'          WRITE HOME ADDRESS OP CODE                06020200
SENSEIO  EQU   X'04'          SENSE I/O                                 06021190
NOPCCW   EQU   X'03'          NO-OPERATION CCW                          06022180
         SPACE ,                                                        06023170
COMMA    EQU   C','           CHARACTER COMMA                           06024160
BLANK    EQU   1              A SINGLE BLANK IN BET. NAME & CYL         06025150
CYLNUM   EQU   4              4 DIGIT START/ENDING CYL NUMBERS          06026140
NAMCHARS EQU   4              CHARS AS 'PERM', 'TEMP', ... ETC.         06027130
         SPACE ,                                                        06028120
         SPACE ,                                                        06029110
DSKADD   DC    H'0'           DEVICE ADDRESS                            06030100
CONSOL   DC    H'9'           CONSOLE DEFAULT ADDRESS                   06031090
CON01F   DC    X'001F'        CONSOLE ADDRESS 001F                      06032080
ADDR1    DC    X'5B5F'        LOCATION LINE 22 COL 80                   06033070
ADDR2    DC    X'5D6B'        LOCATION LINE 24 COL 60                   06034060
ADDR3    DC    X'D65F'        LOCATION LINE 18 COL 80                   06035050
ADDR4    DC    X'D86B'        LOCATION LINE 20 COL 60                   06036040
ADDR5    DC    X'4040'        INITIALIZED ADDR                          06037030
ADDR6    DC    X'5B60'        LOCATION LINE 23 COL 01                   06038020
ADDR7    DC    X'D660'        LOCATION LINE 19 COL 01                   06039010
         DS    0F                                                       06040000
MAXLEN   DC    F'0000'                                                  06040990
LEN3270  DC    F'1760'        3270 MOD2 24 LINE CONSOLE/TERM            06041980
LEN3278  DC    F'1440'        3278 MOD2A 20 LINE CONSOLE                06042970
         SPACE ,                                                        06043960
         DS    0D                                                       06044950
WTPSW    DC    X'00020000'    HARD WAIT PSW FOR PROG/MACH CHK           06045940
         DC    F'0'                                                     06046930
PRNUPSW  DC    F'0',A(PRCHK)  PROGRAM NEW PSW                           06047920
MCNUPSW  DC    F'0',A(MCRTN)  MACHINE CHECK NEW PSW                     06048910
         SPACE ,                                                        06049900
INDATA   DC    132X'00'       INPUT DATA AREA                           06050890
FILEMASK DC    X'C0'          ALLOW WRITE OPERATIONS                    06051880
MASKA    DC    XL8'F0F0F0F0F0F0F0F0' MASKS FOR DETERMINING IF           06052870
MASKB    DC    XL8'F0F0F0F0F0F0F0F0' DATA IS ALL NUMERIC                06053860
         SPACE ,                                                        06054850
FIELDA   DC    D'0'           PACK/UNPACK DATA FIELD                    06055840
FIELDB   DC    D'0'           PACK/UNPACK DATA FIELD                    06056830
FIELDC   DC    D'0'           PACK/UNPACK DATA FIELD                    06057820
BLANKS8  DC    X'4040404040404040' BLANKS                               06058810
FFS8     DC    X'FFFFFFFFFFFFFFFF' FFS                                  06059800
TTAB     DC    C'0123456789ABCDEF' TRANSLATE TABLE                      06060790
         SPACE ,                                                        06061780
TIC3380  CCW   TIC,SPEC3380,0,0 MODIFYING CCW FOR 3380 WRITES           06062770
WRT3340  CCW   WCKD,RF33330,CC+SILI,8 TO REPLACE 3380 MOD CCW           06063760
SPEC3330 CCW   07,SEEKA,CC+SILI,6      SEEK CYL 0 HEAD 0                06064750
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    06065740
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06066730
         CCW   08,*-8,0,0              TIC BACK                         06067720
         CCW   05,R0STUF,CC+SILI,8     WRITE RECORD 0                   06068710
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06069700
         CCW   08,*-8,0,0              TIC BACK TO SEARCH               06070690
         CCW   29,R1SPEC,CC+SILI,8+24  WRITE IPL RECORD                 06071680
         CCW   29,R2SPEC,CC+SILI,8     WRITE RECORD                     06072670
         CCW   29,R3VOL1,CC+SILI,8+84  WRITE VOL1 OS LABEL              06073660
         CCW   29,R4COUNT,CC+SILI,8+DL4096  ALLOCATION MAP              06074650
*              R4 IS 4K FOR 3380-3, 2K FOR 3380-2, ELSE 1K              06075640
*              CHAN WILL PAD END OF DATA WITH 0'S                       06076630
         CCW   29,FORMAT4,CC+SILI,8+140  WRITE FORMAT4 RECORD           06077620
         CCW   29,FORMAT5,CC+SILI,8+140  WRITE FORMAT5 RECORD           06078610
NOP3340  CCW   29,RF33330,CC+SILI,8    WRITE 1 PAGE RECORD              06079600
         CCW   08,VERIFY,0,0           VERIFY WHAT WAS WRITTEN          06080590
         SPACE ,                                                        06081580
         DS    0D                                                       06082570
RDFMT4   CCW   7,SEEKA,CC,6            RD FMT4 AS SPEC. IN VTOC         06083560
         CCW   31,FILEMASK,CC,1        SET FILE MASK                    06084550
         CCW   49,VTOCBEG,CC+SILI,5    SEARCH ID EQ                     06085540
         CCW   8,*-8,0,0               TIC                              06086530
         CCW   6,FMT4DATA,SILI,96      READ FMT4 LABEL                  06087520
*---------------------------------------------------------------------- 06088510
*        3380 FORMAT CYLINDER 0 TRACK 0 CCWS                            06089500
*---------------------------------------------------------------------- 06090490
         SPACE ,                                                        06091480
SPEC3380 CCW   WCKD,RF43380,CC+SILI,8 WRITE FILLER (1 PAGE)             06092470
         CCW   WCKD,RF53380,CC+SILI,8 WRITE FILLER (1 PAGE)             06093460
         CCW   WCKD,RF63380,CC+SILI,8 WRITE FILLER (1 PAGE)             06094450
         CCW   WCKD,RF73380,CC+SILI,8 WRITE FILLER                      06095440
*              4K IF 3380-0, 3K IF 3380-2, 1K IF 3380-3                 06096430
         CCW   WCKD,RF83380,CC+SILI,8 WRITE FILLER 400 BYTES            06097420
         CCW   WCKD,RS73380,CC+SILI,8 VALID PAGE RECORD                 06098410
         CCW   WCKD,RS83380,CC+SILI,8 VALID PAGE RECORD                 06099400
         CCW   WCKD,RS93380,CC+SILI,8 VALID PAGE RECORD                 06100390
         CCW   WCKD,RSA3380,CC+SILI,8 VALID PAGE RECORD                 06101380
         CCW   TIC,VERIFY,0,0         GO VERIFY SPECIAL RECORDS         06102370
         SPACE ,                                                        06103360
*---------------------------------------------------------------------- 06104350
*        3380 READ/VERIFY CYLINDER 0 TRACK 0 CCWS                       06105340
*---------------------------------------------------------------------- 06106330
         SPACE ,                                                        06107320
VRFY3380 CCW   SEEK,SEEKA,CC+SILI,6   VERIFY CYL0 TRK 0 RECS            06108310
         SPACE ,                                                        06109300
         CCW   SIEQ,RF43380,CC+SILI,5 SEARCH ID EQUAL                   06110290
         CCW   TIC,*-8,0,0            TIC BACK                          06111280
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06112270
         CCW   SIEQ,RF53380,CC+SILI,5 SEARCH ID EQUAL                   06113260
         CCW   TIC,*-8,0,0            TIC BACK                          06114250
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06115240
         CCW   SIEQ,RF63380,CC+SILI,5 SEARCH ID EQUAL                   06116230
         CCW   TIC,*-8,0,0            TIC BACK                          06117220
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06118210
         CCW   SIEQ,RF73380,CC+SILI,5 SEARCH ID EQUAL                   06119200
         CCW   TIC,*-8,0,0            TIC BACK                          06120190
         CCW   READ,0,CC+SKIP+SILI,DL4096 READ DATA                     06121180
*              DATA IS 4K IF 3380, 3K IF 3380-2, 4K IF 3380-3           06122170
         CCW   SIEQ,RF83380,CC+SILI,5 SEARCH ID EQUAL                   06123160
         CCW   TIC,*-8,0,0            TIC BACK                          06124150
         CCW   READ,0,CC+SKIP,400     READ FILLER (RF83380)             06125140
         CCW   SIEQ,RS73380,CC+SILI,5 SEARCH ID EQUAL                   06126130
         CCW   TIC,*-8,0,0            TIC BACK                          06127120
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06128110
         CCW   SIEQ,RS83380,CC+SILI,5 SEARCH ID EQUAL                   06129100
         CCW   TIC,*-8,0,0            TIC BACK                          06130090
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06131080
         CCW   SIEQ,RS93380,CC+SILI,5 SEARCH ID EQUAL                   06132070
         CCW   TIC,*-8,0,0            TIC BACK                          06133060
         CCW   READ,0,CC+SKIP,4096    READ DATA (1 PAGE)                06134050
         CCW   SIEQ,RSA3380,CC+SILI,5 SEARCH ID EQUAL                   06135040
         CCW   TIC,*-8,0,0            TIC BACK                          06136030
         CCW   READ,0,SKIP,4096       READ DATA (1 PAGE)                06137020
         SPACE ,                                                        06138010
L18112   EQU   18112          FOR USE AS A SYMBOLIC LENGTH              06139000
D28      EQU   28             FOR USE AS SYMBOLIC DISPLACEMENT          06139990
D55      EQU   55             FOR USE AS SYMBOLIC DISPLACEMENT          06140980
D240     EQU   240            FOR USE AS SYMBOLIC DISPLACEMENT          06141970
         SPACE ,                                                        06142960
DL24     EQU   24             FOR USE AS SYMBOLIC DATA LENGTH           06143950
DL84     EQU   84             FOR USE AS SYMBOLIC DATA LENGTH           06144940
DL140    EQU   140            FOR USE AS SYMBOLIC DATA LENGTH           06145930
DL1024   EQU   1024           FOR USE AS SYMBOLIC DATA LENGTH           06146920
DL2048   EQU   2048           DATA LENGTH 2048                          06147910
DL4096   EQU   4096           FOR USE AS SYMBOLIC DATA LENGTH           06148900
*---------------------------------------------------------------------- 06149890
*        3340-35/3340-70 FORMAT CCWS                                    06150880
*---------------------------------------------------------------------- 06151870
         SPACE ,                                                        06152860
         DS    0D                                                       06153850
FMT3340  CCW   07,SEEKA,CC+SILI,6      SEEK                             06154840
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    06155830
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06156820
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06157810
         CCW   08,*-8,0,0              TIC                              06158800
         CCW   29,REC1,CC+SILI,8       WRITE 4096 PAGE                  06159790
         CCW   29,REC2,CC+SILI,8       WRITE 4096 PAGE                  06160780
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06161770
         CCW   08,*-8,0,0              TIC                              06162760
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06163750
         CCW   07,SEEKB,CC+SILI,6      SEEK                             06164740
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06165730
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06166720
         CCW   08,*-8,0,0              TIC                              06167710
         CCW   29,REC3,CC+SILI,8       WRITE 4096 PAGE                  06168700
         CCW   29,REC4,CC+SILI,8       WRITE 4096 PAGE                  06169690
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06170680
         CCW   08,*-8,0,0              TIC                              06171670
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06172660
         CCW   07,SEEKC,CC+SILI,6      SEEK                             06173650
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06174640
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06175630
         CCW   08,*-8,0,0              TIC                              06176620
         CCW   29,REC5,CC+SILI,8       WRITE 4096 PAGE                  06177610
         CCW   29,REC6,CC+SILI,8       WRITE 4096 PAGE                  06178600
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06179590
         CCW   08,*-8,0,0              TIC                              06180580
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06181570
         CCW   07,SEEKD,CC+SILI,6      SEEK                             06182560
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06183550
         CCW   49,SEEKD+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06184540
         CCW   08,*-8,0,0              TIC                              06185530
         CCW   29,REC7,CC+SILI,8       WRITE 4096 PAGE                  06186520
         CCW   29,REC8,CC+SILI,8       WRITE 4096 PAGE                  06187510
         CCW   49,SEEKD+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06188500
         CCW   08,*-8,0,0              TIC                              06189490
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06190480
         CCW   07,SEEKE,CC+SILI,6      SEEK                             06191470
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06192460
         CCW   49,SEEKE+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06193450
         CCW   08,*-8,0,0              TIC                              06194440
         CCW   29,REC9,CC+SILI,8       WRITE 4096 PAGE                  06195430
         CCW   29,REC10,CC+SILI,8      WRITE 4096 PAGE                  06196420
         CCW   49,SEEKE+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06197410
         CCW   08,*-8,0,0              TIC                              06198400
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06199390
         CCW   07,SEEKF,CC+SILI,6      SEEK                             06200380
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06201370
         CCW   49,SEEKF+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06202360
         CCW   08,*-8,0,0              TIC                              06203350
         CCW   29,REC11,CC+SILI,8      WRITE 4096 PAGE                  06204340
         CCW   29,REC12,CC+SILI,8      WRITE 4096 PAGE                  06205330
         CCW   49,SEEKF+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06206320
         CCW   08,*-8,0,0              TIC                              06207310
EWT3340  EQU   *                       LAST WRITE CCW IN PROG.          06208300
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06209290
*---------------------------------------------------------------------- 06210280
*        3340-35/3340-70 READ/VERIFY CCWS                               06211270
*---------------------------------------------------------------------- 06212260
         SPACE ,                                                        06213250
         CCW   07,SEEKA,CC+SILI,6      SEEK                             06214240
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06215230
         CCW   49,REC1,CC+SILI,5       SEARCH ID EQ                     06216220
         CCW   08,*-8,0,0              TIC                              06217210
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06218200
         CCW   49,REC2,CC+SILI,5       SEARCH ID EQ                     06219190
         CCW   08,*-8,0,0              TIC                              06220180
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06221170
         CCW   07,SEEKB,CC+SILI,6      SEEK                             06222160
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06223150
         CCW   49,REC3,CC+SILI,5       SEARCH ID EQ                     06224140
         CCW   08,*-8,0,0              TIC                              06225130
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06226120
         CCW   49,REC4,CC+SILI,5       SEARCH ID EQ                     06227110
         CCW   08,*-8,0,0              TIC                              06228100
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06229090
         CCW   07,SEEKC,CC+SILI,6      SEEK                             06230080
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06231070
         CCW   49,REC5,CC+SILI,5       SEARCH ID EQ                     06232060
         CCW   08,*-8,0,0              TIC                              06233050
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06234040
         CCW   49,REC6,CC+SILI,5       SEARCH ID EQ                     06235030
         CCW   08,*-8,0,0              TIC BACK                         06236020
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06237010
         CCW   07,SEEKD,CC+SILI,6      SEEK                             06238000
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06238990
         CCW   49,REC7,CC+SILI,5       SEARCH ID EQUAL                  06239980
         CCW   08,*-8,0,0              TIC                              06240970
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06241960
         CCW   49,REC8,CC+SILI,5       SEARCH ID EQ                     06242950
         CCW   08,*-8,0,0              TIC                              06243940
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06244930
         CCW   07,SEEKE,CC+SILI,6      SEEK                             06245920
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06246910
         CCW   49,REC9,CC+SILI,5       SEARCH ID EQ                     06247900
         CCW   08,*-8,0,0              TIC                              06248890
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06249880
         CCW   49,REC10,CC+SILI,5      SEARCH ID EQ                     06250870
         CCW   08,*-8,0,0              TIC                              06251860
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06252850
         CCW   07,SEEKF,CC+SILI,6      SEEK                             06253840
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06254830
         CCW   49,REC11,CC+SILI,5      SEARCH ID EQ                     06255820
         CCW   08,*-8,0,0              TIC                              06256810
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06257800
         CCW   49,REC12,CC+SILI,5      SEARCH ID EQ                     06258790
         CCW   08,*-8,0,0              TIC                              06259780
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06260770
         CCW   08,BITMAP,0,0           TIC TO WRITE R0 BIT MAP          06261760
*---------------------------------------------------------------------- 06262750
*        3350 FORMAT CCWS                                               06263740
*---------------------------------------------------------------------- 06264730
         SPACE ,                                                        06265720
         DS    0D                                                       06266710
FMT3350  CCW   07,SEEKA,CC+SILI,6      SEEK                             06267700
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    06268690
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06269680
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06270670
         CCW   08,*-8,0,0              TIC                              06271660
         CCW   29,REC1,CC+SILI,8       WRITE 4096 PAGE                  06272650
         CCW   29,RECX1,CC+SILI,8      WRITE FILLER                     06273640
         CCW   29,REC2,CC+SILI,8       WRITE 4096 PAGE                  06274630
         CCW   29,RECX2,CC+SILI,8      WRITE FILLER                     06275620
         CCW   29,REC3,CC+SILI,8       WRITE 4096 PAGE                  06276610
         CCW   29,RECX3,CC+SILI,8      WRITE FILLER                     06277600
         CCW   29,REC4,CC+SILI,8       WRITE 4096 PAGE                  06278590
         CCW   49,SEEKA+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06279580
         CCW   08,*-8,0,0              TIC                              06280570
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06281560
         CCW   07,SEEKB,CC+SILI,6      SEEK                             06282550
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06283540
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06284530
         CCW   08,*-8,0,0              TIC                              06285520
         CCW   29,REC5,CC+SILI,8       WRITE 4096 PAGE                  06286510
         CCW   29,RECX5,CC+SILI,8      WRITE FILLER                     06287500
         CCW   29,REC6,CC+SILI,8       WRITE 4096 PAGE                  06288490
         CCW   29,RECX6,CC+SILI,8      WRITE FILLER                     06289480
         CCW   29,REC7,CC+SILI,8       WRITE 4096 PAGE                  06290470
         CCW   29,RECX7,CC+SILI,8      WRITE FILLER                     06291460
         CCW   29,REC8,CC+SILI,8       WRITE 4096 PAGE                  06292450
         CCW   49,SEEKB+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06293440
         CCW   08,*-8,0,0              TIC BACK                         06294430
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06295420
         CCW   07,SEEKC,CC+SILI,6      SEEK                             06296410
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06297400
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06298390
         CCW   08,*-8,0,0              TIC                              06299380
         CCW   29,REC9,CC+SILI,8       WRITE 4096 PAGE                  06300370
         CCW   29,RECX9,CC+SILI,8      WRITE FILLER                     06301360
         CCW   29,REC10,CC+SILI,8      WRITE 4096 PAGE                  06302350
         CCW   29,RECX10,CC+SILI,8     WRITE FILLER                     06303340
         CCW   29,REC11,CC+SILI,8      WRITE 4096 PAGE                  06304330
         CCW   29,RECX11,CC+SILI,8     WRITE FILLER                     06305320
         CCW   29,REC12,CC+SILI,8      WRITE 4096 PAGE                  06306310
         CCW   49,SEEKC+2,CC+SILI,5    SEARCH ID EQ RECORD 0            06307300
         CCW   08,*-8,0,0              TIC BACK                         06308290
EWT3350  EQU   *                       LAST WRITE CCW IN PROG.          06309280
         CCW   05,ZERO,CC+SILI,8       WRITE RECORD 0                   06310270
         SPACE ,                                                        06311260
*---------------------------------------------------------------------- 06312250
*        3350 READ/VERIFY CCWS                                          06313240
*---------------------------------------------------------------------- 06314230
         SPACE ,                                                        06315220
         CCW   07,SEEKA,CC+SILI,6      SEEK                             06316210
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06317200
         CCW   49,REC1,CC+SILI,5       SEARCH ID EQUAL                  06318190
         CCW   08,*-8,0,0              TIC BACK                         06319180
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06320170
         CCW   49,REC2,CC+SILI,5       SEARCH ID EQUAL                  06321160
         CCW   08,*-8,0,0              TIC BACK                         06322150
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06323140
         CCW   49,REC3,CC+SILI,5       SEARCH ID EQUAL                  06324130
         CCW   08,*-8,0,0              TIC BACK                         06325120
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06326110
         CCW   49,REC4,CC+SILI,5       SEARCH ID EQ                     06327100
         CCW   08,*-8,0,0              TIC BACK                         06328090
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06329080
         CCW   07,SEEKB,CC+SILI,6      SEEK                             06330070
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06331060
         CCW   49,REC5,CC+SILI,5       SEARCH ID EQUAL                  06332050
         CCW   08,*-8,0,0              TIC BACK                         06333040
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06334030
         CCW   49,REC6,CC+SILI,5       SEARCH ID EQUAL                  06335020
         CCW   08,*-8,0,0              TIC BACK                         06336010
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06337000
         CCW   49,REC7,CC+SILI,5       SEARCH ID EQUAL                  06337990
         CCW   08,*-8,0,0              TIC BACK                         06338980
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06339970
         CCW   49,REC8,CC+SILI,5       SEARCH ID EQUAL                  06340960
         CCW   08,*-8,0,0              TIC BACK                         06341950
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06342940
         CCW   07,SEEKC,CC+SILI,6      SEEK                             06343930
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06344920
         CCW   49,REC9,CC+SILI,5       SEARCH ID EQUAL                  06345910
         CCW   08,*-8,0,0              TIC BACK                         06346900
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06347890
         CCW   49,REC10,CC+SILI,5      SEARCH ID EQUAL                  06348880
         CCW   08,*-8,0,0              TIC BACK                         06349870
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06350860
         CCW   49,REC11,CC+SILI,5      SEARCH ID EQUAL                  06351850
         CCW   08,*-8,0,0              TIC BACK                         06352840
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06353830
         CCW   49,REC12,CC+SILI,5      SEARCH ID EQUAL                  06354820
         CCW   08,*-8,0,0              TIC BACK                         06355810
         CCW   06,0,CC+SKIP,4096       READ DATA (1 PAGE)               06356800
         CCW   08,BITMAP,0,0           TIC TO WRITE R0 BIT MAP          06357790
*---------------------------------------------------------------------- 06358780
*        E4 SENSE CCW                                                   06359770
*---------------------------------------------------------------------- 06360760
         SPACE ,                                                        06361750
CCWSNSE4 CCW   E4,SENSE,SILI,L7            E4 SENSE                     06362740
         SPACE ,                                                        06363730
*---------------------------------------------------------------------- 06364720
*        3380 CKD FORMAT CCWS                                           06365710
*---------------------------------------------------------------------- 06366700
         SPACE ,                                                        06367690
         DS    0D                                                       06368680
FMT3380  CCW   SEEK,SEEKA,CC+SILI,6    SEEK                             06369670
         CCW   SFM,FILEMASK,CC+SILI,1  SET FILE MASK                    06370660
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06371650
         CCW   SIEQ,SEEKA+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06372640
         CCW   TIC,*-8,0,0             TIC                              06373630
         SPACE ,                                                        06374620
*        TRACK N FORMAT WRITE CCWS                                      06375610
         SPACE ,                                                        06376600
         CCW   WCKD,REC1,CC+SILI,8     WRITE 4096 PAGE                  06377590
         CCW   WCKD,REC2,CC+SILI,8     WRITE 4096 PAGE                  06378580
         CCW   WCKD,REC3,CC+SILI,8     WRITE 4096 PAGE                  06379570
         CCW   WCKD,RECXX3,CC+SILI,8   WRITE A FILLER RECORD            06380560
         CCW   WCKD,REC4,CC+SILI,8     WRITE 4096 PAGE                  06381550
         CCW   WCKD,REC5,CC+SILI,8     WRITE 4096 PAGE                  06382540
         CCW   WCKD,REC6,CC+SILI,8     WRITE 4096 PAGE                  06383530
         CCW   WCKD,RECXX6,CC+SILI,8   WRITE A FILLER RECORD            06384520
         CCW   WCKD,REC7,CC+SILI,8     WRITE 4096 PAGE                  06385510
         CCW   WCKD,REC8,CC+SILI,8     WRITE 4096 PAGE                  06386500
         CCW   WCKD,REC9,CC+SILI,8     WRITE 4096 PAGE                  06387490
         CCW   WCKD,REC10,CC+SILI,8    WRITE 4096 PAGE                  06388480
         CCW   SIEQ,SEEKA+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06389470
         CCW   TIC,*-8,0,0             TIC BACK                         06390460
         CCW   WRTD,ZERO,CC+SILI,8     WRITE RECORD 0                   06391450
         SPACE ,                                                        06392440
*        TRACK (N+1)                                                    06393430
         SPACE ,                                                        06394420
         CCW   SEEK,SEEKB,CC+SILI,6    SEEK                             06395410
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06396400
         CCW   SIEQ,SEEKB+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06397390
         CCW   TIC,*-8,0,0             TIC BACK                         06398380
         SPACE ,                                                        06399370
*        TRACK (N+1) FORMAT WRITE CCWS                                  06400360
         SPACE ,                                                        06401350
         CCW   WCKD,REC11,CC+SILI,8    WRITE 4096 PAGE                  06402340
         CCW   WCKD,REC12,CC+SILI,8    WRITE 4096 PAGE                  06403330
         CCW   WCKD,REC13,CC+SILI,8    WRITE 4096 PAGE                  06404320
         CCW   WCKD,RECXX13,CC+SILI,8  WRITE A FILLER RECORD            06405310
         CCW   WCKD,REC14,CC+SILI,8    WRITE 4096 PAGE                  06406300
         CCW   WCKD,REC15,CC+SILI,8    WRITE 4096 PAGE                  06407290
         CCW   WCKD,REC16,CC+SILI,8    WRITE 4096 PAGE                  06408280
         CCW   WCKD,RECXX16,CC+SILI,8  WRITE A FILLER RECORD            06409270
         CCW   WCKD,REC17,CC+SILI,8    WRITE 4096 PAGE                  06410260
         CCW   WCKD,REC18,CC+SILI,8    WRITE 4096 PAGE                  06411250
         CCW   WCKD,REC19,CC+SILI,8    WRITE 4096 PAGE                  06412240
         CCW   WCKD,REC20,CC+SILI,8    WRITE 4096 PAGE                  06413230
         CCW   SIEQ,SEEKB+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06414220
         CCW   TIC,*-8,0,0             TIC BACK                         06415210
         CCW   WRTD,ZERO,CC+SILI,8     WRITE RECORD 0                   06416200
         SPACE ,                                                        06417190
*        TRACK (N+2)                                                    06418180
         SPACE ,                                                        06419170
         CCW   SEEK,SEEKC,CC+SILI,6    SEEK                             06420160
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06421150
         CCW   SIEQ,SEEKC+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06422140
         CCW   TIC,*-8,0,0             TIC BACK                         06423130
         SPACE ,                                                        06424120
*        TRACK (N+2) FORMAT WRITE CCWS                                  06425110
         SPACE ,                                                        06426100
         CCW   WCKD,REC21,CC+SILI,8    WRITE 4096 PAGE                  06427090
         CCW   WCKD,REC22,CC+SILI,8    WRITE 4096 PAGE                  06428080
         CCW   WCKD,REC23,CC+SILI,8    WRITE 4096 PAGE                  06429070
         CCW   WCKD,RECXX23,CC+SILI,8  WRITE A FILLER RECORD            06430060
         CCW   WCKD,REC24,CC+SILI,8    WRITE 4096 PAGE                  06431050
         CCW   WCKD,REC25,CC+SILI,8    WRITE 4096 PAGE                  06432040
         CCW   WCKD,REC26,CC+SILI,8    WRITE 4096 PAGE                  06433030
         CCW   WCKD,RECXX26,CC+SILI,8  WRITE A FILLER RECORD            06434020
         CCW   WCKD,REC27,CC+SILI,8    WRITE 4096 PAGE                  06435010
         CCW   WCKD,REC28,CC+SILI,8    WRITE 4096 PAGE                  06436000
         CCW   WCKD,REC29,CC+SILI,8    WRITE 4096 PAGE                  06436990
         CCW   WCKD,REC30,CC+SILI,L8   WRITE 4096 PAGE                  06437980
         CCW   SIEQ,SEEKC+2,CC+SILI,5  SEARCH ID EQ RECORD 0            06438970
         CCW   TIC,*-8,0,0             TIC BACK                         06439960
EWT3380  EQU   *                       LAST WRITE CCW IN PROG.          06440950
         CCW   WRTD,ZERO,CC+SILI,8     WRITE RECORD 0                   06441940
         SPACE ,                                                        06442930
*---------------------------------------------------------------------- 06443920
*        3380 READ/VERIFY CCWS                                          06444910
*---------------------------------------------------------------------- 06445900
         SPACE ,                                                        06446890
*        TRACK N                                                        06447880
         SPACE ,                                                        06448870
VWRT3380 CCW   SEEK,SEEKA,CC+SILI,6    SEEK                             06449860
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06450850
         CCW   SIEQ,REC1,CC+SILI,5     SEARCH ID EQ                     06451840
         CCW   TIC,*-8,0,0             TIC BACK                         06452830
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06453820
         CCW   SIEQ,REC2,CC+SILI,5     SEARCH ID EQ                     06454810
         CCW   TIC,*-8,0,0             TIC BACK                         06455800
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06456790
         CCW   SIEQ,REC3,CC+SILI,5     SEARCH ID EQ                     06457780
         CCW   TIC,*-8,0,0             TIC BACK                         06458770
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06459760
         CCW   SIEQ,REC4,CC+SILI,5     SEARCH ID EQ                     06460750
         CCW   TIC,*-8,0,0             TIC BACK                         06461740
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06462730
         CCW   SIEQ,REC5,CC+SILI,5     SEARCH ID EQ                     06463720
         CCW   TIC,*-8,0,0             TIC BACK                         06464710
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06465700
         CCW   SIEQ,REC6,CC+SILI,5     SEARCH ID EQ                     06466690
         CCW   TIC,*-8,0,0             TIC BACK                         06467680
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06468670
         CCW   SIEQ,REC7,CC+SILI,5     SEARCH ID EQ                     06469660
         CCW   TIC,*-8,0,0             TIC BACK                         06470650
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06471640
         CCW   SIEQ,REC8,CC+SILI,5     SEARCH ID EQ                     06472630
         CCW   TIC,*-8,0,0             TIC BACK                         06473620
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06474610
         CCW   SIEQ,REC9,CC+SILI,5     SEARCH ID EQ                     06475600
         CCW   TIC,*-8,0,0             TIC BACK                         06476590
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06477580
         CCW   SIEQ,REC10,CC+SILI,5    SEARCH ID EQ                     06478570
         CCW   TIC,*-8,0,0             TIC BACK                         06479560
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06480550
         SPACE ,                                                        06481540
*        TRACK (N+1)                                                    06482530
         SPACE ,                                                        06483520
         CCW   SEEK,SEEKB,CC+SILI,6    SEEK                             06484510
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06485500
         CCW   SIEQ,REC11,CC+SILI,5    SEARCH ID EQ                     06486490
         CCW   TIC,*-8,0,0             TIC BACK                         06487480
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06488470
         CCW   SIEQ,REC12,CC+SILI,5    SEARCH ID EQ                     06489460
         CCW   TIC,*-8,0,0             TIC BACK                         06490450
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06491440
         CCW   SIEQ,REC13,CC+SILI,5    SEARCH ID EQ                     06492430
         CCW   TIC,*-8,0,0             TIC BACK                         06493420
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06494410
         CCW   SIEQ,REC14,CC+SILI,5    SEARCH ID EQ                     06495400
         CCW   TIC,*-8,0,0             TIC BACK                         06496390
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06497380
         CCW   SIEQ,REC15,CC+SILI,5    SEARCH ID EQ                     06498370
         CCW   TIC,*-8,0,0             TIC BACK                         06499360
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06500350
         CCW   SIEQ,REC16,CC+SILI,5    SEARCH ID EQ                     06501340
         CCW   TIC,*-8,0,0             TIC BACK                         06502330
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06503320
         CCW   SIEQ,REC17,CC+SILI,5    SEARCH ID EQ                     06504310
         CCW   TIC,*-8,0,0             TIC BACK                         06505300
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06506290
         CCW   SIEQ,REC18,CC+SILI,5    SEARCH ID EQ                     06507280
         CCW   TIC,*-8,0,0             TIC BACK                         06508270
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06509260
         CCW   SIEQ,REC19,CC+SILI,5    SEARCH ID EQ                     06510250
         CCW   TIC,*-8,0,0             TIC BACK                         06511240
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06512230
         CCW   SIEQ,REC20,CC+SILI,5    SEARCH ID EQ                     06513220
         CCW   TIC,*-8,0,0             TIC BACK                         06514210
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06515200
         SPACE ,                                                        06516190
*        TRACK (N+2)                                                    06517180
         SPACE ,                                                        06518170
         CCW   SEEK,SEEKC,CC+SILI,6    SEEK                             06519160
         CCW   STSCTR,R0SEC,CC+SILI,1  SET SECTOR                       06520150
         CCW   SIEQ,REC21,CC+SILI,5    SEARCH ID EQ                     06521140
         CCW   TIC,*-8,0,0             TIC BACK                         06522130
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06523120
         CCW   SIEQ,REC22,CC+SILI,5    SEARCH ID EQ                     06524110
         CCW   TIC,*-8,0,0             TIC BACK                         06525100
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06526090
         CCW   SIEQ,REC23,CC+SILI,5    SEARCH ID EQ                     06527080
         CCW   TIC,*-8,0,0             TIC BACK                         06528070
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06529060
         CCW   SIEQ,REC24,CC+SILI,5    SEARCH ID EQ                     06530050
         CCW   TIC,*-8,0,0             TIC BACK                         06531040
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06532030
         CCW   SIEQ,REC25,CC+SILI,5    SEARCH ID EQ                     06533020
         CCW   TIC,*-8,0,0             TIC BACK                         06534010
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06535000
         CCW   SIEQ,REC26,CC+SILI,5    SEARCH ID EQ                     06535990
         CCW   TIC,*-8,0,0             TIC BACK                         06536980
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06537970
         CCW   SIEQ,REC27,CC+SILI,5    SEARCH ID EQ                     06538960
         CCW   TIC,*-8,0,0             TIC BACK                         06539950
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06540940
         CCW   SIEQ,REC28,CC+SILI,5    SEARCH ID EQ                     06541930
         CCW   TIC,*-8,0,0             TIC BACK                         06542920
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06543910
         CCW   SIEQ,REC29,CC+SILI,5    SEARCH ID EQ                     06544900
         CCW   TIC,*-8,0,0             TIC BACK                         06545890
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06546880
         CCW   SIEQ,REC30,CC+SILI,L5   SEARCH ID EQ                     06547870
         CCW   TIC,*-8,0,0             TIC BACK                         06548860
         CCW   READ,0,CC+SKIP,4096     READ DATA (1 PAGE)               06549850
         SPACE ,                                                        06550840
         CCW   TIC,BITMAP,0,0          GO WRITE BIT MAP                 06551830
*---------------------------------------------------------------------- 06552820
*        2314/2319 FORMAT CCWS                                          06553810
*---------------------------------------------------------------------- 06554800
         SPACE ,                                                        06555790
FMT2314  CCW   7,SEEKA,CC+SILI,6       SEEK                             06556780
         CCW   31,FILEMASK,CC+SILI,1   SET FILE MASK                    06557770
         CCW   25,SEEKA+1,CC+SILI,5    WRITE HOME ADDRESS               06558760
         CCW   21,SEEKA+2,CC+SILI,16   WRITE RECORD 0                   06559750
         CCW   29,R1STUF,CC+SILI,8     WRITE CKD RECORD                 06560740
         CCW   01,R2STUF,CC+SILI,8     WRITE SPECIAL CKD                06561730
         CCW   07,SEEKB,CC+SILI,6      SEEK                             06562720
         CCW   25,SEEKB+1,CC+SILI,5    WRITE HOME ADDRESS               06563710
         CCW   21,SEEKB+2,CC+SILI,16   WRITE RECORD 0                   06564700
         CCW   29,R2ASTUF,CC+SILI,8    WRITE CKD RECORD                 06565690
         CCW   29,R3STUF,CC+SILI,8     WRITE CKD RECORD                 06566680
         CCW   01,R4STUF,CC+SILI,8     WRITE SPECIAL CKD                06567670
         CCW   07,SEEKC,CC+SILI,6      SEEK                             06568660
         CCW   25,SEEKC+1,CC+SILI,5    WRITE HOME ADDRESS               06569650
         CCW   21,SEEKC+2,CC+SILI,16   WRITE RECORD 0                   06570640
         CCW   29,R4ASTUF,CC+SILI,8    WRITE CKD RECORD                 06571630
         CCW   01,R5STUF,CC+SILI,8     WRITE SPECIAL CKD                06572620
         CCW   07,SEEKD,CC+SILI,6      SEEK                             06573610
         CCW   25,SEEKD+1,CC+SILI,5    WRITE HOME ADDRESS               06574600
         CCW   21,SEEKD+2,CC+SILI,16   WRITE RECORD 0                   06575590
         CCW   29,R5ASTUF,CC+SILI,8    WRITE CKD RECORD                 06576580
         CCW   29,R6STUF,CC+SILI,8     WRITE CKD RECORD                 06577570
         CCW   01,R7STUF,CC+SILI,8     WRITE SPECIAL CKD                06578560
         CCW   07,SEEKE,CC+SILI,6      SEEK                             06579550
         CCW   25,SEEKE+1,CC+SILI,5    WRITE HOME ADDRESS               06580540
         CCW   21,SEEKE+2,CC+SILI,16   WRITE RECORD 0                   06581530
         CCW   29,R7ASTUF,CC+SILI,8    WRITE CKD RECORD                 06582520
         CCW   29,R8STUF,CC+SILI,8     WRITE CKD RECORD                 06583510
         SPACE ,                                                        06584500
*---------------------------------------------------------------------- 06585490
*        2314/2319 READ/VERIFY CCWS                                     06586480
*---------------------------------------------------------------------- 06587470
         SPACE ,                                                        06588460
         CCW   07,SEEKA,CC+SILI,6      SEEK                             06589450
         CCW   49,R1STUF,CC+SILI,5     SEARCH ID EQ                     06590440
         CCW   08,*-8,0,0              TIC                              06591430
         CCW   06,0,CC+SKIP,4096       READ DATA                        06592420
         CCW   49,R2STUF,CC+SILI,5     SEARCH ID EQ                     06593410
         CCW   08,*-8,0,0              TIC                              06594400
         CCW   06,0,CC+SKIP,4096       READ DATA                        06595390
         CCW   07,SEEKB,CC,6           SEEK                             06596380
         CCW   49,R3STUF,CC,5          SEARCH ID EQ                     06597370
         CCW   08,*-8,0,0              TIC                              06598360
         CCW   06,0,CC+SKIP,4096       READ DATA                        06599350
         CCW   49,R4STUF,CC,5          SEARCH ID EQ                     06600340
         CCW   08,*-8,0,0              TIC                              06601330
         CCW   06,0,CC+SKIP,4096       READ DATA                        06602320
         CCW   07,SEEKC,CC,6           SEEK                             06603310
         CCW   49,R5STUF,CC,5          SEARCH ID EQ                     06604300
         CCW   08,*-8,0,0              TIC                              06605290
         CCW   06,0,CC+SKIP,4096       READ DATA                        06606280
         CCW   07,SEEKD,CC,6           SEEK                             06607270
         CCW   49,R6STUF,CC,5          SEARCH ID EQ                     06608260
         CCW   08,*-8,0,0              TIC                              06609250
         CCW   06,0,CC+SKIP,4096       READ DATA                        06610240
         CCW   49,R7STUF,CC,5          SEARCH ID EQ                     06611230
         CCW   08,*-8,0,0              TIC                              06612220
         CCW   06,0,CC+SKIP,4096       READ DATA                        06613210
         CCW   07,SEEKE,CC,6           SEEK                             06614200
         CCW   49,R8STUF,CC,5          SEARCH ID EQ                     06615190
         CCW   08,*-8,0,0              TIC                              06616180
         CCW   06,01,CC+SKIP,4096      READ DATA                        06617170
         SPACE ,                                                        06618160
*---------------------------------------------------------------------- 06619150
*        WRITE REC 0 BIT MAP FOR 2314,3330,3340,3350,3380 OR 2305       06620140
*---------------------------------------------------------------------- 06621130
         SPACE ,                                                        06622120
BITMAP   CCW   07,SEEK0,CC,6           SEEK                             06623110
         CCW   49,SEEK0+2,CC,5         SEARCH ID EQ                     06624100
         CCW   08,*-8,0,0              TIC                              06625090
         CCW   05,R0STUF,CC+SILI,8     REWRITE BIT MAP                  06626080
         CCW   22,0,SKIP,16            READ RECORD 0                    06627070
*---------------------------------------------------------------------  06628060
*               DEVICE TYPE/FORMAT PROCEDURE DATA TABLE                 06629050
*                                                                       06630040
*        THIS TABLE HAS THE FORMAT OF THE DFODATA DSECT.  CHANGES MADE  06631030
*        HERE MUST ALSO BE MADE IN THE DSECT.  EXPAND THE TABLE ONLY    06632020
*        BY FULL WORDS.                                                 06633010
*                                                                       06634000
*        TYPE  DS  X    DEVICE TYPE                                     06634990
*        ENDFL DS  X    FLAGS FOR FEATURES OR PROCESS                   06635980
*                  X'01' LAST ENTRY IN TABLE (OR'ED)                    06636970
*        NRECS DS  H    NUMBER OF CCW DATA TO BE UPDATED                06637960
*        1REC  DS  A    FIRST CCW TO BE UPDATED                         06638950
*        CAW   DS  A    CAW TO BE USED                                  06639940
*        CAWEW DS  A    LAST WRITE CCW IN WRITE PROGRAM                 06640930
*        RPPAS DS  H    RECORDS PER PASS (PAGES)                        06641920
*        TRPAS DS  H    TRACKS PER PASS                                 06642910
*              DS  H    FUTURE                                          06643900
*        RECTR DS  X    RECORDS/TRACK (NOT 2314)                        06644890
*              DS  X    FOR FUTURE USE                                  06645880
*                                                                       06646870
*---------------------------------------------------------------------- 06647860
         SPACE ,                                                        06648850
DFOTABLE DS    0F             DEVICE FORMAT TABLE                       06649840
         SPACE ,                                                        06650830
DFO3380  DS    0F             3380 DEVICE DATA                          06651820
         DC    AL1(TYP3380)   DEVICE TYPE                               06652810
         DC    AL1(DFOTBSTD)  STANDARD NON-ECKD                         06653800
         DC    AL2(RNRC3380)  NUMBER OF RECORDS TO UPDATE               06654790
         DC    AL4(REC1)      FIRST RECORD TO UPDATE                    06655780
         DC    AL4(FMT3380)   CHANNEL PROGRAM ADDRESS                   06656770
         DC    AL4(EWT3380)   LAST WRITE CCW IN WRITE PROGRAM           06657760
         DC    AL2(RN3380)    RECORDS PER PASS                          06658750
         DC    AL2(TRPP3380)  TRACKS PER PASS                           06659740
         DC    AL2(0)                                                   06660730
         DC    AL1(RNTR3380)  RECORDS PER TRACK                         06661720
         DC    AL1(0)                                                   06662710
DFO3380F DS    0F             3380 DEVICE DATA                          06663700
         DC    AL1(TYP3380)   DEVICE TYPE                               06664690
         DC    AL1(DFOTBSPE)  SPECIAL TO UPDATE FILLER RECORDS          06665680
         DC    AL2(RNRECS1)   NUMBER OF RECORDS TO UPDATE               06666670
         DC    AL4(RECXX3)    FIRST FILLER RECORD TO UPDATE             06667660
         DC    AL4(FMT3380)   CHANNEL PROGRAM ADDRESS                   06668650
         DC    AL4(EWT3380)   LAST WRITE CCW IN WRITE PROGRAM           06669640
         DC    AL2(RNRECS1)   RECORDS PER PASS                          06670630
         DC    AL2(TRPP3380)  TRACKS PER PASS                           06671620
         DC    AL2(0)                                                   06672610
         DC    AL1(RNTR3380)  RECORDS PER TRACK                         06673600
         DC    AL1(0)                                                   06674590
         SPACE ,                                                        06675580
DFO3350  DS    0F              3350                                     06676570
         DC    AL1(TYP3350)                                             06677560
         DC    AL1(DFOTBSTD)   STANDARD                                 06678550
         DC    AL2(RNRC3350)                                            06679540
         DC    AL4(REC1)                                                06680530
         DC    AL4(FMT3350)                                             06681520
         DC    AL4(EWT3350)   LAST WRITE CCW IN WRITE PROGRAM           06682510
         DC    AL2(RN3350)                                              06683500
         DC    AL2(TRPP3350)                                            06684490
         DC    AL2(0)                                                   06685480
         DC    AL1(0)                                                   06686470
         DC    AL1(0)                                                   06687460
         SPACE ,                                                        06688450
DFO3340  DS    0F             3340-35 AND 3340-70                       06689440
         DC    AL1(TYP334X)                                             06690430
         DC    AL1(DFOTBSTD)  STANDARD                                  06691420
         DC    AL2(RNRC3340)                                            06692410
         DC    AL4(REC1)                                                06693400
         DC    AL4(FMT3340)                                             06694390
         DC    AL4(EWT3340)   LAST WRITE CCW IN WRITE PROGRAM           06695380
         DC    AL2(RN3340)                                              06696370
         DC    AL2(TRPP3340)                                            06697360
         DC    AL2(0)                                                   06698350
         DC    AL1(0)                                                   06699340
         DC    AL1(0)                                                   06700330
         SPACE ,                                                        06701320
DFO3330  DS    0F             3330 MOD.1 AND MOD. 2 AND MOD. 11         06702310
         DC    AL1(TYP3330)                                             06703300
         DC    AL1(DFOTBSTD)  STANDARD                                  06704290
         DC    AL2(RNRC3330)                                            06705280
         DC    AL4(REC1)                                                06706270
         DC    AL4(FMT3330)                                             06707260
         DC    AL4(EWT3330)   LAST WRITE CCW IN WRITE PROGRAM           06708250
         DC    AL2(RN3330)                                              06709240
         DC    AL2(TRPP3330)                                            06710230
         DC    AL2(0)                                                   06711220
         DC    AL1(0)                                                   06712210
         DC    AL1(0)                                                   06713200
         SPACE ,                                                        06714190
DFO2314  DS    0F             2314 AND 2319                             06715180
         DC    AL1(TYP2314)                                             06716170
         DC    AL1(DFOTBSTD)  STANDARD                                  06717160
         DC    AL2(RNRC2314)                                            06718150
         DC    AL4(R1STUF)                                              06719140
         DC    AL4(FMT2314)                                             06720130
         DC    AL4(0)         LAST WRITE CCW IN WRITE PROGRAM           06721120
         DC    AL2(RN2314)                                              06722110
         DC    AL2(TRPP2314)                                            06723100
         DC    AL2(0)                                                   06724090
         DC    AL1(0)                                                   06725080
         DC    AL1(0)                                                   06726070
         SPACE ,                                                        06727060
DFO23051 DS    0F             2305 MOD. 1                               06728050
         DC    AL1(TYP23051)                                            06729040
         DC    AL1(DFOTBSTD)  STANDARD                                  06730030
         DC    AL2(RNRC2305)                                            06731020
         DC    AL4(REC1)                                                06732010
         DC    AL4(FMT2305)                                             06733000
         DC    AL4(0)         LAST WRITE CCW IN WRITE PROGRAM           06733990
         DC    AL2(RN2305)                                              06734980
         DC    AL2(TRPP2305)                                            06735970
         DC    AL2(0)                                                   06736960
         DC    AL1(0)                                                   06737950
         DC    AL1(0)                                                   06738940
         SPACE ,                                                        06739930
DFO23052 DS    0F             2305 MOD. 2                               06740920
         DC    AL1(TYP23052)                                            06741910
         DC    AL1(DFOTBSTD+DFOTBEND)  STANDARD + LAST ENTRY            06742900
         DC    AL2(RNRC2305)                                            06743890
         DC    AL4(REC1)                                                06744880
         DC    AL4(FMT2305)                                             06745870
         DC    AL4(0)         LAST WRITE CCW IN WRITE PROGRAM           06746860
         DC    AL2(RN2305)                                              06747850
         DC    AL2(TRPP2305)                                            06748840
         DC    AL2(0)                                                   06749830
         DC    AL1(0)                                                   06750820
         DC    AL1(0)                                                   06751810
*---------------------------------------------------------------------- 06752800
*   THE FOLLOWING TWO TABLES ARE USED BY THE ROUTINE CHECKCKD           06753790
*   TO FIND THE DEVICE SPECIFIC PARAMETERS FOR THE DEVICE TYPE          06754780
*   THE USER HAS SPECIFIED.  DEVTBL1 CONTAINS THE DEVICE DATA,          06755770
*   AND DEVTBL2 CONTAINS THE DEVICE NAME FOR COMPARISON TO HOW          06756760
*   THE USER SPECIFIED IT.                                              06757750
*                                                                       06758740
*** IMPORTANT:  THE ENTRIES IN THESE TWO TABLES MUST BE    ***          06759730
***             KEPT IN THE SAME RELATIVE SEQUENCE!!!      ***          06760720
*                                                                       06761710
*   THE SPECIAL FEATURE INDEX IS USED TO DO ANY UNIQUE DEVICE           06762700
*   PROCESSING.  CURRENT ASSIGNMENTS ARE:                               06763690
*       DEVSFIX = 0 - NO SPECIAL HANDLING REQUIRED                      06764680
*       DEVSFIX = 4 - 3380                                              06765670
*       DEVSFIX = 8 - 3330, 3330-11                                     06766660
*       DEVSFIX = 12- 3340-70MB                                         06767650
*                                                                       06768640
*   THE WRITE VERIFICATION INDEX IS USED TO DEFINE WHETHER A CKD        06769630
*   DEVICE SUPPORTS THE WRITE VERIFICATION AS AN OPTION.  CURRENT       06770620
*   ASSIGNMENTS ARE:                                                    06771610
*       DEVWVDEF = 0 - OPTION IS UNAVAILABLE FOR THIS DEVICE, USER WILL 06772600
*                      NOT RECEIVE THE PROMPT.                          06773590
*       DEVWVDEF = 8 - OPTION IS AVAILABLE FOR THIS DEVICE, THEREFORE   06774580
*                      PROMPT THE USER AND DETERMINE WHETHER WRITE      06775570
*                      VERIFICATION IS REQUIRED.                        06776560
*---------------------------------------------------------------------- 06777550
         SPACE ,                                                        06778540
DEVGO    EQU   0                                                        06779530
DEVHIVAL EQU   DEVGO+8                                                  06780520
DEVRECVL EQU   DEVHIVAL+2                                               06781510
DEVICETP EQU   DEVRECVL+1                                               06782500
DEVARGLN EQU   DEVICETP+1                                               06783490
DEVSFIX  EQU   DEVARGLN+1                                               06784480
DEVWVDEF EQU   DEVSFIX+1    DEVICE DEFAULTS FOR WRITE                   06785470
*                           VERIFICATION OPTION USAGE.                  06786460
         SPACE ,                                                        06787450
*-------------------------------------------------------------          06788440
*   DEVSFIX EQUATES                                                     06789430
*-------------------------------------------------------------          06790420
         SPACE ,                                                        06791410
DVIXNONE EQU   0            NO SPECIAL HANDLING REQUIRED                06792400
DVIX3380 EQU   4            3380                                        06793390
DVIX3330 EQU   8            3330, 3330-11                               06794380
DVIX3340 EQU   12           3340-70MB                                   06795370
         SPACE ,                                                        06796360
*---------------------------------------------------------------------- 06797350
*   DEVWVDEF EQUATES                                                    06798340
*---------------------------------------------------------------------- 06799330
         SPACE ,                                                        06800320
DVWVPMT  EQU   WVPMT        PROMPT USER FOR WRITE VERIFICATION          06801310
DVWVSKIP EQU   WVNOTOPT     WRITE VERIFICATION IS NOT OPTIONAL          06802300
*                           FOR THIS DEV AND WILL ALWAYS BE PERFORMED   06803290
DVWVREQ  EQU   WVREQ        USER HAS SELECTED WRT VERIFICATION          06804280
         SPACE ,                                                        06805270
DEVTBEND EQU   X'FF'        END OF TABLE INDICATOR                      06806260
         SPACE ,                                                        06807250
*---------------------------------------------------------------------- 06808240
*   DEVTBL1                                                             06809230
*---------------------------------------------------------------------- 06810220
         SPACE ,                                                        06811210
DEVTBL1  DS    0D                                                       06812200
         SPACE ,                                                        06813190
*                             3380 ENTRY                                06814180
         CCW   TIC,VRFY3380,0,0  MODIFYING CCW FOR 3380 VERIFY          06815170
         DC    H'884'         HIGHEST CYLINDER ON 3380                  06816160
         DC    AL1(MREC3380)  # RECORDS/CYLINDER                        06817150
         DC    AL1(TYP3380)   DEVICE TYPE                               06818140
         DC    AL1(L'NM3380-1) LNGTH OF NAME FOR COMPARISON             06819130
         DC    AL1(DVIX3380)  SPECIAL FEATURE INDEX                     06820120
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06821110
         SPACE ,                                                        06822100
         DS    0D                                                       06823090
DEVTBESZ EQU   *-DEVTBL1                                                06824080
         SPACE ,                                                        06825070
*                             3350 ENTRY                                06826060
         DS    0D                                                       06827050
         CCW   08,GO2314,0,0  USED TO ALTER OTHER TICS                  06828040
         DC    H'554'         HIGHEST CYLINDER ON 3350                  06829030
         DC    X'78'          # RECORDS/CYLINDER                        06830020
         DC    AL1(TYP3350)   DEVICE TYPE                               06831010
         DC    AL1(L'NM3350-1) LNGTH OF NAME FOR COMPARISON             06832000
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06832990
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06833980
         SPACE ,                                                        06834970
*                             3330 ENTRY                                06835960
         DS    0D                                                       06836950
         CCW   08,GO3330,0,0  USED TO ALTER OTHER TICS                  06837940
         DC    H'403'         HIGHEST CYLINDER ON 3330                  06838930
         DC    X'3C'          # RECORDS/CYLINDER                        06839920
         DC    AL1(TYP3330)   DEVICE TYPE                               06840910
         DC    AL1(L'NM3330-1) LNGTH OF NAME FOR COMPARISON             06841900
         DC    AL1(DVIX3330)  SPECIAL FEATURE INDEX                     06842890
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06843880
         SPACE ,                                                        06844870
*                             3330-11 ENTRY                             06845860
         DS    0D                                                       06846850
         CCW   08,GO3330,0,0  USED TO ALTER OTHER TICS                  06847840
         DC    H'807'         HIGHEST CYLINDER ON 3330                  06848830
         DC    X'3C'          # RECORDS/CYLINDER                        06849820
         DC    AL1(TYP3330)   DEVICE TYPE                               06850810
         DC    AL1(L'NM333011-1) LNGTH OF NAME FOR COMPARISON           06851800
         DC    AL1(DVIX3330)  SPECIAL FEATURE INDEX                     06852790
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06853780
         SPACE ,                                                        06854770
*                             3340-35 ENTRY                             06855760
         DS    0D                                                       06856750
         CCW   04,0,SKIP+SILI,1  USED TO ALTER OTHER TICS               06857740
         DC    H'347'         HIGHEST CYLINDER ON 3340-35               06858730
         DC    X'18'          # RECORDS/CYLINDER                        06859720
         DC    AL1(TYP334X)   DEVICE TYPE                               06860710
         DC    AL1(L'NM334035-1) LNGTH OF NAME FOR COMPARISON           06861700
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06862690
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06863680
         SPACE ,                                                        06864670
*                             3340-70 ENTRY                             06865660
         DS    0D                                                       06866650
         CCW   04,0,SKIP+SILI,1  USED TO ALTER OTHER TICS               06867640
         DC    H'695'         HIGHEST CYLINDER ON 3340-70               06868630
         DC    X'18'          # RECORDS/CYLINDER                        06869620
         DC    AL1(TYP334X)   DEVICE TYPE                               06870610
         DC    AL1(L'NM334070-1) LNGTH OF NAME FOR COMPARISON           06871600
         DC    AL1(DVIX3340)  SPECIAL FEATURE INDEX                     06872590
         DC    AL1(DVWVPMT)   PROMPT FOR WRITE VERIFICATION             06873580
         SPACE ,                                                        06874570
*                             2305-1 ENTRY                              06875560
         DS    0D                                                       06876550
         CCW   08,GO3330,0,0  USED TO ALTER OTHER TICS                  06877540
         DC    H'47'          HIGHEST CYLINDER ON 2305-1                06878530
         DC    X'18'          # RECORDS/CYLINDER                        06879520
         DC    AL1(TYP23051)  DEVICE TYPE                               06880510
         DC    AL1(L'NM23051-1) LNGTH OF NAME FOR COMPARISON            06881500
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06882490
         DC    AL1(DVWVSKIP)  NO PROMPT FOR WRITE VERIFICATION          06883480
         SPACE ,                                                        06884470
*                             2305-2 ENTRY                              06885460
         DS    0D                                                       06886450
         CCW   08,GO3330,0,0  USED TO ALTER OTHER TICS                  06887440
         DC    H'95'          HIGHEST CYLINDER ON 2305-2                06888430
         DC    X'18'          # RECORDS/CYLINDER                        06889420
         DC    AL1(TYP23052)  DEVICE TYPE                               06890410
         DC    AL1(L'NM23052-1) LNGTH OF NAME FOR COMPARISON            06891400
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06892390
         DC    AL1(DVWVSKIP)  NO PROMPT FOR WRITE VERIFICATION          06893380
         SPACE ,                                                        06894370
*                             2314 ENTRY                                06895360
         DS    0D                                                       06896350
         CCW   08,GO2314,0,0  USED TO ALTER OTHER TICS                  06897340
         DC    H'202'         HIGHEST CYLINDER ON 2314                  06898330
         DC    X'20'          # RECORDS/CYLINDER                        06899320
         DC    AL1(TYP2314)   DEVICE TYPE                               06900310
         DC    AL1(L'NM2314-1) LNGTH OF NAME FOR COMPARISON             06901300
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06902290
         DC    AL1(DVWVSKIP)  NO PROMPT FOR WRITE VERIFICATION          06903280
         SPACE ,                                                        06904270
*                             2319 ENTRY                                06905260
         DS    0D                                                       06906250
         CCW   08,GO2314,0,0  USED TO ALTER OTHER TICS                  06907240
         DC    H'202'         HIGHEST CYLINDER ON 2319                  06908230
         DC    X'20'          # RECORDS/CYLINDER                        06909220
         DC    AL1(TYP2319)   DEVICE TYPE                               06910210
         DC    AL1(L'NM2319-1) LNGTH OF NAME FOR COMPARISON             06911200
         DC    AL1(DVIXNONE)  SPECIAL FEATURE INDEX                     06912190
         DC    AL1(DVWVSKIP)  NO PROMPT FOR WRITE VERIFICATION          06913180
         DS    0D                                                       06914170
         DC    AL1(DEVTBEND)  SIGNAL END OF TABLE                       06915160
         SPACE ,                                                        06916150
*---------------------------------------------------------------------- 06917140
*   DEVTBL2 - DEVICE NAMES AS SPECIFIED BY THE USER                     06918130
*---------------------------------------------------------------------- 06919120
         SPACE ,                                                        06920110
DEVTBL2  EQU   *                                                        06921100
         SPACE ,                                                        06922090
NM3380   DC    C'3380 '                                                 06923080
NM3350   DC    C'3350 '                                                 06924070
NM3330   DC    C'3330 '                                                 06925060
NM333011 DC    C'3330-11 '                                              06926050
NM334035 DC    C'3340-35 '                                              06927040
NM334070 DC    C'3340-70 '                                              06928030
NM23051  DC    C'2305-1 '                                               06929020
NM23052  DC    C'2305-2 '                                               06930010
NM2314   DC    C'2314 '                                                 06931000
NM2319   DC    C'2319 '                                                 06931990
         SPACE ,                                                        06932980
*                                                                       06933970
*   ALLOCATION MAP BUFFER                                               06934960
*                                                                       06935950
* DO NOT SEPARATE R4COUNT AND TABLE.  THEY MUST BE CONTIGUOUS SO THAT   06936940
* WCKD WHICH WRITES ALLOC MAP TO CYLINDER 0 WORKS CORRECTLY.            06937930
         DS    0F                                                       06938920
R4COUNT  DC    XL8'00'        ALLOC MAP COUNT FIELD                     06939910
TABLE    DC    4096X'00'      ALLOC MAP BUFFER                          06940900
*---------------------------------------------------------------------- 06941890
*        'DEVICE DATA AND FORMATTING PROCEDURE' TABLE ENTRY DSECT       06942880
*---------------------------------------------------------------------- 06943870
         SPACE ,                                                        06944860
DFODATA  DSECT                DEVICE FORMAT DATA                        06945850
DFOTYPE  DS    X              DEVICE TYPE                               06946840
DFOENDFL DS    X              FLAG BYTE                                 06947830
DFOTBEND EQU   X'01'          SIGNALS: LAST ENTRY IN TABLE              06948820
*                             ... OR-ED WITH OTHER BITS                 06949810
DFOTBSTD EQU   X'00'          STANDARD ENTRY                            06950800
DFOTBSPE EQU   X'20'          ENTRY USED FOR SPECIAL PURPOSE            06951790
DFONRECS DS    H              NUMBER OF CCW DATA TO BE UPDATED          06952780
DFO1REC  DS    A              FIRST CCW DATA TO BE UPDATED              06953770
DFOCAW   DS    A              CAW TO BE USED                            06954760
DFOCAWEW DS    A              LAST WRITE CCW IN WRITE PROGRAM           06955750
DFORPPAS DS    H              RECORDS PER PASS (PAGE RECORDS)           06956740
DFOTRPAS DS    H              TRACKS PER PASS                           06957730
         DS    H              RESERVED                                  06958720
DFORECTR DS    X              RECORDS/TRACK(NOT USED FOR 2314)          06959710
*                             ... PAGE AND NON-PAGE RECORDS             06960700
         DS    X              RESERVED                                  06961690
         SPACE ,                                                        06962680
DFOTELEN EQU   *-DFODATA      LENGTH OF DEV/FORM TABLE ENTRY            06963670
         COPY  EQU                                                      06964660
L1       EQU   1                                                        06965650
L2       EQU   2                                                        06966640
L3       EQU   3                                                        06967630
L4       EQU   4                                                        06968620
L5       EQU   5                                                        06969610
L6       EQU   6                                                        06970600
L7       EQU   7                                                        06971590
L8       EQU   8                                                        06972580
L9       EQU   9                                                        06973570
L10      EQU   10                                                       06974560
L11      EQU   11                                                       06975550
L12      EQU   12                                                       06976540
L13      EQU   13                                                       06977530
L14      EQU   14                                                       06978520
L15      EQU   15                                                       06979510
L16      EQU   16                                                       06980500
L17      EQU   17                                                       06981490
L18      EQU   18                                                       06982480
L19      EQU   19                                                       06983470
L20      EQU   20                                                       06984460
D1       EQU   1                                                        06985450
D2       EQU   2                                                        06986440
D3       EQU   3                                                        06987430
D4       EQU   4                                                        06988420
D5       EQU   5                                                        06989410
D6       EQU   6                                                        06990400
D7       EQU   7                                                        06991390
D8       EQU   8                                                        06992380
D9       EQU   9                                                        06993370
D10      EQU   10                                                       06994360
D11      EQU   11                                                       06995350
D12      EQU   12                                                       06996340
D13      EQU   13                                                       06997330
D14      EQU   14                                                       06998320
D15      EQU   15                                                       06999310
D16      EQU   16                                                       07000300
D17      EQU   17                                                       07001290
D18      EQU   18                                                       07002280
D19      EQU   19                                                       07003270
D20      EQU   20                                                       07004260
         PSA                                                            07005250
UNSTAT   EQU   CSW+4          UNIT STATUS FROM CHANNEL STATUS           07006240
         SPACE ,                                                        07007230
         END   DMKFMT                                                   07008220