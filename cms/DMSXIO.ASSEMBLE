XIO TITLE 'EXECIO Implementation for VM/370'                            00010000
*                                                                       00020000
* >>--EXECIO--.-lines-.--.---DISKR---| Diskr Operands|---.--><          00030000
*             '-*-----'  |                               |              00040000
*                        |---CARD----| Card  Operands |--.              00050000
*                        |                               |              00060000
*                        |---CP------| CP    Operands |--.              00070000
*                        |                               |              00080000
*                        |---DISKW---| DISKR Operands |--.              00090000
*                        |                               |              00100000
*                        |---PUNCH---| PUNCH Operands |--.              00110000
*                        |                               |              00120000
*                        |---EMSG----| EMSG  Operands |--.              00130000
*                        |                               |              00140000
*                        '---PRINT---| PRINT Optrands |--'              00150000
*                                                                       00160000
* Diskr Operands:                                                       00170000
*                                                                       00180000
*            .-*--1----------------.                                    00190000
* |--fn--ft--+---------------------+------------------------->          00200000
*            |         .-1-------. |                                    00210000
*            '-.-fm-.--+---------+-'                                    00220000
*              '-*--'  '-linenum-'                                      00230000
*                                                                       00240000
* >--.----------------------------------------------.--------|          00250000
*    |                                              |                   00260000
*    '-(-----.-------.--| Input Options |-----.---.-'                   00270000
*            '-FINIs-'                        '-)-'                     00280000
*                                                                       00290000
* Card Operands:                                                        00300000
*                                                                       00310000
* |--.-----------------------------------.-------------------|          00320000
*    |                                   |                              00330000
*    '-(-----| Input Options |-----.---.-'                              00340000
*                                  '-)-'                                00350000
*                                                                       00360000
* CP Operands:                                                          00370000
*                                                                       00380000
* |--.-----------------------------.-------------------------|          00390000
*    |                             |                                    00400000
*    '-(--| CP Options |-----.---.-'                                    00410000
*                            '-)-'                                      00420000
*                                                                       00430000
* CP Options:                                                           00440000
*                                                                       00450000
* |--| Input Options |--.---------------.--.-------------.---|          00460000
*                       '-BUFfer-length-'  '-STring-text-'              00470000
*                                                                       00480000
* DISKW Operands:                                                       00490000
*                                                                       00500000
* |--fn--ft--.-fm-.--.-------------------------------.------->          00510000
*            '-*--'  '-linenum--.------------------.-'                  00520000
*                               | .-V-.            |                    00530000
*                               '-+---+--.-------.-'                    00540000
*                                 '-F-'  '-lrecl-'                      00550000
*                                                                       00560000
* >--.-----------------------------------------------.-------|          00570000
*    |                                               |                  00580000
*    '-(-----.-------.--| Output Options |-----.---.-'                  00590000
*            '-FINIs-'                         '-)-'                    00600000
*                                                                       00610000
* PUNCH Operands:                                                       00620000
*                                                                       00630000
* |--.------------------------------------.------------------|          00640000
*    |                                    |                             00650000
*    '-(-----| Output Options |-----.---.-'                             00660000
*                                   '-)-'                               00670000
*                                                                       00680000
* EMSG Operands:                                                        00690000
*                                                                       00700000
* |--.------------------------------------.--------|                    00710000
*    |                                    |                             00720000
*    '-(-----| Output Options |-----.---.-'                             00730000
*                                   '-)-'                               00740000
*                                                                       00750000
* PRINT Operands:                                                       00760000
*                                                                       00770000
* |--.---------------------------------------------------.---|          00780000
*    |                                                   |              00790000
*    '-(--.--------------.--| Output Options |-----.---.-'              00800000
*         '-CC--.-code-.-'                         '-)-'                00810000
*               '-DATA-'                                                00820000
*                                                                       00830000
* Input Options:                                                        00840000
*                                            .-Zone-1-*---.             00850000
* |--.------------------------------------.--+------------+-->          00860000
*    |-.-FInd--/chars/---.-.------------.-|  '-Zone-n1-n2-'             00870000
*    | |-LOcate--/chars/-| |-LIFO-------| |                             00880000
*    | '-Avoid--/chars/--' |-FIFO-------| |                             00890000
*    |                     '-STEm--stem-' |                             00900000
*    '-VAR--xxxx---------------------------'                            00910000
*                                                                       00920000
*              .-Margins--1--*---.                                      00930000
* >--.------.--+-----------------+--.-------.--.--------.----|          00940000
*    '-SKip-'  '-Margins--n1--n2-'  '-STRIP-'  '-NOTYPE-'               00950000
*                                                                       00960000
* Output Options:                                                       00970000
*                                                                       00980000
*    .-Margins--1--*---.                                                00990000
* |--+-----------------+--.-------.--.--------.-------------->          01000000
*    '-Margins--n1--n2-'  '-STRIP-'  '-NOTYPE-'                         01010000
*                                                                       01020000
*                                                                       01030000
*    .-CAse--M-.                                                        01040000
* >--+-------------.------------------.----------------------|          01050000
*    '-CAse--U-'   |-STEm--stem-------|                                 01060000
*                  |-VAR--xxxx--------|                                 01070000
*                  '-STring--text-----'                                 01080000
*                                                                       01090000
DMSXIO   CSECT                                                          01100000
         USING NUCON,0                                                  01110000
         STM   R14,R12,12(R13)                                          01120000
         LR    R12,R15                                                  01130000
         LA    R11,2048(,R12)                                           01140000
         LA    R11,2048(,R11)                                           01150000
         USING DMSXIO,R12,R11     Set addressability                    01160000
         LR    R2,R0              Incoming extended plist               01170000
         LR    R3,R1              Incoming tokenized plist              01180000
*                                                                       01190000
         LA    R0,(WORKSIZE+8)/8                                        01200000
         DMSFREE DWORDS=(0),TYPE=USER Allocate Work area                01210000
         LR    R6,R1              Hold WORKAREA address                 01220000
         LR    R0,R6                                                    01230000
         LA    R1,WORKSIZE                                              01240000
         SR    R5,R5                                                    01250000
         MVCL  R0,R4              Zero out the WORKAREA                 01260000
*                                                                       01270000
         ST    R13,4(,R6)         Chain                                 01280000
         ST    R6,8(,R13)            to                                 01290000
         LR    R13,R6                  new                              01300000
         USING WORKAREA,R13              savearea                       01310000
*                                                                       01320000
* Some calls use information from the extended plist                    01330000
* We save 2 copies here. One is ASIS, one is Uppercased.                01340000
*                                                                       01350000
         LM    R4,R5,4(R2)        Load begargs,endargs                  01360000
         SR    R5,R4                                                    01370000
         ST    R5,EPLENGTH        Save length of command args           01380000
         LTR   R5,R5                                                    01390000
         BZ    EPLSET                                                   01400000
*                                                                       01410000
         LA    R6,EPLLOCAL        Assume short EPLIST                   01420000
         C     R5,=A(80-1)        Unless too long                       01430000
         BNH   EPLCOPY            Save copy in our DSA                  01440000
         LA    R0,2+7(,R5)        Get storage for two                   01450000
         AR    R0,R5                copies                              01460000
         SRL   R0,3                   in doublewords                    01470000
         DMSFREE DWORDS=(0),TYPE=USER Allocate Work area                01480000
         LR    R6,R1                                                    01490000
EPLCOPY  DS    0H                                                       01500000
         ST    R6,EPLADDR                                               01510000
*                                                                       01520000
         MVI   0(R6),C' '         Blank out the area                    01530000
         MVC   1(*-*,R6),0(R6)     for size of EPLIST                   01540000
         EX    R5,*-6                plus one blank                     01550000
*                                                                       01560000
         BCTR  R5,0               Length - 1                            01570000
         MVC   0(*-*,R6),0(R4)                                          01580000
         EX    R5,*-6             Copy in arguments                     01590000
*                                                                       01600000
         LA    R6,1(R5,R6)        Skip over first copy                  01610000
         MVC   0(*-*,R6),0(R4)    Make a second copy                    01620000
         EX    R5,*-6             Copy in arguments                     01630000
*                                                                       01640000
         L     R6,EPLADDR         Back to first copy                    01650000
         L     R15,NUCUPPER                                             01660000
         B     *+4+6                                                    01670000
         TR    0(*-*,R6),0(R15)   Uppercase 1st copy                    01680000
         EX    R5,*-6                                                   01690000
EPLSET   DS    0H                                                       01700000
         MVC   EPLNXT,EPLADDR     Set start of EPLIST                   01710000
         MVC   EPLLEFT,EPLENGTH   Set remaining bytes to scan           01720000
*                                 EPLTOKEN has next parm                01730000
*                                                                       01740000
* Retrieve the number of lines                                          01750000
*                                                                       01760000
         LA    R4,=CL8'Lines'                                           01770000
         BAL   R14,NXTTOKEN       Get the next token                    01780000
         B     MISSING            Bif operand is missing                01790000
*                                                                       01800000
         L     R0,MAXWORD         Assume '*'                            01810000
         CLC   EPLTOKEN(2),=C'* '                                       01820000
         BE    SETLINES           Yes, set -1 for *                     01830000
         LA    R1,EPLTOKEN        Here too                              01840000
         BAL   R14,CVB            Convert lines to binary               01850000
         B     INVLINES           Bif invalid number                    01860000
SETLINES DS    0H                                                       01870000
         ST    R0,LINES           Set the number of lines               01880000
*                                                                       01890000
* Check the operation call type                                         01900000
*                                                                       01910000
         LA    R4,=CL8'Device'                                          01920000
         BAL   R14,NXTTOKEN       Get the next token                    01930000
         B     MISSING            Bif operand is missing                01940000
*                                                                       01950000
         LA    R0,CTYPTBNE        Call type table # entries             01960000
         LA    R15,CTYPTBL        First entry                           01970000
ROUTINEL DS    0H                                                       01980000
         CLC   0(8,R15),EPLTOKEN  Match found?                          01990000
         BE    ROUTINEF           Yes, routine name found               02000000
         LA    R15,CTYPTBEL(,R15) Step to next                          02010000
         BCT   R0,ROUTINEL        Looking for routine name              02020000
         B     INVPARM            Invalid Parameter                     02030000
ROUTINEF DS    0H                 Go to the address specified           02040000
         L     R15,8(,R15)                                              02050000
         BR    R15                                                      02060000
*                                                                       02070000
*  Return to caller                                                     02080000
*                                                                       02090000
EXIT0    DS    0H                                                       02100000
         SR    R15,R15                                                  02110000
EXITRC   DS    0H                                                       02120000
         LR    R5,R15             Hold the return code                  02130000
         ICM   R0,B'1111',REXBUFFL Did we get a REXX buffer?            02140000
         BZ    EXITRC2            Skip return if not                    02150000
         SRL   R0,3               Bytes to dwords                       02160000
         L     R1,REXBUFF         Get the address                       02170000
         DMSFRET DWORDS=(0),LOC=(1)                                     02180000
EXITRC2  DS   0H                                                        02190000
         LR    R1,R13                                                   02200000
         L     R13,4(,R13)                                              02210000
         ST    R5,16(,R13)        Pass back the return code             02220000
         LA    R0,(WORKSIZE+8)/8                                        02230000
         DMSFRET DWORDS=(0),LOC=(1)                                     02240000
         LM    R14,R12,12(R13)                                          02250000
         BR    R14                                                      02260000
 TITLE 'EXECIO: Handle activity type DISKR'                             02270000
*------------------------------------------------------------*          02280000
*                                                            *          02290000
* DISKR  -     Read data from a minidisk file                *          02300000
*                                                            *          02310000
*------------------------------------------------------------*          02320000
$DISKR   DS    0H                                                       02330000
         MVI   CURROP,VDISKR      Set the current operation             02340000
         LA    R5,EXFSCB          Build FSCB here                       02350000
         USING FSCBD,R5                                                 02360000
         XC    FSCBD(FSCBDLEN),FSCBD                                    02370000
         MVC   FSCBFM,=CL2'* '    Default file mode is '*'              02380000
         XC    NEXTREC,NEXTREC    Assume we will read the               02390000
*                                   next record in the file             02400000
         LA    R4,=CL8'Filename'                                        02410000
         BAL   R14,NXTTOKEN       Get the next token                    02420000
         B     MISSING            Bif operand is missing                02430000
         MVC   FSCBFN,EPLTOKEN    Copy in filename                      02440000
*                                                                       02450000
         LA    R4,=CL8'Filetype'                                        02460000
         BAL   R14,NXTTOKEN       Get the next token                    02470000
         B     MISSING            Bif operand is missing                02480000
         MVC   FSCBFT,EPLTOKEN    Copy in filetype                      02490000
*                                                                       02500000
         BAL   R14,NXTTOKEN       Get the '(' if present                02510000
         B     $DISKR20           Bif no operands or options            02520000
         CLI   EPLTOKEN,C'('      Start of options                      02530000
         BE    $DISKR10           Yes go get them                       02540000
         CLI   EPLTOKEN+2,C' '    Max length is 2                       02550000
         BNE   INVPARM            Too long for filemode                 02560000
         MVC   FSCBFM,EPLTOKEN    Copy in filemode                      02570000
*                                                                       02580000
         BAL   R14,NXTTOKEN       Get the '(' if present                02590000
         B     $DISKR20           Bif no operands or options            02600000
         CLI   EPLTOKEN,C'('      Start of options                      02610000
         BE    $DISKR10           Yes go get them                       02620000
*                                                                       02630000
* Retrieve the line number                                              02640000
*                                                                       02650000
         LA    R1,EPLTOKEN        Here too                              02660000
         BAL   R14,CVB            Convert lines to binary               02670000
         B     INVLINES           Bif invalid number                    02680000
         STH   R0,NEXTREC         Get this record number next           02690000
*                                                                       02700000
         BAL   R14,NXTTOKEN       Get the '(' if present                02710000
         B     $DISKR20           Bif no operands or options            02720000
         CLI   EPLTOKEN,C'('      Start of options                      02730000
         BE    $DISKR10           Yes go get them                       02740000
         B     INVPARM                                                  02750000
$DISKR10 DS    0H                 Here to scan next option              02760000
         BAL   R14,NXTTOKEN       Get the next option token             02770000
         B     $DISKR20           Bif no operands or options            02780000
         BAL   R14,OPTLKUP        Chk option entry from VDISKR          02790000
*                                                                       02800000
* Process the option entry in                                           02810000
*                                                                       02820000
         B     $DISKR10           Go look at next                       02830000
*                                                                       02840000
$DISKR20 DS    0H                 Here after option scan                02850000
         FSSTATE FSCB=(R5)                                              02860000
         LTR   R15,R15                                                  02870000
         BZ    $DISKR30                                                 02880000
         LR    R2,R15             Pass return code                      02890000
         LA    R3,=CL8'FSSTATE'   Pass MACRO name                       02900000
         B     INVRETCD           Tell caller about error               02910000
$DISKR30 DS    0H                                                       02920000
         MVC   EXFSTD(FSTDSIZE),0(R1)  Save copy of FSTD                02930000
*        USING FSTD,R1                                                  02940000
         LA    R0,L'BUFFER                                              02950000
         L     R15,FSTLRECL-FSTD+EXFSTD Current file lrecl              02960000
         CR    R15,R0                                                   02970000
         BL    $DISKR40           Skip if record fits BUFFER            02980000
         TM    OPTBITS3,OPVAR+OPSTEM Input from stem or var?            02990000
         BZ    REC2LARG           Record too large for stack            03000000
*                                 Need a bigger buffer                  03010000
         LA    R0,7(,R15)                                               03020000
         SRL   R0,3               Buffer size in dwords                 03030000
         ST    R0,FILEBUFL                                              03040000
         DMSFREE DWORDS=(0),TYPE=USER,ERR=NOSTORE                       03050000
         ST    R1,FILEBUFA                                              03060000
*                                                                       03070000
$DISKR40 DS    0H                                                       03080000
         TM    OPTBITS3,OPSTEM    REXX STEM output                      03090000
         BZ    $DISKR45           Skip if not                           03100000
         SR    R0,R0              Set the .0 value to 0                 03110000
         ST    R0,STEMNEXT                                              03120000
         BAL   R14,STEMNBLD       Build the .0 stemname                 03130000
*                                                                       03140000
         L     R0,STEMNAML        Length and                            03150000
         LA    R1,STEMNAME           address of xxx.n name              03160000
         LA    R2,1               Length and                            03170000
         LA    R3,=C'0'              address of initial value           03180000
         BAL   R14,PUTREXXV       Set the variable value                03190000
$DISKR45 DS    0H                                                       03200000
*                                                                       03210000
         L     R4,LINES           Number of records to read             03220000
         SR    R3,R3              Records read so far                   03230000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID Search wanted?           03240000
         BNZ   $DISKRL2           Go perform search loop if so          03250000
*                                                                       03260000
* Read the requested number of records                                  03270000
*                                                                       03280000
$DISKRL1 DS    0H                                                       03290000
         BAL   R14,INPUTDEV       Read a file record                    03300000
         LTR   R15,R15                                                  03310000
         BNZ   $DISKEOF           Handle End of file                    03320000
         BAL   R14,MODIFY         Modify output                         03330000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           03340000
         BCT   R4,$DISKRL1        Loop for all lines                    03350000
         B     $DISKR70           Go handle end of count                03360000
*                                                                       03370000
* Read the requested number of records and search                       03380000
*                                                                       03390000
$DISKRL2 DS    0H                                                       03400000
         BAL   R14,INPUTDEV       Read a file record                    03410000
         LTR   R15,R15                                                  03420000
         BNZ   $DISKEOF           Handle End of file                    03430000
         LA    R3,1(,R3)          Count records read                    03440000
         BAL   R14,SEARCH         Search output                         03450000
         BZ    $DISKR50           Branch if match found                 03460000
         BCT   R4,$DISKRL2        Loop for all lines                    03470000
         B     $DISKR70           Go handle end of count                03480000
$DISKR50 DS    0H                                                       03490000
         TM    OPTBITS3,OPFIFO+OPLIFO Stack order specified?            03500000
         BNZ   *+8                                                      03510000
         OI    OPTBITS3,OPLIFO    If not searches stack LIFO            03520000
*                                                                       03530000
         BAL   R14,MODIFY         Modify output                         03540000
         BAL   R14,OUTPUT         Deliver record to caller              03550000
*                                                                       03560000
*        Deliver relative and absolute line numbers                     03570000
*                                                                       03580000
* Current item number only available with internal interface.           03590000
* This program probably only works for VM/370.                          03600000
*                                                                       03610000
         SR    R0,R0              STart search at beginning             03620000
         LA    R1,EXFSCB          Pass FSCB for our file                03630000
         LR    R4,R13             Hold workarea pointer                 03640000
         LA    R13,BUFFER         Save area for ACTLKP                  03650000
         L     R15,AACTLKP        Active File Table lookup              03660000
         BALR  R14,R15                                                  03670000
         LR    R13,R4             Restore workarea pointer              03680000
         LA    R4,99              In case lookup failed                 03690000
         BNZ   $DISKR60           Should not fail, file active          03700000
         USING AFTSECT,R1                                               03710000
         LH    R4,AFTRP           Next Read Pointer                     03720000
         BCTR  R4,0               Current Read Pointer                  03730000
         DROP  R1                                                       03740000
$DISKR60 DS    0H                                                       03750000
*                                                                       03760000
* Relative number to printable                                          03770000
*                                                                       03780000
         CVD   R3,DWORD           Convert binary to packed              03790000
         MVC   BUFFER(L'STEMPAT),STEMPAT  Set pattern                   03800000
         EDMK  BUFFER(L'STEMPAT),DWORD    EDIT with pattern             03810000
*                                                                       03820000
* Absolute number to printable                                          03830000
*                                                                       03840000
         CVD   R4,DWORD           Convert binary to packed              03850000
         MVC   BUFFER+L'STEMPAT(L'STEMPAT),STEMPAT Set pattern          03860000
         EDMK  BUFFER+L'STEMPAT(L'STEMPAT),DWORD EDIT                   03870000
*                                                                       03880000
* Set the two numbers in a line and output to the caller                03890000
*                                                                       03900000
         MVC   BUFFER(10),BUFFER+L'STEMPAT-10                           03910000
         MVI   BUFFER+10,C' '                                           03920000
         MVC   BUFFER+11(10),BUFFER+L'STEMPAT+L'STEMPAT-10              03930000
*                                                                       03940000
         LA    R0,21                                                    03950000
         LA    R1,BUFFER                                                03960000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           03970000
*                                                                       03980000
$DISKR70 DS    0H                                                       03990000
         SR    R3,R3              Set RC = 0                            04000000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID Search requested?        04010000
         BZ    $DISKRXT           Done if not                           04020000
         TM    SELECTFL,SUCCESS   Was search successful?                04030000
         BO    $DISKRXT           Done if so                            04040000
         LA    R3,3               Set RC = 3                            04050000
         B     $DISKRXT                                                 04060000
$DISKEOF DS    0H                 Enter here at End of file             04070000
         CLC   LINES,MAXWORD      lines set to '*'?                     04080000
         BE    $DISKR70           If so, RC=0                           04090000
         C     R3,LINES           Sufficient records read?              04100000
         BNL   $DISKR70           RC=0 if so                            04110000
         LA    R3,2               EOF too soon RC                       04120000
         B     $DISKRXT           Go free buffer and exit               04130000
$DISKRXT DS    0H                 Here with RC in R15                   04140000
         TM    OPTBITS,OPFINIS    FINIS specified                       04150000
         BZ    $DISKR80           If not leave file open                04160000
         FSCLOSE FSCB=(R5)        Close the file                        04170000
         DROP  R5                                                       04180000
$DISKR80 DS    0H                                                       04190000
         ICM   R1,B'1111',FILEBUFA  Allocated buffer address            04200000
         BZ    $DISKR90           Skip if we did not allocate           04210000
         L     R0,FILEBUFL        Size in dwords                        04220000
         DMSFRET DWORDS=(0),LOC=(1)                                     04230000
$DISKR90 DS    0H                                                       04240000
         LR    R15,R3                                                   04250000
         B     EXITRC                                                   04260000
 TITLE 'EXECIO: Handle activity type CARD'                              04270000
*------------------------------------------------------------*          04280000
*                                                            *          04290000
* CARD   -     Read data from the virtual reader             *          04300000
*                                                            *          04310000
*------------------------------------------------------------*          04320000
$CARD    DS    0H                                                       04330000
         MVI   CURROP,VCARD       Set the current operation             04340000
         BAL   R14,NXTTOKEN       Get the next token                    04350000
         B     $CARD20            Bif all processed                     04360000
*                                                                       04370000
         CLI   EPLTOKEN,C'('      Start of options                      04380000
         BNE   INVPARM                                                  04390000
$CARD20  DS    0H                 Here to scan next option              04400000
         BAL   R14,NXTTOKEN       Get the next token                    04410000
         B     $CARD40            Bif all processed                     04420000
*                                                                       04430000
         BAL   R14,OPTLKUP        Chk option entry from VCARD           04440000
         B     $CARD20            Go look at next                       04450000
*                                                                       04460000
$CARD40  DS    0H                 Here after option scan                04470000
         TM    OPTBITS3,OPSTEM    REXX STEM output                      04480000
         BZ    $CARD45            Skip if not                           04490000
         SR    R0,R0              Set the .0 value to 0                 04500000
         ST    R0,STEMNEXT                                              04510000
         BAL   R14,STEMNBLD       Build the .0 stemname                 04520000
*                                                                       04530000
         L     R0,STEMNAML        Length and                            04540000
         LA    R1,STEMNAME           address of xxx.n name              04550000
         LA    R2,1               Length and                            04560000
         LA    R3,=C'0'              address of initial value           04570000
         BAL   R14,PUTREXXV       Set the variable value                04580000
$CARD45  DS    0H                                                       04590000
*                                                                       04600000
         L     R4,LINES           Number of records to read             04610000
         SR    R3,R3              Records read so far                   04620000
*                                                                       04630000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID Search wanted?           04640000
         BNZ   $CARDL2            Go perform search loop if so          04650000
*                                                                       04660000
* Read the requested number of records                                  04670000
*                                                                       04680000
$CARDL1  DS    0H                                                       04690000
         BAL   R14,INPUTDEV       Read a card image                     04700000
         LTR   R15,R15                                                  04710000
         BNZ   $CARD80            Handle End of file                    04720000
         BAL   R14,MODIFY         Modify output                         04730000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           04740000
         BCT   R4,$CARDL1         Loop for all lines                    04750000
         B     $CARD80                                                  04760000
*                                                                       04770000
* Read the requested number of records and search                       04780000
*                                                                       04790000
$CARDL2  DS    0H                                                       04800000
         BAL   R14,INPUTDEV       Read a card image                     04810000
         LTR   R15,R15                                                  04820000
         BNZ   $CARDEOF           Handle End of file                    04830000
         LA    R3,1(,R3)          Count records read                    04840000
         BAL   R14,SEARCH         Search output                         04850000
         BZ    $CARD60            Branch if match found                 04860000
         BCT   R4,$CARDL2         Loop for all lines                    04870000
$CARDEOF DS    0H                 Enter here at EOF                     04880000
         LA    R15,3              Not found RC                          04890000
         B     EXITRC                                                   04900000
$CARD60  DS    0H                                                       04910000
         TM    OPTBITS3,OPFIFO+OPLIFO Stack order specified?            04920000
         BNZ   *+8                                                      04930000
         OI    OPTBITS3,OPLIFO    If not searches stack LIFO            04940000
*                                                                       04950000
         BAL   R14,MODIFY         Modify output                         04960000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           04970000
*                                 Deliver relative line number          04980000
         CVD   R3,DWORD           Convert binary to packed              04990000
         MVC   BUFFER(L'STEMPAT),STEMPAT  Set pattern                   05000000
         EDMK  BUFFER(L'STEMPAT),DWORD    EDIT with pattern             05010000
         LA    R0,10                                                    05020000
         LA    R1,BUFFER+6                                              05030000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           05040000
*                                                                       05050000
$CARD80  DS    0H                 Here after option scan                05060000
         B     EXIT0                                                    05070000
 TITLE 'EXECIO: Handle activity type CP'                                05080000
*------------------------------------------------------------*          05090000
*                                                            *          05100000
* CP     -     Issue a CP command and retrieve the response  *          05110000
*                                                            *          05120000
*------------------------------------------------------------*          05130000
$CP      DS    0H                                                       05140000
         MVI   CURROP,VCP         Set the current operation             05150000
         MVC   CPBUFFL,=F'8192'   Set default response length           05160000
*                                                                       05170000
         BAL   R14,NXTTOKEN       Get the next token                    05180000
         B     $CP040             Bif no options                        05190000
*                                                                       05200000
         CLI   EPLTOKEN,C'('      Start of options                      05210000
         BNE   INVPARM                                                  05220000
$CP020   DS    0H                 Here to scan next option              05230000
         BAL   R14,NXTTOKEN       Get the next token                    05240000
         B     $CP040             Bif all processed                     05250000
*                                                                       05260000
         BAL   R14,OPTLKUP        Chk option entry from VCP             05270000
         B     $CP020             Go look at next                       05280000
*                                                                       05290000
$CP040   DS    0H                 Here after option scan                05300000
*                                                                       05310000
         BAL   R14,INPUT          Fetch input line                      05320000
*                                                                       05330000
         LTR   R5,R0              Length of the cmd                     05340000
         BZ    $CP080             Null record is end of file            05350000
         LR    R4,R1              Address of cmd                        05360000
*                                                                       05370000
         LA    R0,7                                                     05380000
         A     R0,CPBUFFL                                               05390000
         SRL   R0,3                                                     05400000
         DMSFREE DWORDS=(0),TYPE=USER Allocate Resp area                05410000
         ST    R1,CPBUFF                                                05420000
*                                                                       05430000
         LR    R0,R4              Set command line address              05440000
         LR    R2,R5              command line length                   05450000
         ICM   R2,B'1000',=X'40'  Return response to buffer             05460000
*                                                                       05470000
         L     R1,CPBUFF          Response buffer address               05480000
         L     R3,CPBUFFL         Response buffer length                05490000
         DIAG  R0,R2,X'08'                                              05500000
         LA    R15,1              Assume buffer too short               05510000
         BNZ   *+8                Bif response will not fit             05520000
         LA    R15,0              Buffer size was OK                    05530000
*                                                                       05540000
         ST    R1,CPRESPNX        CP response next line addr            05550000
         ST    R3,CPRESPRL        CP response remaining length          05560000
*                                                                       05570000
         LTR   R2,R2              Test CP command return code           05580000
         BZ    $CP045             Skip next if CP command RC=0          05590000
         M     R14,=F'10000'                                            05600000
         LA    R15,1000(,R15)                                           05610000
         AR    R15,R2             Return 1000 + return code             05620000
*                                   from CP command plus                05630000
*                                   10000 times EXECIO RC               05640000
*                                   (0, 1, 2, or 3)                     05650000
$CP045   DS    0H                                                       05660000
         LTR   R15,R15                                                  05670000
         BNZ   EXITRC             Exit with error return code           05680000
*                                                                       05690000
         TM    OPTBITS3,OPSTEM    REXX STEM output                      05700000
         BZ    $CP050             Skip if not                           05710000
         SR    R0,R0              Set the .0 value to 0                 05720000
         ST    R0,STEMNEXT                                              05730000
         BAL   R14,STEMNBLD       Build the .0 stemname                 05740000
*                                                                       05750000
         L     R0,STEMNAML        Length and                            05760000
         LA    R1,STEMNAME           address of xxx.n name              05770000
         LA    R2,1               Length and                            05780000
         LA    R3,=C'0'              address of initial value           05790000
         BAL   R14,PUTREXXV       Set the variable value                05800000
$CP050   DS    0H                                                       05810000
*                                                                       05820000
         L     R4,LINES           Number of records to read             05830000
*                                                                       05840000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID Search wanted?           05850000
         BNZ   $CPL2              Go perform search loop if so          05860000
*                                                                       05870000
* Read the requested number of records                                  05880000
*                                                                       05890000
$CPL1    DS    0H                                                       05900000
         BAL   R14,INPUTDEV       Read next CP response line            05910000
         LTR   R15,R15                                                  05920000
         BNZ   $CP080             Handle End of file                    05930000
         BAL   R14,MODIFY         Modify output                         05940000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           05950000
         BCT   R4,$CPL1           Loop for all lines                    05960000
         B     $CP080             Almost done                           05970000
*                                                                       05980000
* Read the requested number of records and search                       05990000
*                                                                       06000000
$CPL2    DS    0H                                                       06010000
         BAL   R14,INPUTDEV       Read next CP response line            06020000
         LTR   R15,R15                                                  06030000
         BNZ   $CPEOF             Handle End of file                    06040000
         LA    R3,1(,R3)          Count records read                    06050000
         BAL   R14,SEARCH         Search output                         06060000
         BZ    $CP060             Branch if match found                 06070000
         BCT   R4,$CPL2           Loop for all lines                    06080000
$CPEOF   DS    0H                                                       06090000
         BAL   R14,$CPFRET        Release the response buffer           06100000
         LA    R15,3              Not found RC                          06110000
         B     EXITRC                                                   06120000
$CP060   DS    0H                 Here after option scan                06130000
         TM    OPTBITS3,OPFIFO+OPLIFO Stack order specified?            06140000
         BNZ   *+8                                                      06150000
         OI    OPTBITS3,OPLIFO    If not searches stack LIFO            06160000
*                                                                       06170000
         BAL   R14,MODIFY         Modify output                         06180000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           06190000
*                                 Deliver relative line number          06200000
         CVD   R3,DWORD           Convert binary to packed              06210000
         MVC   BUFFER(L'STEMPAT),STEMPAT  Set pattern                   06220000
         EDMK  BUFFER(L'STEMPAT),DWORD    EDIT with pattern             06230000
         LA    R0,10                                                    06240000
         LA    R1,BUFFER+6                                              06250000
         BAL   R14,OUTPUT         Deliver to the calling EXEC           06260000
$CP080   DS    0H                                                       06270000
         B     EXIT0                                                    06280000
*                                                                       06290000
$CPFRET  DS    0H                                                       06300000
         STM   R14,R1,SAVEAREA                                          06310000
         A     R0,CPBUFFL                                               06320000
         SRL   R0,3                                                     06330000
         L     R1,CPBUFF                                                06340000
         DMSFRET DWORDS=(0),LOC=(1) Release Resp area                   06350000
         LM    R14,R1,SAVEAREA                                          06360000
         BR    R14                                                      06370000
 TITLE 'EXECIO: Handle activity type DISKW'                             06380000
*------------------------------------------------------------*          06390000
*                                                            *          06400000
* DISKW  -     Write data to minidisk file                   *          06410000
*                                                            *          06420000
*------------------------------------------------------------*          06430000
$DISKW   DS    0H                                                       06440000
         MVI   CURROP,VDISKW      Set the current operation             06450000
         LA    R5,EXFSCB          Build FSCB here                       06460000
         USING FSCBD,R5                                                 06470000
         XC    FSCBD(FSCBDLEN),FSCBD                                    06480000
         MVC   FSCBITNO,=H'1'     Default record number is 1            06490000
         XC    NEXTREC,NEXTREC    Assume we will write the              06500000
*                                   next record in the file             06510000
         LA    R4,=CL8'Filename'                                        06520000
         BAL   R14,NXTTOKEN       Get the next token                    06530000
         B     MISSING                                                  06540000
         MVC   FSCBFN,EPLTOKEN    Copy in filename                      06550000
*                                                                       06560000
         LA    R4,=CL8'Filetype'                                        06570000
         BAL   R14,NXTTOKEN       Get the next token                    06580000
         B     MISSING                                                  06590000
         MVC   FSCBFT,EPLTOKEN    Copy in filetype                      06600000
*                                                                       06610000
         LA    R4,=CL8'Filemode'                                        06620000
         BAL   R14,NXTTOKEN       Get the next token                    06630000
         B     MISSING                                                  06640000
         CLI   EPLTOKEN+2,C' '    Max length is 2                       06650000
         BNE   INVPARM            Too long for filemode                 06660000
         MVC   FSCBFM,EPLTOKEN    Copy in filemode                      06670000
*                                                                       06680000
         FSSTATE FSCB=(R5)        Does file exist?                      06690000
         LTR   R15,R15                                                  06700000
         BNZ   $DISKW01           Skip if not                           06710000
         MVC   EXFSTD(FSTDSIZE),0(R1)  Save copy of FSTD                06720000
*        USING FSTD,R1                                                  06730000
         LA    R0,L'BUFFER                                              06740000
         L     R15,FSTLRECL-FSTD+EXFSTD Current file lrecl              06750000
         ST    R15,FILERECL       Set LRECL                             06760000
         ST    R15,FSCBSIZE       Here too                              06770000
         MVC   FSCBFV(1),FSTRECFM-FSTD+EXFSTD Record format             06780000
         MVI   FSCBFV+1,C' '                                            06790000
         B     $DISKW02           Skip                                  06800000
$DISKW01 DS    0H                                                       06810000
*                                                                       06820000
* Here when file does not exist                                         06830000
*                                                                       06840000
         MVC   FSCBFV,=CL2'V '    Default record format                 06850000
         MVC   FSCBSIZE,=F'80'    Default record length is 80           06860000
$DISKW02 DS    0H                                                       06870000
*                                                                       06880000
         BAL   R14,NXTTOKEN       Get the next token                    06890000
         B     $DISKW30           Bif no operands or options            06900000
         CLI   EPLTOKEN,C'('      Start of options                      06910000
         BE    $DISKW20           Yes go get them                       06920000
*                                                                       06930000
* Retrieve the line number                                              06940000
*                                                                       06950000
         LA    R1,EPLTOKEN        Here too                              06960000
         BAL   R14,CVB            Convert lines to binary               06970000
         B     INVLINES           Bif invalid number                    06980000
         STH   R0,NEXTREC         Put this record number next           06990000
*                                                                       07000000
         BAL   R14,NXTTOKEN       Get the next token                    07010000
         B     $DISKW30           Bif no operands or options            07020000
         CLI   EPLTOKEN,C'('      Start of options                      07030000
         BE    $DISKW20           Yes go get them                       07040000
*                                                                       07050000
* Retrieve the record format                                            07060000
*                                                                       07070000
         LA    R4,=CL8'RECFM'                                           07080000
         CLI   EPLTOKEN+1,C' '    Max length is 1                       07090000
         BNE   INVPARM            Too long for recfm                    07100000
         CLI   EPLTOKEN,C'F'      Fixed?                                07110000
         BE    $DISKW10                                                 07120000
         CLI   EPLTOKEN,C'V'      Variable                              07130000
         BNE   INVPARM            Bad recfm value                       07140000
$DISKW10 DS    0H                                                       07150000
         MVC   FSCBFV,EPLTOKEN                                          07160000
*                                                                       07170000
         BAL   R14,NXTTOKEN       Get the next token                    07180000
         B     $DISKW30           Bif no operands or options            07190000
         CLI   EPLTOKEN,C'('      Start of options                      07200000
         BE    $DISKW20           Yes go get them                       07210000
*                                                                       07220000
* Retrieve the record length                                            07230000
*                                                                       07240000
         LA    R1,EPLTOKEN        Here too                              07250000
         BAL   R14,CVB            Convert lines to binary               07260000
         B     INVLRECL           Bif invalid lrecl                     07270000
         ST    R0,FILERECL        Save the output LRECL                 07280000
*                                                                       07290000
         BAL   R14,NXTTOKEN       Get the next token                    07300000
         B     $DISKW30           Bif no operands or options            07310000
         CLI   EPLTOKEN,C'('      Start of options                      07320000
         BNE   INVPARM                                                  07330000
*                                                                       07340000
* Process command options                                               07350000
*                                                                       07360000
$DISKW20 DS    0H                 Here to start option scan             07370000
         BAL   R14,NXTTOKEN       Get the next token                    07380000
         B     $DISKW30              Bif all processed                  07390000
*                                                                       07400000
         BAL   R14,OPTLKUP        Chk option entry from VDISKW          07410000
         B     $DISKW20           Go look at next                       07420000
*                                                                       07430000
$DISKW30 DS    0H                 Here after option scan                07440000
         TM    OPTBITS3,OPVAR+OPSTEM Input from stem or var?            07450000
         BZ    $DISKW40           No special buffer needed              07460000
         LA    R0,L'BUFFER        Default buffer size                   07470000
         L     R1,FILERECL        Get the output LRECL                  07480000
         CR    R1,R0              Is default buffer OK?                 07490000
         BNH   $DISKW40           Bif default <= LRECL                  07500000
*                                                                       07510000
         LA    R0,7(,R1)          Round up                              07520000
         SRL   R0,3                 to LRECL doublewords                07530000
         DMSFREE DWORDS=(0),TYPE=USER Allocate Work area                07540000
         SLL   R0,3               Dwords to Bytes                       07550000
         ST    R0,REXBUFFL                                              07560000
         ST    R1,REXBUFF                                               07570000
$DISKW40 DS    0H                 Here when buffer ready                07580000
         L     R4,LINES                                                 07590000
$DISKW50 DS    0H                                                       07600000
*                                                                       07610000
         BAL   R14,INPUT          Fetch input line                      07620000
         LTR   R0,R0                                                    07630000
         BZ    $DISKW70           Null record is end of file            07640000
         BAL   R14,MODIFY         Modify output                         07650000
*                                                                       07660000
         LR    R3,R0              Length of the line                    07670000
         LR    R2,R1              Address of line                       07680000
         LH    R6,NEXTREC         Possible next record number           07690000
*                                    to write (or 0 to write            07700000
*                                    the record after the last          07710000
*                                    record we wrote)                   07720000
         XC    NEXTREC,NEXTREC    Normal increment now         HRC428DS 07720100
$DISKW55 DS    0H                                                       07730000
         FSWRITE FSCB=(R5),BUFFER=(R2),BSIZE=(R3),RECNO=(R6)            07740000
         LTR   R15,R15                                                  07750000
         BZ    $DISKW65                                                 07760000
         C     R15,=F'9'          Already OPEN for READ?                07770000
         BNE   $DISKW60           Skip if not                           07780000
         FSCLOSE FSCB=(R5)        Just close it                         07790000
         B     $DISKW55                                                 07800000
$DISKW60 DS    0H                                                       07810000
         LR    R2,R15             Pass return code                      07820000
         LA    R3,=CL8'FSWRITE'   Pass MACRO name                       07830000
         B     INVRETCD           Tell caller about error               07840000
$DISKW65 DS    0H                                                       07850000
         BCT   R4,$DISKW50        Loop for all lines                    07860000
$DISKW70 DS    0H                                                       07870000
         SR    R15,R15            RC=0                                  07880000
         TM    OPTBITS,OPFINIS    FINIS specified                       07890000
         BZ    $DISKW80           If not leave file open                07900000
*                                                                       07910000
         FSCLOSE FSCB=(R5)        Close the file                        07920000
         DROP  R5                                                       07930000
         SR    R15,R15            RC=0                                  07940000
$DISKW80 DS    0H                 Here with RC in R15                   07950000
         LR    R3,R15                                                   07960000
         ICM   R1,B'1111',FILEBUFA  Allocated buffer address            07970000
         BZ    $DISKW90           Skip if we did not allocate           07980000
         L     R0,FILEBUFL        Size in dwords                        07990000
         DMSFRET DWORDS=(0),LOC=(1)                                     08000000
$DISKW90 DS    0H                                                       08010000
         LR    R15,R3                                                   08020000
         B     EXITRC                                                   08030000
 TITLE 'EXECIO: Handle activity type PUNCH'                             08040000
*------------------------------------------------------------*          08050000
*                                                            *          08060000
* PUNCH  -     Send data to the virtual punch                *          08070000
*                                                            *          08080000
*------------------------------------------------------------*          08090000
$PUNCH   DS    0H                                                       08100000
         MVI   CURROP,VPUNCH      Set the current operation             08110000
         BAL   R14,NXTTOKEN       Get the next token                    08120000
         B     $PUNCHNO           Bif no options                        08130000
*                                                                       08140000
         CLI   EPLTOKEN,C'('      Start of options                      08150000
         BNE   INVPARM                                                  08160000
$PUNCHOP DS    0H                 Here to start option scan             08170000
         BAL   R14,NXTTOKEN       Get the next token                    08180000
         B     $PUNCHNO           Bif no options                        08190000
*                                                                       08200000
         BAL   R14,OPTLKUP        Chk option entry from VPUNCH          08210000
         B     $PUNCHOP           Go look at next                       08220000
*                                                                       08230000
$PUNCHNO DS    0H                 Here after option scan                08240000
         L     R4,LINES                                                 08250000
$PUNCHLP DS    0H                                                       08260000
*                                                                       08270000
         BAL   R14,INPUT          Fetch input line                      08280000
         LTR   R0,R0                                                    08290000
         BZ    $PUNCHND           Null record is end of file            08300000
         BAL   R14,MODIFY         Modify output                         08310000
*                                                                       08320000
         LR    R3,R0              Length of the line                    08330000
         LR    R2,R1              Address of line                       08340000
         PUNCHC (R2)              Punch it, Mr. Sulu                    08350000
         LTR   R15,R15                                                  08360000
         BZ    $PUNCHOK                                                 08370000
         LR    R2,R15             Pass return code                      08380000
         LA    R3,=CL8'PUNCHC'    Pass MACRO name                       08390000
         B     INVRETCD           Tell caller about error               08400000
$PUNCHOK DS    0H                                                       08410000
         BCT   R4,$PUNCHLP        Loop for all lines                    08420000
*                                                                       08430000
$PUNCHND DS    0H                                                       08440000
         B     EXIT0                                                    08450000
 TITLE 'EXECIO: Handle activity type EMSG'                              08460000
*------------------------------------------------------------*          08470000
*                                                            *          08480000
* EMSG   -     Edit message                                  *          08490000
*                                                            *          08500000
*------------------------------------------------------------*          08510000
$EMSG    DS    0H                                                       08520000
         MVI   CURROP,VEMSG       Set the current operation             08530000
         BAL   R14,NXTTOKEN       Get the next token                    08540000
         B     $EMSGNO            Bif no options                        08550000
         CLI   EPLTOKEN,C'('      Start of options                      08560000
         BNE   INVPARM                                                  08570000
$EMSGOP  DS    0H                 Here to start option scan             08580000
         BAL   R14,NXTTOKEN       Get the next token                    08590000
         B     $EMSGNO            Bif no options                        08600000
*                                                                       08610000
         BAL   R14,OPTLKUP        Chk option entry from VEMSG           08620000
         B     $EMSGOP            Go look at next                       08630000
*                                                                       08640000
$EMSGNO  DS    0H                 Here after option scan                08650000
         L     R4,LINES                                                 08660000
$EMSGLP  DS    0H                                                       08670000
*                                                                       08680000
         BAL   R14,INPUT          Fetch input line                      08690000
         LTR   R0,R0                                                    08700000
         BZ    $EMSGEND           Null record is end of file            08710000
         BAL   R14,MODIFY         Modify output                         08720000
*                                                                       08730000
         LA    R2,BUFFERE         TEXTA message goes here               08740000
         LR    R3,R0              EMSG text length                      08750000
         BCTR  R3,0                  minus 1                            08760000
         MVC   1(*-*,R2),0(R1)    Copy EMSG to BUFFERE + 1              08770000
         EX    R3,*-6                                                   08780000
         LA    R3,1(,R3)          Set true length                       08790000
         STC   R3,0(,R2)            as first byte                       08800000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  08810000
         MVI   BUFFER,255         Set buffer size in byte 1             08820000
         LINEDIT TEXTA=(R2),DOT=NO,DISP=ERRMSG,BUFFA=BUFFER,           *08830000
               MF=(E,LINEDITL)                                          08840000
         BCT   R4,$EMSGLP         Loop for all lines                    08850000
$EMSGEND DS    0H                 Here after option scan                08860000
         B     EXIT0                                                    08870000
 TITLE 'EXECIO: Handle activity type PRINT'                             08880000
*------------------------------------------------------------*          08890000
*                                                            *          08900000
* PRINT  -     Send data to the virtual printer              *          08910000
*                                                            *          08920000
*------------------------------------------------------------*          08930000
$PRINT   DS    0H                                                       08940000
         MVI   CURROP,VPRINT      Set the current operation             08950000
         MVI   CC,C' '            Set the default CC value              08960000
         BAL   R14,NXTTOKEN       Get the next token                    08970000
         B     $PRINTNO           Bif no options                        08980000
*                                                                       08990000
         CLI   EPLTOKEN,C'('      Start of options                      09000000
         BNE   INVPARM                                                  09010000
$PRINTOP DS    0H                 Here to start option scan             09020000
         BAL   R14,NXTTOKEN       Get the next token                    09030000
         B     $PRINTNO           Bif no options                        09040000
*                                                                       09050000
         BAL   R14,OPTLKUP        Chk option entry from VPRINT          09060000
         B     $PRINTOP           Go look at next                       09070000
*                                                                       09080000
$PRINTNO DS    0H                 Here after option scan                09090000
         L     R4,LINES                                                 09100000
$PRINTLP DS    0H                                                       09110000
*                                                                       09120000
         BAL   R14,INPUT          Fetch input line                      09130000
         LTR   R0,R0                                                    09140000
         BZ    $PRINTND           Null record is end of file            09150000
         BAL   R14,MODIFY         Modify output                         09160000
*                                                                       09170000
         LR    R3,R0              Length of the line                    09180000
         LR    R2,R1              Address of line                       09190000
         PRINTL (R2),(R3)                                               09200000
         LTR   R15,R15                                                  09210000
         BZ    $PRINTOK                                                 09220000
         LR    R2,R15             Pass return code                      09230000
         LA    R3,=CL8'PRINTL'    Pass MACRO name                       09240000
         B     INVRETCD           Tell caller about error               09250000
$PRINTOK DS    0H                                                       09260000
         BCT   R4,$PRINTLP        Loop for all lines                    09270000
*                                                                       09280000
$PRINTND DS    0H                                                       09290000
         B     EXIT0                                                    09300000
 TITLE 'EXECIO: Retrieve input from caller'                             09310000
*------------------------------------------------------------*          09320000
*                                                            *          09330000
* Retrieve incoming information from the calling EXEC        *          09340000
*                                                            *          09350000
*------------------------------------------------------------*          09360000
INPUT    DS    0H                                                       09370000
         STM   R14,R5,SAVEAREA                                          09380000
         USING SHVBLOCK,R5                                              09390000
         TM    CURROP,VCP         Is current operation 'CP'?            09400000
         BO    INPNSTEM           No VAR or STEM input if so            09410000
*                                                                       09420000
* Retrieve input from a REXX variable                                   09430000
*                                                                       09440000
         TM    OPTBITS3,OPVAR     REXX Variable input                   09450000
         BZ    INPNV              Skip if not                           09460000
*                                 Is option used for input?             09470000
         TM    CURROP,VOUT        Option used as output by              09480000
*                                    an input operator?                 09490000
         BZ    INPNV              Skip if not                           09500000
*                                                                       09510000
         L     R1,VARNAMEA        REXX variable name address            09520000
         L     R0,VARNAMEL        REXX variable name length             09530000
         BAL   R14,GETREXXV       Get the variable value                09540000
*              R1                 REXX variable value address           09550000
*              R0                 REXX variable value length            09560000
         B     INPUTRET                                                 09570000
INPNV    DS    0H                                                       09580000
*                                                                       09590000
* Retrieve input from a REXX stem                                       09600000
*                                                                       09610000
         TM    OPTBITS3,OPSTEM    REXX STEM input                       09620000
         BZ    INPNSTEM           Skip if not                           09630000
*                                 Is option used for input?             09640000
         TM    CURROP,VOUT        Option used as output by              09650000
*                                    an input operator?                 09660000
         BZ    INPNSTEM           Skip if not                           09670000
*                                                                       09680000
* Retrieve max elements in stem count if first time through             09690000
*                                                                       09700000
         ICM   R1,B'1111',STEMMAXI Maximum index for stem               09710000
         BNZ   INPSHAV0           Bif it is set                         09720000
*                                                                       09730000
         SR    R0,R0              Build the                             09740000
         BAL   R14,STEMNBLD             .0 stemname                     09750000
         MVI   BUFFER,C' '                                              09760000
         MVC   BUFFER+1(L'BUFFER-1),BUFFER  Blank buffer                09770000
         L     R0,STEMNAML        Length and                            09780000
         LA    R1,STEMNAME           address of xxx.0 name              09790000
*                                                                       09800000
*              R1                 REXX variable name address            09810000
*              R0                 REXX variable name length             09820000
         BAL   R14,GETREXXV       Get the variable value                09830000
*              R1                 REXX variable value address           09840000
*              R0                 REXX variable value length            09850000
         BAL   R14,CVB                                                  09860000
         B     INVOPTV            Bif invalid number                    09870000
         ST    R0,STEMMAXI        Set xxx.0 value here                  09880000
         LA    R1,1                                                     09890000
         ST    R1,STEMNEXT        Next xxx.n value to fetch             09900000
INPSHAV0 DS    0H                                                       09910000
*                                                                       09920000
         L     R0,STEMNEXT        R0 = .n to build                      09930000
         C     R0,STEMMAXI        Is n > stem.0?                        09940000
         BNH   INPSGETN           If not, get next element              09950000
         SR    R0,R0                                                    09960000
         B     INPUTRET           Send back EOF indicator               09970000
INPSGETN DS    0H                                                       09980000
         BAL   R14,STEMNBLD       Build the .n stemname                 09990000
         L     R0,STEMNAML        Length and                            10000000
         LA    R1,STEMNAME           address of xxx.n name              10010000
*              R1                 REXX variable name address            10020000
*              R0                 REXX variable name length             10030000
         BAL   R14,GETREXXV       Get the variable value                10040000
*              R1                 REXX variable value address           10050000
*              R0                 REXX variable value length            10060000
         LA    R14,1              Increment the .n                      10070000
         A     R14,STEMNEXT         value for next iteration            10080000
         ST    R14,STEMNEXT                                             10090000
         B     INPUTRET                                                 10100000
INPNSTEM DS    0H                                                       10110000
*                                                                       10120000
* Retrieve input from the STRING option                                 10130000
*                                                                       10140000
         TM    OPTBITS3,OPSTRING  STRING input                          10150000
         BZ    INPNSTR            Skip if not                           10160000
         L     R1,STRINGBF        Set upper case buffer addr            10170000
         L     R0,STRINGBL        Set length                            10180000
         B     INPUTRET                                                 10190000
INPNSTR  DS    0H                                                       10200000
*                                                                       10210000
* Retrieve input from the stack                                         10220000
*                                                                       10230000
*                                                                       10240000
         BAL   R14,PULL           Pull next line from stack             10250000
*                                 R1 -> string, R0 = length             10260000
INPUTRET DS    0H                                                       10270000
*                                 Return  R15 = return code             10280000
         L     R14,SAVEAREA                 0 = input length            10290000
         LM    R2,R5,SAVEAREA+16            1 = input address           10300000
         BR    R14                Input data is ready                   10310000
         DROP  R5                                                       10320000
 TITLE 'EXECIO: Retrieve input from a device or CP response'            10330000
*------------------------------------------------------------*          10340000
*                                                            *          10350000
* Retrieve incoming information from input device or         *          10360000
*        the CP command response buffer                      *          10370000
*                                                            *          10380000
*------------------------------------------------------------*          10390000
INPUTDEV DS    0H                                                       10400000
         STM   R14,R5,SAVEAREA                                          10410000
*                                                                       10420000
* Fetch input line from a file                                          10430000
*                                                                       10440000
         TM    CURROP,VDISKR      From file?                            10450000
         BZ    INPUTD2            No, try next                          10460000
         LA    R5,EXFSCB          Build FSCB here                       10470000
         LA    R2,BUFFER                                                10480000
         L     R3,FSTLRECL-FSTD+EXFSTD Record size                      10490000
*                                                                       10500000
         LA    R15,L'BUFFER                                             10510000
         CR    R3,R15             Is lrecl < 256?                       10520000
         BL    INPUTD1            Skip next if so                       10530000
         L     R2,FILEBUFA        Use larger buffer                     10540000
INPUTD1  DS    0H                                                       10550000
*                                                                       10560000
         LH    R4,NEXTREC         Possible next record number           10570000
*                                    to read (or 0 to read              10580000
*                                    the record after the last          10590000
*                                    record we read)                    10600000
         XC    NEXTREC,NEXTREC    Normal increment now         HRC428DS 10600100
INPUTD14 DS    0H                                                       10610000
         FSREAD FSCB=(R5),BUFFER=(R2),BSIZE=(R3),                      *10620000
               RECNO=(R4),NOREC=1                                       10630000
         LR    R1,R2              Reload record address                 10640000
         LTR   R15,R15                                                  10650000
         BZ    INPUTEND                                                 10660000
         C     R15,=F'12'         EOF?                                  10670000
         BE    INPUTEOF           Input from Device is done             10680000
         C     R15,=F'9'          Already OPEN for WRITE?               10690000
         BNE   INPUTD18           Skip if not                           10700000
         FSCLOSE FSCB=(R5)        Just close it                         10710000
         B     INPUTD14                                                 10720000
INPUTD18 DS    0H                                                       10730000
         LR    R2,R15             Pass return code                      10740000
         LA    R3,=CL8'FSREAD'    Pass MACRO name                       10750000
         B     INVRETCD           Tell caller about error               10760000
*                                                                       10770000
* Fetch input line from a card reader                                   10780000
*                                                                       10790000
INPUTD2  DS    0H                                                       10800000
         TM    CURROP,VCARD       From Card reader?                     10810000
         BZ    INPUTD3            No, try next                          10820000
         LA    R2,BUFFER                                                10830000
         LA    R3,151             Max lrecl for reader                  10840000
         RDCARD (R2),(R3)         Read a record                         10850000
         LA    R1,BUFFER          Record address                        10860000
*              R0                 Record length                         10870000
         LTR   R15,R15                                                  10880000
         BZ    INPUTEND                                                 10890000
         C     R15,=F'5'          Incorrect length?                     10900000
         BE    INPUTEND           Correct length is in R0               10910000
         C     R15,=F'1'          EOF?                                  10920000
         BE    INPUTEOF           Input from Device is done             10930000
         LR    R2,R15             Pass return code                      10940000
         LA    R3,=CL8'RDCARD'    Pass MACRO name                       10950000
         B     INVRETCD           Tell caller about error               10960000
*                                                                       10970000
* Fetch input line from a CP command response buffer                    10980000
*                                                                       10990000
INPUTD3  DS    0H                                                       11000000
         TM    CURROP,VCP         From CP response                      11010000
         BZ    INPUTD4            No, try next                          11020000
         L     R2,CPRESPNX        CP response next line addr            11030000
         L     R3,CPRESPRL        CP response remaining length          11040000
*                                 R2 is the response address            11050000
*                                 R3 is the response length             11060000
         LTR   R0,R3              Anything left to return?              11070000
         BZ    INPUTEOF           If not, send EOF to caller            11080000
         LR    R4,R2              Start of 1st response line            11090000
INPUTD15 DS    0H                                                       11100000
         LA    R4,1(,R4)                                                11110000
         CLI   0(R4),X'15'        Found X'15' delimiter?                11120000
         BE    *+8                Found end of line, skip out           11130000
         BCT   R3,INPUTD15        No, keep looking                      11140000
*                                                                       11150000
         BCTR  R3,0               Decrement to account for              11160000
*                                   the trailing X'15'                  11170000
         LA    R0,1(,R4)                                                11180000
         ST    R0,CPRESPNX        Save next line start                  11190000
*                                    for next iteration                 11200000
         BCTR  R3,0                                                     11210000
         ST    R3,CPRESPRL        Save remaining length                 11220000
*                                    for next iteration                 11230000
         LR    R1,R2              Address of line we found              11240000
         LR    R0,R4              Address of following X'15'            11250000
         SR    R0,R1              Length of line we found               11260000
         B     INPUTEND                                                 11270000
INPUTD4  DS    0H                                                       11280000
         DC    H'0'               Should not get here                   11290000
INPUTEND DS    0H                                                       11300000
         SR    R15,R15                                                  11310000
         B     INPUTXIT                                                 11320000
INPUTEOF DS    0H                 Input from Device is done             11330000
         LA    R15,1              EOF Return code                       11340000
INPUTXIT DS    0H                                                       11350000
         STM   R15,R1,SAVEAREA+4  Pass back R15,R0,R1                   11360000
         LM    R14,R5,SAVEAREA                                          11370000
         BR    R14                                                      11380000
 TITLE 'EXECIO: Select input records'                                   11390000
*------------------------------------------------------------*          11400000
*                                                            *          11410000
* Choose specific records using selection criteria           *          11420000
*                                                            *          11430000
*------------------------------------------------------------*          11440000
SEARCH   DS    0H                                                       11450000
         STM   R14,R5,SAVEAREA                                          11460000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID Search wanted?           11470000
         BZ    SRCHRET            Return if no search criteria          11480000
*                                                                       11490000
         LR    R7,R1              Address of line to search             11500000
         LR    R8,R0              Length of line to search              11510000
*                                                                       11520000
         LR    R2,R7                                                    11530000
         TM    OPTBITS2,OPZONE    Specific column range?                11540000
         BZ    NOZONE1            Skip if not                           11550000
         A     R2,ZONE1           Search start address                  11560000
         BCTR  R2,0                                                     11570000
NOZONE1  DS    0H                 R2 is search start address            11580000
*                                                                       11590000
         LA    R6,0(R7,R8)        point past end of line                11600000
         LR    R1,R6              Here too                              11610000
         TM    OPTBITS2,OPZONE    Specific column range?                11620000
         BZ    NOZONE2            Skip if not                           11630000
         LR    R1,R7                                                    11640000
         A     R1,ZONE2           End start address                     11650000
         C     R1,MAXWORD                                               11660000
         BNH   *+8                Don't go overboard.                   11670000
         L     R1,MAXWORD                                               11680000
*                                                                       11690000
         CR    R1,R6              Pick the lessor of end                11700000
         BNH   *+6                   of zone or end of line             11710000
         LR    R1,R6                                                    11720000
NOZONE2  DS    0H                 R2 is search start address            11730000
*                                                                       11740000
* R1 is one byte past search area                                       11750000
* R2 is start of search area                                            11760000
*                                                                       11770000
         L     R4,FILTERL         Length of string to find              11780000
         SR    R1,R4              Address of last place in              11790000
*                                   record where search can             11800000
*                                     be done                           11810000
         BCTR  R4,0               Length of search string - 1           11820000
*                                                                       11830000
*                                                                       11840000
* Filter data as requested by option FIND                               11850000
*                                                                       11860000
         TM    OPTBITS,OPFIND     Specific records to FIND?             11870000
         BZ    SRCHNF             Skip if not                           11880000
         L     R15,FILTERA        Search data start                     11890000
         CLC   0(*-*,R2),0(R15)                                         11900000
         EX    R4,*-6             Match found in 1st column?            11910000
         BE    SRCHPASS           Yes, found                            11920000
         B     SRCHFAIL           No, not found                         11930000
SRCHNF   DS    0H                                                       11940000
*                                                                       11950000
* Filter data by option LOCATE or AVOID                                 11960000
*                                                                       11970000
         CR    R2,R1              Within search area?                   11980000
         BH    SRCHFAIL           Not found if not                      11990000
         L     R15,FILTERA        Search data start                     12000000
SRCHLOOP DS    0H                                                       12010000
         CLC   0(*-*,R2),0(R15)                                         12020000
         EX    R4,*-6             Match?                                12030000
         BE    SEARCHF            Yes, search done                      12040000
*                                                                       12050000
         LA    R2,1(,R2)          Step to next column                   12060000
         CR    R2,R1              Within search area?                   12070000
         BL    SRCHLOOP           Check next column if so               12080000
*                                 No match with search                  12090000
         TM    OPTBITS,OPLOCATE   Specific records to LOCATE?           12100000
         BO    SRCHFAIL           Bif record we want not found          12110000
         B     SRCHPASS           Otherwise pass                        12120000
SEARCHF  DS    0H                 Record matches search                 12130000
         TM    OPTBITS,OPAVOID    Specific records to AVOID             12140000
         BO    SRCHFAIL           Bif record not avoided                12150000
         B     SRCHPASS           Otherwise match passes                12160000
*                                                                       12170000
SRCHPASS DS    0H                                                       12180000
         OI    SELECTFL,SUCCESS   Remember search success               12190000
         SR    R15,R15            CC=0 means use the record             12200000
         B     SRCHRET                                                  12210000
SRCHFAIL DS    0H                                                       12220000
         LA    R15,1                                                    12230000
SRCHRET  DS    0H                                                       12240000
         L     R14,SAVEAREA                                             12250000
         LM    R0,R5,SAVEAREA+8                                         12260000
         LTR   R15,R15            Set CC                                12270000
         BR    R14                                                      12280000
 TITLE 'EXECIO: Modify system output'                                   12290000
*------------------------------------------------------------*          12300000
*                                                            *          12310000
* Modify data before sending to calling EXEC or to device    *          12320000
*                                                            *          12330000
*------------------------------------------------------------*          12340000
MODIFY   DS    0H                                                       12350000
         STM   R14,R5,SAVEAREA                                          12360000
*                                                                       12370000
* Transform data as requested by option MARGIN                          12380000
*                                                                       12390000
         TM    OPTBITS2,OPMARGIN  specific output columns?              12400000
         BZ    MODOUNM            Skip if not                           12410000
         L     R4,MARGIN1                                               12420000
         L     R5,MARGIN2                                               12430000
         LR    R2,R0                                                    12440000
         LA    R2,0(R2,R1)        R2 points past last byte              12450000
*                                    in string                          12460000
         LA    R5,0(R5,R1)        R5 points past last byte              12470000
*                                    in ending margin                   12480000
         CR    R2,R5                                                    12490000
         BNH   *+6                Skip if margin 2 not smaller          12500000
         LR    R2,R5              R2 now points to byte past            12510000
*                                    end margin                         12520000
         BCTR  R4,0                                                     12530000
         LA    R4,0(R4,R1)        R4 points to first byte in            12540000
*                                    start margin                       12550000
         CR    R1,R4                                                    12560000
         BNL   *+6                Skip if margin 1 not larger           12570000
         LR    R1,R4              R1 now points to byte at              12580000
*                                    start margin                       12590000
         LR    R0,R2                                                    12600000
         SR    R0,R1              R0 has new length                     12610000
MODOUNM  DS    0H                                                       12620000
*                                                                       12630000
* Transform data as requested by option STRIP                           12640000
*                                                                       12650000
         TM    OPTBITS2,OPSTRIP   Skip leading,trailing blanks          12660000
         BZ    MODOUNS            Skip if not                           12670000
         C     R0,=F'1'           No strip for string                   12680000
         BE    MODOUS5               one byte long                      12690000
*                                                                       12700000
         LR    R2,R0                                                    12710000
         LA    R2,0(R2,R1)        R2 points past last byte              12720000
*                                    in string                          12730000
         BCTR  R2,0               R2 points to last byte                12740000
MODOUS1  DS    0H                                                       12750000
         CR    R2,R1                                                    12760000
         BNH   MODOUS2            All blanks?                           12770000
         CLI   0(R2),C' '                                               12780000
         BNE   MODOUS2                                                  12790000
         BCT   R2,MODOUS1         Back up one and look again            12800000
MODOUS2  DS    0H                                                       12810000
         LA    R2,1(,R2)          Point past last non-blank             12820000
*                                    or past one single blank           12830000
MODOUS3  DS    0H                                                       12840000
         CLI   0(R1),C' '                                               12850000
         BNE   MODOUS4            No leading blanks                     12860000
         LA    R1,1(,R1)                                                12870000
         CR    R1,R2                                                    12880000
         BL    MODOUS3                                                  12890000
         BCTR  R1,0               Back up to only blank                 12900000
MODOUS4  DS    0H                 Here when 1st nonblank found          12910000
*                                    or string is one byte now          12920000
         LR    R0,R2                                                    12930000
         SR    R0,R1              R1 is stripped start,R0=len           12940000
MODOUS5  DS    0H                 Here when 1st nonblank found          12950000
*                                                                       12960000
* Transform data as requested by option UPPERCASE                       12970000
*                                                                       12980000
MODOUNS  DS    0H                                                       12990000
         TM    OPTBITS,OPCASEU    Uppercase selected?                   13000000
         BZ    MODOUNCU           Skip if not                           13010000
         L     R2,NUCUPPER                                              13020000
         LR    R15,R0                                                   13030000
         BCTR  R15,0                                                    13040000
         EX    R15,MODUPPER       Translate to uppercase                13050000
MODOUNCU DS    0H                 Pass back modified R0-R1              13060000
         LM    R14,R15,SAVEAREA                                         13070000
         LM    R2,R5,SAVEAREA+16                                        13080000
         BR    R14                Input data is ready                   13090000
*                                                                       13100000
MODUPPER TR    0(*-*,R1),0(R2)    Translate to uppercase                13110000
 TITLE 'EXECIO: Output records to EXEC caller'                          13120000
*------------------------------------------------------------*          13130000
*                                                            *          13140000
* Send data to an EXEC caller via stack, VAR, or STEM.       *          13150000
*                                                            *          13160000
*------------------------------------------------------------*          13170000
OUTPUT   DS    0H                                                       13180000
         STM   R14,R5,SAVEAREA                                          13190000
         USING SHVBLOCK,R5                                              13200000
         TM    OPTBITS2,OPSKIP    Skip output wanted?                   13210000
         BO    OUTPRET            If so, just return                    13220000
*                                                                       13230000
* Send output to a REXX variable                                        13240000
*                                                                       13250000
         TM    OPTBITS3,OPVAR     REXX Variable output                  13260000
         BZ    OUTNV              Skip if not                           13270000
         TM    CURROP,VIN         Option used as input by               13280000
*                                    an output operator?                13290000
         BZ    OUTNV              Skip if not                           13300000
*                                                                       13310000
         LR    R2,R0              Variable value length                 13320000
         LR    R3,R1              Variable value address                13330000
         L     R0,VARNAMEL        REXX variable name length             13340000
         L     R1,VARNAMEA        REXX variable name address            13350000
         BAL   R14,PUTREXXV       Put the variable value                13360000
         B     OUTPRET                                                  13370000
OUTNV    DS    0H                                                       13380000
*                                                                       13390000
* Send output to a REXX stemmed variable                                13400000
*                                                                       13410000
         TM    OPTBITS3,OPSTEM    REXX STEM output                      13420000
         BZ    OUTNST             Skip if not                           13430000
         TM    CURROP,VIN         Option used as input by               13440000
*                                    an output operator?                13450000
         BZ    OUTNST             Skip if not                           13460000
*                                                                       13470000
         LR    R2,R0              Variable value length                 13480000
         LR    R3,R1              Variable value address                13490000
         LA    R0,1               Increment the .n                      13500000
         A     R0,STEMNEXT          value to build                      13510000
         ST    R0,STEMNEXT                                              13520000
         BAL   R14,STEMNBLD       Build the .n stemname                 13530000
*                                                                       13540000
         L     R0,STEMNAML        Length and                            13550000
         LA    R1,STEMNAME           address of xxx.n name              13560000
         BAL   R14,PUTREXXV       Set the variable value                13570000
*                                                                       13580000
* Set max elements in stem count                                        13590000
*                                                                       13600000
         L     R4,STEMNAML        Length and                            13610000
         LA    R5,STEMNAME           address of xxx.n name              13620000
         S     R4,VARNAMEL        Length of the 'n' string              13630000
         A     R5,VARNAMEL        Address of the 'n' string             13640000
*                                 varname.|nn|                          13650000
         BCTR  R4,0               Copy nn                               13660000
         MVC   STEMNAMC(*-*),0(R5)  to                                  13670000
         EX    R4,*-6                 STEMNAMC                          13680000
         LA    R4,1(,R4)          Hold length                           13690000
         LA    R5,STEMNAMC        Hold address                          13700000
*                                                                       13710000
         SR    R0,R0              Build the                             13720000
         BAL   R14,STEMNBLD             .0 stemname                     13730000
         L     R0,STEMNAML        Length and                            13740000
         LA    R1,STEMNAME           address of xxx.0 name              13750000
*                                                                       13760000
         LR    R2,R4              Variable value length                 13770000
         LR    R3,R5              Variable value address                13780000
         BAL   R14,PUTREXXV       Put the .0 variable value             13790000
         B     OUTPRET                                                  13800000
OUTNST   DS    0H                                                       13810000
*                                                                       13820000
* Send output to the stack                                              13830000
*                                                                       13840000
         TM    OPTBITS3,OPLIFO    Which end to use                      13850000
         BO    OUTLIFO                                                  13860000
         BAL   R14,QUEUE          Stack First in First out              13870000
         B     OUTPRET                                                  13880000
OUTLIFO  DS    0H                                                       13890000
         BAL   R14,PUSH           Stack Last in First out               13900000
         B     OUTPRET                                                  13910000
*                                                                       13920000
OUTPRET  DS    0H                                                       13930000
         LM    R14,R5,SAVEAREA                                          13940000
         BR    R14                                                      13950000
 TITLE 'EXECIO: Option processing'                                      13960000
*------------------------------------------------------------*          13970000
*                                                            *          13980000
* AVOID  option processing                                   *          13990000
*                                                            *          14000000
*------------------------------------------------------------*          14010000
$AVOID   DS    0H                                                       14020000
         TM    OPTBITS,OPFIND+OPLOCATE                                  14030000
         BNZ   MUTXOP1                                                  14040000
         TM    OPTBITS3,OPVAR                                           14050000
         BNZ   MUTXOP3                                                  14060000
         OI    OPTBITS,OPAVOID    Remember option specified             14070000
         B     FINDDLM            Join common code below                14080000
         SPACE 2                                                        14090000
*------------------------------------------------------------*          14100000
*                                                            *          14110000
* BUFFER option processing                                   *          14120000
*                                                            *          14130000
*------------------------------------------------------------*          14140000
$BUFFER  DS    0H                                                       14150000
         BAL   R14,NXTTOKEN       Get the next token                    14160000
         B     NOOPTV             Bif no option value                   14170000
*                                                                       14180000
         LA    R1,EPLTOKEN                                              14190000
         BAL   R14,CVB            Convert size to binary                14200000
         B     INVOPTV            Bif invalid number                    14210000
*                                                                       14220000
         ST    R0,CPBUFFL         Set size of the CP response           14230000
         B     TONEXTOP                                                 14240000
         SPACE 2                                                        14250000
*------------------------------------------------------------*          14260000
*                                                            *          14270000
* CASE   option processing                                   *          14280000
*                                                            *          14290000
*------------------------------------------------------------*          14300000
$CASE    DS    0H                                                       14310000
         BAL   R14,NXTTOKEN       Get the next token                    14320000
         B     NOOPTV             Bif no option value                   14330000
*                                                                       14340000
         CLC   =C'M ',EPLTOKEN    Mixed case?                           14350000
         BE    TONEXTOP                                                 14360000
         CLC   =C'U ',EPLTOKEN    Uppercase?                            14370000
         BNE   INVOPTV            Say invalid option value              14380000
         OI    OPTBITS,OPCASEU    Set uppercase                         14390000
         B     TONEXTOP                                                 14400000
         SPACE 2                                                        14410000
*------------------------------------------------------------*          14420000
*                                                            *          14430000
* CC     option processing                                   *          14440000
*                                                            *          14450000
*        ASA       Move paper then print data                *          14460000
*                                                            *          14470000
*        blank     Advance 1 line before printing            *          14480000
*        0         Advance 2 lines before printing           *          14490000
*        -         Advance 2 lines before printing           *          14500000
*        +         Advance 0 lines before printing           *          14510000
*        1         Advance to next page before printing      *          14520000
*                                                            *          14530000
*        2-9,A,B,C Advance to vertical tab stop or carriage  *          14540000
*                  control tape channel                      *          14550000
*                                                            *          14560000
*        Machine Immediate -  Advance the paper, no printing *          14570000
*        -------                                             *          14580000
*        X'03'     No operation                              *          14590000
*        X'0B'     Space 1 line                              *          14600000
*        X'13'     Space 2 lines                             *          14610000
*        X'1B'     Space 3 lines                             *          14620000
*        X'8B'     Skip to channel 1 immediate               *          14630000
*        X'93'     Skip to channel 2 immediate               *          14640000
*        X'9B'     Skip to channel 3 immediate               *          14650000
*        X'A3'     Skip to channel 4 immediate               *          14660000
*        X'AB'     Skip to channel 5 immediate               *          14670000
*        X'B3'     Skip to channel 6 immediate               *          14680000
*        X'BB'     Skip to channel 7 immediate               *          14690000
*        X'C3'     Skip to channel 8 immediate               *          14700000
*        X'CB'     Skip to channel 9 immediate               *          14710000
*        X'D3'     Skip to channel 10 immediate              *          14720000
*        X'DB'     Skip to channel 11 immediate              *          14730000
*        X'E3'     Skip to channel 12 immediate              *          14740000
*                                                            *          14750000
*        Machine   Print data then move paper                *          14760000
*        -------                                             *          14770000
*        X'01'     Write without spacing                     *          14780000
*        X'09'     Write and space 1 line                    *          14790000
*        X'11'     Write and space 2 lines                   *          14800000
*        X'19'     Write and space 3 lines                   *          14810000
*        X'89'     Write and skip to channel 1               *          14820000
*        X'91'     Write and skip to channel 2               *          14830000
*        X'99'     Write and skip to channel 3               *          14840000
*        X'A1'     Write and skip to channel 4               *          14850000
*        X'A9'     Write and skip to channel 5               *          14860000
*        X'B1'     Write and skip to channel 6               *          14870000
*        X'C9'     Write and skip to channel 7               *          14880000
*        X'C1'     Write and skip to channel 8               *          14890000
*        X'C9'     Write and skip to channel 9               *          14900000
*        X'D1'     Write and skip to channel 10              *          14910000
*        X'D9'     Write and skip to channel 11              *          14920000
*        X'E1'     Write and skip to channel 12              *          14930000
*                                                            *          14940000
*------------------------------------------------------------*          14950000
$CC      DS    0H                                                       14960000
         BAL   R14,NXTTOKEN       Get the next token                    14970000
         B     NOOPTV             Bif no option value                   14980000
*                                                                       14990000
         CLC   =C'DATA ',EPLTOKEN Is CC within the data?                15000000
         BE    $CCDATA            Go remember that                      15010000
         CLI   EPLTOKEN+1,C' '    Is CC One byte?                       15020000
         BNE   INVOPTV            No, invalid option value              15030000
         MVC   CC,EPLTOKEN        Save CC                               15040000
         B     TONEXTOP                                                 15050000
$CCDATA  DS    0H                                                       15060000
         MVI   CC,0               Remember CC is in the data            15070000
         B     TONEXTOP                                                 15080000
         SPACE 2                                                        15090000
*------------------------------------------------------------*          15100000
*                                                            *          15110000
* FIFO   option processing                                   *          15120000
*                                                            *          15130000
*------------------------------------------------------------*          15140000
$FIFO    DS    0H                                                       15150000
         TM    OPTBITS3,OPLIFO+OPVAR+OPSTEM                             15160000
         BNZ   MUTXOP2                                                  15170000
         OI    OPTBITS3,OPFIFO    Remember option specified             15180000
         B     TONEXTOP                                                 15190000
         SPACE 2                                                        15200000
*------------------------------------------------------------*          15210000
*                                                            *          15220000
* FINIS  option processing                                   *          15230000
*                                                            *          15240000
*------------------------------------------------------------*          15250000
$FINIS   DS    0H                                                       15260000
         OI    OPTBITS,OPFINIS    Close disk file after                 15270000
         B     TONEXTOP                                                 15280000
         SPACE 2                                                        15290000
*------------------------------------------------------------*          15300000
*                                                            *          15310000
* FIND   option processing                                   *          15320000
*                                                            *          15330000
*------------------------------------------------------------*          15340000
$FIND    DS    0H                                                       15350000
         TM    OPTBITS,OPAVOID+OPLOCATE                                 15360000
         BNZ   MUTXOP1                                                  15370000
         TM    OPTBITS3,OPVAR                                           15380000
         BNZ   MUTXOP3                                                  15390000
         OI    OPTBITS,OPFIND     Remember option specified             15400000
         B     FINDDLM            Join common code below                15410000
         SPACE 2                                                        15420000
*------------------------------------------------------------*          15430000
*                                                            *          15440000
* LIFO   option processing                                   *          15450000
*                                                            *          15460000
*------------------------------------------------------------*          15470000
$LIFO    DS    0H                                                       15480000
         TM    OPTBITS3,OPFIFO+OPVAR+OPSTEM                             15490000
         BNZ   MUTXOP2                                                  15500000
         OI    OPTBITS3,OPLIFO    Remember option specified             15510000
         B     TONEXTOP                                                 15520000
         SPACE 2                                                        15530000
*------------------------------------------------------------*          15540000
*                                                            *          15550000
* LOCATE option processing                                   *          15560000
*                                                            *          15570000
*------------------------------------------------------------*          15580000
$LOCATE  DS    0H                                                       15590000
         TM    OPTBITS,OPAVOID+OPFIND                                   15600000
         BNZ   MUTXOP1                                                  15610000
         TM    OPTBITS3,OPVAR                                           15620000
         BNZ   MUTXOP3                                                  15630000
         OI    OPTBITS,OPLOCATE   Remember option specified             15640000
*                                                                       15650000
* Common code for AVOID, FIND, and LOCATE                               15660000
*                                                                       15670000
FINDDLM  DS    0H                                                       15680000
         LM    R0,R1,EPLLEFT EPLNXT EPLIST Scan ptrs                    15690000
         C     R0,=F'1'           Anything after 'FIND'                 15700000
*                                    (or its abbreviation)?             15710000
         BL    NOOPTV             Missing value                         15720000
*                                                                       15730000
FINDDLM1 DS    0H                                                       15740000
         CLI   0(R1),C' '         Found our delimiter?                  15750000
         BNE   FINDDLM2           Yes, continue                         15760000
         LA    R1,1(,R1)                                                15770000
         BCT   R0,FINDDLM1                                              15780000
         B     NOOPTV             Missing value                         15790000
FINDDLM2 DS    0H                                                       15800000
         LR    R2,R1              Pointer to delimiter                  15810000
FINDDLM3 DS    0H                                                       15820000
         LA    R1,1(,R1)                                                15830000
         CLC   0(1,R1),0(R2)      Found matching delimiter?             15840000
         BE    FINDDLM4           Yes, continue                         15850000
         BCT   R0,FINDDLM3                                              15860000
         B     NOOPTV             Missing value                         15870000
FINDDLM4 DS    0H                                                       15880000
         BCTR  R0,0               Reduce for found end delim            15890000
         LA    R2,1(,R2)          One byte past 1st delim               15900000
         LR    R3,R1              Last delim address                    15910000
         SR    R3,R2              Length of delimited string            15920000
         STM   R2,R3,FILTERA FILTERL Remember for later                 15930000
*                                                                       15940000
         LA    R1,1(,R1)          Past for trailing delimiter           15950000
         BCTR  R0,0               Reduce                                15960000
         STM   R0,R1,EPLLEFT EPLNXT EPLIST Scan ptrs                    15970000
         B     TONEXTOP                                                 15980000
         SPACE 2                                                        15990000
*------------------------------------------------------------*          16000000
*                                                            *          16010000
* MARGINS option processing                                  *          16020000
*                                                            *          16030000
*------------------------------------------------------------*          16040000
$MARGINS DS    0H                                                       16050000
         BAL   R14,NXTTOKEN       Get the next token                    16060000
         B     NOOPTV             Bif no option value                   16070000
*                                                                       16080000
         LA    R1,EPLTOKEN                                              16090000
         BAL   R14,CVB            Convert zone start                    16100000
         B     INVOPTV            Bif invalid number                    16110000
         ST    R0,MARGIN1         Set starting margin column            16120000
*                                                                       16130000
         BAL   R14,NXTTOKEN       Get the next token                    16140000
         B     NOOPTV             Bif no option value                   16150000
*                                                                       16160000
         LA    R1,EPLTOKEN                                              16170000
         BAL   R14,CVB            Convert zone start                    16180000
         B     INVOPTV            Bif invalid number                    16190000
         ST    R0,MARGIN2         Set ending margin column              16200000
         OI    OPTBITS2,OPMARGIN  specific output columns               16210000
         B     TONEXTOP                                                 16220000
         SPACE 2                                                        16230000
*------------------------------------------------------------*          16240000
*                                                            *          16250000
* NOTYPE option processing                                   *          16260000
*                                                            *          16270000
*------------------------------------------------------------*          16280000
$NOTYPE  DS    0H                                                       16290000
         OI    OPTBITS2,OPNOTYPE  Set option bit                        16300000
         B     TONEXTOP                                                 16310000
         SPACE 2                                                        16320000
*------------------------------------------------------------*          16330000
*                                                            *          16340000
* SKIP   option processing                                   *          16350000
*                                                            *          16360000
*------------------------------------------------------------*          16370000
$SKIP    DS    0H                                                       16380000
         OI    OPTBITS2,OPSKIP    Set option bit                        16390000
         B     TONEXTOP                                                 16400000
         SPACE 2                                                        16410000
*------------------------------------------------------------*          16420000
*                                                            *          16430000
* STEM   option processing                                   *          16440000
*                                                            *          16450000
*------------------------------------------------------------*          16460000
$STEM    DS    0H                                                       16470000
         TM    OPTBITS3,OPFIFO+OPLIFO+OPVAR                             16480000
         BNZ   MUTXOP2                                                  16490000
*                                                                       16500000
         LM    R0,R1,EPLLEFT EPLNXT EPLIST Scan ptrs                    16510000
         C     R0,=F'1'           Anything after 'STEM'                 16520000
         BL    NOOPTV             Missing value                         16530000
*                                                                       16540000
STEMDLM1 DS    0H                                                       16550000
         CLI   0(R1),C' '         Found start of name?                  16560000
         BNE   STEMDLM2            Yes, continue                        16570000
         LA    R1,1(,R1)                                                16580000
         BCT   R0,STEMDLM1                                              16590000
         B     NOOPTV             Missing value                         16600000
STEMDLM2 DS    0H                                                       16610000
         LR    R2,R1              Pointer to start of name              16620000
         LA    R1,1(,R1)          Next byte                             16630000
         BCT   R0,STEMDLM3        Reduce count and                      16640000
*                                    continue if > 0                    16650000
         B     STEMDLM4           Must be one byte name                 16660000
STEMDLM3 DS    0H                                                       16670000
         CLI   0(R1),C' '         Found end of name?                    16680000
         BE    STEMDLM4           Yes, continue                         16690000
         LA    R1,1(,R1)                                                16700000
         BCT   R0,STEMDLM3                                              16710000
STEMDLM4 DS    0H                                                       16720000
         STM   R0,R1,EPLLEFT EPLNXT New EPLIST Scan ptrs                16730000
*                                                                       16740000
         SR    R1,R2                                                    16750000
         ST    R2,VARNAMEA        Set STEM name pointer                 16760000
         ST    R1,VARNAMEL        Set STEM name length                  16770000
*                                                                       16780000
STEMNTST DS    0H                 Last char must be '.'                 16790000
         CLI   0(R2),C'.'         Only last may be '.'                  16800000
         BE    STEMPFND           Bif period found                      16810000
         LA    R2,1(,R2)                                                16820000
         BCT   R1,STEMNTST                                              16830000
         B     BADSTEM            No period in name                     16840000
STEMPFND DS    0H                 Last char must be '.'                 16850000
         C     R1,=F'1'           Last byte?                            16860000
         BNE   BADSTEM            Period not last byte                  16870000
*                                                                       16880000
         SR    R1,R1                                                    16890000
         ST    R1,STEMNEXT        Next xxx.n value to fetch             16900000
         OI    OPTBITS3,OPSTEM                                          16910000
         B     TONEXTOP                                                 16920000
         SPACE 2                                                        16930000
*------------------------------------------------------------*          16940000
*                                                            *          16950000
* STRIP  option processing                                   *          16960000
*                                                            *          16970000
*------------------------------------------------------------*          16980000
$STRIP   DS    0H                                                       16990000
         OI    OPTBITS2,OPSTRIP   Set option bit                        17000000
         B     TONEXTOP                                                 17010000
         SPACE 2                                                        17020000
*------------------------------------------------------------*          17030000
*                                                            *          17040000
* STRING option processing                                   *          17050000
*                                                            *          17060000
*------------------------------------------------------------*          17070000
$STRING  DS    0H                                                       17080000
         OI    OPTBITS3,OPSTRING                                        17090000
         CLC   LINES,MAXWORD      Was lines set to '*' ?                17100000
         BNE   $STRINGA           No. proceed                           17110000
         CLI   CURROP,VCP         Is this a 'CP' operation              17120000
         BE    $STRINGA           Yes, allowed                          17130000
         B     NOLINEX                                                  17140000
$STRINGA DS    0H                                                       17150000
         LM    R0,R1,EPLLEFT EPLNXT EPLIST Scan ptrs                    17160000
         LTR   R0,R0              Anything after 'STRING'               17170000
*                                    (or its abbreviation)?             17180000
         BZ    $STRINGB           Missing value                HRC429DS 17190100
         LA    R1,1(,R1)          If there it has to be                 17200000
         BCTR  R0,0                  a blank which we skip              17210000
         LTR   R0,R0              Anything after the blank?             17220000
         BZ    $STRINGB           Missing value                HRC429DS 17230100
*                                                                       17240000
*                                 'STRING' (abbreviation) and           17250000
*                                 the blank after it.                   17260000
*                                 This is the start of the              17270000
*                                 STRING option value.                  17280000
         A     R1,EPLENGTH        Switch to the version                 17290000
*                                 of the STRING value that              17300000
*                                 was entered on the command            17310000
         B     $STRINGC           Go set the string value      HRC429DS 17310100
*                                                              HRC429DS 17310200
$STRINGB DS    0H                 Here when no string value    HRC429DS 17310300
         LA    R0,1               Use a value                  HRC429DS 17310400
         LA    R1,=C' '               of one blank             HRC429DS 17310500
$STRINGC DS    0H                 Set the STRING value         HRC429DS 17310600
         ST    R1,STRINGBF        Set upper case buffer addr            17320000
         ST    R0,STRINGBL        Set length                            17330000
*                                                                       17340000
* STRING has to be the last option specified. Fake up a return          17350000
* to end the option scan.                                               17360000
         SR    R0,R0                                                    17370000
         ST    R0,EPLLEFT                                               17380000
         B     TONEXTOP                                                 17390000
         SPACE 2                                                        17400000
*------------------------------------------------------------*          17410000
*                                                            *          17420000
* VAR    option processing                                   *          17430000
*                                                            *          17440000
*------------------------------------------------------------*          17450000
$VAR     DS    0H                                                       17460000
         TM    OPTBITS3,OPFIFO+OPLIFO+OPSTEM                            17470000
         BNZ   MUTXOP2                                                  17480000
         TM    OPTBITS,OPFIND+OPLOCATE+OPAVOID                          17490000
         BNZ   MUTXOP3                                                  17500000
         CLC   LINES,=F'1'        Is number of line one?                17510000
         BNE   VLINES1            If not, fail                          17520000
*                                                                       17530000
         LM    R0,R1,EPLLEFT EPLNXT EPLIST Scan ptrs                    17540000
         C     R0,=F'1'           Anything after 'VAR'                  17550000
         BL    NOOPTV             Missing value                         17560000
*                                                                       17570000
VARDLM1  DS    0H                                                       17580000
         CLI   0(R1),C' '         Found start of name?                  17590000
         BNE   VARDLM2            Yes, continue                         17600000
         LA    R1,1(,R1)                                                17610000
         BCT   R0,VARDLM1                                               17620000
         B     NOOPTV             Missing value                         17630000
VARDLM2  DS    0H                                                       17640000
         LR    R2,R1              Pointer to start of name              17650000
         LA    R1,1(,R1)          Next byte                             17660000
         BCT   R0,VARDLM3         Reduce count and                      17670000
*                                    continue if > 0                    17680000
         B     VARDLM4            Must be one byte name                 17690000
VARDLM3  DS    0H                                                       17700000
         CLI   0(R1),C' '         Found end of name?                    17710000
         BE    VARDLM4            Yes, continue                         17720000
         LA    R1,1(,R1)                                                17730000
         BCT   R0,VARDLM3                                               17740000
VARDLM4  DS    0H                                                       17750000
         STM   R0,R1,EPLLEFT EPLNXT New EPLIST Scan ptrs                17760000
*                                                                       17770000
         SR    R1,R2                                                    17780000
         ST    R2,VARNAMEA        Set VAR name pointer                  17790000
         ST    R1,VARNAMEL        Set VAR name length                   17800000
*                                                                       17810000
         OI    OPTBITS3,OPVAR                                           17820000
         B     TONEXTOP                                                 17830000
         SPACE 2                                                        17840000
*------------------------------------------------------------*          17850000
*                                                            *          17860000
* ZONE   option processing                                   *          17870000
*                                                            *          17880000
*------------------------------------------------------------*          17890000
$ZONE    DS    0H                                                       17900000
         BAL   R14,NXTTOKEN       Get the next token                    17910000
         B     NOOPTV             Bif no option value                   17920000
*                                                                       17930000
         LA    R1,EPLTOKEN                                              17940000
         BAL   R14,CVB            Convert zone start                    17950000
         B     INVOPTV            Bif invalid number                    17960000
         ST    R0,ZONE1           Set starting zone column              17970000
*                                                                       17980000
         BAL   R14,NXTTOKEN       Get the next token                    17990000
         B     NOOPTV             Bif no option value                   18000000
*                                                                       18010000
         LA    R1,EPLTOKEN                                              18020000
         BAL   R14,CVB            Convert zone start                    18030000
         B     INVOPTV            Bif invalid number                    18040000
         ST    R0,ZONE2           Set ending zone column                18050000
         OI    OPTBITS2,OPZONE    Mark option specified                 18060000
         B     TONEXTOP                                                 18070000
         SPACE 2                                                        18080000
 TITLE 'EXECIO: General subroutines'                                    18090000
*------------------------------------------------------------*          18100000
*                                                            *          18110000
*        Next Token Scan                                     *          18120000
*                                                            *          18130000
*------------------------------------------------------------*          18140000
NXTTOKEN DS    0H                                                       18150000
         MVI   EPLTOKEN,C' '      Preblank target area                  18160000
         MVC   EPLTOKEN+1(L'EPLTOKEN-1),EPLTOKEN                        18170000
         LM    R0,R1,EPLLEFT EPLNXT Fetch EPLIST Scan ptrs              18180000
         LTR   R0,R0                                                    18190000
         BZR   R14                Tell caller end of arguments          18200000
NXTTOK2  DS    0H                                                       18210000
         CLI   0(R1),C' '         Found next non-blank?                 18220000
*                                                                       18230000
         BE    NXTTOK3            Y. Keep looking for nonblank          18240000
         CLI   0(R1),C'('         Start of options?                     18250000
         BNE   NXTTOK4            No, found normal character            18260000
*                                 Go scan token                         18270000
         MVC   EPLTOKEN,=CL8'('   Set token                             18280000
         LA    R1,1(,R1)          Skip over '('                         18290000
         BCTR  R0,0               Reduce remaining length               18300000
         STM   R0,R1,EPLLEFT EPLNXT Reset EPLIST Scan ptrs              18310000
         B     4(,R14)            Return argument to caller             18320000
*                                                                       18330000
NXTTOK3  DS    0H                                                       18340000
*                                                                       18350000
         LA    R1,1(,R1)          To next character                     18360000
         BCT   R0,NXTTOK2         Keep looking                          18370000
         BR    R14                Tell caller end of arguments          18380000
NXTTOK4  DS    0H                                                       18390000
         LR    R15,R1             Remember start of token               18400000
NXTTOK5  DS    0H                                                       18410000
         CLI   0(R1),C' '         Found next non-blank?                 18420000
         BE    NXTTOK6            Bif so to scan token                  18430000
         CLI   0(R1),C'('         Found option start?                   18440000
         BE    NXTTOK6            Bif so to scan token                  18450000
         LA    R1,1(,R1)          To next character                     18460000
         BCT   R0,NXTTOK5         Keep looking                          18470000
NXTTOK6  DS    0H                                                       18480000
         STM   R0,R1,EPLLEFT EPLNXT Reset EPLIST Scan ptrs              18490000
         SR    R1,R15             Length of the token                   18500000
         BCTR  R1,0                                                     18510000
         MVC   EPLTOKEN(*-*),0(R15)                                     18520000
         EX    R1,*-6             Copy to 8 byte token area             18530000
         B     4(,R14)            Return argument to caller             18540000
*------------------------------------------------------------*          18550000
*                                                            *          18560000
*        Queue                                               *          18570000
*                                                            *          18580000
*------------------------------------------------------------*          18590000
QUEUE    DS    0H                                                       18600000
         LA    R15,PLISTBLD                                             18610000
         MVC   0(8,R15),=CL8'ATTN' Stack response                       18620000
         MVC   8(4,R15),=CL4'FIFO' First in first out                   18630000
         STC   R0,12(R15)         Set line length                       18640000
         STCM  R1,B'0111',13(R15) Set line address                      18650000
         MVC   16(8,R15),=8X'FF'  Set fence                             18660000
         LR    R1,R15                                                   18670000
         SVC   202                                                      18680000
         DC    AL4(1)                                                   18690000
         BR    R14                                                      18700000
*------------------------------------------------------------*          18710000
*                                                            *          18720000
*        Push                                                *          18730000
*                                                            *          18740000
*------------------------------------------------------------*          18750000
PUSH     DS    0H                                                       18760000
         LA    R15,PLISTBLD                                             18770000
         MVC   0(8,R15),=CL8'ATTN' Stack response                       18780000
         MVC   8(4,R15),=CL4'LIFO' Last in first out                    18790000
         STC   R0,12(R15)         Set line length                       18800000
         STCM  R1,B'0111',13(R15) Set line address                      18810000
         MVC   16(8,R15),=8X'FF'  Set fence                             18820000
         LR    R1,R15                                                   18830000
         SVC   202                                                      18840000
         DC    AL4(1)                                                   18850000
         BR    R14                                                      18860000
*------------------------------------------------------------*          18870000
*                                                            *          18880000
*        Pull                                                *          18890000
*                                                            *          18900000
*------------------------------------------------------------*          18910000
PULL     DS    0H                                                       18920000
* Use RDTERM to read the line.                                          18930000
*        RDTERM BUFFER,EDIT=NO                                          18940000
         MVC   RDTERME(RDTERMPL),RDTERMP set pattern                    18950000
         LA    R1,BUFFER                                                18960000
         MVI   0(R1),C' '         Init to blanks                        18970000
         MVC   1(255,R1),0(R1)                                          18980000
         STCM  R1,B'0111',RDTERME+9 Set buffer address                  18990000
         LA    R1,RDTERME                                               19000000
         SVC   202                                                      19010000
         DC    AL4(1)                                                   19020000
         LA    R1,BUFFER                                                19030000
         SR    R0,R0                                                    19040000
         ICM   R0,B'0111',RDTERME+13 Returned line length               19050000
         BR    R14                                                      19060000
*                                                                       19070000
RDTERMP  DS    0D                                                       19080000
         DC    CL8'WAITRD'                                              19090000
         DC    AL1(1)                                                   19100000
         DC    AL3(*-*)           Address of input line                 19110000
         DC    C'T'               NO UPPERCASE OR BLANK FILL            19120000
         DC    AL3(*-*)           Count returned here                   19130000
RDTERMPL EQU   *-RDTERMP                                                19140000
*------------------------------------------------------------*          19150000
*                                                            *          19160000
*        Convert to Binary                                   *          19170000
*                                                            *          19180000
*        Input: R1  = address of character decimal number    *          19190000
*                     followed by a blank                    *          19200000
*        Output: R1 = Binary number                          *          19210000
*                                                            *          19220000
*        Return to 0(,R14)    conversion error               *          19230000
*                  4(,R14)    successful conversion          *          19240000
*------------------------------------------------------------*          19250000
CVB      DS    0H                                                       19260000
         STM   R14,R5,CVBSAVE                                           19270000
         SR    R2,R2              R2-R3 used to build number            19280000
         SR    R3,R3                                                    19290000
         SR    R5,R5              R4 has next digit                     19300000
         LA    R0,8               Loop counter                          19310000
CVBLP    DS    0H                 Loop for all digits                   19320000
         CLI   0(R1),C' '         Found end of the number?              19330000
         BE    CVBEXIT            Yes, go process                       19340000
         CLI   0(R1),C'0'         Valid EBCDIC digit?                   19350000
         BL    CVBERR             Nope                                  19360000
         CLI   0(R1),C'9'         Valid EBCDIC digit?                   19370000
         BH    CVBERR             Nope                                  19380000
         IC    R5,0(,R1)          Next digit                            19390000
         N     R5,=A(X'0F')                                             19400000
         M     R2,=F'10'                                                19410000
         AR    R3,R5              Accumulate the total                  19420000
         LA    R1,1(,R1)          Step to next digit                    19430000
         BCT   R0,CVBLP           Check all 8 bytes                     19440000
CVBEXIT  DS    0H                                                       19450000
         ST    R3,CVBSAVE+8       Return binary in R0                   19460000
         LM    R14,R5,CVBSAVE                                           19470000
         B     4(,R14)                                                  19480000
CVBERR   DS    0H                                                       19490000
         LM    R14,R5,CVBSAVE                                           19500000
         BR    R14                                                      19510000
*------------------------------------------------------------*          19520000
*                                                            *          19530000
*        Build REXX stem variable name                       *          19540000
*                                                            *          19550000
* Input:   VARNAMEL stem variable name length                *          19560000
*          VARNAMEA stem variable name address               *          19570000
*          R0       next stem number to use                  *          19580000
*                                                            *          19590000
* Output:  STEMNAML Built stem name length                   *          19600000
*          STEMNAME Built stem name string                   *          19610000
*                                                            *          19620000
*------------------------------------------------------------*          19630000
STEMNBLD DS    0H                                                       19640000
         STM   R14,R5,CVBSAVE                                           19650000
*              R0                 Index of stem to use                  19660000
         L     R14,VARNAMEA       Address of provided name              19670000
         L     R15,VARNAMEL       Length of provided name               19680000
         BCTR  R15,0                                                    19690000
         MVC   STEMNAME(*-*),0(R14) Copy stemname to result             19700000
         EX    R15,*-6                                                  19710000
*                                                                       19720000
         LA    R2,STEMNAME+1(R15) Point past end of stemname            19730000
         LA    R1,L'STEMPAT-1(R2) (In case EDMK gets RC=0)              19740000
         CVD   R0,DWORD           Convert binary to packed              19750000
         MVC   0(L'STEMPAT,R2),STEMPAT  Set pattern                     19760000
         EDMK  0(L'STEMPAT,R2),DWORD    EDIT with pattern               19770000
         LA    R15,L'STEMPAT-1(R2) To end of the number                 19780000
         SR    R15,R1             Get number length - 1                 19790000
         MVC   0(*-*,R2),0(R1)    Move the suffix number                19800000
         EX    R15,*-6                                                  19810000
*                                                                       19820000
         LA    R1,1(,R15)         Number length in R1                   19830000
         A     R1,VARNAMEL        Length of the build variable          19840000
         ST    R1,STEMNAML        Pass to caller                        19850000
         LM    R14,R5,CVBSAVE                                           19860000
         BR    R14                AND DONE, RETURN TO CALLER            19870000
STEMPAT  DC    X'40202020202020202020202020202120' EDMK Mask            19880000
*------------------------------------------------------------*          19890000
*                                                            *          19900000
*        Get REXX variable value                             *          19910000
*                                                            *          19920000
* Input:   R0  REXX variable name length                     *          19930000
*          R1  REXX variable name Address                    *          19940000
*                                                            *          19950000
* Output:  R0  REXX variable value length                    *          19960000
*          R1  REXX variable value Address                   *          19970000
*          R15 EXECCOMM RC                                   *          19980000
*                                                            *          19990000
* Error Exit: INVRETCD                                       *          20000000
*                                                            *          20010000
*------------------------------------------------------------*          20020000
         USING SHVBLOCK,R5                                              20030000
GETREXXV DS    0H                                                       20040000
         STM   R14,R5,REXSAVE                                           20050000
         LA    R5,SHVAREA                                               20060000
         XC    SHVBLOCK(SHVBLEN),SHVBLOCK                               20070000
         XC    SHEPLIST(16),SHEPLIST                                    20080000
*                                                                       20090000
         MVI   SHVCODE,SHVFETCH   Fetch variable value                  20100000
         ST    R1,SHVNAMA         Set VAR name address                  20110000
         ST    R0,SHVNAML                  and length                   20120000
         ICM   R2,B'1111',REXBUFFL Large buffer in use?                 20130000
         BZ    GETLOCLB           Use local buffer if not               20140000
         ST    R2,SHVBUFL         Length of the buffer                  20150000
         L     R2,REXBUFF                                               20160000
*                                                                       20170000
         ST    R2,SHVVALA         Address of value buffer               20180000
         B     GETSETPL           Go set plist and go                   20190000
GETLOCLB DS    0H                                                       20200000
         LA    R2,BUFFER                                                20210000
*                                                                       20220000
         ST    R2,SHVVALA         Address of value buffer               20230000
         LA    R2,L'BUFFER                                              20240000
         ST    R2,SHVBUFL         Length of the buffer                  20250000
GETSETPL DS    0H                                                       20260000
*                                                                       20270000
         LA    R1,EXECCOMM        Fill in                               20280000
         ST    R1,SHEPLIST           EPLIST                             20290000
         ST    R5,SHEPL4          Word 4 -> SHVBLOCK                    20300000
         LA    R0,SHEPLIST                                              20310000
         ICM   R1,B'1000',=X'02'                                        20320000
         SVC   202                                                      20330000
         DC    AL4(1)                                                   20340000
*                                                                       20350000
         TM    SHVRET,SHVTRUNC    Did variable fit in buffer?           20360000
         BZ    NOTRUNC1                                                 20370000
**************************************************************          20380000
*                                                                       20390000
* The usual buffer in the DSA is not large enough to                    20400000
* retrieve the REXX variable value. EXECIO returns the size             20410000
* needed in REXBUFFL. Allocate a new buffer and try again.              20420000
*                                                                       20430000
         ICM   R1,B'1111',REXBUFFL                                      20440000
         LA    R0,7(,R1)          Round up to doublewords               20450000
         SRL   R0,3                                                     20460000
         DMSFREE DWORDS=(0),TYPE=USER Allocate Work area                20470000
         SLL   R0,3               Dwords to Bytes                       20480000
         ST    R0,REXBUFFL                                              20490000
         ST    R1,REXBUFF                                               20500000
         ST    R0,SHVBUFL         Length of the buffer                  20510000
         ST    R1,SHVVALA         Address of value buffer               20520000
         B     GETSETPL           Go set plist and go                   20530000
*                                                                       20540000
**************************************************************          20550000
NOTRUNC1 DS    0H                                                       20560000
         L     R0,SHVVALL         Length of variable value              20570000
         L     R1,SHVVALA         Address of variable value             20580000
         STM   R15,R1,REXSAVE+4   Pass back the value ptrs              20590000
         LM    R14,R5,REXSAVE                                           20600000
         BR    R14                                                      20610000
*------------------------------------------------------------*          20620000
*                                                            *          20630000
*        Put REXX variable value                             *          20640000
*                                                            *          20650000
* Input:   R0  REXX variable name length                     *          20660000
*          R1  REXX variable name address                    *          20670000
*          R2  REXX variable value length                    *          20680000
*          R3  REXX variable value address                   *          20690000
*                                                            *          20700000
* Error Exit: INVRETCD                                       *          20710000
*                                                            *          20720000
*------------------------------------------------------------*          20730000
PUTREXXV DS    0H                                                       20740000
         STM   R14,R5,REXSAVE                                           20750000
*                                                                       20760000
         LA    R5,SHVAREA                                               20770000
         XC    SHVBLOCK(SHVBLEN),SHVBLOCK                               20780000
         XC    SHEPLIST(16),SHEPLIST                                    20790000
*                                                                       20800000
         MVI   SHVCODE,SHVSTORE   Call to set variable value            20810000
         ST    R1,SHVNAMA         Set VAR name address                  20820000
         ST    R0,SHVNAML                  and length                   20830000
         ST    R3,SHVVALA         Set VAR value address                 20840000
         ST    R2,SHVVALL                  and length                   20850000
*                                                                       20860000
         LA    R1,EXECCOMM        Fill in                               20870000
         ST    R1,SHEPLIST           EPLIST                             20880000
         ST    R5,SHEPL4          Word 4 -> SHVBLOCK                    20890000
         LA    R0,SHEPLIST                                              20900000
         ICM   R1,B'1000',=X'02'                                        20910000
         SVC   202                                                      20920000
         DC    AL4(1)                                                   20930000
         LTR   R2,R15                                                   20940000
         BZ    REXXVSET           Br if value set OK                    20950000
         LA    R3,EXECCOMM                                              20960000
         B     INVRETCD           Report EXECCOMM RC                    20970000
REXXVSET DS    0H                                                       20980000
         LM    R14,R5,REXSAVE                                           20990000
         BR    R14                                                      21000000
         DROP  R5                                                       21010000
*------------------------------------------------------------*          21020000
*                                                            *          21030000
* Look for parameter as option keyword                       *          21040000
*                                                            *          21050000
*------------------------------------------------------------*          21060000
OPTLKUP  DS    0H                                                       21070000
         ST    R14,OPTRET         Set return address                    21080000
         LA    R15,EPLTOKEN+7     Point to byte 8 of option             21090000
         CLI   0(R15),C' '        Is is blank                           21100000
         BNE   *+8                Yes skip out                          21110000
         BCT   R15,*-8            Go test previous byte                 21120000
*                                                                       21130000
         LA    R15,1(,R15)                                              21140000
         LA    R0,EPLTOKEN                                              21150000
         SR    R15,R0             User supplied option length           21160000
*                                                                       21170000
         LA    R2,OPTTBL          Start of option table                 21180000
         LA    R4,OPTTBLNE        Number of entries                     21190000
OPTLKUP2 DS    0H                                                       21200000
         CLM   R15,B'0001',8(R2)  Check against entry min size          21210000
         BL    OPTLKUP3           Provided name too short               21220000
         CLM   R15,B'0001',9(R2)  Check against entry max size          21230000
         BH    OPTLKUP3           Provided name too long                21240000
         BCTR  R15,0                                                    21250000
         CLC   0(*-*,R2),EPLTOKEN                                       21260000
         EX    R15,*-6            Does this option name match?          21270000
         LA    R15,1(,R15)        Back to true lebgth                   21280000
         BNE   OPTLKUP3           If, not, go check next                21290000
*                                                                       21300000
         MVC   OPTNAME,0(R2)      Set option name for msgs              21310000
         IC    R15,CURROP         Pick up caller identity bit           21320000
         TM    10(R2),*-*         Test whether this option              21330000
         EX    R15,*-4              is valid for our call type          21340000
         BZ    INVOPT             Error exit if not                     21350000
         L     R15,12(,R2)        Option kwd handler routine            21360000
         BR    R15                Go there                              21370000
*                                                                       21380000
OPTLKUP3 DS    0H                                                       21390000
         LA    R2,OPTENTLN(,R2)   Skip to next tbl entry                21400000
         BCT   R4,OPTLKUP2          and go check that one               21410000
         B     INVOPT             No match on supplied option           21420000
TONEXTOP DS    0H                                                       21430000
         L     R14,OPTRET         Get return address                    21440000
         BR    R14                Go look for more options              21450000
 TITLE 'EXECIO: Error exits'                                            21460000
*------------------------------------------------------------*          21470000
*                                                            *          21480000
* Error Exit routines                                        *          21490000
*                                                            *          21500000
*------------------------------------------------------------*          21510000
INVRETCD DS    0H                                                       21520000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21530000
         MVI   BUFFER,255         Set buffer size in byte 1             21540000
         LINEDIT TEXT='Error: Return code ........ from ........',     *21550000
               BUFFA=BUFFER,DISP=TYPE,                                 *21560000
               SUB=(DEC,(R2),CHARA,((R3),8)),                          *21570000
               MF=(E,LINEDITL)                                          21580000
         LA    R15,100(,R2)       RC = 100 plus device rc               21590000
         B     EXITRC                                                   21600000
INVLRECL DS    0H                                                       21610000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21620000
         MVI   BUFFER,255         Set buffer size in byte 1             21630000
         LINEDIT TEXT='Invalid LRECL:........',                        *21640000
               BUFFA=BUFFER,DISP=TYPE,                                 *21650000
               SUB=(CHARA,EPLTOKEN),                                   *21660000
               MF=(E,LINEDITL)                                          21670000
         LA    R15,24                                                   21680000
         B     EXITRC                                                   21690000
INVLINES DS    0H                                                       21700000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21710000
         MVI   BUFFER,255         Set buffer size in byte 1             21720000
         LINEDIT TEXT='Invalid number of lines:........',              *21730000
               BUFFA=BUFFER,DISP=TYPE,                                 *21740000
               SUB=(CHARA,EPLTOKEN),                                   *21750000
               MF=(E,LINEDITL)                                          21760000
         LA    R15,24                                                   21770000
         B     EXITRC                                                   21780000
INVPARM  DS    0H                                                       21790000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21800000
         MVI   BUFFER,255         Set buffer size in byte 1             21810000
         LINEDIT TEXT='Invalid operand: ........',                     *21820000
               BUFFA=BUFFER,DISP=TYPE,                                 *21830000
               SUB=(CHARA,EPLTOKEN),                                   *21840000
               MF=(E,LINEDITL)                                          21850000
         LA    R15,24                                                   21860000
         B     EXITRC                                                   21870000
INVOPT   DS    0H                                                       21880000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21890000
         MVI   BUFFER,255         Set buffer size in byte 1             21900000
         LINEDIT TEXT='Invalid option: ........',                      *21910000
               BUFFA=BUFFER,DISP=TYPE,                                 *21920000
               SUB=(CHARA,EPLTOKEN),                                   *21930000
               MF=(E,LINEDITL)                                          21940000
         LA    R15,24                                                   21950000
         B     EXITRC                                                   21960000
INVOPTV  DS    0H                                                       21970000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  21980000
         MVI   BUFFER,255         Set buffer size in byte 1             21990000
         LINEDIT TEXT='Invalid value: ........ for option: ........',  *22000000
               BUFFA=BUFFER,DISP=TYPE,                                 *22010000
               SUB=(CHARA,EPLTOKEN,CHARA,OPTNAME),                     *22020000
               MF=(E,LINEDITL)                                          22030000
         LA    R15,24                                                   22040000
         B     EXITRC                                                   22050000
MUTXOP1  DS    0H                                                       22060000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22070000
         MVI   BUFFER,255         Set buffer size in byte 1             22080000
         LINEDIT TEXT='FIND, LOCATE, and AVOID are mutually exclusive o*22090000
               ptions',                                                *22100000
               BUFFA=BUFFER,DISP=TYPE,                                 *22110000
               MF=(E,LINEDITL)                                          22120000
         LA    R15,24                                                   22130000
         B     EXITRC                                                   22140000
MUTXOP2  DS    0H                                                       22150000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22160000
         MVI   BUFFER,255         Set buffer size in byte 1             22170000
         LINEDIT TEXT='FIFO, LIFO, VAR, and STEM are mutually exclusive*22180000
                options',                                              *22190000
               BUFFA=BUFFER,DISP=TYPE,                                 *22200000
               MF=(E,LINEDITL)                                          22210000
         LA    R15,24                                                   22220000
         B     EXITRC                                                   22230000
MUTXOP3  DS    0H                                                       22240000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22250000
         MVI   BUFFER,255         Set buffer size in byte 1             22260000
         LINEDIT TEXT='VAR option is not valid with FIND, AVOID, or LOC*22270000
               ATE options',                                           *22280000
               BUFFA=BUFFER,DISP=TYPE,                                 *22290000
               MF=(E,LINEDITL)                                          22300000
         LA    R15,24                                                   22310000
         B     EXITRC                                                   22320000
NOOPTV   DS    0H                                                       22330000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22340000
         MVI   BUFFER,255         Set buffer size in byte 1             22350000
         LINEDIT TEXT='Missing value for option: ........',            *22360000
               BUFFA=BUFFER,DISP=TYPE,                                 *22370000
               SUB=(CHARA,OPTNAME),                                    *22380000
               MF=(E,LINEDITL)                                          22390000
         LA    R15,24                                                   22400000
         B     EXITRC                                                   22410000
MISSING  DS    0H                                                       22420000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22430000
         MVI   BUFFER,255         Set buffer size in byte 1             22440000
         LINEDIT TEXT='Missing ........ operand',                      *22450000
               BUFFA=BUFFER,DISP=TYPE,                                 *22460000
               SUB=(CHARA,((R4),8)),                                   *22470000
               MF=(E,LINEDITL)                                          22480000
         LA    R15,24                                                   22490000
         B     EXITRC                                                   22500000
REC2LARG DS    0H                                                       22510000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22520000
         MVI   BUFFER,255         Set buffer size in byte 1             22530000
         LINEDIT TEXT='VAR or STEM must be used for records larger than*22540000
                255 bytes',                                            *22550000
               BUFFA=BUFFER,DISP=TYPE,                                 *22560000
               MF=(E,LINEDITL)                                          22570000
         LA    R15,24                                                   22580000
         B     EXITRC                                                   22590000
NOSTORE  DS    0H                                                       22600000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22610000
         MVI   BUFFER,255         Set buffer size in byte 1             22620000
         LINEDIT TEXT='Requested storage not available',               *22630000
               BUFFA=BUFFER,DISP=TYPE,                                 *22640000
               MF=(E,LINEDITL)                                          22650000
         LA    R15,41                                                   22660000
         B     EXITRC                                                   22670000
STRNOTF  DS    0H                                                       22680000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22690000
         MVI   BUFFER,255         Set buffer size in byte 1             22700000
         LINEDIT TEXT='STRING operand not found',                      *22710000
               BUFFA=BUFFER,DISP=TYPE,                                 *22720000
               MF=(E,LINEDITL)                                          22730000
         LA    R15,24                                                   22740000
         B     EXITRC                                                   22750000
VLINES1  DS    0H                                                       22760000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22770000
         MVI   BUFFER,255         Set buffer size in byte 1             22780000
         LINEDIT TEXT='Number of lines must be one when VAR is set',   *22790000
               BUFFA=BUFFER,DISP=TYPE,                                 *22800000
               MF=(E,LINEDITL)                                          22810000
         LA    R15,24                                                   22820000
         B     EXITRC                                                   22830000
NOLINEX  DS    0H                                                       22840000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22850000
         MVI   BUFFER,255         Set buffer size in byte 1             22860000
         LINEDIT TEXT='Lines * not allowed with STRING for this operati*22870000
               on',                                                    *22880000
               BUFFA=BUFFER,DISP=TYPE,                                 *22890000
               MF=(E,LINEDITL)                                          22900000
         LA    R15,24                                                   22910000
         B     EXITRC                                                   22920000
BADSTEM  DS    0H                                                       22930000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  22940000
         MVI   BUFFER,255         Set buffer size in byte 1             22950000
         LINEDIT TEXT='Stem name must have one period at the end',     *22960000
               BUFFA=BUFFER,DISP=TYPE,                                 *22970000
               MF=(E,LINEDITL)                                          22980000
         LA    R15,24                                                   22990000
         B     EXITRC                                                   23000000
NOTYET   DS    0H                                                       23010000
         MVC   LINEDITL(LINEDISZ),LINEDITP Set pattern                  23020000
         MVI   BUFFER,255         Set buffer size in byte 1             23030000
         LINEDIT TEXT='Destination not yet implemented',               *23040000
               BUFFA=BUFFER,DISP=TYPE,                                 *23050000
               MF=(E,LINEDITL)                                          23060000
         LA    R15,24                                                   23070000
         B     EXITRC                                                   23080000
 TITLE 'EXECIO: Lookup tables'                                          23090000
*------------------------------------------------------------*          23100000
* Table of valid operation calls and the handler address     *          23110000
*------------------------------------------------------------*          23120000
CTYPTBL  DS    0D                                                       23130000
         DC    CL8'DISKR   ',A($DISKR)                                  23140000
CTYPTBEL EQU   *-CTYPTBL          Length of an entry                    23150000
         DC    CL8'CARD    ',A($CARD)                                   23160000
         DC    CL8'CP      ',A($CP)                                     23170000
         DC    CL8'DISKW   ',A($DISKW)                                  23180000
         DC    CL8'PUNCH   ',A($PUNCH)                                  23190000
         DC    CL8'EMSG    ',A($EMSG)                                   23200000
         DC    CL8'PRINT   ',A($PRINT)                                  23210000
CTYPTBNE EQU   (*-CTYPTBL)/CTYPTBEL Number of entries                   23220000
*------------------------------------------------------------*          23230000
*                                                            *          23240000
* The option table format is:                                *          23250000
*        Option name         - 8 characters                  *          23260000
*        Minimum name length - 1 byte numeric                *          23270000
*        Maximum name length - 1 byte numeric                *          23280000
*        Valid call types                                    *          23290000
*          for this option   - 1 byte of bit maps            *          23300000
*        Unused              - 1                             *          23310000
*        Label               - address of handler for call   *          23320000
*                                                            *          23330000
*------------------------------------------------------------*          23340000
OPTTBL   DS    0D                                                       23350000
         DC    CL8'AVOID  ',AL1(1,5,VIN,0),A($AVOID)                    23360000
OPTENTLN EQU   *-OPTTBL           Length of an entry                    23370000
         DC    CL8'BUFFER ',AL1(2,6,VCP,0),A($BUFFER)                   23380000
         DC    CL8'CASE   ',AL1(2,4,VOUT,0),A($CASE)                    23390000
         DC    CL8'CC     ',AL1(1,2,VPRINT,0),A($CC)                    23400000
         DC    CL8'FIFO   ',AL1(1,4,VIN,0),A($FIFO)                     23410000
         DC    CL8'FINIS  ',AL1(4,5,VDISKR+VDISKW,0),A($FINIS)          23420000
         DC    CL8'FIND   ',AL1(2,4,VIN,0),A($FIND)                     23430000
         DC    CL8'LIFO   ',AL1(1,4,VIN,0),A($LIFO)                     23440000
         DC    CL8'LOCATE ',AL1(2,6,VIN,0),A($LOCATE)                   23450000
         DC    CL8'MARGINS',AL1(1,7,VIN+VOUT,0),A($MARGINS)             23460000
         DC    CL8'NOTYPE ',AL1(1,6,VIN+VOUT,0),A($NOTYPE)              23470000
         DC    CL8'SKIP   ',AL1(2,4,VIN,0),A($SKIP)                     23480000
         DC    CL8'STEM   ',AL1(2,4,VIN+VOUT,0),A($STEM)                23490000
         DC    CL8'STRIP  ',AL1(1,5,VIN+VOUT,0),A($STRIP)               23500000
         DC    CL8'STRING ',AL1(2,6,VCP+VOUT,0),A($STRING)              23510000
         DC    CL8'VAR    ',AL1(3,3,VIN+VOUT,0),A($VAR)                 23520000
         DC    CL8'ZONE   ',AL1(1,4,VIN,0),A($ZONE)                     23530000
OPTTBLNE EQU   (*-OPTTBL)/OPTENTLN Number of entries                    23540000
*                                                                       23550000
*                            Valid call type bits                       23560000
*                            show that a certain option                 23570000
*                            is allowed for a certain                   23580000
*                            call types                                 23590000
VDISKR   EQU   X'80'                                                    23600000
VCARD    EQU   X'40'                                                    23610000
VCP      EQU   X'20'                                                    23620000
VPUNCH   EQU   X'10'                                                    23630000
VDISKW   EQU   X'08'                                                    23640000
VEMSG    EQU   X'04'                                                    23650000
VPRINT   EQU   X'02'                                                    23660000
VIN      EQU   VDISKR+VCARD+VCP           Any input call type           23670000
VOUT     EQU   VPUNCH+VDISKW+VEMSG+VPRINT Any output call type          23680000
 TITLE 'EXECIO: Constants'                                              23690000
*                                                                       23700000
LINEDITP LINEDIT MF=L,MAXSUBS=5                                         23710000
LINEDISZ EQU   *-LINEDITP                                               23720000
 TITLE 'EXECIO: Constants and literals'                                 23730000
*------------------------------------------------------------*          23740000
*  Constants and Literals                                    *          23750000
*------------------------------------------------------------*          23760000
         DS    0D                                                       23770000
EXECCOMM DC    CL8'EXECCOMM'                                            23780000
         DC    XL8'FFFFFFFFFFFFFFFF'                                    23790000
*                                                                       23800000
MAXWORD  DC    A(X'7FFFFFFF')     Maximum positive integer              23810000
*                                                                       23820000
         LTORG ,                                                        23830000
 TITLE 'EXECIO: File System Control Block'                              23840000
         FSCBD ,                                                        23850000
FSCBDLEN EQU   *-FSCBD                                                  23860000
*                                                                       23870000
         FSTD ,                                                         23880000
 TITLE 'EXECIO: Shared Variable Communications Block'                   23890000
         SHVBLOCK ,                                                     23900000
*                                                                       23910000
 TITLE 'EXECIO: Work Area Definitions'                                  23920000
*------------------------------------------------------------*          23930000
*  Program Work Areas                                        *          23940000
*------------------------------------------------------------*          23950000
WORKAREA DSECT                                                          23960000
         DS    18A                                                      23970000
*                                                                       23980000
EXFSCB   DS    XL(FSCBDLEN)       Build FSCB here                       23990000
EXFSTD   DS    XL(FSTDSIZE)       Fetch FST  here                       24000000
NEXTREC  DS    H                  Read or write this file               24010000
*                                    record number on next I/O          24020000
DWORD    DS    D                  Doubleword work area                  24030000
*                                                                       24040000
RC       DS    F                  EXECIO Return code                    24050000
*                                                                       24060000
LINES    DS    F                  Number of lines to process            24070000
OPTRET   DS    A                  Option handler return addr            24080000
*                                                                       24090000
FILEBUFA DS    A                  Buffer for CMS file I/O               24100000
FILEBUFL DS    F                  Length of CMS file I/O buff           24110000
FILERECL DS    F                  Length of CMS file record             24120000
*                                                                       24130000
STRINGBF DS    A                  Buffer for STRING value               24140000
STRINGBL DS    F                  Length of string buffer               24150000
*                                                                       24160000
REXBUFF  DS    A                  Large buffer for REXX var             24170000
REXBUFFL DS    F                  Length of REXX var buffer             24180000
*                                                                       24190000
CPBUFF   DS    A                  CP command response buffer            24200000
CPBUFFL  DS    F                  CP command buffer size                24210000
CPRESPNX DS    A                  CP response next line addr            24220000
CPRESPRL DS    F                  CP response remaining length          24230000
*                                                                       24240000
FILTERA  DS    A                  Ptr to AVOID/FIND/LOCATE              24250000
FILTERL  DS    F                    filter and length of it             24260000
*                                                                       24270000
MARGIN1  DS    F                  Selection column range                24280000
MARGIN2  DS    F                                                        24290000
*                                                                       24300000
ZONE1    DS    F                  Search zone start column              24310000
ZONE2    DS    F                  Search zone end column                24320000
*                                                                       24330000
VARNAMEA DS    A                  Address of VAR or STEM name           24340000
VARNAMEL DS    F                  Length of the name                    24350000
*                                                                       24360000
OPTNAME  DS    CL8                                                      24370000
*                                                                       24380000
OPTBITS  DS    X                  Option bits                           24390000
OPCASEU  EQU   X'80'                                                    24400000
OPFINIS  EQU   X'40'                                                    24410000
OPFIND   EQU   X'20'                                                    24420000
OPLOCATE EQU   X'10'                                                    24430000
OPAVOID  EQU   X'08'                                                    24440000
OPTBITS2 DS    X                  Option bits 2                         24450000
OPSKIP   EQU   X'80'                                                    24460000
OPSTRIP  EQU   X'40'                                                    24470000
OPNOTYPE EQU   X'20'                                                    24480000
OPZONE   EQU   X'10'                                                    24490000
OPMARGIN EQU   X'08'                                                    24500000
OPTBITS3 DS    X                  Option bits 3                         24510000
OPFIFO   EQU   X'80'              Input is from stack                   24520000
OPLIFO   EQU   X'40'              Input is from stack                   24530000
OPVAR    EQU   X'20'              Input is from REXX variable           24540000
OPSTEM   EQU   X'10'              Input is from REXX stem               24550000
OPSTRING EQU   X'08'              Input is from STRING                  24560000
*                                                                       24570000
CURROP   DS    X                  Current option bit flag               24580000
*                                                                       24590000
SELECTFL DS    X                  Selection option bit flag             24600000
SUCCESS  EQU   X'80'              Target was fould                      24610000
*                                                                       24620000
EPLENGTH DS    F                  Length of EPLIST args                 24630000
EPLADDR  DS    A                  Address of large EPLIST               24640000
EPLLEFT  DS    F                  Bytes left to scan in EPLIST          24650000
EPLNXT   DS    A                  Address of next byte to scan          24660000
EPLTOKEN DS    CL8                Last token scaned from EPLIST         24670000
EPLLOCAL DS    CL(2*80)           EPLIST saved uppercase copy           24680000
*                                 +EPLENGTH is lowercase copy           24690000
*                                                                       24700000
CVBSAVE  DS    8A                 Hold R14-R5 in CVB                    24710000
REXSAVE  DS    8A                 Hold R14-R5 in GETREXXV               24720000
*                                            and PUTREXXV               24730000
SAVEAREA DS    15A                Save area for R14-R12                 24740000
*                                                                       24750000
PLISTBLD DS    0D                 Various plists built here             24760000
         DS    5D                                                       24770000
LINEDITL LINEDIT MF=L,MAXSUBS=5                                         24780000
*                                                                       24790000
RDTERME  DS    0D                                                       24800000
         DC    CL8'WAITRD'                                              24810000
         DC    AL1(1)                                                   24820000
         DC    AL3(*-*)           Address of input line                 24830000
         DS    C'T'               No uppercase or blank fill            24840000
         DC    AL3(*-*)           Count returned here                   24850000
*                                                                       24860000
SHEPLIST DS    A                  EPLIST for EXECCOMM call              24870000
         DS    A                                                        24880000
         DS    A                                                        24890000
SHEPL4   DS    A                                                        24900000
*                                                                       24910000
SHVAREA  DS    ((SHVBLEN+7)/8)D   SHVBLOCK build area                   24920000
*                                                                       24930000
STEMNEXT DS    F                  Next stem index to use                24940000
STEMMAXI DS    F                  Max stem index in binary              24950000
STEMNAML DS    F                  Stem element name length              24960000
STEMNAMC DS    CL8                Stem index number in EBCDIC           24970000
STEMNAME DS    CL80               Stem element name                     24980000
*                                                                       24990000
CC       DS    X                  Carriage control value                25000000
*                                                                       25010000
         DS    0D                                                       25020000
BUFFER   DS    CL256                                                    25030000
BUFFERE  DS    CL256                                                    25040000
WORKSIZE EQU   *-WORKAREA                                               25050000
         REGEQU ,                                                       25060000
         AFT ,                                                          25070000
         NUCON ,                                                        25080000
         END                                                            25090000