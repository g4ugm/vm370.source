DMSBUF   CSECT                                                          00010000
*.                                                                      00020000
*  Module name -                                                        00030000
*                                                                       00040000
*         DMSBUF                                                        00050000
*                                                                       00060000
*  Function -                                                           00070000
*                                                                       00080000
*         Support console stack buffer manipulations in VM/370          00090000
*                                                                       00100000
*         MAKEBUF, DROPBUF, SENTRIES                                    00110000
*                                                                       00120000
* The stack levels are described by a list of two word                  00130000
* entries anchored in NUCXXXXX and NUCYYYYY. The first                  00140000
* word points to the 8 byte entry for the previous                      00150000
* stack buffer. The second word has the line number                     00160000
* of the previous stack buffer.                                         00170000
*                                                                       00180000
         USING NUCON,0                                                  00190000
         USING DMSBUF,R12                                               00200000
         EJECT                                                          00210000
*.                                                                      00220000
* Entry condition -                                                     00230000
*                                                                       00240000
*        R1 => CL8'MAKEBUF'                                             00250000
*              8X'FF'                                                   00260000
*                                                                       00270000
* Exit condition -                                                      00280000
*                                                                       00290000
*        R15 = New stack number                                         00300000
*.                                                                      00310000
DMSBUFMK DS    0H                                                       00320000
         ENTRY DMSBUFMK                                                 00330000
         LR    R12,R15            Establish global                      00340000
         LA    R15,DMSBUFMK-DMSBUF      base                            00350000
         SLR   R12,R15                                                  00360000
*                                                                       00370000
         LR    R2,R14             Hold R14 across call                  00380000
         LA    R0,1               Just need 8 bytes                     00390000
         DMSFREE DWORDS=(0),TYPCALL=BALR,TYPE=NUCLEUS                   00400000
         MVC   0(8,R1),NUCFSTLN   Save current stack lvl                00410000
*                                 first and last line ptrs              00420000
         ST    R1,NUCFSTLN        Hold last stack info                  00430000
         SR    R15,R15                                                  00440000
         ST    R15,NUCLSTLN       Clear the last line pointer           00450000
         LA    R15,1                                                    00460000
         A     R15,NUCNBSTK       Increment stack level                 00470000
         ST    R15,NUCNBSTK                                             00480000
* The stack level number becomes the MAKEBUF return code                00490000
         LR    R14,R2             Return address                        00500000
         BR    R14                Back to the caller                    00510000
*.                                                                      00520000
* Entry condition -                                                     00530000
*                                                                       00540000
*        R1 => CL8'SENTRIES'                                            00550000
*              8X'FF'                                                   00560000
*                                                                       00570000
* Exit condition -                                                      00580000
*                                                                       00590000
*        R15 = Total number of stacked lines                            00600000
*.                                                                      00610000
DMSBUFSE DS    0H                                                       00620000
         ENTRY DMSBUFSE                                                 00630000
         L     R15,NUCNLSTK       Number of lines in Pgm stack          00640000
         BR    R14                Return the count                      00650000
*.                                                                      00660000
* Entry condition -                                                     00670000
*                                                                       00680000
*        R1 => CL8'DROPBUF'                                             00690000
*              CL8'level'     (Optional)                                00700000
*              8X'FF'                                                   00710000
* Exit condition -                                                      00720000
*                                                                       00730000
*        R15 = 0, Successful                                            00740000
*              1, Invalid level number                                  00750000
*              2, Level number does not exist                           00760000
*.                                                                      00770000
DMSBUFDB DS    0H                                                       00780000
         ENTRY DMSBUFDB                                                 00790000
         LR    R12,R15           Establish global                       00800000
         LA    R15,DMSBUFDB-DMSBUF  base                                00810000
         SLR   R12,R15                                                  00820000
         LR    R11,R14            Hold return address here              00830000
*                                                                       00840000
         L     R5,NUCNBSTK        Default stack number to free          00850000
         LA    R1,8(,R1)          Point to possible argument            00860000
         CLI   0(R1),X'FF'        Any argument?                         00870000
         BE    DBPARMOK           If none, use the default              00880000
*                                                                       00890000
         SR    R2,R2              R2-R3 used to build number            00900000
         SR    R3,R3                                                    00910000
         SR    R5,R5              R4 has next digit                     00920000
         LA    R15,8              Loop counter                          00930000
DBPARMLP DS    0H                 Loop for all digits                   00940000
         CLI   0(R1),C' '         Found end of the number?              00950000
         BE    DBPARMOK           Yes, go process                       00960000
         CLI   0(R1),C'0'         Valid EBCDIC digit?                   00970000
         BL    ERROR1             Nope                                  00980000
         CLI   0(R1),C'9'         Valid EBCDIC digit?                   00990000
         BH    ERROR1             Nope                                  01000000
         IC    R5,0(,R1)          Next digit                            01010000
         N     R5,=A(X'0F')                                             01020000
         M     R2,=F'10'                                                01030000
         AR    R3,R5              Accumulate the total                  01040000
         LA    R1,1(,R1)          Step to next digit                    01050000
         BCT   R15,DBPARMLP       Check all 8 bytes                     01060000
DBPARMOK DS    0H                                                       01070000
*                                                                       01080000
* Release all the stack levels from the current level                   01090000
* down to and including the level specied in the plist                  01100000
*                                                                       01110000
         SLR   R10,R10             Accumulate released line             01120000
*                                     count as we go                    01130000
         L     R6,NUCNBSTK         Current stack level                  01140000
         CR    R5,R6               Does parm level exist?               01150000
         BH    ERROR2              ERROR2 if not                        01160000
         SR    R0,R0                                                    01170000
DBMAINLP DS    0H                  Delete next stack level              01180000
         LM    R3,R4,NUCFSTLN NUCLSTLN Get stack level ptrs             01190000
         LTR   R4,R4               If level is empty then               01200000
         BZ    NOLINES                no lines to delete                01210000
*                                                                       01220000
* Loop to release all the lines in the stack                            01230000
*                                                                       01240000
FRETSTAK DS    0H                                                       01250000
         LR    R1,R3          Address of next line                      01260000
         SR    R14,R14                                                  01270000
         IC    R14,5(,R3)     Length                                    01280000
         LA    R14,5+7(R14)   Convert length + 5 to doublewords         01290000
         SRL   R14,3                                                    01300000
         LR    R0,R14         Length to R0 for DMSFRET                  01310000
         L     R3,0(,R3)      Fetch next line ptr                       01320000
         LR    R8,R1          Address being remove for later            01330000
         DMSFRET DWORDS=(0),LOC=(1),TYPCALL=BALR                        01340000
         LA    R10,1(,R10)    Increment lines released counter          01350000
         CR    R4,R8          Was that the last line in stack?          01360000
         BNE   FRETSTAK       Keep going if not                         01370000
NOLINES  DS    0H                                                       01380000
*                                                                       01390000
*        Any more levels left to release?                               01400000
*                                                                       01410000
         XC    NUCFSTLN(8),NUCFSTLN    Clear stack pointers             01420000
         LTR   R1,R3              Everything cleared?                   01430000
         BZ    DBEXIT0            Exit if down to 0                     01440000
         MVC   NUCFSTLN(8),0(R3)  Swap ptrs to the previous level       01450000
         LA    R0,1               Release the doubleword of ptrs        01460000
         DMSFRET DWORDS=(0),LOC=(1),TYPCALL=BALR                        01470000
         BCTR  R6,0               Decrement to chk prior lvl            01480000
         CR    R5,R6              Any more to release?                  01490000
         BNH   DBMAINLP           Iterate Main loop if so               01500000
*                                   to delete the next level            01510000
* Clean up and return                                                   01520000
*                                                                       01530000
DBEXIT0  DS    0H                                                       01540000
         L     R15,NUCNLSTK       Decrement stacked lines               01550000
         SR    R15,R10              by number released                  01560000
         ST    R15,NUCNLSTK                                             01570000
*                                                                       01580000
         LH    R15,NUMFINRD       Decrement finished reads              01590000
         SR    R15,R10              by number released                  01600000
         STH   R15,NUMFINRD                                             01610000
*                                                                       01620000
         ST    R6,NUCNBSTK        Reset current stack number            01630000
         LR    R14,R11            Restore return address                01640000
         SR    R15,R15            Everything's fine                     01650000
         BR    R14                Return to caller                      01660000
*                                                                       01670000
ERROR1   DS    0H                                                       01680000
         LR    R14,R11            Restore return address                01690000
         LA    R15,1              Invalid argument                      01700000
         BR    R14                Return to caller                      01710000
*                                                                       01720000
ERROR2   DS    0H                                                       01730000
         LR    R14,R11            Restore return address                01740000
         LA    R15,2              Buffer does not exist                 01750000
         BR    R14                                                      01760000
*                                                                       01770000
*                                                                       01780000
         REGEQU ,                                                       01790000
         NUCON                                                          01800000
         END                                                            01810000